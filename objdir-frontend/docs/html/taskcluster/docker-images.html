

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Docker Images &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Periodic Taskgraphs" href="cron.html" />
    <link rel="prev" title="Optimization and SCHEDULES" href="optimization-schedules.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">TaskCluster Task-Graph Generation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="taskgraph.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="mach.html">Taskcluster Mach commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="loading.html">Loading Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="transforms.html">Transforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="optimization.html">Optimization</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Docker Images</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#organization">Organization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#task-images-build-on-push">Task Images (build-on-push)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#docker-registry-images-prebuilt">Docker Registry Images (prebuilt)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#re-building-images">(Re)-Building images</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#docker-registry-images">Docker Registry Images</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#special-dockerfile-syntax">Special Dockerfile Syntax</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cron.html">Periodic Taskgraphs</a></li>
<li class="toctree-l2"><a class="reference internal" href="try.html">Try</a></li>
<li class="toctree-l2"><a class="reference internal" href="actions.html">Actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="release-promotion.html">Release Promotion</a></li>
<li class="toctree-l2"><a class="reference internal" href="versioncontrol.html">Version Control in CI</a></li>
<li class="toctree-l2"><a class="reference internal" href="config.html">Taskcluster Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="how-tos.html">How Tos</a></li>
<li class="toctree-l2"><a class="reference internal" href="task-graph.html">Task Graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference.html">Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">TaskCluster Task-Graph Generation</a> &raquo;</li>
        
      <li>Docker Images</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/taskcluster/docker-images.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="docker-images">
<h1>Docker Images<a class="headerlink" href="#docker-images" title="Permalink to this headline">¶</a></h1>
<p>TaskCluster Docker images are defined in the source directory under
<code class="docutils literal notranslate"><span class="pre">taskcluster/docker</span></code>. Each directory therein contains the name of an
image used as part of the task graph.</p>
<div class="section" id="organization">
<h2>Organization<a class="headerlink" href="#organization" title="Permalink to this headline">¶</a></h2>
<p>Each folder describes a single docker image.  We have two types of images that can be defined:</p>
<ol class="arabic simple">
<li><p>Task Images (build-on-push)</p></li>
<li><p>Docker Images (prebuilt)</p></li>
</ol>
<p>These images depend on one another, as described in the <a class="reference external" href="https://docs.docker.com/v1.8/reference/builder/#from">FROM</a> line at the top of the
Dockerfile in each folder.</p>
<p>Images could either be an image intended for pushing to a docker registry, or
one that is meant either for local testing or being built as an artifact when
pushed to vcs.</p>
<div class="section" id="task-images-build-on-push">
<h3>Task Images (build-on-push)<a class="headerlink" href="#task-images-build-on-push" title="Permalink to this headline">¶</a></h3>
<p>Images can be uploaded as a task artifact, <a class="reference internal" href="#task-image-index-namespace"><span class="std std-ref">indexed</span></a> under
a given namespace, and used in other tasks by referencing the task ID.</p>
<p>Important to note, these images do not require building and pushing to a docker registry, and are
built per push (if necessary) and uploaded as task artifacts.</p>
<p>The decision task that is run per push will <a class="reference internal" href="#context-directory-hashing"><span class="std std-ref">determine</span></a>
if the image needs to be built based on the hash of the context directory and if the image
exists under the namespace for a given branch.</p>
<p>As an additional convenience, and a precaution to loading images per branch, if an image
has been indexed with a given context hash for mozilla-central, any tasks requiring that image
will use that indexed task.  This is to ensure there are not multiple images built/used
that were built from the same context. In summary, if the image has been built for mozilla-central,
pushes to any branch will use that already built image.</p>
<p>To use within an in-tree task definition, the format is:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">image</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="s">&#39;task-image&#39;</span>
    <span class="nt">path</span><span class="p">:</span> <span class="s">&#39;public/image.tar.zst&#39;</span>
    <span class="nt">taskId</span><span class="p">:</span> <span class="s">&#39;&lt;task_id_for_image_builder&gt;&#39;</span>
</pre></div>
</div>
<div class="section" id="context-directory-hashing">
<span id="id1"></span><h4>Context Directory Hashing<a class="headerlink" href="#context-directory-hashing" title="Permalink to this headline">¶</a></h4>
<p>Decision tasks will calculate the sha256 hash of the contents of the image
directory and will determine if the image already exists for a given branch and hash
or if a new image must be built and indexed.</p>
<p>Note: this is the contents of <em>only</em> the context directory, not the
image contents.</p>
<p>The decision task will:</p>
<ol class="arabic simple">
<li><p>Recursively collect the paths of all files within the context directory</p></li>
<li><p>Sort the filenames alphabetically to ensure the hash is consistently calculated</p></li>
<li><p>Generate a sha256 hash of the contents of each file</p></li>
<li><p>All file hashes will then be combined with their path and used to update the
hash of the context directory</p></li>
</ol>
<p>This ensures that the hash is consistently calculated and path changes will result
in different hashes being generated.</p>
</div>
<div class="section" id="task-image-index-namespace">
<span id="id2"></span><h4>Task Image Index Namespace<a class="headerlink" href="#task-image-index-namespace" title="Permalink to this headline">¶</a></h4>
<p>Images that are built on push and uploaded as an artifact of a task will be indexed under the
following namespaces.</p>
<ul class="simple">
<li><p>gecko.cache.level-{level}.docker.v2.{name}.hash.{digest}</p></li>
<li><p>gecko.cache.level-{level}.docker.v2.{name}.latest</p></li>
<li><p>gecko.cache.level-{level}.docker.v2.{name}.pushdate.{year}.{month}-{day}-{pushtime}</p></li>
</ul>
<p>Not only can images be browsed by the pushdate and context hash, but the ‘latest’ namespace
is meant to view the latest built image.  This functions similarly to the ‘latest’ tag
for docker images that are pushed to a registry.</p>
</div>
</div>
<div class="section" id="docker-registry-images-prebuilt">
<h3>Docker Registry Images (prebuilt)<a class="headerlink" href="#docker-registry-images-prebuilt" title="Permalink to this headline">¶</a></h3>
<p><strong>*Warning: Registry images are only used for ``decision`` and
``image_builder`` images.*</strong></p>
<p>These are images that are intended to be pushed to a docker registry and used
by specifying the docker image name in task definitions.  They are generally
referred to by a <code class="docutils literal notranslate"><span class="pre">&lt;repo&gt;&#64;&lt;repodigest&gt;</span></code> string:</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>image: taskcluster/decision:0.1.10@sha256:c5451ee6c655b3d97d4baa3b0e29a5115f23e0991d4f7f36d2a8f793076d6854
</pre></div>
</div>
<p>Such images must always be referred to with both a version and a repo digest.
For the decision image, the repo digest is stored in the <code class="docutils literal notranslate"><span class="pre">HASH</span></code> file in the
image directory and used to refer to the image as above.  The version for both
images is in <code class="docutils literal notranslate"><span class="pre">VERSION</span></code>.</p>
<p>The version file serves to help users identify which image is being used, and makes old
versions easy to discover in the registry.</p>
<p>The file <code class="docutils literal notranslate"><span class="pre">taskcluster/docker/REGISTRY</span></code> specifies the image registry to which
the completed image should be uploaded.</p>
<div class="section" id="docker-hashes-and-digests">
<h4>Docker Hashes and Digests<a class="headerlink" href="#docker-hashes-and-digests" title="Permalink to this headline">¶</a></h4>
<p>There are several hashes involved in this process:</p>
<blockquote>
<div><ul class="simple">
<li><p>Image Hash – the long version of the image ID; can be seen with
<code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">images</span> <span class="pre">--no-trunc</span></code> or in the <code class="docutils literal notranslate"><span class="pre">Id</span></code> field in <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">inspect</span></code>.</p></li>
<li><p>Repo Digest – hash of the image manifest; seen when running <code class="docutils literal notranslate"><span class="pre">docker</span>
<span class="pre">push</span></code> or <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">pull</span></code>.</p></li>
<li><p>Context Directory Hash – see above (not a Docker concept at all)</p></li>
</ul>
</div></blockquote>
<p>The use of hashes allows older tasks which were designed to run on an older
version of the image to be executed in Taskcluster while new tasks use the new
version.  Furthermore, this mitigates attacks against the registry as docker
will verify the image hash when loading the image.</p>
</div>
</div>
</div>
<div class="section" id="re-building-images">
<h2>(Re)-Building images<a class="headerlink" href="#re-building-images" title="Permalink to this headline">¶</a></h2>
<p>Generally, images can be pulled from the Docker registry rather than built
locally, however, for developing new images it’s often helpful to hack on them
locally.</p>
<p>To build an image, invoke <code class="docutils literal notranslate"><span class="pre">mach</span> <span class="pre">taskcluster-build-image</span></code> with the name of the
folder (without a trailing slash):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./mach taskcluster-build-image &lt;image-name&gt;
</pre></div>
</div>
<p>This is a wrapper around <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span> <span class="pre">-t</span> <span class="pre">$REGISTRY/$FOLDER:$VERSION</span></code>.</p>
<p>It’s a good idea to bump the <code class="docutils literal notranslate"><span class="pre">VERSION</span></code> early in this process, to avoid
<code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">push</span></code>-ing  over any old tags.</p>
<p>For task images, test your image locally or push to try. This is all that is
required.</p>
<div class="section" id="docker-registry-images">
<h3>Docker Registry Images<a class="headerlink" href="#docker-registry-images" title="Permalink to this headline">¶</a></h3>
<p>Landing docker registry images takes a little more care.</p>
<p>Begin by bumping the <code class="docutils literal notranslate"><span class="pre">VERSION</span></code>.  Once the new version of the image has been
built and tested locally, push it to the docker registry and make note of the
resulting repo digest.  Put this value in the <code class="docutils literal notranslate"><span class="pre">HASH</span></code> file for the
<code class="docutils literal notranslate"><span class="pre">decision</span></code> image and in <code class="docutils literal notranslate"><span class="pre">taskcluster/taskgraph/transforms/docker_image.py</span></code>
for the <code class="docutils literal notranslate"><span class="pre">image_builder</span></code> image.</p>
<p>The change is now safe to use in Try pushes.</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre">image_builder</span></code> change can be tested directly in try pushes without
using a registry, as the in-registry <code class="docutils literal notranslate"><span class="pre">image_builder</span></code> image is used to build a
task image which is then used to build other images.  It is referenced by hash
in <code class="docutils literal notranslate"><span class="pre">taskcluster/taskgraph/transforms/docker_image.py</span></code>.</p>
</div>
</div>
<div class="section" id="special-dockerfile-syntax">
<h2>Special Dockerfile Syntax<a class="headerlink" href="#special-dockerfile-syntax" title="Permalink to this headline">¶</a></h2>
<p>Dockerfile syntax has been extended to allow <em>any</em> file from the
source checkout to be added to the image build <em>context</em>. (Traditionally
you can only <code class="docutils literal notranslate"><span class="pre">ADD</span></code> files from the same directory as the Dockerfile.)</p>
<p>Simply add the following syntax as a comment in a Dockerfile:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># %include &lt;path&gt;</span>
</pre></div>
</div>
<p>e.g.</p>
<blockquote>
<div><p># %include mach
# %include testing/mozharness</p>
</div></blockquote>
<p>The argument to <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">%include</span></code> is a relative path from the root level of
the source directory. It can be a file or a directory. If a file, only that
file will be added. If a directory, every file under that directory will be
added (even files that are untracked or ignored by version control).</p>
<p>Files added using <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">%include</span></code> syntax are available inside the build
context under the <code class="docutils literal notranslate"><span class="pre">topsrcdir/</span></code> path.</p>
<p>Files are added as they exist on disk. e.g. executable flags should be
preserved. However, the file owner/group is changed to <code class="docutils literal notranslate"><span class="pre">root</span></code> and the
<code class="docutils literal notranslate"><span class="pre">mtime</span></code> of the file is normalized.</p>
<p>Here is an example Dockerfile snippet:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># %include mach</span>
<span class="n">ADD</span> <span class="n">topsrcdir</span><span class="o">/</span><span class="n">mach</span> <span class="o">/</span><span class="n">builds</span><span class="o">/</span><span class="n">worker</span><span class="o">/</span><span class="n">mach</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="cron.html" class="btn btn-neutral float-right" title="Periodic Taskgraphs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="optimization-schedules.html" class="btn btn-neutral float-left" title="Optimization and SCHEDULES" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>