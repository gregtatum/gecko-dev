

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tutorial: Show Allocations Per Call Path &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Tutorial: Set a breakpoint using Debugger" href="Tutorial-Breakpoint.html" />
    <link rel="prev" title="General Conventions" href="Conventions.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">SpiderMonkey</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../build.html">Building SpiderMonkey</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Debugger API</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="Debugger-API.html">The <code class="docutils literal notranslate"><span class="pre">Debugger</span></code> Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="Debugger.html">The Debugger Object</a></li>
<li class="toctree-l3"><a class="reference internal" href="Debugger.Object.html">Debugger.Object</a></li>
<li class="toctree-l3"><a class="reference internal" href="Debugger.Script.html">Debugger.Script</a></li>
<li class="toctree-l3"><a class="reference internal" href="Debugger.Source.html">Debugger.Source</a></li>
<li class="toctree-l3"><a class="reference internal" href="Debugger.Environment.html">Debugger.Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="Debugger.Frame.html">Debugger.Frame</a></li>
<li class="toctree-l3"><a class="reference internal" href="Debugger.Memory.html">Debugger.Memory</a></li>
<li class="toctree-l3"><a class="reference internal" href="Conventions.html">General Conventions</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Tutorial: Show Allocations Per Call Path</a></li>
<li class="toctree-l3"><a class="reference internal" href="Tutorial-Breakpoint.html">Tutorial: Set a breakpoint using <code class="docutils literal notranslate"><span class="pre">Debugger</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="Tutorial-Debugger-Statement.html">Tutorial: Evaluate an Expression When a debugger; Statement Is Executed</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../SavedFrame/index.html">SavedFrame</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">SpiderMonkey</a> &raquo;</li>
        
          <li><a href="index.html">Debugger API</a> &raquo;</li>
        
      <li>Tutorial: Show Allocations Per Call Path</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/js/Debugger/Tutorial-Alloc-Log-Tree.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tutorial-show-allocations-per-call-path">
<h1>Tutorial: Show Allocations Per Call Path<a class="headerlink" href="#tutorial-show-allocations-per-call-path" title="Permalink to this headline">¶</a></h1>
<p>This page shows how to use the <a class="reference internal" href="Debugger-API.html"><span class="doc">Debugger API</span></a> to show how many
objects a web page allocates, sorted by the function call path that allocated
them.</p>
<ol>
<li><p>Visit the URL <code class="docutils literal notranslate"><span class="pre">about:config</span></code>, and set the <code class="docutils literal notranslate"><span class="pre">devtools.chrome.enabled</span></code>
preference to <code class="docutils literal notranslate"><span class="pre">true</span></code>:</p>
<p><img alt="Setting the 'devtools.chrome.enabled' preference" src="../../_images/enable-chrome-devtools.png" /></p>
</li>
<li><p>Open a developer Scratchpad (Menu button &gt; Developer &gt; Scratchpad), and
select “Browser” from the “Environment” menu. (This menu will not be
present unless you have changed the preference as explained above.)</p>
<p><img alt="Selecting the 'browser' context in the Scratchpad" src="../../_images/scratchpad-browser-environment.png" /></p>
</li>
<li><p>Enter the following code in the Scratchpad:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// This simply defines the &#39;Debugger&#39; constructor in this</span>
<span class="c1">// Scratchpad; it doesn&#39;t actually start debugging anything.</span>
<span class="nx">Components</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="kr">import</span><span class="p">(</span><span class="s1">&#39;resource://gre/modules/jsdebugger.jsm&#39;</span><span class="p">);</span>
<span class="nx">addDebuggerToGlobal</span><span class="p">(</span><span class="nb">window</span><span class="p">);</span>

<span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// The debugger we&#39;ll use to observe a tab&#39;s allocation.</span>
  <span class="kd">var</span> <span class="nx">dbg</span><span class="p">;</span>

  <span class="c1">// Start measuring the selected tab&#39;s main window&#39;s memory</span>
  <span class="c1">// consumption. This function is available in the browser</span>
  <span class="c1">// console.</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">demoTrackAllocations</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">dbg</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Debugger</span><span class="p">;</span>

    <span class="c1">// This makes hacking on the demo *much* more</span>
    <span class="c1">// pleasant.</span>
    <span class="nx">dbg</span><span class="p">.</span><span class="nx">uncaughtExceptionHook</span> <span class="o">=</span> <span class="nx">handleUncaughtException</span><span class="p">;</span>

    <span class="c1">// Find the current tab&#39;s main content window.</span>
    <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="nx">gBrowser</span><span class="p">.</span><span class="nx">selectedBrowser</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Tracking allocations in page: &quot;</span> <span class="o">+</span>
                <span class="nx">w</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">);</span>

    <span class="c1">// Make that window a debuggee of our Debugger.</span>
    <span class="nx">dbg</span><span class="p">.</span><span class="nx">addDebuggee</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">wrappedJSObject</span><span class="p">);</span>

    <span class="c1">// Enable allocation tracking in dbg&#39;s debuggees.</span>
    <span class="nx">dbg</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">trackingAllocationSites</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nb">window</span><span class="p">.</span><span class="nx">demoPlotAllocations</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Grab the allocation log.</span>
    <span class="kd">var</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">dbg</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">drainAllocationsLog</span><span class="p">();</span>

    <span class="c1">// Neutralize the Debugger, and drop it on the floor</span>
    <span class="c1">// for the GC to collect.</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Stopping allocation tracking.&quot;</span><span class="p">);</span>
    <span class="nx">dbg</span><span class="p">.</span><span class="nx">removeAllDebuggees</span><span class="p">();</span>
    <span class="nx">dbg</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>

    <span class="c1">// Analyze and display the allocation log.</span>
    <span class="nx">plot</span><span class="p">(</span><span class="nx">log</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">handleUncaughtException</span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Debugger hook threw:&#39;</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ex</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Stack:&#39;</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ex</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">plot</span><span class="p">(</span><span class="nx">log</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Given the log, compute a map from allocation sites to</span>
    <span class="c1">// allocation counts. Note that stack entries are &#39;===&#39; if</span>
    <span class="c1">// they represent the same site with the same callers.</span>
    <span class="kd">var</span> <span class="nx">counts</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">site</span> <span class="k">of</span> <span class="nx">log</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// This is a kludge, necessary for now. The saved stacks</span>
      <span class="c1">// are new, and Firefox doesn&#39;t yet understand that they</span>
      <span class="c1">// are safe for chrome code to use, so we must tell it</span>
      <span class="c1">// so explicitly.</span>
      <span class="nx">site</span> <span class="o">=</span> <span class="nx">Components</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">waiveXrays</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">frame</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">counts</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">site</span><span class="p">))</span>
        <span class="nx">counts</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="mf">0</span><span class="p">);</span>
      <span class="nx">counts</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="nx">counts</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">site</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Walk from each site that allocated something up to the</span>
    <span class="c1">// root, computing allocation totals that include</span>
    <span class="c1">// children. Remember that &#39;null&#39; is a valid site,</span>
    <span class="c1">// representing the root.</span>
    <span class="kd">var</span> <span class="nx">totals</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="p">[</span><span class="nx">site</span><span class="p">,</span> <span class="nx">count</span><span class="p">]</span> <span class="k">of</span> <span class="nx">counts</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">totals</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">site</span><span class="p">))</span>
          <span class="nx">totals</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="mf">0</span><span class="p">);</span>
        <span class="nx">totals</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="nx">totals</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">site</span><span class="p">)</span> <span class="o">+</span> <span class="nx">count</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">site</span><span class="p">)</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="nx">site</span> <span class="o">=</span> <span class="nx">site</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Compute parent-to-child links, since saved stack frames</span>
    <span class="c1">// have only parent links.</span>
    <span class="kd">var</span> <span class="nx">rootChildren</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nx">childMapFor</span><span class="p">(</span><span class="nx">site</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">site</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">rootChildren</span><span class="p">;</span>

      <span class="kd">let</span> <span class="nx">parentMap</span> <span class="o">=</span> <span class="nx">childMapFor</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">parent</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">parentMap</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">site</span><span class="p">))</span>
        <span class="k">return</span> <span class="nx">parentMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">site</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">;</span>
      <span class="nx">parentMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="nx">m</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">m</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="p">[</span><span class="nx">site</span><span class="p">,</span> <span class="nx">total</span><span class="p">]</span> <span class="k">of</span> <span class="nx">totals</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">childMapFor</span><span class="p">(</span><span class="nx">site</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Print the allocation count for |site|. Print</span>
    <span class="c1">// |children|&#39;s entries as |site|&#39;s child nodes. Indent</span>
    <span class="c1">// the whole thing by |indent|.</span>
    <span class="kd">function</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">indent</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">place</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">site</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">name</span> <span class="o">=</span> <span class="nx">site</span><span class="p">.</span><span class="nx">functionDisplayName</span><span class="p">;</span>
        <span class="nx">place</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="nx">site</span><span class="p">.</span><span class="nx">source</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">site</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">site</span><span class="p">.</span><span class="nx">column</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;(root)&#39;</span><span class="p">;</span>
        <span class="nx">place</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">indent</span> <span class="o">+</span> <span class="nx">totals</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">site</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="nx">place</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="p">[</span><span class="nx">child</span><span class="p">,</span> <span class="nx">grandchildren</span><span class="p">]</span> <span class="k">of</span> <span class="nx">children</span><span class="p">)</span>
        <span class="nx">walk</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">grandchildren</span><span class="p">,</span> <span class="nx">indent</span> <span class="o">+</span> <span class="s1">&#39;   &#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">walk</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">rootChildren</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">})();</span>
</pre></div>
</div>
</li>
<li><p>In the Scratchpad, ensure that no text is selected, and press the “Run”
button. (If you get an error complaining that <code class="docutils literal notranslate"><span class="pre">Components.utils</span></code> is not
defined, be sure you’ve selected <code class="docutils literal notranslate"><span class="pre">Browser</span></code> from the scratchpad’s
<code class="docutils literal notranslate"><span class="pre">Environment</span></code> menu, as described in step 2.)</p></li>
<li><p>Save the following HTML text to a file, and visit the file in your browser.
Make sure the current browser tab is displaying this page.</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;doDivsAndSpans()&quot;</span><span class="p">&gt;</span>
  Click here to make the page do some allocations.
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="kd">function</span> <span class="nx">makeFactory</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="nx">factory</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">elt</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">type</span><span class="p">);</span>
      <span class="nx">elt</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">content</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">elt</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">divFactory</span> <span class="o">=</span> <span class="nx">makeFactory</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">spanFactory</span> <span class="o">=</span> <span class="nx">makeFactory</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">divsAndSpans</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mf">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nx">divFactory</span><span class="p">(</span><span class="s1">&#39;div #&#39;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">);</span>
      <span class="nx">div</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">spanFactory</span><span class="p">(</span><span class="s1">&#39;span #&#39;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">));</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">doDivsAndSpans</span><span class="p">()</span> <span class="p">{</span> <span class="nx">divsAndSpans</span><span class="p">();</span> <span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div>
</div>
</li>
<li><p>Open the browser console (Menu Button &gt; Developer &gt; Browser Console), and
then evaluate the expression <code class="docutils literal notranslate"><span class="pre">demoTrackAllocations()</span></code> in the browser
console. This begins logging allocations in the current browser tab.</p></li>
<li><p>In the browser tab, click on the text that says “Click here…”. The event
handler should add some text to the end of the page.</p></li>
<li><p>Back in the browser console, evaluate the expression
<code class="docutils literal notranslate"><span class="pre">demoPlotAllocations()</span></code>. This stops logging allocations, and displays a tree
of allocations:</p>
<p><img alt="An allocation plot, displayed in the console" src="../../_images/alloc-plot-console.png" /></p>
<p>The numbers at the left edge of each line show the total number of objects
allocated at that site or at sites called from there. After the count, we
see the function name, and the source code location of the call site or
allocation.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">(root)</span></code> node’s count includes objects allocated in the content page by
the web browser, like DOM events. Indeed, this display shows that
<code class="docutils literal notranslate"><span class="pre">popup.xml</span></code> and <code class="docutils literal notranslate"><span class="pre">content.js</span></code>, which are internal components of Firefox,
allocated more objects in the page’s compartment than the page itself. (We
will probably revise the allocation log to present such allocations in a way
that is more informative, and that exposes less of Firefox’s internal
structure.)</p>
<p>As expected, the <code class="docutils literal notranslate"><span class="pre">onclick</span></code> handler is responsible for all allocation done by
the page’s own code. (The line number for the onclick handler is <code class="docutils literal notranslate"><span class="pre">1</span></code>,
indicating that the allocating call is located on line one of the handler
text itself. We will probably change this to be the line number within
<code class="docutils literal notranslate"><span class="pre">page.html</span></code>, not the line number within the handler code.)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">onclick</span></code> handler calls <code class="docutils literal notranslate"><span class="pre">doDivsAndSpans</span></code>, which calls <code class="docutils literal notranslate"><span class="pre">divsAndSpans</span></code>,
which invokes closures of <code class="docutils literal notranslate"><span class="pre">factory</span></code> to do all the actual allocation. (It is
unclear why <code class="docutils literal notranslate"><span class="pre">spanFactory</span></code> allocated thirteen objects, despite being called
only ten times.)</p>
</li>
</ol>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Tutorial-Breakpoint.html" class="btn btn-neutral float-right" title="Tutorial: Set a breakpoint using Debugger" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Conventions.html" class="btn btn-neutral float-left" title="General Conventions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>