Native Allocations
==================

The profiler can sample allocations and de-allocations from malloc using the
"Native Allocations" feature. This can be enabled by going to `about:profiling` and
enabling the "Native Allocations" checkbox. It is only available in Nightly, as it
uses a technique of hooking into malloc that could be a little more risky to apply to
the broader population of Firefox users.

This implementation is located in: `tools/profiler/core/memory_hooks.cpp
<https://searchfox.org/mozilla-central/source/tools/profiler/core/memory_hooks.cpp>`_

It works by hooking into all of the malloc calls. When the profiler is running, it
performs a `Bernoulli trial`_, that will pass for a given probability of per-byte
allocated. What this means is that larger allocations have a higher chance of being
recorded compared to smaller allocations. Currently, there is no way to configure
the per-byte probability.

This infrastructure is quite similar to DMD, but with the additional motiviations of
making it easy to turn on and use with the profiler. The overhead is quite high,
especially on systems with more expensive stack walking, like Linux. Turning off
thee "Native Stacks" feature can help lower overhead, but will give less information.

For more information on analyzing these profiles, see the `Firefox Profiler docs`_.

.. _Bernoulli trial: https://en.wikipedia.org/wiki/Bernoulli_trial
.. _Firefox Profiler docs: https://profiler.firefox.com/docs/#/./memory-allocations
