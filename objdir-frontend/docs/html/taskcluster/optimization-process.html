

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Optimization Process &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Optimization and SCHEDULES" href="optimization-schedules.html" />
    <link rel="prev" title="Optimization" href="optimization.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">TaskCluster Task-Graph Generation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="taskgraph.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="mach.html">Taskcluster Mach commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="loading.html">Loading Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="transforms.html">Transforms</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="optimization.html">Optimization</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="optimization.html#optimization-strategies">Optimization Strategies</a></li>
<li class="toctree-l3"><a class="reference internal" href="optimization.html#optimizing-target-tasks">Optimizing Target Tasks</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="optimization.html#more-information">More Information</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">Optimization Process</a></li>
<li class="toctree-l4"><a class="reference internal" href="optimization-schedules.html">Optimization and SCHEDULES</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="docker-images.html">Docker Images</a></li>
<li class="toctree-l2"><a class="reference internal" href="cron.html">Periodic Taskgraphs</a></li>
<li class="toctree-l2"><a class="reference internal" href="try.html">Try</a></li>
<li class="toctree-l2"><a class="reference internal" href="actions.html">Actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="release-promotion.html">Release Promotion</a></li>
<li class="toctree-l2"><a class="reference internal" href="versioncontrol.html">Version Control in CI</a></li>
<li class="toctree-l2"><a class="reference internal" href="config.html">Taskcluster Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="how-tos.html">How Tos</a></li>
<li class="toctree-l2"><a class="reference internal" href="task-graph.html">Task Graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference.html">Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">TaskCluster Task-Graph Generation</a> &raquo;</li>
        
          <li><a href="optimization.html">Optimization</a> &raquo;</li>
        
      <li>Optimization Process</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/taskcluster/optimization-process.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="optimization-process">
<h1>Optimization Process<a class="headerlink" href="#optimization-process" title="Permalink to this headline">¶</a></h1>
<p>Optimization proceeds in three phases: removing tasks, replacing tasks,
and finally generating a subgraph containing only the remaining tasks.</p>
<p>Assume the following task graph as context for these examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>TC1 &lt;--\     ,- UP1
      , B1 &lt;--- T1a
I1 &lt;-|       `- T1b
      ` B2 &lt;--- T2a
TC2 &lt;--/     |- T2b
             `- UP2
</pre></div>
</div>
<div class="section" id="removing-tasks">
<h2>Removing Tasks<a class="headerlink" href="#removing-tasks" title="Permalink to this headline">¶</a></h2>
<p>This phase begins with tasks on which nothing depends and follows the
dependency graph backward from there – right to left in the diagram above. If
a task is not removed, then nothing it depends on will be removed either.
Thus if T1a and T1b are both removed, B1 may be removed as well. But if T2b is
not removed, then B2 may not be removed either.</p>
<p>For each task with no remaining dependencies, the decision whether to remove is
made by calling the optimization strategy’s <code class="docutils literal notranslate"><span class="pre">should_remove_task</span></code> method. If
this method returns True, the task is removed.</p>
<p>The optimization process takes a <code class="docutils literal notranslate"><span class="pre">do_not_optimize</span></code> argument containing a list
of tasks that cannot be removed under any circumstances. This is used to
“force” running specific tasks.</p>
</div>
<div class="section" id="replacing-tasks">
<h2>Replacing Tasks<a class="headerlink" href="#replacing-tasks" title="Permalink to this headline">¶</a></h2>
<p>This phase begins with tasks having no dependencies and follows the reversed
dependency graph from there – left to right in the diagram above. If a task is
not replaced, then anything depending on that task cannot be replaced.
Replacement is generally done on the basis of some hash of the inputs to the
task. In the diagram above, if both TC1 and I1 are replaced with existing
tasks, then B1 is a candidate for replacement. But if TC2 has no replacement,
then replacement of B2 will not be considered.</p>
<p>It is possible to replace a task with nothing.  This is similar to optimzing
away, but is useful for utility tasks like UP1. If such a task is considered
for replacement, then all of its dependencies (here, B1) have already been
replaced and there is no utility in running the task and no need for a
replacement task.  It is an error for a task on which others depend to be
replaced with nothing.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">do_not_optimize</span></code> set applies to task replacement, as does an additional
<code class="docutils literal notranslate"><span class="pre">existing_tasks</span></code> dictionary which allows the caller to supply as set of
known, pre-existing tasks. This is used for action tasks, for example, where it
contains the entire task-graph generated by the original decision task.</p>
</div>
<div class="section" id="subgraph-generation">
<h2>Subgraph Generation<a class="headerlink" href="#subgraph-generation" title="Permalink to this headline">¶</a></h2>
<p>The first two phases annotate each task in the existing taskgraph with their
fate: removed, replaced, or retained. The tasks that are replaced also have a
replacement taskId.</p>
<p>The last phase constructs a subgraph containing the retained tasks, and
simultaneously rewrites all dependencies to refer to taskIds instead of labels.
To do so, it assigns a taskId to each retained task and uses the replacement
taskId for all replaced tasks.</p>
<p>The <cite>soft-dependencies</cite> are then solved for each task, by adding all the
remaining tasks in the subgraph from that list to its <cite>dependencies</cite>.</p>
<p>The result is an optimized taskgraph with tasks named by taskId instead of
label. At this phase, the edges in the task graph diverge from the
<code class="docutils literal notranslate"><span class="pre">task.dependencies</span></code> attributes, as the latter may contain dependencies
outside of the taskgraph (for replacement tasks).</p>
<p>As a side-effect, this phase also expands all <code class="docutils literal notranslate"><span class="pre">{&quot;task-reference&quot;:</span> <span class="pre">&quot;..&quot;}</span></code> and
<code class="docutils literal notranslate"><span class="pre">{&quot;artifact-reference&quot;:</span> <span class="pre">&quot;..&quot;}</span></code> objects within the task definitions.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="optimization-schedules.html" class="btn btn-neutral float-right" title="Optimization and SCHEDULES" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="optimization.html" class="btn btn-neutral float-left" title="Optimization" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>