

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Async tab switcher &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Touch Bar" href="../../touchbar/index.html" />
    <link rel="prev" title="tabbrowser" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Firefox</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../urlbar/index.html">Address Bar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../BrowserUsageTelemetry.html">Browser Usage Telemetry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../components/enterprisepolicies/docs/index.html">Enterprise Policies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../extensions/formautofill/docs/index.html">Form Autofill</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../components/newtab/docs/index.html">Firefox Home (New Tab)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installer/windows/installer/index.html">Installer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../toolkit/mozapps/defaultagent/default-browser-agent/index.html">Default Browser Agent</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../components/newtab/content-src/asrouter/docs/index.html">Messaging System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sslerrorreport/index.html">SSL Error Reporting</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">tabbrowser</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Async tab switcher</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#briefly-introducing-layers-and-the-compositor">Briefly introducing Layers and the Compositor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#renderlayers-haslayers-docshellisactive">renderLayers, hasLayers, docShellIsActive</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#lifecycle">Lifecycle</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tab-states">Tab states</a></li>
<li class="toctree-l4"><a class="reference internal" href="#stepping-through-a-simple-tab-switch">Stepping through a simple tab switch</a></li>
<li class="toctree-l4"><a class="reference internal" href="#unloading-background-tabs">Unloading background tabs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#perceived-performance-optimizations">Perceived performance optimizations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#warming">Warming</a></li>
<li class="toctree-l4"><a class="reference internal" href="#logging">Logging</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../touchbar/index.html">Touch Bar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../components/uitour/docs/index.html">UITour</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../components/payments/docs/index.html">WebPayments UI</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Firefox</a> &raquo;</li>
        
          <li><a href="index.html">tabbrowser</a> &raquo;</li>
        
      <li>Async tab switcher</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/browser/base/tabbrowser/async-tab-switcher.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="async-tab-switcher">
<span id="tabbrowser-async-tab-switcher"></span><h1>Async tab switcher<a class="headerlink" href="#async-tab-switcher" title="Permalink to this headline">¶</a></h1>
<p>At a very high level, the async tab switcher is responsible for telling tabs with out-of-process (or “remote”) <code class="docutils literal notranslate"><span class="pre">&lt;xul:browser&gt;</span></code>’s to render and upload their contents to the compositor, and then update the UI to show that content as a tab switch. Similarly, the async tab switcher is responsible for telling tabs that have been switched away from to stop rendering their content, and for the compositor to release those contents.</p>
<div class="section" id="briefly-introducing-layers-and-the-compositor">
<h2>Briefly introducing Layers and the Compositor<a class="headerlink" href="#briefly-introducing-layers-and-the-compositor" title="Permalink to this headline">¶</a></h2>
<p>For out-of-process tabs, the presentation portion of Gecko computes the final contents of a tab inside the tabs content process, and then uploads that information to the compositor. This uploaded information is usually referred to as <em>layers</em>.</p>
<p>The compositor is what eventually presents these layers to the user as pixels. The compositor can retain several sets of layers without necessarily showing them to the user, but this consumes memory. Layers that are no longer needed are released.</p>
<p>From here forward, “contents of a tab” will be referred to as that tab’s <em>layers</em>.</p>
</div>
<div class="section" id="renderlayers-haslayers-docshellisactive">
<span id="async-tab-switcher-useful-properties"></span><h2>renderLayers, hasLayers, docShellIsActive<a class="headerlink" href="#renderlayers-haslayers-docshellisactive" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">&lt;xul:browser&gt;</span></code>’s have a number of useful properties exposed on them that the async tab switcher uses:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">renderLayers</span></code></dt><dd><p>For remote <code class="docutils literal notranslate"><span class="pre">&lt;xul:browser&gt;</span></code>’s, setting this to <code class="docutils literal notranslate"><span class="pre">true</span></code> from <code class="docutils literal notranslate"><span class="pre">false</span></code> means to ask the content process to render the layers for that <code class="docutils literal notranslate"><span class="pre">&lt;xul:browser&gt;</span></code> and upload them to the compositor. Setting this to <code class="docutils literal notranslate"><span class="pre">false</span></code> from <code class="docutils literal notranslate"><span class="pre">true</span></code> means to ask the content process to stop rendering the layers and for the compositor to release the layers. Setting this property to <code class="docutils literal notranslate"><span class="pre">true</span></code> when it is already <code class="docutils literal notranslate"><span class="pre">true</span></code> or <code class="docutils literal notranslate"><span class="pre">false</span></code> when it is already <code class="docutils literal notranslate"><span class="pre">false</span></code> is a no-op. When this property returns <code class="docutils literal notranslate"><span class="pre">true</span></code>, this means that layers have been requested for this tab, but there is no guarantee that the layers have been received by the compositor yet. Similarly, when this property returns <code class="docutils literal notranslate"><span class="pre">false</span></code>, this means that this browser has been asked to stop rendering layers, but there is no guarantee that the layers have been released by the compositor yet.</p>
<p>For non-remote <code class="docutils literal notranslate"><span class="pre">&lt;xul:browser&gt;</span></code>’s, <code class="docutils literal notranslate"><span class="pre">renderLayers</span></code> is an alias for <code class="docutils literal notranslate"><span class="pre">docShellIsActive</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">hasLayers</span></code></dt><dd><p>For remote <code class="docutils literal notranslate"><span class="pre">&lt;xul:browser&gt;</span></code>’s, this read-only property returns <code class="docutils literal notranslate"><span class="pre">true</span></code> if the compositor has layers for this tab, and <code class="docutils literal notranslate"><span class="pre">false</span></code> otherwise.</p>
<p>For non-remote <code class="docutils literal notranslate"><span class="pre">&lt;xul:browser&gt;</span></code>’s, <code class="docutils literal notranslate"><span class="pre">hasLayers</span></code> returns the value for <code class="docutils literal notranslate"><span class="pre">docShellIsActive</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">docShellIsActive</span></code></dt><dd><p>For remote <code class="docutils literal notranslate"><span class="pre">&lt;xul:browser&gt;</span></code>’s, setting <code class="docutils literal notranslate"><span class="pre">docShellIsActive</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code> also sets <code class="docutils literal notranslate"><span class="pre">renderLayers</span></code> to true, and then sends a message to the content process to set its top-level docShell active state to <code class="docutils literal notranslate"><span class="pre">true</span></code>. Similarly, setting <code class="docutils literal notranslate"><span class="pre">docShellIsActive</span></code> to <code class="docutils literal notranslate"><span class="pre">false</span></code> also sets <code class="docutils literal notranslate"><span class="pre">renderLayers</span></code> to false, and then sends a message to the content process to set its top-level docShell active state to <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p>
<p>For non-remote <code class="docutils literal notranslate"><span class="pre">&lt;xul:browser&gt;</span></code>’s, <code class="docutils literal notranslate"><span class="pre">docShellIsActive</span></code> forwards to the <code class="docutils literal notranslate"><span class="pre">isActive</span></code> property on the <code class="docutils literal notranslate"><span class="pre">&lt;xul:browser&gt;</span></code>’s top-level docShell.</p>
<p>Setting a docShell to be active causes the tab’s visibilitychange event to fire to indicate that the tab has become visible. Media that was waiting to be played until the tab is selected will also begin to play.</p>
<p>An active docShell is also required in order to generate a print preview of the loaded document.</p>
</dd>
</dl>
</div>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>There are a number of requirements that the tab switcher must satisfy. In no particular order, they are:</p>
<ol class="arabic simple">
<li><p>The switcher must be prepared to switch between any mixture of remote and non-remote tabs. Non-remote tabs include tabs pointed at <a class="reference external" href="about:addons">about:addons</a>, <a class="reference external" href="about:config">about:config</a>, and others</p></li>
<li><p>We want to avoid switching the toolbar state (for example, the URL bar input, security indicators, toolbar button states) until we are ready to show the layers of the tab that we’re switching to</p></li>
<li><p>Only one tab should appear to be selected in the tab strip at any given time</p></li>
<li><p>We want to avoid switching keyboard focus to a selected tab until the layers for the tab are ready - but only if the user doesn’t change focus between the start and end of the async tab switch</p></li>
<li><p>If the layers for a tab are not available after a certain amount of time, we should “complete” the tab switch by displaying the “tab switch spinner” - an animated spinner against a white background. This way, we at least show the user some activity, despite the fact that we don’t have the layers of the tab to show them</p></li>
<li><p>The printing UI uses tabs to show print preview, which requires that the print-previewed tab is in the background and yet also have its docShell be “active” - a state that’s usually reserved for the selected tab. See <a class="reference internal" href="#async-tab-switcher-useful-properties"><span class="std std-ref">renderLayers, hasLayers, docShellIsActive</span></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;xul:tab&gt;</span></code>’s and <code class="docutils literal notranslate"><span class="pre">&lt;xul:browser&gt;</span></code>’s might be created or destroyed at any time during an async tab switch</p></li>
<li><p>It should be possible to render layers for a tab, despite it not having been set as active (this is used for <a class="reference internal" href="#async-tab-switcher-warming"><span class="std std-ref">Warming</span></a>)</p></li>
</ol>
</div>
<div class="section" id="lifecycle">
<h2>Lifecycle<a class="headerlink" href="#lifecycle" title="Permalink to this headline">¶</a></h2>
<p>Per window, an async tab switcher instance is only supposed to exist if one or more tabs still need to have their layers loaded or unloaded. This means that an async tab switcher instance might exist even though a tab switch appears to the user to have completed. This also means that an async tab switcher might continue to exist and handle a new tab switch if the user initiates that tab switch before some background tabs have had their layers unloaded.</p>
<p>There’s only one async tab switcher at a time per window, and it’s owned by the <code class="docutils literal notranslate"><span class="pre">&lt;xul:tabbrowser&gt;</span></code>.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">&lt;xul:tabbrowser&gt;</span></code> starts without an async tab switcher, and only once a tab switch (or warming) is initiated by the user is the switcher instantiated.</p>
<p>Once the switcher determines that the tab that the user has requested is being shown, and all background tabs have been properly unloaded or destroyed, the async tab switcher cleans up and destroys itself.</p>
</div>
<div class="section" id="tab-states">
<span id="async-tab-switcher-states"></span><h2>Tab states<a class="headerlink" href="#tab-states" title="Permalink to this headline">¶</a></h2>
<p>While the async tab switcher exists, it maps each <code class="docutils literal notranslate"><span class="pre">&lt;xul:tab&gt;</span></code> in the window to one of the following internal states:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">STATE_UNLOADED</span></code></dt><dd><p>Layers for this <code class="docutils literal notranslate"><span class="pre">&lt;xul:tab&gt;</span></code> are not being uploaded to the compositor, and we haven’t requested that the tab start doing so. This tab is fully in the background.</p>
<p>When a tab is in <code class="docutils literal notranslate"><span class="pre">STATE_UNLOADED</span></code>, this means that the associated <code class="docutils literal notranslate"><span class="pre">&lt;xul:browser&gt;</span></code> either does not exist, or will have its <code class="docutils literal notranslate"><span class="pre">renderLayers</span></code> and <code class="docutils literal notranslate"><span class="pre">hasLayers</span></code> properties both return <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p>
<p>If a tab is in this state, it must have either initialized there, or transitioned from <code class="docutils literal notranslate"><span class="pre">STATE_UNLOADING</span></code>.</p>
<p>When logging states, this state is indicated by the <code class="docutils literal notranslate"><span class="pre">unloaded</span></code> string.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">STATE_LOADING</span></code></dt><dd><p>Layers for this <code class="docutils literal notranslate"><span class="pre">&lt;xul:tab&gt;</span></code> have not yet been reported as “received” by the compositor, but we’ve asked the tab to start rendering. This usually means that we want to switch to the tab, or at least to warm it up.</p>
<p>When a tab is in <code class="docutils literal notranslate"><span class="pre">STATE_LOADING</span></code>, this means that the associated <code class="docutils literal notranslate"><span class="pre">&lt;xul:browser&gt;</span></code> will have its <code class="docutils literal notranslate"><span class="pre">renderLayers</span></code> property return <code class="docutils literal notranslate"><span class="pre">true</span></code> and its <code class="docutils literal notranslate"><span class="pre">hasLayers</span></code> property return <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p>
<p>If a tab is in this state, it must have either initialized there, or transitioned from <code class="docutils literal notranslate"><span class="pre">STATE_UNLOADED</span></code>.</p>
<p>When logging states, this state is indicated by the <code class="docutils literal notranslate"><span class="pre">loading</span></code> string.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">STATE_LOADED</span></code></dt><dd><p>Layers for this <code class="docutils literal notranslate"><span class="pre">&lt;xul:tab&gt;</span></code> are available on the compositor and can be displayed. This means that the tab is either being shown to the user, or could be very quickly shown to the user.</p>
<p>If a tab is in this state, it must have either initialized there, or transitioned from <code class="docutils literal notranslate"><span class="pre">STATE_LOADING</span></code>.</p>
<p>When a tab is in <code class="docutils literal notranslate"><span class="pre">STATE_LOADED</span></code>, this means that the associated <code class="docutils literal notranslate"><span class="pre">&lt;xul:browser&gt;</span></code> will have its <code class="docutils literal notranslate"><span class="pre">renderLayers</span></code> and <code class="docutils literal notranslate"><span class="pre">hasLayers</span></code> properties both return <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p>
<p>When logging states, this state is indicated by the <code class="docutils literal notranslate"><span class="pre">loaded</span></code> string.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">STATE_UNLOADING</span></code></dt><dd><p>Layers for this <code class="docutils literal notranslate"><span class="pre">&lt;xul:tab&gt;</span></code> were at one time available on the compositor, but we’ve asked the tab to unload them to preserve memory. This usually means that we’ve switched away from this tab, or have stopped warming it up.</p>
<p>When a tab is in <code class="docutils literal notranslate"><span class="pre">STATE_UNLOADING</span></code>, this means that the associated <code class="docutils literal notranslate"><span class="pre">&lt;xul:browser&gt;</span></code> will have its <code class="docutils literal notranslate"><span class="pre">renderLayers</span></code> property return <code class="docutils literal notranslate"><span class="pre">false</span></code> and its <code class="docutils literal notranslate"><span class="pre">hasLayers</span></code> property return <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p>
<p>If a tab is in this state, it must have either initialized there, or transitioned from <code class="docutils literal notranslate"><span class="pre">STATE_LOADED</span></code>.</p>
<p>When logging states, this state is indicated by the <code class="docutils literal notranslate"><span class="pre">unloading</span></code> string.</p>
</dd>
</dl>
<p>Having a tab render its layers is done by settings its state to <code class="docutils literal notranslate"><span class="pre">STATE_LOADING</span></code>. Once the layers have been received, the switcher will automatically set the state to <code class="docutils literal notranslate"><span class="pre">STATE_LOADED</span></code>. Similarly, telling a tab to stop rendering is done by settings its state to <code class="docutils literal notranslate"><span class="pre">STATE_UNLOADING</span></code>. The switcher will automatically set the state to <code class="docutils literal notranslate"><span class="pre">STATE_UNLOADED</span></code> once the layers have fully unloaded.</p>
</div>
<div class="section" id="stepping-through-a-simple-tab-switch">
<h2>Stepping through a simple tab switch<a class="headerlink" href="#stepping-through-a-simple-tab-switch" title="Permalink to this headline">¶</a></h2>
<p>In our simple scenario, suppose the user has a single browser window with two tabs: a tab at index <strong>0</strong> and a tab at index <strong>1</strong>. Both tabs are completed loaded, and <strong>0</strong> is currently selected and displaying its content.</p>
<p>The user chooses to switch to tab <strong>1</strong>. An async tab switcher is instantiated, and it immediately attaches a number of event handlers to the window. Among them are handlers for the <code class="docutils literal notranslate"><span class="pre">MozLayerTreeReady</span></code> and <code class="docutils literal notranslate"><span class="pre">MozLayerTreeCleared</span></code> events.</p>
<p>The switcher then creates an internal mapping from <code class="docutils literal notranslate"><span class="pre">&lt;xul:tab&gt;&gt;</span></code>’s to states. That mapping is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>// This is using the logging syntax laid out in the `Tab states` section.
0:(loaded) 1:(unloaded)
</pre></div>
</div>
<p>Be sure to refer to <a class="reference internal" href="#async-tab-switcher-states"><span class="std std-ref">Tab states</span></a> for an explanation of the terminology and <a class="reference internal" href="#async-tab-switcher-logging"><span class="std std-ref">Logging</span></a> syntax for states.</p>
<p>This last example translates to:</p>
<blockquote>
<div><p>The tab at index <strong>0</strong>, is in <code class="docutils literal notranslate"><span class="pre">STATE_LOADED</span></code> and the tab at index <strong>1</strong> is in <code class="docutils literal notranslate"><span class="pre">STATE_UNLOADED</span></code>.</p>
</div></blockquote>
<p>Now that initialization done, the switcher is asked to request <strong>1</strong>. It does this by putting <strong>1</strong> into <code class="docutils literal notranslate"><span class="pre">STATE_LOADING</span></code> and requesting that <strong>1</strong>’s layers be rendered. The new state mapping is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0:(loaded) 1:(loading)
</pre></div>
</div>
<p>At this point, the user is still looking at tab <strong>0</strong>, and none of the UI is showing any visible indication of tab change.</p>
<p>Now the switcher is waiting, so it goes back to the event loop. During this time, if any code were to ask the tabbrowser which tab is selected, it’d return <strong>1</strong>, since it’s <em>logically</em> selected despite not being <em>visually</em> selected.</p>
<p>Eventually, the layers for <strong>1</strong> are uploaded to the compositor, and the <code class="docutils literal notranslate"><span class="pre">&lt;xul:browser&gt;</span></code> for <strong>1</strong> fires its <code class="docutils literal notranslate"><span class="pre">MozLayerTreeReady</span></code> event. This is when the switcher changes its internal state again:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0:(loaded) 1:(loaded)
</pre></div>
</div>
<p>So now layers for both <strong>0</strong> and <strong>1</strong> are uploading and available on the compositor. At this point, the switcher updates the visual state of the browser, and flips the <code class="docutils literal notranslate"><span class="pre">&lt;xul:deck&gt;</span></code> to display <strong>1</strong>, and the user experiences the tab switch.</p>
<p>The switcher isn’t done, however. After a predefined amount of time (dictated by <code class="docutils literal notranslate"><span class="pre">UNLOAD_DELAY</span></code>), tabs that aren’t currently selected but in <code class="docutils literal notranslate"><span class="pre">STATE_LOADED</span></code> are put into <code class="docutils literal notranslate"><span class="pre">STATE_UNLOADING</span></code>. Now the internal state looks like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0:(unloading) 1:(loaded)
</pre></div>
</div>
<p>Having requested that <strong>0</strong> go into <code class="docutils literal notranslate"><span class="pre">STATE_UNLOADING</span></code>, the switcher returns back to the event loop. The user, meanwhile, continues to use <code class="docutils literal notranslate"><span class="pre">1</span></code>.</p>
<p>Eventually, the layers for <strong>0</strong> are cleared from the compositor, and the <code class="docutils literal notranslate"><span class="pre">&lt;xul:browser&gt;</span></code> for <strong>0</strong> fires its <code class="docutils literal notranslate"><span class="pre">MozLayerTreeCleared</span></code> event. This is when the switcher changes its internal state once more:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0:(unloaded) 1:(loaded)
</pre></div>
</div>
<p>The tab at <strong>0</strong> is now in <code class="docutils literal notranslate"><span class="pre">STATE_UNLOADED</span></code>. Since the last requested tab <strong>1</strong> is in <code class="docutils literal notranslate"><span class="pre">STATE_LOADED</span></code> and all other background tabs are in <code class="docutils literal notranslate"><span class="pre">STATE_UNLOADED</span></code>, the switcher decides its work is done. It deregisters its event handlers, and then destroys itself.</p>
</div>
<div class="section" id="unloading-background-tabs">
<span id="async-tab-switcher-unloading-background"></span><h2>Unloading background tabs<a class="headerlink" href="#unloading-background-tabs" title="Permalink to this headline">¶</a></h2>
<p>While an async tab switcher exists, it will periodically scan the window for tabs that are in <code class="docutils literal notranslate"><span class="pre">STATE_LOADED</span></code> but are also in the background. These tabs will then be put into <code class="docutils literal notranslate"><span class="pre">STATE_UNLOADING</span></code>. Only once all background tabs have settled into the <code class="docutils literal notranslate"><span class="pre">STATE_UNLOADED</span></code> state are the background tabs considered completely cleared.</p>
<p>The background scanning interval is <code class="docutils literal notranslate"><span class="pre">UNLOAD_DELAY</span></code>, in milliseconds.</p>
</div>
<div class="section" id="perceived-performance-optimizations">
<h2>Perceived performance optimizations<a class="headerlink" href="#perceived-performance-optimizations" title="Permalink to this headline">¶</a></h2>
<p>We use a few tricks and optimizations to help improve the perceived performance of tab switches.</p>
<ol class="arabic simple">
<li><p>Sometimes users switch between the same tabs quickly. We want to optimize for this case by not releasing the layers for tabs until some time has gone by. That way, quick switching just resolves in a re-composite in the compositor, as opposed to a full re-paint and re-upload of the layers from a remote tab’s content process.</p></li>
<li><p>When a tab hasn’t ever been seen before, and is still in the process of loading (right now, dubiously checked by looking for the “busy” attribute on the <code class="docutils literal notranslate"><span class="pre">&lt;xul:tab&gt;</span></code>) we show a blank content area until its layers are finally ready. The idea here is to shift perceived lag from the async tab switcher to the network by showing the blank space instead of the tab switch spinner.</p></li>
<li><p>“Warming” is a nascent optimization that will allow us to pre-emptively render and cache the layers for tabs that we think the user is likely to switch to soon. After a timeout (<code class="docutils literal notranslate"><span class="pre">browser.tabs.remote.warmup.unloadDelayMs</span></code>), “warmed” tabs that aren’t switched to have their layers unloaded and cleared from the cache.</p></li>
<li><p>On platforms that support <code class="docutils literal notranslate"><span class="pre">occlusionstatechange</span></code> events (as of this writing, only macOS) and <code class="docutils literal notranslate"><span class="pre">sizemodechange</span></code> events (Windows, macOS and Linux), we stop rendering the layers for the currently selected tab when the window is minimized or fully occluded by another window.</p></li>
</ol>
<p>5. Based on the browser.tabs.remote.tabCacheSize pref, we keep recently used tabs’
layers around to speed up tab switches by avoiding the round trip to the content
process. This uses a simple array (<code class="docutils literal notranslate"><span class="pre">_tabLayerCache</span></code>) inside tabbrowser.js, which
we examine when determining if we want to unload a tab’s layers or not. This is still
experimental as of Nightly 62.</p>
</div>
<div class="section" id="warming">
<span id="async-tab-switcher-warming"></span><h2>Warming<a class="headerlink" href="#warming" title="Permalink to this headline">¶</a></h2>
<p>Tab warming allows the browser to proactively render and upload layers to the compositor for tabs that the user is likely to switch to. The simplest example is when a user’s mouse cursor is hovering over a tab. When this occurs, the async tab switcher is told to put that tab into a warming list, and to set its state to <code class="docutils literal notranslate"><span class="pre">STATE_LOADING</span></code>, even though the user hasn’t yet clicked on it.</p>
<p>Warming a tab queues up a timer to unload background tabs (if no such timer already exists), which will clear out the warmed tab if the user doesn’t eventually click on it. The unload will occur even if the user continues to hover the tab.</p>
<p>If the user does happen to click on the warmed tab, the tab can be in either one of two states:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">STATE_LOADING</span></code></dt><dd><p>In this case, the user requested the tab switch before the layers were rendered and received by the compositor. We’ll at least have shaved off the time between warming and selection to display the tab’s contents to the user.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">STATE_LOADED</span></code></dt><dd><p>In this case, the user requested the tab switch after the layers had been rendered and received by the compositor. We can switch to the tab immediately.</p>
</dd>
</dl>
<p>Warming is controlled by the following preferences:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">browser.tabs.remote.warmup.enabled</span></code></dt><dd><p>Whether or not the warming optimization is enabled.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">browser.tabs.remote.warmup.maxTabs</span></code></dt><dd><p>The maximum number of tabs that can be warming simultaneously. If the number of warmed tabs exceeds this amount, all background tabs are unloaded (see <a class="reference internal" href="#async-tab-switcher-unloading-background"><span class="std std-ref">Unloading background tabs</span></a>).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">browser.tabs.remote.warmup.unloadDelayMs</span></code></dt><dd><p>The amount of time to wait between the first tab being warmed, and unloading all background tabs (see <a class="reference internal" href="#async-tab-switcher-unloading-background"><span class="std std-ref">Unloading background tabs</span></a>).</p>
</dd>
</dl>
</div>
<div class="section" id="logging">
<span id="async-tab-switcher-logging"></span><h2>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h2>
<p>The async tab switcher has some logging capabilities that make it easier to debug and reason about its behaviour. Setting the hidden <code class="docutils literal notranslate"><span class="pre">browser.tabs.remote.logSwitchTiming</span></code> pref to true will put logging into the Browser Console.</p>
<p>Alternatively, setting the <code class="docutils literal notranslate"><span class="pre">useDumpForLogging</span></code> property to true within the source code of the tab switcher will dump those logs to stdout.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../touchbar/index.html" class="btn btn-neutral float-right" title="Touch Bar" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="tabbrowser" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>