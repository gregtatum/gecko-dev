

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>A primer on macOS SDKs &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Code quality" href="../../code-quality/index.html" />
    <link rel="prev" title="Using macOS APIs" href="macos-apis.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Firefox on macOS</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="macos-apis.html">Using macOS APIs</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">A primer on macOS SDKs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#supported-sdks">Supported SDKs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#obtaining-sdks">Obtaining SDKs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#effects-of-the-sdk-version">Effects of the SDK version</a></li>
<li class="toctree-l3"><a class="reference internal" href="#runtime-differences-based-on-macos-sdk-version">Runtime differences based on macOS SDK version</a><ul>
<li class="toctree-l4"><a class="reference external" href="https://developer.apple.com/documentation/macos_release_notes/macos_catalina_10_15_release_notes?language=objc">macOS 10.15 release notes</a></li>
<li class="toctree-l4"><a class="reference external" href="https://developer.apple.com/documentation/macos_release_notes/macos_mojave_10_14_release_notes/appkit_release_notes_for_macos_10_14?language=objc">macOS 10.14 AppKit release notes</a></li>
<li class="toctree-l4"><a class="reference external" href="https://developer.apple.com/library/archive/releasenotes/AppKit/RN-AppKit/">macOS 10.13 AppKit release notes</a></li>
<li class="toctree-l4"><a class="reference external" href="https://developer.apple.com/library/archive/releasenotes/AppKit/RN-AppKitOlderNotes/">macOS 10.12 and older AppKit release notes</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#supporting-multiple-sdks">Supporting multiple SDKs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#overriding-sdk-dependent-runtime-behavior">Overriding SDK-dependent runtime behavior</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#how-it-works">How it works</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">Overriding SDK-dependent runtime behavior</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Firefox on macOS</a> &raquo;</li>
        
      <li>A primer on macOS SDKs</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/widget/cocoa/sdks.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="a-primer-on-macos-sdks">
<h1>A primer on macOS SDKs<a class="headerlink" href="#a-primer-on-macos-sdks" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>A macOS SDK is an on-disk directory that contains header files and meta information for macOS APIs.
Apple distributes SDKs as part of the Xcode app bundle. Each Xcode version comes with one macOS SDK,
the SDK for the most recent released version of macOS at the time of the Xcode release.
The SDK is located at <code class="docutils literal notranslate"><span class="pre">/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk</span></code>.</p>
<p>Compiling Firefox for macOS requires a macOS SDK. The build system uses the SDK from Xcode.app by
default, and you can select a different SDK using the <code class="docutils literal notranslate"><span class="pre">mozconfig</span></code> option <code class="docutils literal notranslate"><span class="pre">--with-macos-sdk</span></code>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>ac_add_options --with-macos-sdk=/Users/username/SDKs/MacOSX10.11.sdk
</pre></div>
</div>
</div>
<div class="section" id="supported-sdks">
<h2>Supported SDKs<a class="headerlink" href="#supported-sdks" title="Permalink to this headline">¶</a></h2>
<p>First off, Firefox runs on 10.9 and above. This is called the “minimum deployment target” and is
independent of the SDK version.</p>
<p>Our official Firefox builds compiled in CI (continuous integration) currently use the 10.11 SDK.
<a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1475652">Bug 1475652</a> tracks updating this SDK.</p>
<p>For local builds, all SDKs from 10.11 to 10.15 are supported. Firefox should compile successfully
with all of those SDKs, but minor differences in runtime behavior can occur.</p>
<p>However, since only the 10.11 SDK is used in CI, compiling with different SDKs breaks from time to time.
Such breakages should be <a class="reference external" href="https://bugzilla.mozilla.org/enter_bug.cgi?blocked=mach-busted&amp;bug_type=defect&amp;cc=:spohl,:mstange&amp;component=General&amp;form_name=enter_bug&amp;keywords=regression&amp;op_sys=macOS&amp;product=Firefox%20Build%20System&amp;rep_platform=All">reported in Bugzilla</a> and fixed quickly.</p>
<p>Aside: Firefox seems to be a bit of a special snowflake with its ability to build with an arbitrary SDK.
For example, at the time of this writing (June 2020),
<a class="reference external" href="https://chromium.googlesource.com/chromium/src/+/master/docs/mac_build_instructions.md#system-requirements">building Chrome requires the 10.15 SDK</a>.
Some apps even require a certain version of Xcode and only support building with the SDK of that Xcode version.</p>
<p>Why are we using such an old SDK in CI, you ask? It basically comes down to the fact that macOS
hardware is expensive, and the fact that the compilers and linkers supplied by Xcode don’t run on Linux.</p>
</div>
<div class="section" id="obtaining-sdks">
<h2>Obtaining SDKs<a class="headerlink" href="#obtaining-sdks" title="Permalink to this headline">¶</a></h2>
<p>Sometimes you need an SDK that’s different from the one in your Xcode.app, for example
to check whether your code change breaks building with other SDKs, or to verify the
runtime behavior with the SDK used for CI builds.</p>
<p>The easy but slightly questionable way to obtain an SDK is to download it from a public github repo.</p>
<p>Here’s another option:</p>
<ol class="simple">
<li><p>Have your Apple ID login details ready, and bring enough time and patience for a 5GB download.</p></li>
<li><p>Check <a class="reference external" href="https://en.wikipedia.org/wiki/Xcode#Xcode_7.0_-_10.x_(since_Free_On-Device_Development)">these tables in the Xcode wikipedia article</a>
and find an Xcode version that contains the SDK you need.</p></li>
<li><p>Look up the Xcode version number on <a class="reference external" href="https://xcodereleases.com/">xcodereleases.com</a> and click the Download link for it.</p></li>
<li><p>Log in with your Apple ID. Then the download should start.</p></li>
<li><p>Wait for the 5GB Xcode_*.xip download to finish.</p></li>
<li><p>Open the downloaded xip file. This will extract the Xcode.app bundle.</p></li>
<li><p>Inside the app bundle, the SDK is at <code class="docutils literal notranslate"><span class="pre">Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk</span></code>.</p></li>
</ol>
</div>
<div class="section" id="effects-of-the-sdk-version">
<h2>Effects of the SDK version<a class="headerlink" href="#effects-of-the-sdk-version" title="Permalink to this headline">¶</a></h2>
<p>An SDK only contains declarations of APIs. It does not contain the implementations for these APIs.</p>
<p>The implementation of an API is provided by the OS that the app runs on. It is supplied at runtime,
when your app starts up, by the dynamic linker. For example, the AppKit implementation comes
from <code class="docutils literal notranslate"><span class="pre">/System/Library/Frameworks/AppKit.framework</span></code> from the OS that the app is run on, regardless
of what SDK was used when compiling the app.</p>
<p>In other words, building with a macOS SDK of a higher version doesn’t magically make new APIs available
when running on older versions of macOS. And, conversely, building with a lower macOS SDK doesn’t limit
which APIs you can use if your app is run on a newer version of macOS, assuming you manage to convince the
compiler to accept your code.</p>
<p>The SDK used for building an app determines three things:</p>
<ol class="simple">
<li><p>Whether your code compiles at all,</p></li>
<li><p>which range of macOS versions your app can run on (available deployment targets), and</p></li>
<li><p>certain aspects of runtime behavior.</p></li>
</ol>
<p>The first is straightforward: An SDK contains header files. If you call an API that’s not declared
anywhere - neither in a header file nor in your own code - then your compiler will emit an error.
(Special case: Calling an unknown Objective-C method usually only emits a warning, not an error.)</p>
<p>The second aspect, available deployment targets, is usually not worth worrying about:
SDKs have large ranges of supported macOS deployment targets.
For example, the 10.15 SDK supports running your app on macOS versions all the way back to 10.6.
This information is written down in the SDK’s <code class="docutils literal notranslate"><span class="pre">SDKSettings.plist</span></code>.</p>
<p>The third aspect, varying runtime behavior, is perhaps the most insidious and surprising aspect, and is described
in the next section.</p>
</div>
<div class="section" id="runtime-differences-based-on-macos-sdk-version">
<h2>Runtime differences based on macOS SDK version<a class="headerlink" href="#runtime-differences-based-on-macos-sdk-version" title="Permalink to this headline">¶</a></h2>
<p>When a new version of macOS is released, existing APIs can change their behavior.
These changes are usually described in the AppKit release notes:</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference external" href="https://developer.apple.com/documentation/macos_release_notes/macos_catalina_10_15_release_notes?language=objc">macOS 10.15 release notes</a></li>
<li class="toctree-l1"><a class="reference external" href="https://developer.apple.com/documentation/macos_release_notes/macos_mojave_10_14_release_notes/appkit_release_notes_for_macos_10_14?language=objc">macOS 10.14 AppKit release notes</a></li>
<li class="toctree-l1"><a class="reference external" href="https://developer.apple.com/library/archive/releasenotes/AppKit/RN-AppKit/">macOS 10.13 AppKit release notes</a></li>
<li class="toctree-l1"><a class="reference external" href="https://developer.apple.com/library/archive/releasenotes/AppKit/RN-AppKitOlderNotes/">macOS 10.12 and older AppKit release notes</a></li>
</ul>
</div>
<p>Sometimes, these differences in behavior have the potential to break existing apps. In those instances,
Apple often provides the old (compatible) behavior until the app is re-built with the new SDK, expecting
developers to update their apps so that they work with the new behavior, at the same time as
they update to the new SDK.</p>
<p>Here’s an <a class="reference external" href="https://developer.apple.com/library/archive/releasenotes/AppKit/RN-AppKit/#10_13NSCollectionView%20Responsive%20Scrolling">example from the 10.13 release notes</a>:</p>
<blockquote>
<div><p>Responsive Scrolling in NSCollectionViews is enabled only for apps linked on or after macOS 10.13.</p>
</div></blockquote>
<p>Here, “linked on or after macOS 10.13” means “linked against the macOS 10.13 SDK or newer”.</p>
<p>Apple’s expectation is that you upgrade to the new macOS version when it is released, download a new
Xcode version when it is released, synchronize these updates across the machines of all developers
that work on your app, use the SDK in the newest Xcode to compile your app, and make changes to your
app to be compatible with any behavior changes whenever you update Xcode.
This expectation does not always match reality. It definitely doesn’t match what we’re doing with Firefox.</p>
<p>For Firefox, SDK-dependent compatibility behaviors mean that developers who build Firefox locally
can see different runtime behavior than the users of our CI builds, if they use a different SDK than
the SDK used in CI.
That is, unless we change the Firefox code so that it has the same behavior regardless of SDK version.
Often this can be achieved by using APIs in a way that’s more in line with the API’s recommended use.</p>
<p>For example, we’ve had cases of
<a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1273106">broken placeholder text in search fields</a>,
<a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=941325">missing</a> or <a class="reference external" href="https://searchfox.org/mozilla-central/rev/9ad88f80aeedcd3cd7d7f63be07f577861727054/widget/cocoa/nsNativeThemeCocoa.mm#149-169">double-drawn focus rings</a>,
<a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1516437">a startup crash</a>,
<a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1494022">fully black windows</a>,
<a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1576113#c4">fully gray windows</a>,
<a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1475694">broken vibrancy</a>, and
<a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1578917">broken colors in dark mode</a>.</p>
<p>In most of these cases, the breakage was either very minor, or it was caused by Firefox doing things
that were explicitly discouraged, like creating unexpected NSView hierarchies, or relying on unspecified
implementation details. (With one exception: In 10.14, HiDPI-aware <code class="docutils literal notranslate"><span class="pre">NSOpenGLContext</span></code> rendering in
layer-backed windows simply broke.)</p>
<p>And in all of these cases, it was the SDK-dependent compatibility behavior that protected our users from being
exposed to the breakage. Our CI builds continued to work because they were built with an older SDK.</p>
<p>We have addressed all known cases of breakage when building Firefox with newer SDKs.
I am not aware of any current instances of this problem as of this writing (June 2020).</p>
<p>For more information about how these compatibility tricks work,
read the <a class="reference external" href="#overriding-sdk-dependent-runtime-behavior">Overriding SDK-dependent runtime behavior</a> section.</p>
</div>
<div class="section" id="supporting-multiple-sdks">
<h2>Supporting multiple SDKs<a class="headerlink" href="#supporting-multiple-sdks" title="Permalink to this headline">¶</a></h2>
<p>As described under <a class="reference external" href="#supported-sdks">Supported SDKs</a>, Firefox can be built with a wide variety of SDK versions.</p>
<p>This ability comes at the cost of some manual labor; it requires some well-placed <code class="docutils literal notranslate"><span class="pre">#ifdefs</span></code> and
copying of header definitions.</p>
<p>Every SDK defines the macro <code class="docutils literal notranslate"><span class="pre">MAC_OS_X_VERSION_MAX_ALLOWED</span></code> with a value that matches the SDK version,
in the SDK’s <code class="docutils literal notranslate"><span class="pre">AvailabilityMacros.h</span></code> header. This header also defines version constants like <code class="docutils literal notranslate"><span class="pre">MAC_OS_X_VERSION_10_12</span></code>.
For example, I have a version of the 10.12 SDK which contains the line</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#define MAC_OS_X_VERSION_MAX_ALLOWED MAC_OS_X_VERSION_10_12_4</span>
</pre></div>
</div>
<p>The name <code class="docutils literal notranslate"><span class="pre">MAC_OS_X_VERSION_MAX_ALLOWED</span></code> is rather misleading; a better name would be
<code class="docutils literal notranslate"><span class="pre">MAC_OS_X_VERSION_MAX_KNOWN_BY_SDK</span></code>. Compiling with an old SDK <em>does not</em> prevent apps from running
on newer versions of macOS.</p>
<p>With the help of the <code class="docutils literal notranslate"><span class="pre">MAC_OS_X_VERSION_MAX_ALLOWED</span></code> macro, we can make our code adapt to the SDK that’s
being used. Here’s <a class="reference external" href="https://searchfox.org/mozilla-central/rev/9ad88f80aeedcd3cd7d7f63be07f577861727054/toolkit/xre/MacApplicationDelegate.mm#345-351">an example</a> where the 10.14 SDK changed the signature of
<a class="reference external" href="https://developer.apple.com/documentation/appkit/nsapplicationdelegate/1428471-application?language=objc">an <code class="docutils literal notranslate"><span class="pre">NSApplicationDelegate</span></code> method</a>:</p>
<div class="highlight-objc++ notranslate"><div class="highlight"><pre><span></span><span class="p">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">application:</span><span class="p">(</span><span class="n">NSApplication</span><span class="o">*</span><span class="p">)</span><span class="nv">application</span>
    <span class="nf">continueUserActivity:</span><span class="p">(</span><span class="bp">NSUserActivity</span><span class="o">*</span><span class="p">)</span><span class="nv">userActivity</span>
<span class="cp">#if defined(MAC_OS_X_VERSION_10_14) &amp;&amp; MAC_OS_X_VERSION_MAX_ALLOWED &gt;= MAC_OS_X_VERSION_10_14</span>
      <span class="nf">restorationHandler:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="bp">NSArray</span><span class="o">&lt;</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">NSUserActivityRestoring</span><span class="o">&gt;&gt;*</span><span class="p">))</span><span class="nv">restorationHandler</span> <span class="p">{</span>
<span class="cp">#else</span>
      <span class="nl">restorationHandler</span><span class="p">:(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="bp">NSArray</span><span class="o">*</span><span class="p">))</span><span class="n">restorationHandler</span> <span class="p">{</span>
<span class="cp">#endif</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We can also use this macro to supply missing API definitions in such a way that
they don’t conflict with the definitions from the SDK.
This is described in the “Using macOS APIs” document, under <a class="reference external" href="./macos-apis.html#using-new-apis-with-old-sdks">Using new APIs with old SDKs</a>.</p>
</div>
<div class="section" id="overriding-sdk-dependent-runtime-behavior">
<h2>Overriding SDK-dependent runtime behavior<a class="headerlink" href="#overriding-sdk-dependent-runtime-behavior" title="Permalink to this headline">¶</a></h2>
<p>This section contains some more details on the compatibility tricks that cause different runtime
behavior dependent on the SDK, as described in
<a class="reference external" href="#runtime-differences-based-on-macos-sdk-version">Runtime differences based on macOS SDK version</a>.</p>
<div class="section" id="how-it-works">
<h3>How it works<a class="headerlink" href="#how-it-works" title="Permalink to this headline">¶</a></h3>
<p>AppKit is the one system framework I know of that employs these tricks. Let’s explore how AppKit makes this work,
by going back to the <a class="reference external" href="https://developer.apple.com/library/archive/releasenotes/AppKit/RN-AppKit/#10_13NSCollectionView%20Responsive%20Scrolling">NSCollectionView example</a> from above:</p>
<blockquote>
<div><p>Responsive Scrolling in NSCollectionViews is enabled only for apps linked on or after macOS 10.13.</p>
</div></blockquote>
<p>For each of these SDK-dependent behavior differences, both the old and the new behavior are implemented
in the version of AppKit that ships with the new macOS version.
At runtime, AppKit selects one of the behaviors based on the SDK version, with a call to
<code class="docutils literal notranslate"><span class="pre">_CFExecutableLinkedOnOrAfter()</span></code>. This call checks the SDK version of the main executable of the
process that’s running AppKit code; in our case that’s the <code class="docutils literal notranslate"><span class="pre">firefox</span></code> or <code class="docutils literal notranslate"><span class="pre">plugin-container</span></code> executable.
The SDK version is stored in the mach-o headers of the executable by the linker.</p>
<p>One interesting design aspect of AppKit’s compatibility tricks is the fact that most of these behavior differences
can be toggled with a “user default” preference.
For example, the “responsive scrolling in NSCollectionViews” behavior change can be controlled with
a user default with the name “NSCollectionViewPrefetchingEnabled”.
The SDK check only happens if “NSCollectionViewPrefetchingEnabled” is not set to either YES or NO.</p>
<p>More precisely, this example works as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-[NSCollectionView</span> <span class="pre">prepareContentInRect:]</span></code> is the function that supports both the old and the new behavior.</p></li>
<li><p>It calls <code class="docutils literal notranslate"><span class="pre">_NSGetBoolAppConfig</span></code> for the value “NSCollectionViewPrefetchingEnabled”, and also supplies a “default
value function”.</p></li>
<li><p>If the user default is not set, the default value function is called. This function has the name
<code class="docutils literal notranslate"><span class="pre">NSCollectionViewPrefetchingEnabledDefaultValueFunction</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NSCollectionViewPrefetchingEnabledDefaultValueFunction</span></code> calls <code class="docutils literal notranslate"><span class="pre">_CFExecutableLinkedOnOrAfter(13)</span></code>.</p></li>
</ul>
<p>You can find many similar toggles if you list the AppKit symbols that end in <code class="docutils literal notranslate"><span class="pre">DefaultValueFunction</span></code>,
for example by executing <code class="docutils literal notranslate"><span class="pre">nm</span> <span class="pre">/System/Library/Frameworks/AppKit.framework/AppKit</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">DefaultValueFunction</span></code>.</p>
</div>
<div class="section" id="id1">
<h3>Overriding SDK-dependent runtime behavior<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>You can set these preferences programmatically, in a way that <code class="docutils literal notranslate"><span class="pre">_NSGetBoolAppConfig()</span></code> can pick them up,
for example with <a class="reference external" href="https://developer.apple.com/documentation/foundation/nsuserdefaults/1417065-registerdefaults?language=objc"><code class="docutils literal notranslate"><span class="pre">registerDefaults</span></code></a>
or like this:</p>
<div class="highlight-objc++ notranslate"><div class="highlight"><pre><span></span><span class="p">[[</span><span class="bp">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">]</span> <span class="nl">setBool</span><span class="p">:</span><span class="nb">YES</span> <span class="nl">forKey</span><span class="p">:</span><span class="s">@&quot;NSViewAllowsRootLayerBacking&quot;</span><span class="p">];</span>
</pre></div>
</div>
<p>The AppKit release notes mention this ability but ask for it to only be used for debugging purposes:</p>
<blockquote>
<div><p>In some cases, we provide defaults (preferences) settings which can be used to get the old or new behavior,
independent of what system an application was built against. Often these preferences are provided for
debugging purposes only; in some cases the preferences can be used to globally modify the behavior
of an application by registering the values (do it somewhere very early, with <code class="docutils literal notranslate"><span class="pre">-[NSUserDefaults</span> <span class="pre">registerDefaults:]</span></code>).</p>
</div></blockquote>
<p>It’s interesting that they mention this at all because, as far as I can tell, none of these values are documented.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../code-quality/index.html" class="btn btn-neutral float-right" title="Code quality" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="macos-apis.html" class="btn btn-neutral float-left" title="Using macOS APIs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>