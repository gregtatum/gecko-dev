

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>AsyncShutdown &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="FirstStartup" href="FirstStartup.html" />
    <link rel="prev" title="Toolkit Modules" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Toolkit</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../mozapps/extensions/addon-manager/index.html">Add-on Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../components/crashes/crash-manager/index.html">Crash Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../crashreporter/crashreporter/index.html">Crash Reporter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../components/featuregates/featuregates/index.html">Feature Gates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../search/index.html">Search Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../components/normandy/normandy/index.html">Shield Recipe Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../components/messaging-system/docs/index.html">Messaging System Schemas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../components/pictureinpicture/pictureinpicture/index.html">Picture-in-Picture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../components/prompts/prompts/index.html">Prompts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../subprocess/toolkit_modules/subprocess/index.html">Subprocess Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../components/telemetry/index.html">Telemetry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../components/glean/index.html">Firefox on Glean (FOG)</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Toolkit Modules</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">AsyncShutdown</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#barriers-expressing-shutdown-dependencies-towards-a-service">Barriers: Expressing shutdown dependencies towards a service</a></li>
<li class="toctree-l4"><a class="reference internal" href="#phases-expressing-dependencies-towards-phases-of-shutdown">Phases: Expressing dependencies towards phases of shutdown</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="FirstStartup.html">FirstStartup</a></li>
<li class="toctree-l3"><a class="reference internal" href="Region.html">Region</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../content/toolkit_widgets/index.html">Toolkit Widgets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../components/url-classifier/url-classifier/index.html">URL Classifier</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../components/extensions/webextensions/index.html">WebExtensions API Development</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Toolkit</a> &raquo;</li>
        
          <li><a href="index.html">Toolkit Modules</a> &raquo;</li>
        
      <li>AsyncShutdown</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/toolkit/modules/toolkit_modules/AsyncShutdown.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="asyncshutdown">
<span id="id1"></span><h1>AsyncShutdown<a class="headerlink" href="#asyncshutdown" title="Permalink to this headline">¶</a></h1>
<p>During shutdown of the process, subsystems are closed one after another. <code class="docutils literal notranslate"><span class="pre">AsyncShutdown</span></code> is a module dedicated to express shutdown-time dependencies between:</p>
<ul class="simple">
<li><p>services and their clients;</p></li>
<li><p>shutdown phases (e.g. profile-before-change) and their clients.</p></li>
</ul>
<div class="section" id="barriers-expressing-shutdown-dependencies-towards-a-service">
<span id="asyncshutdown-barriers"></span><h2>Barriers: Expressing shutdown dependencies towards a service<a class="headerlink" href="#barriers-expressing-shutdown-dependencies-towards-a-service" title="Permalink to this headline">¶</a></h2>
<p>Consider a service FooService. At some point during the shutdown of the process, this service needs to:</p>
<ul class="simple">
<li><p>inform its clients that it is about to shut down;</p></li>
<li><p>wait until the clients have completed their final operations based on FooService (often asynchronously);</p></li>
<li><p>only then shut itself down.</p></li>
</ul>
<p>This may be expressed as an instance of <code class="docutils literal notranslate"><span class="pre">AsyncShutdown.Barrier</span></code>. An instance of <code class="docutils literal notranslate"><span class="pre">AsyncShutdown.Barrier</span></code> provides:</p>
<ul class="simple">
<li><p>a capability <code class="docutils literal notranslate"><span class="pre">client</span></code> that may be published to clients, to let them register or unregister blockers;</p></li>
<li><p>methods for the owner of the barrier to let it consult the state of blockers and wait until all client-registered blockers have been resolved.</p></li>
</ul>
<div class="section" id="shutdown-timeouts">
<h3>Shutdown timeouts<a class="headerlink" href="#shutdown-timeouts" title="Permalink to this headline">¶</a></h3>
<p>By design, an instance of <code class="docutils literal notranslate"><span class="pre">AsyncShutdown.Barrier</span></code> will cause a crash
if it takes more than 60 seconds <cite>awake</cite> for its clients to lift or
remove their blockers (<cite>awake</cite> meaning that seconds during which the
computer is asleep or too busy to do anything are not counted). This
mechanism helps ensure that we do not leave the process in a state in
which it can neither proceed with shutdown nor be relaunched.</p>
<p>If the CrashReporter is enabled, this crash will report:</p>
<ul class="simple">
<li><p>the name of the barrier that failed;</p></li>
<li><p>for each blocker that has not been released yet:</p>
<ul>
<li><p>the name of the blocker;</p></li>
<li><p>the state of the blocker, if a state function has been provided (see <a class="reference internal" href="#asyncshutdown-barrier-state"><span class="std std-ref">Example 3: More sophisticated Barrier client</span></a>).</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="example-1-simple-barrier-client">
<h3>Example 1: Simple Barrier client<a class="headerlink" href="#example-1-simple-barrier-client" title="Permalink to this headline">¶</a></h3>
<p>The following snippet presents an example of a client of FooService that has a shutdown dependency upon FooService. In this case, the client wishes to ensure that FooService is not shutdown before some state has been reached. An example is clients that need write data asynchronously and need to ensure that they have fully written their state to disk before shutdown, even if due to some user manipulation shutdown takes place immediately.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// Some client of FooService called FooClient</span>

<span class="nx">Components</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="kr">import</span><span class="p">(</span><span class="s2">&quot;resource://gre/modules/FooService.jsm&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

<span class="c1">// FooService.shutdown is the `client` capability of a `Barrier`.</span>
<span class="c1">// See example 2 for the definition of `FooService.shutdown`</span>
<span class="nx">FooService</span><span class="p">.</span><span class="nx">shutdown</span><span class="p">.</span><span class="nx">addBlocker</span><span class="p">(</span>
  <span class="s2">&quot;FooClient: Need to make sure that we have reached some state&quot;</span><span class="p">,</span>
  <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">promiseReachedSomeState</span>
<span class="p">);</span>
<span class="c1">// promiseReachedSomeState should be an instance of Promise resolved once</span>
<span class="c1">// we have reached the expected state</span>
</pre></div>
</div>
</div>
<div class="section" id="example-2-simple-barrier-owner">
<h3>Example 2: Simple Barrier owner<a class="headerlink" href="#example-2-simple-barrier-owner" title="Permalink to this headline">¶</a></h3>
<p>The following snippet presents an example of a service FooService that
wishes to ensure that all clients have had a chance to complete any
outstanding operations before FooService shuts down.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// Module FooService</span>

<span class="nx">Components</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="kr">import</span><span class="p">(</span><span class="s2">&quot;resource://gre/modules/AsyncShutdown.jsm&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

<span class="k">this</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FooService&quot;</span><span class="p">];</span>

<span class="kd">let</span> <span class="nx">shutdown</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AsyncShutdown</span><span class="p">.</span><span class="nx">Barrier</span><span class="p">(</span><span class="s2">&quot;FooService: Waiting for clients before shutting down&quot;</span><span class="p">);</span>

<span class="c1">// Export the `client` capability, to let clients register shutdown blockers</span>
<span class="nx">FooService</span><span class="p">.</span><span class="nx">shutdown</span> <span class="o">=</span> <span class="nx">shutdown</span><span class="p">.</span><span class="nx">client</span><span class="p">;</span>

<span class="c1">// This function should be triggered at some point during shutdown, generally</span>
<span class="c1">// as a client to another Barrier or Phase. Triggering this function is not covered</span>
<span class="c1">// in this snippet.</span>
<span class="kd">let</span> <span class="nx">onshutdown</span> <span class="o">=</span> <span class="nx">async</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Wait for all registered clients to have lifted the barrier</span>
  <span class="nx">await</span> <span class="nx">shutdown</span><span class="p">.</span><span class="nx">wait</span><span class="p">();</span>

  <span class="c1">// Now deactivate FooService itself.</span>
  <span class="c1">// ...</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Frequently, a service that owns a <code class="docutils literal notranslate"><span class="pre">AsyncShutdown.Barrier</span></code> is itself a client of another Barrier.</p>
</div>
<div class="section" id="example-3-more-sophisticated-barrier-client">
<span id="asyncshutdown-barrier-state"></span><h3>Example 3: More sophisticated Barrier client<a class="headerlink" href="#example-3-more-sophisticated-barrier-client" title="Permalink to this headline">¶</a></h3>
<p>The following snippet presents FooClient2, a more sophisticated client of FooService that needs to perform a number of operations during shutdown but before the shutdown of FooService. Also, given that this client is more sophisticated, we provide a function returning the state of FooClient2 during shutdown. If for some reason FooClient2’s blocker is never lifted, this state can be reported as part of a crash report.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// Some client of FooService called FooClient2</span>

<span class="nx">Components</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="kr">import</span><span class="p">(</span><span class="s2">&quot;resource://gre/modules/FooService.jsm&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

<span class="nx">FooService</span><span class="p">.</span><span class="nx">shutdown</span><span class="p">.</span><span class="nx">addBlocker</span><span class="p">(</span>
  <span class="s2">&quot;FooClient2: Collecting data, writing it to disk and shutting down&quot;</span><span class="p">,</span>
  <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">Blocker</span><span class="p">.</span><span class="nx">wait</span><span class="p">(),</span>
  <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">Blocker</span><span class="p">.</span><span class="nx">state</span>
<span class="p">);</span>

<span class="kd">let</span> <span class="nx">Blocker</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// This field contains information on the status of the blocker.</span>
  <span class="c1">// It can be any JSON serializable object.</span>
  <span class="nx">state</span><span class="o">:</span> <span class="s2">&quot;Not started&quot;</span><span class="p">,</span>

  <span class="nx">async</span> <span class="nx">wait</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// This method is called once FooService starts informing its clients that</span>
    <span class="c1">// FooService wishes to shut down.</span>

    <span class="c1">// Update the state as we go. If the Barrier is used in conjunction with</span>
    <span class="c1">// a Phase, this state will be reported as part of a crash report if FooClient fails</span>
    <span class="c1">// to shutdown properly.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="s2">&quot;Starting&quot;</span><span class="p">;</span>

    <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">collectSomeData</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="s2">&quot;Data collection complete&quot;</span><span class="p">;</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">await</span> <span class="nx">writeSomeDataToDisk</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="s2">&quot;Data successfully written to disk&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="s2">&quot;Writing data to disk failed, proceeding with shutdown: &quot;</span> <span class="o">+</span> <span class="nx">ex</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">await</span> <span class="nx">FooService</span><span class="p">.</span><span class="nx">oneLastCall</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="s2">&quot;Ready&quot;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="example-4-a-service-with-both-internal-and-external-dependencies">
<h3>Example 4: A service with both internal and external dependencies<a class="headerlink" href="#example-4-a-service-with-both-internal-and-external-dependencies" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// Module FooService2</span>

<span class="nx">Components</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="kr">import</span><span class="p">(</span><span class="s2">&quot;resource://gre/modules/AsyncShutdown.jsm&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
<span class="nx">Components</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="kr">import</span><span class="p">(</span><span class="s2">&quot;resource://gre/modules/Promise.jsm&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

<span class="k">this</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FooService2&quot;</span><span class="p">];</span>

<span class="kd">let</span> <span class="nx">shutdown</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AsyncShutdown</span><span class="p">.</span><span class="nx">Barrier</span><span class="p">(</span><span class="s2">&quot;FooService2: Waiting for clients before shutting down&quot;</span><span class="p">);</span>

<span class="c1">// Export the `client` capability, to let clients register shutdown blockers</span>
<span class="nx">FooService2</span><span class="p">.</span><span class="nx">shutdown</span> <span class="o">=</span> <span class="nx">shutdown</span><span class="p">.</span><span class="nx">client</span><span class="p">;</span>

<span class="c1">// A second barrier, used to avoid shutting down while any connections are open.</span>
<span class="kd">let</span> <span class="nx">connections</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AsyncShutdown</span><span class="p">.</span><span class="nx">Barrier</span><span class="p">(</span><span class="s2">&quot;FooService2: Waiting for all FooConnections to be closed before shutting down&quot;</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">isClosed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

<span class="nx">FooService2</span><span class="p">.</span><span class="nx">openFooConnection</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isClosed</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;FooService2 is closed&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
  <span class="nx">connections</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">addBlocker</span><span class="p">(</span><span class="s2">&quot;FooService2: Waiting for connection &quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot; to close&quot;</span><span class="p">,</span>  <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">);</span>

  <span class="c1">// ...</span>


  <span class="k">return</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="c1">// Some FooConnection object. Presumably, it will have additional methods.</span>
    <span class="c1">// ...</span>
    <span class="nx">close</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// ...</span>
      <span class="c1">// Perform any operation necessary for closing</span>
      <span class="c1">// ...</span>

      <span class="c1">// Don&#39;t hoard blockers.</span>
      <span class="nx">connections</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">removeBlocker</span><span class="p">(</span><span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">);</span>

      <span class="c1">// The barrier MUST be lifted, even if removeBlocker has been called.</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">};</span>


<span class="c1">// This function should be triggered at some point during shutdown, generally</span>
<span class="c1">// as a client to another Barrier. Triggering this function is not covered</span>
<span class="c1">// in this snippet.</span>
<span class="kd">let</span> <span class="nx">onshutdown</span> <span class="o">=</span> <span class="nx">async</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Wait for all registered clients to have lifted the barrier.</span>
  <span class="c1">// These clients may open instances of FooConnection if they need to.</span>
  <span class="nx">await</span> <span class="nx">shutdown</span><span class="p">.</span><span class="nx">wait</span><span class="p">();</span>

  <span class="c1">// Now stop accepting any other connection request.</span>
  <span class="nx">isClosed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c1">// Wait for all instances of FooConnection to be closed.</span>
  <span class="nx">await</span> <span class="nx">connections</span><span class="p">.</span><span class="nx">wait</span><span class="p">();</span>

  <span class="c1">// Now finish shutting down FooService2</span>
  <span class="c1">// ...</span>
<span class="p">});</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="phases-expressing-dependencies-towards-phases-of-shutdown">
<span id="asyncshutdown-phases"></span><h2>Phases: Expressing dependencies towards phases of shutdown<a class="headerlink" href="#phases-expressing-dependencies-towards-phases-of-shutdown" title="Permalink to this headline">¶</a></h2>
<p>The shutdown of a process takes place by phase, such as:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">profileBeforeChange</span></code> (once this phase is complete, there is no guarantee that the process has access to a profile directory);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">webWorkersShutdown</span></code> (once this phase is complete, JavaScript does not have access to workers anymore);</p></li>
<li><p>…</p></li>
</ul>
<p>Much as services, phases have clients. For instance, all users of web workers MUST have finished using their web workers before the end of phase <code class="docutils literal notranslate"><span class="pre">webWorkersShutdown</span></code>.</p>
<p>Module <code class="docutils literal notranslate"><span class="pre">AsyncShutdown</span></code> provides pre-defined barriers for a set of
well-known phases. Each of the barriers provided blocks the corresponding shutdown
phase until all clients have lifted their blockers.</p>
<div class="section" id="list-of-phases">
<h3>List of phases<a class="headerlink" href="#list-of-phases" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">AsyncShutdown.profileChangeTeardown</span></code></p>
<blockquote>
<div><p>The client capability for clients wishing to block asynchronously
during observer notification “profile-change-teardown”.</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">AsyncShutdown.profileBeforeChange</span></code></p>
<blockquote>
<div><p>The client capability for clients wishing to block asynchronously
during observer notification “profile-change-teardown”. Once the
barrier is resolved, clients other than Telemetry MUST NOT access
files in the profile directory and clients MUST NOT use Telemetry
anymore.</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">AsyncShutdown.sendTelemetry</span></code></p>
<blockquote>
<div><p>The client capability for clients wishing to block asynchronously
during observer notification “profile-before-change-telemetry”.
Once the barrier is resolved, Telemetry must stop its operations.</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">AsyncShutdown.webWorkersShutdown</span></code></p>
<blockquote>
<div><p>The client capability for clients wishing to block asynchronously
during observer notification “web-workers-shutdown”. Once the phase
is complete, clients MUST NOT use web workers.</p>
</div></blockquote>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="FirstStartup.html" class="btn btn-neutral float-right" title="FirstStartup" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Toolkit Modules" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>