

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Performance scripts &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Performance scripts</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/testing/perfdocs/writing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="performance-scripts">
<h1>Performance scripts<a class="headerlink" href="#performance-scripts" title="Permalink to this headline">¶</a></h1>
<p>Performance scripts are programs that drive the browser to run a specific
benchmark (like a page load or a lower level call) and produce metrics.</p>
<p>We support two flavors right now in <cite>perftest</cite> (but it’s easy to add
new ones):</p>
<ul class="simple">
<li><p><strong>xpcshell</strong> a classical xpcshell test, turned into a performance test</p></li>
<li><p><strong>browsertime</strong> a browsertime script, which runs a full browser and controls
it via a Selenium client.</p></li>
</ul>
<p>In order to qualify as performance tests, both flavors require metadata.</p>
<p>For our supported flavors that are both Javascript modules, those are
provided in a <cite>perfMetadata</cite> mapping variable in the module, or in
the <cite>module.exports</cite> variable when using Node.</p>
<p>This is the list of fields:</p>
<ul class="simple">
<li><p><strong>owner</strong>: name of the owner (person or team) [mandatory]</p></li>
<li><p><strong>author</strong>: author of the test</p></li>
<li><p><strong>name</strong>: name of the test [mandatory]</p></li>
<li><p><strong>description</strong>: short description [mandatory]</p></li>
<li><p><strong>longDescription</strong>: longer description</p></li>
<li><p><strong>options</strong>: options used to run the test</p></li>
<li><p><strong>supportedBrowsers</strong>: list of supported browsers (or “Any”)</p></li>
<li><p><strong>supportedPlatforms</strong>: list of supported platforms (or “Any”)</p></li>
<li><p><strong>tags</strong> a list of tags that describe the test</p></li>
</ul>
<p>Tests are registered using tests manifests and the <strong>PERFTESTS_MANIFESTS</strong>
variable in <cite>moz.build</cite> files - it’s good practice to name this file
<cite>perftest.ini</cite>.</p>
<p>Example of such a file: <a class="reference external" href="https://searchfox.org/mozilla-central/source/testing/performance/perftest.ini">https://searchfox.org/mozilla-central/source/testing/performance/perftest.ini</a></p>
<div class="section" id="xpcshell">
<h2>xpcshell<a class="headerlink" href="#xpcshell" title="Permalink to this headline">¶</a></h2>
<p><cite>xpcshell</cite> tests are plain xpcshell tests, with two more things:</p>
<ul class="simple">
<li><p>the <cite>perfMetadata</cite> variable, as described in the previous section</p></li>
<li><p>calls to <cite>info(“perfMetrics”, …)</cite> to send metrics to the <cite>perftest</cite> framework.</p></li>
</ul>
<p>Here’s an example of such a metrics call:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute some speed metrics</span>
<span class="n">let</span> <span class="n">speed</span> <span class="o">=</span> <span class="mi">12345</span><span class="p">;</span>
<span class="n">info</span><span class="p">(</span><span class="s2">&quot;perfMetrics&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">speed</span> <span class="p">});</span>
</pre></div>
</div>
</div>
<div class="section" id="browsertime">
<h2>Browsertime<a class="headerlink" href="#browsertime" title="Permalink to this headline">¶</a></h2>
<p>With the browsertime layer, performance scenarios are Node modules that
implement at least one async function that will be called by the framework once
the browser has started. The function gets a webdriver session and can interact
with the browser.</p>
<p>You can write complex, interactive scenarios to simulate a user journey,
and collect various metrics.</p>
<p>Full documentation is available <a class="reference external" href="https://www.sitespeed.io/documentation/sitespeed.io/scripting/">here</a></p>
<p>The mozilla-central repository has a few performance tests script in
<cite>testing/performance</cite> and more should be added in components in the future.</p>
<p>By convention, a performance test is prefixed with <strong>perftest_</strong> to be
recognized by the <cite>perftest</cite> command.</p>
<p>A performance test implements at least one async function published in node’s
<cite>module.exports</cite> as <cite>test</cite>. The function receives two objects:</p>
<ul class="simple">
<li><p><strong>context</strong>, which contains:</p>
<ul>
<li><p><strong>options</strong> - All the options sent from the CLI to Browsertime</p></li>
<li><p><strong>log</strong> - an instance to the log system so you can log from your navigation script</p></li>
<li><p><strong>index</strong> - the index of the runs, so you can keep track of which run you are currently on</p></li>
<li><p><strong>storageManager</strong> - The Browsertime storage manager that can help you read/store files to disk</p></li>
<li><p><strong>selenium.webdriver</strong> - The Selenium WebDriver public API object</p></li>
<li><p><strong>selenium.driver</strong> - The instantiated version of the WebDriver driving the current version of the browser</p></li>
</ul>
</li>
<li><p><strong>command</strong> provides API to interact with the browser. It’s a wrapper
around the selenium client <a class="reference external" href="https://www.sitespeed.io/documentation/sitespeed.io/scripting/#commands">Full documentation here</a></p></li>
</ul>
<p>Below is an example of a test that visits the BBC homepage and clicks on a link.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">setUp</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&quot;setUp example!&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">test</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">commands</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">await</span> <span class="nx">commands</span><span class="p">.</span><span class="nx">navigate</span><span class="p">(</span><span class="s2">&quot;https://www.bbc.com/&quot;</span><span class="p">);</span>

    <span class="c1">// Wait for browser to settle</span>
    <span class="nx">await</span> <span class="nx">commands</span><span class="p">.</span><span class="nx">wait</span><span class="p">.</span><span class="nx">byTime</span><span class="p">(</span><span class="mf">10000</span><span class="p">);</span>

    <span class="c1">// Start the measurement</span>
    <span class="nx">await</span> <span class="nx">commands</span><span class="p">.</span><span class="nx">measure</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="s2">&quot;pageload&quot;</span><span class="p">);</span>

    <span class="c1">// Click on the link and wait for page complete check to finish.</span>
    <span class="nx">await</span> <span class="nx">commands</span><span class="p">.</span><span class="nx">click</span><span class="p">.</span><span class="nx">byClassNameAndWait</span><span class="p">(</span><span class="s2">&quot;block-link__overlay-link&quot;</span><span class="p">);</span>

    <span class="c1">// Stop and collect the measurement</span>
    <span class="nx">await</span> <span class="nx">commands</span><span class="p">.</span><span class="nx">measure</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">tearDown</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&quot;tearDown example!&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setUp</span><span class="p">,</span>
    <span class="nx">test</span><span class="p">,</span>
    <span class="nx">tearDown</span><span class="p">,</span>
    <span class="nx">owner</span><span class="o">:</span> <span class="s2">&quot;Performance Team&quot;</span><span class="p">,</span>
    <span class="nx">test_name</span><span class="o">:</span> <span class="s2">&quot;BBC&quot;</span><span class="p">,</span>
    <span class="nx">description</span><span class="o">:</span> <span class="s2">&quot;Measures pageload performance when clicking on a link from the bbc.com&quot;</span><span class="p">,</span>
    <span class="nx">supportedBrowsers</span><span class="o">:</span> <span class="s2">&quot;Any&quot;</span><span class="p">,</span>
    <span class="nx">supportePlatforms</span><span class="o">:</span> <span class="s2">&quot;Any&quot;</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Besides the <cite>test</cite> function, scripts can implement a <cite>setUp</cite> and a <cite>tearDown</cite> function to run
some code before and after the test. Those functions will be called just once, whereas
the <cite>test</cite> function might be called several times (through the <cite>iterations</cite> option)</p>
</div>
<div class="section" id="hooks">
<h2>Hooks<a class="headerlink" href="#hooks" title="Permalink to this headline">¶</a></h2>
<p>A Python module can be used to run functions during a run lifecycle. Available hooks are:</p>
<ul class="simple">
<li><p><strong>before_iterations(args)</strong> runs before everything is started. Gets the args, which
can be changed. The <strong>args</strong> argument also contains a <strong>virtualenv</strong> variable that
can be used for installing Python packages (e.g. through <a class="reference external" href="https://searchfox.org/mozilla-central/source/python/mozperftest/mozperftest/utils.py#115-144">install_package</a>).</p></li>
<li><p><strong>before_runs(env)</strong> runs before the test is launched. Can be used to
change the running environment.</p></li>
<li><p><strong>after_runs(env)</strong> runs after the test is done.</p></li>
<li><p><strong>on_exception(env, layer, exception)</strong> called on any exception. Provides the
layer in which the exception occured, and the exception. If the hook returns <cite>True</cite>
the exception is ignored and the test resumes. If the hook returns <cite>False</cite>, the
exception is ignored and the test ends immediatly. The hook can also re-raise the
exception or raise its own exception.</p></li>
</ul>
<p>In the example below, the <cite>before_runs</cite> hook is setting the options on the fly,
so users don’t have to provide them in the command line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mozperftest.browser.browsertime</span> <span class="kn">import</span> <span class="n">add_options</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;&#39;https://www.example.com&#39;&quot;</span>

<span class="n">common_options</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;processStartTime&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s2">&quot;firefox.disableBrowsertimeExtension&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s2">&quot;firefox.android.intentArgument&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;-a&#39;&quot;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s2">&quot;firefox.android.intentArgument&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;android.intent.action.VIEW&#39;&quot;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s2">&quot;firefox.android.intentArgument&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;-d&#39;&quot;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s2">&quot;firefox.android.intentArgument&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">before_runs</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="n">add_options</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">common_options</span><span class="p">)</span>
</pre></div>
</div>
<p>To use this hook module, it can be passed to the <cite>–hooks</cite> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  ./mach perftest --hooks hooks.py perftest_example.js
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>