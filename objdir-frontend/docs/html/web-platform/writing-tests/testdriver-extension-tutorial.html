

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Testdriver extension tutorial &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="IDL Tests (idlharness.js)" href="idlharness.html" />
    <link rel="prev" title="testdriver.js Automation" href="testdriver.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">web-platform-tests documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#video-introduction-transcript">Video Introduction (transcript)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#github">GitHub</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#table-of-contents">Table of Contents</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../test-suite-design.html">Test Suite Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="../intro-video-transcript.html">“Introduction to WPT” video transcript</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running-tests/index.html">Running Tests</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Writing Tests</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="index.html#test-types">Test Types</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#submitting-tests">Submitting Tests</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="index.html#table-of-contents">Table of Contents</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reviewing-tests/index.html">Reviewing Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../admin/index.html">Project Administration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">web-platform-tests documentation</a> &raquo;</li>
        
          <li><a href="index.html">Writing Tests</a> &raquo;</li>
        
          <li><a href="testharness.html">JavaScript Tests (testharness.js)</a> &raquo;</li>
        
      <li>Testdriver extension tutorial</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/web-platform/writing-tests/testdriver-extension-tutorial.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="testdriver-extension-tutorial">
<h1>Testdriver extension tutorial<a class="headerlink" href="#testdriver-extension-tutorial" title="Permalink to this headline">¶</a></h1>
<p>Adding new commands to testdriver.js</p>
<div class="section" id="assumptions">
<h2>Assumptions<a class="headerlink" href="#assumptions" title="Permalink to this headline">¶</a></h2>
<p>We assume the following in this writeup:</p>
<ul class="simple">
<li><p>You know what web-platform-tests is and you have a working checkout and can run tests</p></li>
<li><p>You know what WebDriver is</p></li>
<li><p>Familiarity with JavaScript and Python</p></li>
</ul>
</div>
<div class="section" id="introduction">
<h2>Introduction!<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Let’s implement window resizing. We can do this via the <a class="reference external" href="https://w3c.github.io/webdriver/#set-window-rect">Set Window Rect</a> command in WebDriver.</p>
<p>First, we need to think of what the API will look like a little. We will be using WebDriver and Marionette for this, so we can look and see that they take in x, y coordinates, width and height integers.</p>
<p>The first part of this will be browser agnostic, but later we will need to implement a specific layer for each browser (here we will do Firefox and Chrome).</p>
</div>
<div class="section" id="code">
<h2>Code!<a class="headerlink" href="#code" title="Permalink to this headline">¶</a></h2>
<div class="section" id="resources-testdriver-js">
<h3><a class="reference external" href="https://github.com/web-platform-tests/wpt/blob/master/resources/testdriver.js">resources/testdriver.js</a><a class="headerlink" href="#resources-testdriver-js" title="Permalink to this headline">¶</a></h3>
<p>This is the main entry point the tests get. Here we need to add a function to the <code class="docutils literal notranslate"><span class="pre">test_driver</span></code> object that will call the <code class="docutils literal notranslate"><span class="pre">test_driver_internal</span></code> object.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nb">window</span><span class="p">.</span><span class="nx">test_driver</span> <span class="o">=</span> <span class="p">{</span>

    <span class="c1">// other commands...</span>

    <span class="cm">/**</span>
<span class="cm">    * Triggers browser window to be resized and relocated</span>
<span class="cm">    *</span>
<span class="cm">    * This matches the behaviour of the {@link</span>
<span class="cm">    * https://w3c.github.io/webdriver/#set-window-rect|WebDriver</span>
<span class="cm">    * Set Window Rect command}.</span>
<span class="cm">    *</span>
<span class="cm">    * @param {Integer} x - The x coordinate of the top left of the window</span>
<span class="cm">    * @param {Integer} y - The y coordinate of the top left of the window</span>
<span class="cm">    * @param {Integer} width - The width of the window</span>
<span class="cm">    * @param {Integer} height - The width of the window</span>
<span class="cm">    * @returns {Promise} fulfilled after window rect is set occurs, or rejected in</span>
<span class="cm">    *                    the cases the WebDriver command errors</span>
<span class="cm">    */</span>
    <span class="nx">set_window_rect</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">test_driver_internal</span><span class="p">.</span><span class="nx">set_element_rect</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>In the same file, lets add to the internal object. ( do we need to do this?) (make sure to do this if the internal call has different arguments than the external call, especially if it calls multiple internal calls)</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nb">window</span><span class="p">.</span><span class="nx">test_driver_internal</span> <span class="o">=</span> <span class="p">{</span>

    <span class="c1">// other commands...</span>

    <span class="cm">/**</span>
<span class="cm">     * Triggers browser window to be resized and relocated</span>
<span class="cm">     *</span>
<span class="cm">     * This matches the behaviour of the {@link</span>
<span class="cm">     * https://w3c.github.io/webdriver/#set-window-rect|WebDriver</span>
<span class="cm">     * Set Window Rect command}.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {Integer} x - The x coordinate of the top left of the window</span>
<span class="cm">     * @param {Integer} y - The x coordinate of the top left of the window</span>
<span class="cm">     * @param {Integer} width - The width of the window</span>
<span class="cm">     * @param {Integer} height - The height of the window</span>
<span class="cm">     * @returns {Promise} fulfilled after window rect is set occurs, or rejected in</span>
<span class="cm">     *                    the cases the WebDriver command errors</span>
<span class="cm">     */</span>
    <span class="nx">set_window_rect</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;unimplemented&quot;</span><span class="p">))</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>We will leave this unimplemented and override it in another file. Lets do that now!</p>
</div>
<div class="section" id="wptrunner-wptrunner-testdriver-extra-js">
<h3><a class="reference external" href="https://github.com/web-platform-tests/wpt/blob/master/tools/wptrunner/wptrunner/testdriver-extra.js">wptrunner/wptrunner/testdriver-extra.js</a><a class="headerlink" href="#wptrunner-wptrunner-testdriver-extra-js" title="Permalink to this headline">¶</a></h3>
<p>This will be the default function called when invoking the test driver commands (sometimes it is overridden by testdriver-vendor.js, but this is outside the scope of this writeup).</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nb">window</span><span class="p">.</span><span class="nx">test_driver_internal</span><span class="p">.</span><span class="nx">set_element_rect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">pending_promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">pending_resolve</span> <span class="o">=</span> <span class="nx">resolve</span><span class="p">;</span>
        <span class="nx">pending_reject</span> <span class="o">=</span> <span class="nx">reject</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">opener</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="o">:</span> <span class="s2">&quot;set_window_rect&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="o">:</span> <span class="nx">x</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="o">:</span> <span class="nx">y</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="o">:</span> <span class="nx">width</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="o">:</span> <span class="nx">height</span><span class="p">},</span> <span class="s2">&quot;*&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">pending_promise</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The main thing here is the <code class="docutils literal notranslate"><span class="pre">postMessage</span></code> argument. The first argument is an object with properties</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">type</span></code>: this always has to be the string <code class="docutils literal notranslate"><span class="pre">&quot;action&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">action</span></code>: the name of the testdriver command this defines (in this case, <code class="docutils literal notranslate"><span class="pre">set_window_rect</span></code>)</p></li>
<li><p>any other things you want to pass to the next point of execution (in this case, the x, y coordinates and the width and height)</p></li>
</ul>
<!-- The pending promise needs to be there as it is resolved when the window receives a completion message from the executor. --><p>The pending promise is out of scope of this function and is resolved when the window receives a completion message from the executor.
This happens here in the same file:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span>    <span class="kd">let</span> <span class="nx">pending_resolve</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">pending_reject</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span> <span class="o">!==</span> <span class="s2">&quot;object&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s2">&quot;testdriver-complete&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">result</span>
            <span class="nx">pending_resolve</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">pending_reject</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>
</pre></div>
</div>
<p>One limitation this introduces is that only one testdriver call can be made at one time since the <code class="docutils literal notranslate"><span class="pre">pending_resolve</span></code> and <code class="docutils literal notranslate"><span class="pre">pending_reject</span></code> variables are in an outer scope.</p>
<p>Next, this is passed to the executor and protocol in wptrunner. Time to switch to Python!</p>
<p><a class="reference external" href="https://github.com/web-platform-tests/wpt/blob/master/tools/wptrunner/wptrunner/executors/protocol.py">tools/wptrunner/wptrunner/executors/protocol.py</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SetWindowRectProtocolPart</span><span class="p">(</span><span class="n">ProtocolPart</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Protocol part for resizing and changing location of window&quot;&quot;&quot;</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ABCMeta</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;set_window_rect&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_window_rect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change the window rect</span>

<span class="sd">        :param x: The x coordinate of the top left of the window.</span>
<span class="sd">        :param y: The y coordinate of the top left of the window.</span>
<span class="sd">        :param width: The width of the window.</span>
<span class="sd">        :param height: The height of the window.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>Next we change the base executor.</p>
<p><a class="reference external" href="https://github.com/web-platform-tests/wpt/blob/master/tools/wptrunner/wptrunner/executors/base.py">tools/wptrunner/wptrunner/executors/base.py</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CallbackHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handle callbacks from testdriver-using tests.</span>

<span class="sd">    The default implementation here makes sense for things that are roughly like</span>
<span class="sd">    WebDriver. Things that are more different to WebDriver may need to create a</span>
<span class="sd">    fully custom implementation.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">test_window</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_window</span> <span class="o">=</span> <span class="n">test_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_action</span><span class="p">,</span>
            <span class="s2">&quot;complete&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_complete</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;click&quot;</span><span class="p">:</span> <span class="n">ClickAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">),</span>
            <span class="s2">&quot;send_keys&quot;</span><span class="p">:</span> <span class="n">SendKeysAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">),</span>
            <span class="p">{</span><span class="n">other</span> <span class="n">actions</span><span class="p">},</span>
            <span class="s2">&quot;set_window_rect&quot;</span><span class="p">:</span> <span class="n">SetWindowRectAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">)</span> <span class="c1"># add this!</span>
        <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SetWindowRectAction</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">],</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting window rect to be: x=</span><span class="si">%s</span><span class="s2">, y=</span><span class="si">%s</span><span class="s2">, width=</span><span class="si">%s</span><span class="s2">, height=</span><span class="si">%s</span><span class="s2">&quot;</span>
                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">set_window_rect</span><span class="o">.</span><span class="n">set_window_rect</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
</pre></div>
</div>
<p>Don’t forget to write docs in <code class="docutils literal notranslate"><span class="pre">testdriver.md</span></code>.
Now we write the browser specific implementations.</p>
</div>
<div class="section" id="chrome">
<h3>Chrome<a class="headerlink" href="#chrome" title="Permalink to this headline">¶</a></h3>
<p>We will use <a class="reference external" href="https://github.com/web-platform-tests/wpt/blob/master/tools/wptrunner/wptrunner/executors/executorwebdriver.py">executorwebdriver</a> and use the WebDriver API.</p>
<p>There isn’t too much work to do here, we just need to define a subclass of the protocol part we defined earlier.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">WebDriverSetWindowRectProtocolPart</span><span class="p">(</span><span class="n">SetWindowRectProtocolPart</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">webdriver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">webdriver</span>

    <span class="k">def</span> <span class="nf">set_window_rect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">webdriver</span><span class="o">.</span><span class="n">set_window_rect</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
</pre></div>
</div>
<p>Make sure to import the protocol part too!</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.protocol</span> <span class="kn">import</span> <span class="p">(</span><span class="n">BaseProtocolPart</span><span class="p">,</span>
                       <span class="n">TestharnessProtocolPart</span><span class="p">,</span>
                       <span class="n">Protocol</span><span class="p">,</span>
                       <span class="n">SelectorProtocolPart</span><span class="p">,</span>
                       <span class="n">ClickProtocolPart</span><span class="p">,</span>
                       <span class="n">SendKeysProtocolPart</span><span class="p">,</span>
                       <span class="p">{</span><span class="o">...</span> <span class="n">other</span> <span class="n">protocol</span> <span class="n">parts</span><span class="p">}</span>
                       <span class="n">SetWindowRectProtocolPart</span><span class="p">,</span> <span class="c1"># add this!</span>
                       <span class="n">TestDriverProtocolPart</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we have the setup method which just redefines the webdriver object at this level. The important part is the <code class="docutils literal notranslate"><span class="pre">set_window_rect</span></code> function (and it’s important it is named that since we called it that earlier). This will call the WebDriver API for <a class="reference external" href="https://w3c.github.io/webdriver/#set-window-rect">set window rect</a>.</p>
<p>Finally, we just need to tell the WebDriverProtocol to implement this part.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">WebDriverProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="n">implements</span> <span class="o">=</span> <span class="p">[</span><span class="n">WebDriverBaseProtocolPart</span><span class="p">,</span>
                  <span class="n">WebDriverTestharnessProtocolPart</span><span class="p">,</span>
                  <span class="n">WebDriverSelectorProtocolPart</span><span class="p">,</span>
                  <span class="n">WebDriverClickProtocolPart</span><span class="p">,</span>
                  <span class="n">WebDriverSendKeysProtocolPart</span><span class="p">,</span>
                  <span class="p">{</span><span class="o">...</span> <span class="n">other</span> <span class="n">protocol</span> <span class="n">parts</span><span class="p">}</span>
                  <span class="n">WebDriverSetWindowRectProtocolPart</span><span class="p">,</span> <span class="c1"># add this!</span>
                  <span class="n">WebDriverTestDriverProtocolPart</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="firefox">
<h3>Firefox<a class="headerlink" href="#firefox" title="Permalink to this headline">¶</a></h3>
<p>We use the <a class="reference external" href="https://firefox-source-docs.mozilla.org/python/marionette_driver.html#marionette_driver.marionette.Marionette.set_window_rect">set window rect</a> Marionette command.</p>
<p>We will use <a class="reference external" href="https://github.com/web-platform-tests/wpt/blob/master/tools/wptrunner/wptrunner/executors/executormarionette.py">executormarionette</a> and use the Marionette Python API.</p>
<p>We have little actual work to do here! We just need to define a subclass of the protocol part we defined earlier.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MarionetteSetWindowRectProtocolPart</span><span class="p">(</span><span class="n">SetWindowRectProtocolPart</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marionette</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">marionette</span>

    <span class="k">def</span> <span class="nf">set_window_rect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">marionette</span><span class="o">.</span><span class="n">set_window_rect</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
</pre></div>
</div>
<p>Make sure to import the protocol part too!</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.protocol</span> <span class="kn">import</span> <span class="p">(</span><span class="n">BaseProtocolPart</span><span class="p">,</span>
                       <span class="n">TestharnessProtocolPart</span><span class="p">,</span>
                       <span class="n">Protocol</span><span class="p">,</span>
                       <span class="n">SelectorProtocolPart</span><span class="p">,</span>
                       <span class="n">ClickProtocolPart</span><span class="p">,</span>
                       <span class="n">SendKeysProtocolPart</span><span class="p">,</span>
                       <span class="p">{</span><span class="o">...</span> <span class="n">other</span> <span class="n">protocol</span> <span class="n">parts</span><span class="p">}</span>
                       <span class="n">SetWindowRectProtocolPart</span><span class="p">,</span> <span class="c1"># add this!</span>
                       <span class="n">TestDriverProtocolPart</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we have the setup method which just redefines the webdriver object at this level. The important part is the <code class="docutils literal notranslate"><span class="pre">set_window_rect</span></code> function (and it’s important it is named that since we called it that earlier). This will call the Marionette API for <a class="reference external" href="https://firefox-source-docs.mozilla.org/python/marionette_driver.html#marionette_driver.marionette.Marionette.set_window_rect">set window rect</a> (<code class="docutils literal notranslate"><span class="pre">self.marionette</span></code> is a marionette instance here).</p>
<p>Finally, we just need to tell the MarionetteProtocol to implement this part.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MarionetteProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="n">implements</span> <span class="o">=</span> <span class="p">[</span><span class="n">MarionetteBaseProtocolPart</span><span class="p">,</span>
                  <span class="n">MarionetteTestharnessProtocolPart</span><span class="p">,</span>
                  <span class="n">MarionettePrefsProtocolPart</span><span class="p">,</span>
                  <span class="n">MarionetteStorageProtocolPart</span><span class="p">,</span>
                  <span class="n">MarionetteSelectorProtocolPart</span><span class="p">,</span>
                  <span class="n">MarionetteClickProtocolPart</span><span class="p">,</span>
                  <span class="n">MarionetteSendKeysProtocolPart</span><span class="p">,</span>
                  <span class="p">{</span><span class="o">...</span> <span class="n">other</span> <span class="n">protocol</span> <span class="n">parts</span><span class="p">}</span>
                  <span class="n">MarionetteSetWindowRectProtocolPart</span><span class="p">,</span> <span class="c1"># add this</span>
                  <span class="n">MarionetteTestDriverProtocolPart</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="other-browsers">
<h3>Other Browsers<a class="headerlink" href="#other-browsers" title="Permalink to this headline">¶</a></h3>
<p>Other browsers (such as safari) may use executorselenium, or a completely new executor (such as servo). For these, you must change the executor in the same way as we did with chrome and firefox.</p>
</div>
<div class="section" id="write-an-infra-test">
<h3>Write an infra test<a class="headerlink" href="#write-an-infra-test" title="Permalink to this headline">¶</a></h3>
<p>Make sure to add a test to <code class="docutils literal notranslate"><span class="pre">infrastructure/testdriver</span></code> :)</p>
<p>Here is some template code!</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>TestDriver set window rect method<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/resources/testharness.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/resources/testharnessreport.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/resources/testdriver.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/resources/testdriver-vendor.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="nx">promise_test</span><span class="p">(</span><span class="nx">async</span> <span class="nx">t</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">await</span> <span class="nx">test_driver</span><span class="p">.</span><span class="nx">set_window_rect</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span> <span class="mf">100</span><span class="p">,</span> <span class="mf">100</span><span class="p">,</span> <span class="mf">100</span><span class="p">);</span>
  <span class="c1">// do something</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="what-about-testdriver-vendor-js">
<h3>What about testdriver-vendor.js?<a class="headerlink" href="#what-about-testdriver-vendor-js" title="Permalink to this headline">¶</a></h3>
<p>The file <a class="reference external" href="https://github.com/web-platform-tests/wpt/blob/master/resources/testdriver-vendor.js">testdriver-vendor.js</a> is the equivalent to testdriver-extra.js above, except it is
run instead of testdriver-extra.js in browser-specific test environments. For example, in <a class="reference external" href="https://cs.chromium.org/chromium/src/third_party/blink/web_tests/">Chromium web_tests</a>.</p>
</div>
<div class="section" id="what-if-i-need-to-return-a-value-from-my-testdriver-api">
<h3>What if I need to return a value from my testdriver API?<a class="headerlink" href="#what-if-i-need-to-return-a-value-from-my-testdriver-api" title="Permalink to this headline">¶</a></h3>
<p>You can return values from testdriver by just making your Action and Protocol classes use return statements. The data being returned will be serialized into JSON and passed
back to the test on the resolving promise. The test can then deserialize the JSON to access the return values. Here is an example of a theoretical GetWindowRect API:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GetWindowRectAction</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">get_window_rect</span><span class="o">.</span><span class="n">get_window_rect</span><span class="p">()</span>
</pre></div>
</div>
<p>The WebDriver command will return a <a class="reference external" href="https://w3c.github.io/webdriver/#dfn-window-rect">WindowRect object</a>, which is a dictionary with keys <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, <code class="docutils literal notranslate"><span class="pre">width</span></code>, and <code class="docutils literal notranslate"><span class="pre">height</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">WebDriverGetWindowRectProtocolPart</span><span class="p">(</span><span class="n">GetWindowRectProtocolPart</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_window_rect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">webdriver</span><span class="o">.</span><span class="n">get_window_rect</span><span class="p">()</span>
</pre></div>
</div>
<p>Then a test can access the return value as follows:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="nx">async_test</span><span class="p">(</span><span class="nx">t</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">test_driver</span><span class="p">.</span><span class="nx">get_window_rect</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">assert_equals</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="mf">0</span><span class="p">)</span>
    <span class="nx">assert_equals</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="mf">10</span><span class="p">)</span>
    <span class="nx">assert_equals</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="mf">800</span><span class="p">)</span>
    <span class="nx">assert_equals</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="mf">600</span><span class="p">)</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">done</span><span class="p">();</span>
  <span class="p">})</span>
<span class="p">});</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="idlharness.html" class="btn btn-neutral float-right" title="IDL Tests (idlharness.js)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="testdriver.html" class="btn btn-neutral float-left" title="testdriver.js Automation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>