

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>DOM Workers &amp; Storage C++ Code Style &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Layout &amp; CSS" href="../../layout/index.html" />
    <link rel="prev" title="DOM Workers &amp; Storage" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../browser/index.html">Firefox</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">DOM</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../ipc/index.html">DOM IPC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../navigation/index.html">DOM Navigation</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">DOM Workers &amp; Storage</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">DOM Workers &amp; Storage C++ Code Style</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deviations-from-the-google-c-coding-style">Deviations from the Google C++ Coding Style</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deviations-from-the-mozilla-c-coding-style">Deviations from the Mozilla C++ Coding Style</a></li>
<li class="toctree-l4"><a class="reference internal" href="#additions-to-the-google-mozilla-c-code-style">Additions to the Google/Mozilla C++ Code Style</a></li>
<li class="toctree-l4"><a class="reference internal" href="#evolution-process">Evolution Process</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">DOM</a> &raquo;</li>
        
          <li><a href="index.html">DOM Workers &amp; Storage</a> &raquo;</li>
        
      <li>DOM Workers &amp; Storage C++ Code Style</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/dom/workersAndStorage/CodeStyle.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="dom-workers-storage-c-code-style">
<h1><a class="toc-backref" href="#id3">DOM Workers &amp; Storage C++ Code Style</a><a class="headerlink" href="#dom-workers-storage-c-code-style" title="Permalink to this headline">¶</a></h1>
<p>This page describes the code style for the components maintained by the DOM Workers &amp; Storage team. They live in-tree under the ‘dom/docs/indexedDB’ directory.</p>
<p>This document is currently owned by Simon Giesecke &lt;<a class="reference external" href="mailto:sgiesecke&#37;&#52;&#48;mozilla&#46;com">sgiesecke<span>&#64;</span>mozilla<span>&#46;</span>com</a>&gt;.</p>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#dom-workers-storage-c-code-style" id="id3">DOM Workers &amp; Storage C++ Code Style</a></p>
<ul>
<li><p><a class="reference internal" href="#introduction" id="id4">Introduction</a></p></li>
<li><p><a class="reference internal" href="#deviations-from-the-google-c-coding-style" id="id5">Deviations from the Google C++ Coding Style</a></p></li>
<li><p><a class="reference internal" href="#deviations-from-the-mozilla-c-coding-style" id="id6">Deviations from the Mozilla C++ Coding Style</a></p></li>
<li><p><a class="reference internal" href="#additions-to-the-google-mozilla-c-code-style" id="id7">Additions to the Google/Mozilla C++ Code Style</a></p>
<ul>
<li><p><a class="reference internal" href="#naming" id="id8">Naming</a></p>
<ul>
<li><p><a class="reference internal" href="#gtest-test-names" id="id9">gtest test names</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#specifying-types" id="id10">Specifying types</a></p>
<ul>
<li><p><a class="reference internal" href="#use-of-auto-for-declaring-variables" id="id11">Use of <code class="docutils literal notranslate"><span class="pre">auto</span></code> for declaring variables</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#pointer-types" id="id12">Pointer types</a></p>
<ul>
<li><p><a class="reference internal" href="#plain-pointers" id="id13">Plain pointers</a></p></li>
<li><p><a class="reference internal" href="#smart-pointers" id="id14">Smart pointers</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#enums" id="id15">Enums</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#evolution-process" id="id16">Evolution Process</a></p>
<ul>
<li><p><a class="reference internal" href="#managing-code-style-evolution-tasks" id="id17">Managing code style evolution tasks</a></p></li>
<li><p><a class="reference internal" href="#basis-for-code-style-evolution-tasks" id="id18">Basis for code style evolution tasks</a></p></li>
<li><p><a class="reference internal" href="#evolving-code-style-based-on-reviews" id="id19">Evolving code style based on reviews</a></p></li>
<li><p><a class="reference internal" href="#improving-code-style-compliance-when-writing-code" id="id20">Improving code style compliance when writing code</a></p></li>
<li><p><a class="reference internal" href="#syncing-with-the-global-mozilla-c-coding-style" id="id21">Syncing with the global Mozilla C++ Coding Style</a></p></li>
<li><p><a class="reference internal" href="#faq" id="id22">FAQ</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id4">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This code style currently applies to the components living in the following directories:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dom/file</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dom/indexedDB</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dom/localstorage</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dom/payments</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dom/quota</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dom/serviceworkers</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dom/workers</span></code></p></li>
</ul>
<p>In the long-term, the code is intended to use the
<a class="reference internal" href="../../code-quality/coding-style/index.html#coding-style"><span class="std std-ref">Mozilla Coding Style</span></a>,
which references the <a class="reference external" href="https://google.github.io/styleguide/cppguide.html">Google C++ Coding Style</a>.</p>
<p>However, large parts of the code were written before rules and in particular
the reference to the Google C++ Coding Style were enacted, and due to the
size of the code, this misalignment cannot be fixed in the short term.
To avoid that an arbitrary mixture of old-style and new-style code grows,
this document makes deviations from the “global” code style explicit, and
will be amended to describe migration paths in the future.</p>
<p>In addition, to achieve higher consistency within the components maintained by
the team and to reduce style discussions during reviews, allowing them to focus
on more substantial issues, more specific rules are described here that go
beyond the global code style. These topics might have been deliberately or
accidentally omitted from the global code style. Depending on wider agreement
and applicability, these specific rules might be migrated into the global code
style in the future.</p>
<p>Note that this document does not cover pure formatting issues. The code is and
must be kept formatted automatically by clang-format using the supplied
configuration file, and whatever clang-format does takes precedence over any
other stated rules regarding formatting.</p>
</div>
<div class="section" id="deviations-from-the-google-c-coding-style">
<h2><a class="toc-backref" href="#id5">Deviations from the Google C++ Coding Style</a><a class="headerlink" href="#deviations-from-the-google-c-coding-style" title="Permalink to this headline">¶</a></h2>
<p>Deviations not documented yet.</p>
</div>
<div class="section" id="deviations-from-the-mozilla-c-coding-style">
<h2><a class="toc-backref" href="#id6">Deviations from the Mozilla C++ Coding Style</a><a class="headerlink" href="#deviations-from-the-mozilla-c-coding-style" title="Permalink to this headline">¶</a></h2>
<table class="docutils align-default">
<colgroup>
<col style="width: 35%" />
<col style="width: 31%" />
<col style="width: 6%" />
<col style="width: 29%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Mozilla style</p></th>
<th class="head"><p>Prevalent WAS style</p></th>
<th class="head"><p>Deviation scope</p></th>
<th class="head"><p>Evolution</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a href="#id1"><span class="problematic" id="id2">`</span></a>We prefer using “static”, instead of anonymous C++ namespaces.</p></td>
<td><p>Place all symbols that should have internal linkage in a single anonymous
namespace block at the top of an implementation file, rather than declarating them static.</p></td>
<td><p>All files</p></td>
<td><p>Unclear. The recommendation in the Mozilla code style says this might change in the
future depending on debugger support, so this deviation might become obsolete.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://google.github.io/styleguide/cppguide.html#Reference_Arguments">All parameters passed by lvalue reference must be labeled const. […] Input parameters may be const
pointers, but we never allow non-const reference parameters except when required by convention, e.g.,
swap().</a></p></td>
<td><p>Non-const reference parameters may be used.</p></td>
<td><p>All files</p></td>
<td><p>Unclear. Maybe at least restrict the use of non-const reference parameters to
cases that are not clearly output parameters (i.e. which are assigned to).</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="additions-to-the-google-mozilla-c-code-style">
<h2><a class="toc-backref" href="#id7">Additions to the Google/Mozilla C++ Code Style</a><a class="headerlink" href="#additions-to-the-google-mozilla-c-code-style" title="Permalink to this headline">¶</a></h2>
<p>This section contains style guidelines that do not conflict with the Google or
Mozilla C++ Code Style, but may make guidelines more specific or add guidelines
on topics not covered by those style guides at all.</p>
<div class="section" id="naming">
<h3><a class="toc-backref" href="#id8">Naming</a><a class="headerlink" href="#naming" title="Permalink to this headline">¶</a></h3>
<div class="section" id="gtest-test-names">
<h4><a class="toc-backref" href="#id9">gtest test names</a><a class="headerlink" href="#gtest-test-names" title="Permalink to this headline">¶</a></h4>
<p>gtest constructs a full test name from different fragments. Test names are
constructed somewhat differently for basic and parametrized tests.</p>
<p>The <em>prefix</em> for a test should start with an identifier of the component
and class, based on the name of the source code directory, transformed to
PascalCase and underscores as separators, so e.g. for a class <code class="docutils literal notranslate"><span class="pre">Key</span></code> in
<code class="docutils literal notranslate"><span class="pre">dom/indexedDB</span></code>, use <code class="docutils literal notranslate"><span class="pre">DOM_IndexedDB_Key</span></code> as a prefix.</p>
<p>For basic tests constructed with <code class="docutils literal notranslate"><span class="pre">TEST(test_case_name,</span> <span class="pre">test_name)</span></code>: Use
the <em>prefix</em> as the <code class="docutils literal notranslate"><span class="pre">test_case_name</span></code>. Test <code class="docutils literal notranslate"><span class="pre">test_name</span></code> should start with
the name of tested method(s), and a . Use underscores as a separator within
the <code class="docutils literal notranslate"><span class="pre">test_name</span></code>.</p>
<p>Value-parametrized tests are constructed with
<code class="docutils literal notranslate"><span class="pre">TEST_P(parametrized_test_case_name,</span> <span class="pre">parametrized_test_name)</span></code>. They require a
custom test base class, whose name is used as the <code class="docutils literal notranslate"><span class="pre">parametrized_test_case_name</span></code>.
Start the class name with <code class="docutils literal notranslate"><span class="pre">TestWithParam_</span></code>, and end it with a transliteration
of the parameter type (e.g. <code class="docutils literal notranslate"><span class="pre">String_Int_Pair</span></code> for <code class="docutils literal notranslate"><span class="pre">std::pair&lt;nsString,</span> <span class="pre">int&gt;</span></code>),
and place it in an (anonymous) namespace.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>It is important to place the class in an (anonymous) namespace, since its
name according to this guideline is not unique within libxul-gtest, and name
clashes are likely, which would lead to ODR violations otherwise.</p>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">parametrized_test_name</span></code> is constructed according to the same rules
described for <code class="docutils literal notranslate"><span class="pre">test_name</span></code> above.</p>
<p>Instances of value-parametrized tests are constructed using
<code class="docutils literal notranslate"><span class="pre">INSTANTIATE_TEST_CASE_P(prefix,</span> <span class="pre">parametrized_test_case_name,</span> <span class="pre">generator,</span> <span class="pre">...)</span></code>.
As <code class="docutils literal notranslate"><span class="pre">prefix</span></code>, use the prefix as described above.</p>
<p>Similar considerations apply to type-parametrized tests. If necessary, specific
rules for type-parametrized tests will be added here.</p>
<dl class="simple">
<dt>Rationale</dt><dd><p>All gtests (not only from the WAS components) are linked into libxul-gtest,
which requires names to be unique within that large scope. In addition, it
should be clear from the test name (e.g. in the test execution log) in what
source file (or at least which directory) the test code can be found.
Optimally, test names should be structured hierarchically to allow
easy selection of groups of tests for execution. However, gtest has some
restrictions that do not allow that completely. The guidelines try to
accommodate for these as far as possible. Note that gtest recommends not to
use underscores in test names in general, because this may lead to reserved
names and naming conflicts, but the rules stated here should avoid that.
In case of any problems arising, we can evolve the rules to accommodate
for that.</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="specifying-types">
<h3><a class="toc-backref" href="#id10">Specifying types</a><a class="headerlink" href="#specifying-types" title="Permalink to this headline">¶</a></h3>
<div class="section" id="use-of-auto-for-declaring-variables">
<h4><a class="toc-backref" href="#id11">Use of <code class="docutils literal notranslate"><span class="pre">auto</span></code> for declaring variables</a><a class="headerlink" href="#use-of-auto-for-declaring-variables" title="Permalink to this headline">¶</a></h4>
<p>The <a class="reference external" href="https://google.github.io/styleguide/cppguide.html#auto">Google C++ Code Style on auto</a>
allows the use of <code class="docutils literal notranslate"><span class="pre">auto</span></code> generally with encouragements for specific cases, which still
leaves a rather wide range for interpretation.</p>
<p>We extend this by some more encouragements and discouragements:</p>
<ul class="simple">
<li><p>DO use <code class="docutils literal notranslate"><span class="pre">auto</span></code> when the type is already present in the
initialization expression (esp. a template argument or similar),
e.g. <code class="docutils literal notranslate"><span class="pre">auto</span> <span class="pre">c</span> <span class="pre">=</span> <span class="pre">static_cast&lt;uint16_t&gt;(*(iter++))</span> <span class="pre">&lt;&lt;</span> <span class="pre">8;</span></code> or
<code class="docutils literal notranslate"><span class="pre">auto</span> <span class="pre">x</span> <span class="pre">=</span>&#160; <span class="pre">MakeRefPtr&lt;MediaStreamError&gt;(mWindow,</span> <span class="pre">*aError);</span></code></p></li>
<li><p>DO use <code class="docutils literal notranslate"><span class="pre">auto</span></code> if the spelled out type were complex otherwise,
e.g. a nested typedef or type alias, e.g. <code class="docutils literal notranslate"><span class="pre">foo_container::value_type</span></code>.</p></li>
<li><p>DO NOT use <code class="docutils literal notranslate"><span class="pre">auto</span></code> if the type were spelled out as a builtin
integer type or one of the types from <code class="docutils literal notranslate"><span class="pre">&lt;cstdint&gt;</span></code>, e.g.
instead of <code class="docutils literal notranslate"><span class="pre">auto</span> <span class="pre">foo</span> <span class="pre">=</span> <span class="pre">funcThatReturnsUint16();</span></code> use
<code class="docutils literal notranslate"><span class="pre">uint16_t</span> <span class="pre">foo</span> <span class="pre">=</span> <span class="pre">funcThatReturnsUint16();</span></code>.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some disadvantages of using <code class="docutils literal notranslate"><span class="pre">auto</span></code> relate to the unavailability of type
information outside an appropriate IDE/editor. This may be somewhat remedied
by resolving <a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1567464">Bug 1567464</a>
which will make the type information available in searchfox. In consequence,
the guidelines might be amended to promote a more widespread use of <code class="docutils literal notranslate"><span class="pre">auto</span></code>.</p>
</div>
</div>
</div>
<div class="section" id="pointer-types">
<h3><a class="toc-backref" href="#id12">Pointer types</a><a class="headerlink" href="#pointer-types" title="Permalink to this headline">¶</a></h3>
<div class="section" id="plain-pointers">
<h4><a class="toc-backref" href="#id13">Plain pointers</a><a class="headerlink" href="#plain-pointers" title="Permalink to this headline">¶</a></h4>
<p>The use of plain pointers is error-prone. Avoid using owning plain pointers. In
particular, avoid using literal, non-placement new. There are various kinds
of smart pointers, not all of which provide appropriate factory functions.
However, where such factory functions exist, do use them (along with auto).
The following is an incomplete list of smart pointer types and corresponding
factory functions:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 34%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>Factory function</p></th>
<th class="head"><p>Header file</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">mozilla::RefPtr</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mozilla::MakeRefPtr</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;mfbt/RefPtr.h&quot;</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">mozilla::UniquePtr</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mozilla::MakeUnique</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;mfbt/UniquePtr.h&quot;</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">std::unique_ptr</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">std::make_unique</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&lt;memory&gt;</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">std::shared_ptr</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">std::make_shared</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&lt;memory&gt;</span></code></p></td>
</tr>
</tbody>
</table>
<p>Also, to create an <code class="docutils literal notranslate"><span class="pre">already_AddRefed&lt;&gt;</span></code> to pass as a parameter or return from
a function without the need to dereference it, use <code class="docutils literal notranslate"><span class="pre">MakeAndAddRef</span></code> instead of
creating a dereferenceable <code class="docutils literal notranslate"><span class="pre">RefPtr</span></code> (or similar) first and then using
<code class="docutils literal notranslate"><span class="pre">.forget()</span></code>.</p>
</div>
<div class="section" id="smart-pointers">
<h4><a class="toc-backref" href="#id14">Smart pointers</a><a class="headerlink" href="#smart-pointers" title="Permalink to this headline">¶</a></h4>
<p>In function signatures, prefer accepting or returning <code class="docutils literal notranslate"><span class="pre">RefPtr</span></code> instead of
<code class="docutils literal notranslate"><span class="pre">already_AddRefed</span></code> in conjunction with regular <code class="docutils literal notranslate"><span class="pre">std::move</span></code> rather than
<code class="docutils literal notranslate"><span class="pre">.forget()</span></code>. This improves readability and code generation. Prevailing
legimitate uses of <code class="docutils literal notranslate"><span class="pre">already_AddRefed</span></code> are described in its
<a class="reference external" href="https://searchfox.org/mozilla-central/rev/4df8821c1b824db5f40f381f48432f219d99ae36/mfbt/AlreadyAddRefed.h#31">documentation</a>.</p>
<p>Prefer using <code class="docutils literal notranslate"><span class="pre">mozilla::UniquePtr</span></code> over <code class="docutils literal notranslate"><span class="pre">nsAutoPtr</span></code>, since the latter is
deprecated (and e.g. has no factory function, see Bug 1600079).</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">nsCOMPtr&lt;T&gt;</span></code> iff <code class="docutils literal notranslate"><span class="pre">T</span></code> is an XPCOM interface type
(<cite>more details on MDN &lt;https://developer.mozilla.org/en-US/docs/Mozilla/Tech/XPCOM/nsCOMPtr_versus_RefPtr&gt;</cite>).</p>
</div>
</div>
<div class="section" id="enums">
<h3><a class="toc-backref" href="#id15">Enums</a><a class="headerlink" href="#enums" title="Permalink to this headline">¶</a></h3>
<p>Use scoped resp. strongly typed enums (<code class="docutils literal notranslate"><span class="pre">enum</span> <span class="pre">struct</span></code>) rather than non-scoped
enums. Use PascalCase for naming the values of scoped enums.</p>
</div>
</div>
<div class="section" id="evolution-process">
<h2><a class="toc-backref" href="#id16">Evolution Process</a><a class="headerlink" href="#evolution-process" title="Permalink to this headline">¶</a></h2>
<p>This section explains the process to evolve the coding style described in this
document. For clarity, we will distinguish coding tasks from code style
evolution tasks in this section.</p>
<div class="section" id="managing-code-style-evolution-tasks">
<h3><a class="toc-backref" href="#id17">Managing code style evolution tasks</a><a class="headerlink" href="#managing-code-style-evolution-tasks" title="Permalink to this headline">¶</a></h3>
<p>A code style evolution task is a task that ought to amend or revise the
coding style as described in this document.</p>
<p>Code style evolution tasks should be managed in Bugzilla, as individual bugs
for each topic. All such tasks
should block the meta-bug
<cite>1586788 &lt;https://bugzilla.mozilla.org/show_bug.cgi?id=1586788&gt;</cite>.</p>
<p>When you take on to work on a code style evolution task:</p>
<ul class="simple">
<li><p>The task may already include a sketch of a resolution. If no preferred
solution is obvious, discuss options to resolve it via comments on the bug
first.</p></li>
<li><p>When the general idea is ready to be spelled out in this document, amend or
revise it accordingly.</p></li>
<li><p>Submit the changes to this document as a patch to Phabricator, and put it up
for review. Since this will affect a number of people, every change should
be reviewed by at least two people. Ideally, this should include the owner
of this style document and one person with good knowledge of the parts of
the code base this style applies to.</p></li>
<li><p>If there are known violations of the amendment to the coding style, consider
fixing some of them, so that the amendment is tested on actual code. If
the code style evolution task refers to a particular code location from a
review, at least that location should be fixed to comply with the amended
coding style.</p></li>
<li><p>When you have two r+, land the patch.</p></li>
<li><p>Report on the addition in the next team meeting to raise awareness.</p></li>
</ul>
</div>
<div class="section" id="basis-for-code-style-evolution-tasks">
<h3><a class="toc-backref" href="#id18">Basis for code style evolution tasks</a><a class="headerlink" href="#basis-for-code-style-evolution-tasks" title="Permalink to this headline">¶</a></h3>
<p>The desire or necessity to evolve the code style can originate from
different activities, including
- reviews
- reading or writing code locally
- reading the coding style
- general thoughts on coding style</p>
<p>The code style should not be cluttered with aspects that are rarely
relevant or rarely leads to discussions, as the maintenance of the
code style has a cost as well. The code style should be as comprehensive
as necessary to reduce the overall maintenance costs of the code and
code style combined.</p>
<p>A particular focus is therefore on aspects that led to some discussion in
a code review, as reducing the number or verbosity of necessary style
discussions in reviews is a major indicator for the effectiveness of the
documented style.</p>
</div>
<div class="section" id="evolving-code-style-based-on-reviews">
<h3><a class="toc-backref" href="#id19">Evolving code style based on reviews</a><a class="headerlink" href="#evolving-code-style-based-on-reviews" title="Permalink to this headline">¶</a></h3>
<p>The goal of the process described here is to take advantage of style-related
discussions that originate from a code review, but to decouple evolution of
the code style from the review process, so that it does not block progress on
the underlying bug.</p>
<p>The following should be considered when performing a review:</p>
<ul class="simple">
<li><p>Remind yourself of the code style, maybe skim through the document before
starting the review, or have it open side-by-side while doing the review.</p></li>
<li><p>If you find a violation of an existing rule, add an inline comment.</p></li>
<li><p>Have an eye on style-relevant aspects in the code itself or after a
discussions with the author. Consider if this could be generalized into a
style rule, but is not yet  covered by the documented global or local style.
This might be something that is in a different style as opposed to other
locations, differs from your personal style, etc.</p></li>
<li><p>In that case, find an acceptable temporary solution for the code fragments
at hand, which is acceptable for an r+ of the patch. Maybe agree with the
code author on adding a comment that this should be revised later, when
a rule is codified.</p></li>
<li><p>Create a code style evolution task in Bugzilla as described above. In the
description of the bug, reference the review comment that gave rise to it.
If you can suggest a resolution, include that in the description, but this
is not a necessary condition for creating the task.</p></li>
</ul>
</div>
<div class="section" id="improving-code-style-compliance-when-writing-code">
<h3><a class="toc-backref" href="#id20">Improving code style compliance when writing code</a><a class="headerlink" href="#improving-code-style-compliance-when-writing-code" title="Permalink to this headline">¶</a></h3>
<p>Periodically look into the code style document, and remind yourself of its
rules, and give particular attention to recent changes.</p>
<p>When writing code, i.e. adding new code or modify existing code,
remind yourself of checking the code for style compliance.</p>
<p>Time permitting, resolve existing violations on-the-go as part of other work
in the code area. Submit such changes in dedicated patches. If you identify
major violations that are too complex to resolve on-the-go, consider
creating a bug dedicated to the resolution of that violation, which
then can be scheduled in the planning process.</p>
</div>
<div class="section" id="syncing-with-the-global-mozilla-c-coding-style">
<h3><a class="toc-backref" href="#id21">Syncing with the global Mozilla C++ Coding Style</a><a class="headerlink" href="#syncing-with-the-global-mozilla-c-coding-style" title="Permalink to this headline">¶</a></h3>
<p>Several aspects of the coding style described here will be applicable to
the overall code base. However, amendments to the global coding style will
affect a large number of code authors and may require extended discussion.
Deviations from the global coding style should be limited in the long term.
On the other hand, amendments that are not relevant to all parts of the code
base, or where it is difficult to reach a consensus at the global scope,
may make sense to be kept in the local style.</p>
<p>The details of synchronizing with the global style are subject to discussion
with the owner and peers of the global coding style (see
<cite>Bug 1587810 &lt;https://bugzilla.mozilla.org/show_bug.cgi?id=1587810&gt;</cite>).</p>
</div>
<div class="section" id="faq">
<h3><a class="toc-backref" href="#id22">FAQ</a><a class="headerlink" href="#faq" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>When someone introduces new code that adheres to the current style, but the
remainder of the function/class/file does not, is it their responsibility
to update that remainder on-the-go?</p>
<p>The code author is not obliged to update the remainder, but they are
encouraged to do so, time permitting. Whether that is the case depends on a
number of factors, including the number and complexity of existing style
violations, the risk introduced by changing that on the go etc. Judging this
is left to the code author.
At the very least, the function/class/file should not be left in a worse
state than before.</p>
</li>
<li><p>Are stylistic inconsistencies introduced by applying the style as defined
here only to new code considered acceptable?</p>
<p>While this is certainly not optimal, accepting such inconsistencies to
some degree is inevitable to allow making progress towards an improved style.
Personal preferences regarding the degree may differ, but in doubt such
inconsistencies should be considered acceptable. They should not block a bug
from being closed.</p>
</li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../layout/index.html" class="btn btn-neutral float-right" title="Layout &amp; CSS" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="DOM Workers &amp; Storage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>