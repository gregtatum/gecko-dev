

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ICU &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Localization" href="../l10n/index.html" />
    <link rel="prev" title="UI Internationalization" href="dataintl.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Internationalization</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="locale.html">Locale management</a></li>
<li class="toctree-l2"><a class="reference internal" href="dataintl.html">UI Internationalization</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">ICU</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#internationalization-in-spidermonkey-and-gecko">Internationalization in SpiderMonkey and Gecko</a></li>
<li class="toctree-l3"><a class="reference internal" href="#building-spidermonkey-or-gecko-with-icu">Building SpiderMonkey or Gecko with ICU</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-icu-functionality-in-spidermonkey-and-gecko">Using ICU functionality in SpiderMonkey and Gecko</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spidermonkey-and-geckos-imported-icu">SpiderMonkey and Gecko’s imported ICU</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#build-system">Build system</a></li>
<li class="toctree-l4"><a class="reference internal" href="#locale-and-time-zone-data">Locale and time zone data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#local-patching-of-icu">Local patching of ICU</a></li>
<li class="toctree-l4"><a class="reference internal" href="#updating-imported-code">Updating imported code</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Internationalization</a> &raquo;</li>
        
      <li>ICU</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/intl/icu.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="icu">
<h1>ICU<a class="headerlink" href="#icu" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Internationalization (i18n, “i” then 18 letters then “n”) is the process of handling data with respect to a particular locale:</p>
<ul class="simple">
<li><p>The number 5 representing five US dollars might be formatted as</p>
<ul>
<li><p>“$5.00” in American English,</p></li>
<li><p>“US$5.00” in Canadian English, or</p></li>
<li><p>“5,00 $US” in French.</p></li>
</ul>
</li>
<li><p>A list of people’s names in a phone book would sort</p>
<ul>
<li><p>in English alphabetically; but</p></li>
<li><p>in German, where “ä”/“ö”/“ü” are often interchangeable with “ae”/“oe”/“ue”, alphabetically but with vowels with umlauts treated as their two-vowel counterparts.</p></li>
</ul>
</li>
<li><p>The currency whose code is “CHF” might be formatted as</p>
<ul>
<li><p>“Swiss Franc” in English, but</p></li>
<li><p>“franc suisse” in French.</p></li>
</ul>
</li>
<li><p>The Unix time 1590803313070 might format as the time string</p>
<ul>
<li><p>“9:48:33 PM Eastern Daylight Time” in American English, but</p></li>
<li><p>“21:48:33 Nordamerikanische Ostküsten-Sommerzeit” in German.</p></li>
</ul>
</li>
</ul>
<p>i18n encompasses far more than this, but you get the basic idea.</p>
</div>
<div class="section" id="internationalization-in-spidermonkey-and-gecko">
<h2>Internationalization in SpiderMonkey and Gecko<a class="headerlink" href="#internationalization-in-spidermonkey-and-gecko" title="Permalink to this headline">¶</a></h2>
<p>SpiderMonkey implements extensive i18n capabilities through the <a class="reference external" href="https://tc39.es/ecma402/">ECMAScript Internationalization API</a> and the global <code class="docutils literal notranslate"><span class="pre">Intl</span></code> object. Gecko requires i18n capabilities to implement text shaping, sort operations in some contexts, and various other features.</p>
<p>SpiderMonkey and Gecko use <a class="reference external" href="http://site.icu-project.org/">ICU</a>, Internationalization Components for Unicode, to implement many low-level i18n operations. (Line breaking, implemented instead in <code class="docutils literal notranslate"><span class="pre">intl/lwbrk</span></code>, is a notable exception.) Gecko and SpiderMonkey also use ICU’s implementations of certain i18n-<em>adjacent</em> operations (for example, Unicode normalization).</p>
<p>ICU date/time formatting functionality requires extensive knowledge of time zone names and when zone transitions occur. The IANA <code class="docutils literal notranslate"><span class="pre">tzdata</span></code> database supplies this information.</p>
<p>A final note of caution: ICU carefully depends upon an exact Unicode version. Other parts of SpiderMonkey and Gecko have separate dependencies on an exact Unicode version. Updates to ICU and related components <em>must</em> be synchronized with those updates so that the entirety of SpiderMonkey, and the entirety of Gecko including SpiderMonkey within it, advance to new Unicode versions in lockstep. <a class="footnote-reference brackets" href="#lockstep" id="id1">1</a></p>
<dl class="footnote brackets">
<dt class="label" id="lockstep"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>The steps involved in updating Gecko-in-general’s Unicode version, and updating SpiderMonkey’s code dependent on Unicode version, are <a class="reference external" href="https://wiki.mozilla.org/I18n:Updating_Unicode_version">documented on WikiMO</a>.</p>
</dd>
</dl>
</div>
<div class="section" id="building-spidermonkey-or-gecko-with-icu">
<h2>Building SpiderMonkey or Gecko with ICU<a class="headerlink" href="#building-spidermonkey-or-gecko-with-icu" title="Permalink to this headline">¶</a></h2>
<p>SpiderMonkey and Gecko can be built using either a periodically-updated copy of ICU in <code class="docutils literal notranslate"><span class="pre">intl/icu/source</span></code> (using time zone data in <code class="docutils literal notranslate"><span class="pre">intl/tzdata/source</span></code>), or using a system-provided ICU library (dependent on its own <code class="docutils literal notranslate"><span class="pre">tzdata</span></code> information). Pass <code class="docutils literal notranslate"><span class="pre">--with-system-icu</span></code> when configuring to use system ICU. (Using system ICU will disable some <code class="docutils literal notranslate"><span class="pre">Intl</span></code> functionality, such as historically accurate time zone calculations, that can’t be readily supported without a precisely-controlled ICU.) ICU version requirements advance fairly quickly as Gecko depends on features and bug fixes in newer ICU releases. You’ll get a build error if you try to use an unsupported ICU.</p>
<p>SpiderMonkey’s <code class="docutils literal notranslate"><span class="pre">Intl</span></code> API may be built or disabled by configuring <code class="docutils literal notranslate"><span class="pre">--with-intl-api</span></code> (the default) or <code class="docutils literal notranslate"><span class="pre">--without-intl-api</span></code>. SpiderMonkey built without the <code class="docutils literal notranslate"><span class="pre">Intl</span></code> API doesn’t require ICU. However, if you build without the <code class="docutils literal notranslate"><span class="pre">Intl</span></code> API, some non-<code class="docutils literal notranslate"><span class="pre">Intl</span></code> JavaScript functionality will not exist (<code class="docutils literal notranslate"><span class="pre">String.prototype.normalize</span></code>) or won’t fully work (for example, <code class="docutils literal notranslate"><span class="pre">String.prototype.toLocale{Lower,Upper}Case</span></code> will not respect a provided locale, and the various <code class="docutils literal notranslate"><span class="pre">toLocaleString</span></code> functions have best-effort behavior).</p>
</div>
<div class="section" id="using-icu-functionality-in-spidermonkey-and-gecko">
<h2>Using ICU functionality in SpiderMonkey and Gecko<a class="headerlink" href="#using-icu-functionality-in-spidermonkey-and-gecko" title="Permalink to this headline">¶</a></h2>
<p>ICU headers are considered system headers by the Gecko build system, so they must be listed in <code class="docutils literal notranslate"><span class="pre">config/system-headers.mozbuild</span></code>. Code that wishes to use ICU functionality may use <code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">&quot;unicode/unorm.h&quot;</span></code> or similar to do so.</p>
<p>Gecko and SpiderMonkey code may use ICU’s stable C API (ICU4C). These functions are stable and shouldn’t change as ICU updates occur. (ICU4C’s <code class="docutils literal notranslate"><span class="pre">enum</span></code> initializers are not always stable: while initializer values are stable, new initializers are sometimes added, perhaps behind <code class="docutils literal notranslate"><span class="pre">#ifdef</span> <span class="pre">U_HIDE_DRAFT_API</span></code>. This may be necessary for exhaustive <code class="docutils literal notranslate"><span class="pre">switch</span></code>es to add <code class="docutils literal notranslate"><span class="pre">#ifdef</span></code>s around some <code class="docutils literal notranslate"><span class="pre">case</span></code>s.)</p>
<p>Gecko and SpiderMonkey are strongly discouraged from using ICU’s C++ API (unfortunately including all smart pointer classes), because the C++ API doesn’t provide ICU4C’s compatibility guarantees. Rarely, we tolerate C++ API use when no stable option exists. But the API has to “look” reasonably stable, and we usually want to start a discussion with upstream about adding a stable API to eventually use. Use symbols from <code class="docutils literal notranslate"><span class="pre">namespace</span> <span class="pre">icu</span></code> to access ICU C++ functionality. <em>Talk to the current imported-ICU owner (presently Jeff Walden) before you start doing any of this!</em></p>
</div>
<div class="section" id="spidermonkey-and-geckos-imported-icu">
<h2>SpiderMonkey and Gecko’s imported ICU<a class="headerlink" href="#spidermonkey-and-geckos-imported-icu" title="Permalink to this headline">¶</a></h2>
<div class="section" id="build-system">
<h3>Build system<a class="headerlink" href="#build-system" title="Permalink to this headline">¶</a></h3>
<p>The system for building ICU lives in <code class="docutils literal notranslate"><span class="pre">config/external/icu</span></code> and <code class="docutils literal notranslate"><span class="pre">intl/icu/icu_sources_data.py</span></code>. We generate a Mozilla-compatible build system rather than using ICU’s build system. The build system is shared by SpiderMonkey and Gecko both.</p>
<p>ICU includes functionality we never use, so we don’t naively compile all of it. We extract the list of files to compile from <code class="docutils literal notranslate"><span class="pre">intl/icu/source/{common,i18n}/Makefile.in</span></code> and then apply a manually-maintained list of unused files (stored in <code class="docutils literal notranslate"><span class="pre">intl/icu_sources_data.py</span></code>) when we update ICU.</p>
</div>
<div class="section" id="locale-and-time-zone-data">
<h3>Locale and time zone data<a class="headerlink" href="#locale-and-time-zone-data" title="Permalink to this headline">¶</a></h3>
<p>ICU contains a considerable amount of raw locale data: formatting characteristics for each locale, strings for things like currencies and languages for each locale, localized time zone specifiers, and so on. This data lives in human-readable files in <code class="docutils literal notranslate"><span class="pre">intl/icu/source/data</span></code>. Time zone data in <code class="docutils literal notranslate"><span class="pre">intl/tzdata/source</span></code> is stored in partially-compiled formats (some of them only partly human-readable).</p>
<p>However, a normal Gecko build never uses these files! Instead, both ICU and <code class="docutils literal notranslate"><span class="pre">tzdata</span></code> data are precompiled into a large, endian-specific <code class="docutils literal notranslate"><span class="pre">icudtNNE.dat</span></code> (<code class="docutils literal notranslate"><span class="pre">NN</span></code> = ICU version, <code class="docutils literal notranslate"><span class="pre">E</span></code> = endianness) file. <a class="footnote-reference brackets" href="#why-icudt-not-rebuilt-every-time" id="id2">2</a> That file is added to <code class="docutils literal notranslate"><span class="pre">config/external/icu/data/</span></code> and is checked into the Mozilla tree, to be directly incorporated into Gecko/SpiderMonkey builds. For size reasons, only the little-endian version is checked into the tree. It is converted into a big-endian version when necessary during the build.</p>
<p>ICU’s locale data covers <em>all</em> ICU internationalization features, including ones we never need. We trim locale data to size with a <code class="docutils literal notranslate"><span class="pre">intl/icu/data_filter.json</span></code> <a class="reference external" href="https://github.com/unicode-org/icu/blob/master/docs/userguide/icu_data/buildtool.md">data filter</a> when compiling <code class="docutils literal notranslate"><span class="pre">icudtNNE.dat</span></code>. Removing <em>too much</em> data won’t <em>necessarily</em> break the build, so it’s important that we have automated tests for the locale data we actually use in order to detect mistakes.</p>
<dl class="footnote brackets">
<dt class="label" id="why-icudt-not-rebuilt-every-time"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">icudtNNE.dat</span></code> isn’t compiled during a SpiderMonkey/Gecko build because it would require ICU command-line tools. And it’s a pain to either compile and run them during the build, or to require them as build dependencies.</p>
</dd>
</dl>
</div>
<div class="section" id="local-patching-of-icu">
<h3>Local patching of ICU<a class="headerlink" href="#local-patching-of-icu" title="Permalink to this headline">¶</a></h3>
<p>We generally don’t patch our copy of ICU except for compelling need. When we do patch, we usually only apply reasonably small patches that have been reviewed and landed upstream (so that our patch will be obsolete when we next update ICU).</p>
<p>Local patches are stored in the <code class="docutils literal notranslate"><span class="pre">intl/icu-patches</span></code> directory. They’re applied when ICU is updated, so merely updating ICU files in place won’t persist changes across an ICU update.</p>
</div>
<div class="section" id="updating-imported-code">
<h3>Updating imported code<a class="headerlink" href="#updating-imported-code" title="Permalink to this headline">¶</a></h3>
<p>The process of updating imported i18n-relevant code is <em>semi</em>-automated. We use a series of shell and Python scripts to do the job.</p>
<div class="section" id="updating-icu">
<h4>Updating ICU<a class="headerlink" href="#updating-icu" title="Permalink to this headline">¶</a></h4>
<p>New ICU versions are announced on the <a class="reference external" href="https://lists.sourceforge.net/lists/listinfo/icu-announce">icu-announce</a> mailing list. Both release candidates and actual releases are announced here. It’s a good idea to attempt to update ICU when a release candidate is announced, just in case some serious problem is present (especially one that would be painful to fix through local patching).</p>
<p><code class="docutils literal notranslate"><span class="pre">intl/update-icu.sh</span></code> updates our ICU to a given ICU release: <a class="footnote-reference brackets" href="#icu-git-argument" id="id3">3</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="s2">&quot;</span><span class="nv">$topsrcdir</span><span class="s2">/intl&quot;</span>
$ <span class="c1"># Ensure certain Python modules in the tree are accessible when updating.</span>
$ <span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$topsrcdir</span><span class="s2">/python/mozbuild/&quot;</span>
$ <span class="c1">#               &lt;URL to ICU Git&gt;                       &lt;release tag name&gt;</span>
$ ./update-icu.sh https://github.com/unicode-org/icu.git release-67-1
</pre></div>
</div>
<dl class="footnote brackets">
<dt class="label" id="icu-git-argument"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p>The ICU Git URL argument lets you update from a local ICU clone. This can speed up work when you’re updating to a new ICU release and need to adjust or add new local patches.</p>
</dd>
</dl>
<p>But usually you’ll want to update to the latest commit from the corresponding ICU maintenance branch so that you pick up fixes landed post-release:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="s2">&quot;</span><span class="nv">$topsrcdir</span><span class="s2">/intl&quot;</span>
$ <span class="c1"># Ensure certain Python modules in the tree are accessible when updating.</span>
$ <span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$topsrcdir</span><span class="s2">/python/mozbuild/&quot;</span>
$ <span class="c1">#               &lt;URL to ICU Git&gt;                       &lt;maintenance name&gt;</span>
$ ./update-icu.sh https://github.com/unicode-org/icu.git maint/maint-67
</pre></div>
</div>
<p>Updating ICU will also update the language tag registry (which records language tag semantics needed to correctly implement <code class="docutils literal notranslate"><span class="pre">Intl</span></code> functionality). Therefore it’s likely necessary to update SpiderMonkey’s language tag handling after running this <a class="footnote-reference brackets" href="#update-icu-warning-langtags" id="id4">4</a>. See below where the <code class="docutils literal notranslate"><span class="pre">langtags</span></code> mode of <code class="docutils literal notranslate"><span class="pre">make_intl_data.py</span></code> is discussed.</p>
<dl class="footnote brackets">
<dt class="label" id="update-icu-warning-langtags"><span class="brackets"><a class="fn-backref" href="#id4">4</a></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">update-icu.sh</span></code> will print a notice as a reminder of this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>INFO: Please run <span class="s1">&#39;js/src/builtin/intl/make_intl_data.py langtags&#39;</span> to update additional language tag files <span class="k">for</span> SpiderMonkey.
</pre></div>
</div>
</dd>
</dl>
<p><code class="docutils literal notranslate"><span class="pre">update-icu.sh</span></code> is intended for <em>replayability</em>, not for hands-off runnability. It downloads ICU source, prunes various irrelevant files, replaces <code class="docutils literal notranslate"><span class="pre">intl/icu/source</span></code> with the new files – and then blindly applies local patches in fixed order.</p>
<p>Often a local patch won’t apply, or new patches must be applied to successfully build. In this case you’ll have to manually edit <code class="docutils literal notranslate"><span class="pre">update-icu.sh</span></code> to abort after only <em>some</em> patches have been applied, make whatever changes are necessary by hand, generate a new/updated patch file by hand, then carefully reattempt updating. (The people who have updated ICU in the past, usually jwalden and anba, follow this awkward process and don’t have good ideas on how to improve it.)</p>
<p>Any time ICU is updated, you’ll need to fully rebuild whichever of SpiderMonkey or Gecko you’re building. For SpiderMonkey, delete your object directory and reconfigure from scratch. For Gecko, change the message in the top-level <a class="reference external" href="https://searchfox.org/mozilla-central/source/CLOBBER">CLOBBER</a> file.</p>
</div>
<div class="section" id="updating-tzdata">
<h4>Updating tzdata<a class="headerlink" href="#updating-tzdata" title="Permalink to this headline">¶</a></h4>
<p>ICU contains a copy of <code class="docutils literal notranslate"><span class="pre">tzdata</span></code>, but that copy is whatever <code class="docutils literal notranslate"><span class="pre">tzdata</span></code> release was current at the time the ICU release was finalized. Time zone data changes much more often than that: every time some national legislature or tinpot dictator decides to alter time zones. <a class="footnote-reference brackets" href="#tzdata-release-frequency" id="id5">5</a> The <a class="reference external" href="https://mm.icann.org/pipermail/tz-announce/">tz-announce</a> mailing list announces changes as they occur. (Note that we can’t <em>immediately</em> update when a release occurs: ICU’s <a class="reference external" href="https://github.com/unicode-org/icu-data">icu-data</a> repository must be updated before we can update our <code class="docutils literal notranslate"><span class="pre">tzdata</span></code>.)</p>
<dl class="footnote brackets">
<dt class="label" id="tzdata-release-frequency"><span class="brackets"><a class="fn-backref" href="#id5">5</a></span></dt>
<dd><p>To give a sense of how frequently <code class="docutils literal notranslate"><span class="pre">tzdata</span></code> is updated, and the irregularity of releases over time:</p>
<ul class="simple">
<li><p>2019 had three <code class="docutils literal notranslate"><span class="pre">tzdata</span></code> releases, 2019a through 2019c.</p></li>
<li><p>2018 had nine <code class="docutils literal notranslate"><span class="pre">tzdata</span></code> releases, 2018a through 2018i.</p></li>
<li><p>2017 had three <code class="docutils literal notranslate"><span class="pre">tzdata</span></code> releases, 2017a through 2017c.</p></li>
</ul>
</dd>
</dl>
<p>Therefore, either (usually) after you update ICU <em>or</em> when a new <code class="docutils literal notranslate"><span class="pre">tzdata</span></code> release occurs, you’ll need to update our imported <code class="docutils literal notranslate"><span class="pre">tzdata</span></code> files. (If you do need to update time zone data, note that you’ll also need to additionally update SpiderMonkey’s time zone handling, described further below.) This also suitably updates <code class="docutils literal notranslate"><span class="pre">config/external/icu/data/icudtNNE.dat</span></code>. (If you’ve just run <code class="docutils literal notranslate"><span class="pre">update-icu.sh</span></code>, it will warn you that you need to do this. <a class="footnote-reference brackets" href="#update-icu-warning-old-tzdata" id="id6">6</a>)</p>
<dl class="footnote brackets">
<dt class="label" id="update-icu-warning-old-tzdata"><span class="brackets"><a class="fn-backref" href="#id6">6</a></span></dt>
<dd><p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WARN</span><span class="p">:</span> <span class="n">Local</span> <span class="n">tzdata</span> <span class="p">(</span><span class="mi">2020</span><span class="n">a</span><span class="p">)</span> <span class="ow">is</span> <span class="n">newer</span> <span class="n">than</span> <span class="n">ICU</span> <span class="n">tzdata</span> <span class="p">(</span><span class="mi">2019</span><span class="n">c</span><span class="p">),</span> <span class="n">please</span> <span class="n">run</span> <span class="s1">&#39;./update-tzdata.sh 2020a&#39;</span>
</pre></div>
</div>
</dd>
</dl>
<p>First, make sure you have a usable <code class="docutils literal notranslate"><span class="pre">icupkg</span></code> on your system. <a class="footnote-reference brackets" href="#icupkg-on-system" id="id7">7</a> Then run the <code class="docutils literal notranslate"><span class="pre">update-tzdata.sh</span></code> script to update <code class="docutils literal notranslate"><span class="pre">intl/tzdata</span></code> and <code class="docutils literal notranslate"><span class="pre">icudtNNE.dat</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="s2">&quot;</span><span class="nv">$topsrcdir</span><span class="s2">/intl&quot;</span>
$ ./update-tzdata.sh 2020a <span class="c1"># or whatever the latest release is</span>
</pre></div>
</div>
<dl class="footnote brackets">
<dt class="label" id="icupkg-on-system"><span class="brackets"><a class="fn-backref" href="#id7">7</a></span></dt>
<dd><p>To install <code class="docutils literal notranslate"><span class="pre">icupkg</span></code> on your system:</p>
<ul class="simple">
<li><p>On Fedora, use <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">dnf</span> <span class="pre">install</span> <span class="pre">icu</span></code>.</p></li>
<li><p>On Ubuntu, use <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">icu-devtools</span></code>.</p></li>
<li><p>On Mac OS X, use <code class="docutils literal notranslate"><span class="pre">brew</span> <span class="pre">install</span> <span class="pre">icu4c</span></code>.</p></li>
<li><p>On Windows, you’ll need to <a class="reference external" href="https://github.com/unicode-org/icu/releases/tag/release-67-1">download a binary build of ICU for Windows</a> and use the <code class="docutils literal notranslate"><span class="pre">bin/icupkg.exe</span></code> or <code class="docutils literal notranslate"><span class="pre">bin64/icupkg.exe</span></code> utility inside it.</p></li>
</ul>
<p>If you’re on Windows, or for some reason you don’t want to use the <code class="docutils literal notranslate"><span class="pre">icupkg</span></code> now in your <code class="docutils literal notranslate"><span class="pre">$PATH</span></code>, you can manually specify it on the command line using the <code class="docutils literal notranslate"><span class="pre">-e</span> <span class="pre">/path/to/icupkg</span></code> flag:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="s2">&quot;</span><span class="nv">$topsrcdir</span><span class="s2">/intl&quot;</span>
$ ./update-tzdata.sh -e /path/to/icupkg 2020a <span class="c1"># or whatever the latest release is</span>
</pre></div>
</div>
<p><em>In principle</em>, the <code class="docutils literal notranslate"><span class="pre">icupkg</span></code> you use <em>should</em> be the one from the ICU release/maintenance branch being built: if there’s a mismatch, you might encounter an ICU “format version not supported” error. If you’re on Windows, make sure to download a binary build for that release/branch. On other platforms, you might have to build your own ICU from source. The steps required to do this are left as an exercise for the reader. (In the somewhat longer term, the update commands might be changed to do this themselves.)</p>
</dd>
</dl>
<p>If <code class="docutils literal notranslate"><span class="pre">tzdata</span></code> must be updated on trunk, you’ll almost certainly have to backport the update to Beta and ESR. Don’t attempt to backport the literal patch; just run the appropriate commands documented here to do so.</p>
</div>
<div class="section" id="updating-spidermonkey-intl-data">
<h4>Updating SpiderMonkey <code class="docutils literal notranslate"><span class="pre">Intl</span></code> data<a class="headerlink" href="#updating-spidermonkey-intl-data" title="Permalink to this headline">¶</a></h4>
<p>SpiderMonkey itself can’t blindly invoke ICU to perform every i18n operation, because sometimes ICU behavior deviates from what web specifications require. Therefore, when ICU is updated, we also must update SpiderMonkey itself as well (including various generated tests). Such updating is performed using the various modes of <code class="docutils literal notranslate"><span class="pre">js/src/builtin/make_intl_data.py</span></code>.</p>
<div class="section" id="updating-spidermonkey-time-zone-handling">
<h5>Updating SpiderMonkey time zone handling<a class="headerlink" href="#updating-spidermonkey-time-zone-handling" title="Permalink to this headline">¶</a></h5>
<p>The ECMAScript Internationalization API requires that time zone identifiers (<code class="docutils literal notranslate"><span class="pre">America/New_York</span></code>, <code class="docutils literal notranslate"><span class="pre">Antarctica/McMurdo</span></code>, etc.) be interpreted according to <a class="reference external" href="https://www.iana.org/time-zones">IANA</a> semantics. Unfortunately, ICU doesn’t precisely implement those semantics. (See comments in <code class="docutils literal notranslate"><span class="pre">js/src/builtin/intl/SharedIntlData.h</span></code> for details.) Therefore SpiderMonkey has to do certain pre- and post-processing based on what’s in IANA but not in ICU, and what’s in ICU that isn’t in IANA.</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">make_intl_data.py</span></code>’s <code class="docutils literal notranslate"><span class="pre">tzdata</span></code> mode to update time zone information:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="s2">&quot;</span><span class="nv">$topsrcdir</span><span class="s2">/js/src/builtin/intl&quot;</span>
$ <span class="c1"># make_intl_data.py requires yaml.</span>
$ <span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$topsrcdir</span><span class="s2">/third_party/python/PyYAML/lib3/&quot;</span>
$ python3 ./make_intl_data.py tzdata
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">tzdata</span></code> mode accepts two optional arguments that generally will not be needed:</p>
<ul class="simple">
<li><p><strong>``–tz``</strong> will act using data from a local <code class="docutils literal notranslate"><span class="pre">tzdata/</span></code> directory containing raw <code class="docutils literal notranslate"><span class="pre">tzdata</span></code> source (note that this is <em>not</em> the same as what is in <code class="docutils literal notranslate"><span class="pre">intl/tzdata/source</span></code>). It may be useful to help debug problems that arise during an update.</p></li>
<li><p><strong>``–ignore-backzone``</strong> will omit time zone information before 1970. SpiderMonkey and Gecko include this information by default. However, because (by deliberate policy) <code class="docutils literal notranslate"><span class="pre">tzdata</span></code> information before 1970 is not reliable to the same degree as data since 1970, and backzone data has a size cost, a SpiderMonkey embedding or custom Gecko build might decide to omit it.</p></li>
</ul>
</div>
<div class="section" id="updating-spidermonkey-language-tag-handling">
<h5>Updating SpiderMonkey language tag handling<a class="headerlink" href="#updating-spidermonkey-language-tag-handling" title="Permalink to this headline">¶</a></h5>
<p>Language tags (<code class="docutils literal notranslate"><span class="pre">en</span></code>, <code class="docutils literal notranslate"><span class="pre">de-CH</span></code>, <code class="docutils literal notranslate"><span class="pre">ar-u-ca-islamicc</span></code>, and so on) are the primary means of specifying localization characteristics. The ECMAScript Internationalization API supports certain operations that depend upon the current state of the language tag registry (stored in the Unicode Common Locale Data Repository, CLDR, a repository of all locale-specific characteristics) that specifies subtag semantics:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Intl.getCanonicalLocales</span></code> and <code class="docutils literal notranslate"><span class="pre">Intl.Locale</span></code> must replace alias subtags with their preferred forms. For example, <code class="docutils literal notranslate"><span class="pre">ar-u-ca-islamic-civil</span></code> uses the preferred Islamic calendar subtag, while <code class="docutils literal notranslate"><span class="pre">ar-u-ca-islamicc</span></code> uses an alias.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Intl.Locale.prototype.maximize</span></code> and <code class="docutils literal notranslate"><span class="pre">Intl.Locale.prototype.minimize</span></code> accept a language tag and add or remove “likely” subtags from it. For example, <code class="docutils literal notranslate"><span class="pre">de</span></code> most likely refers to German using Latin script in Germany, so it maximizes to <code class="docutils literal notranslate"><span class="pre">de-Latn-DE</span></code> – and in reverse, <code class="docutils literal notranslate"><span class="pre">de-Latn-DE</span></code> minimizes to simply <code class="docutils literal notranslate"><span class="pre">de</span></code>.</p></li>
</ul>
<p>These decisions vary over time: as countries change <a class="footnote-reference brackets" href="#soviet-union" id="id8">8</a>, as customs change, as language prevalence in regions varies, etc.</p>
<dl class="footnote brackets">
<dt class="label" id="soviet-union"><span class="brackets"><a class="fn-backref" href="#id8">8</a></span></dt>
<dd><p>For just one relevant example, the breakup of the Soviet Union is the cause of numerous entries in the language tag registry. <code class="docutils literal notranslate"><span class="pre">ru-SU</span></code>, Russian as used in the Soviet Union, is now expressed as <code class="docutils literal notranslate"><span class="pre">ru-RU</span></code>, Russian as used in Russia; <code class="docutils literal notranslate"><span class="pre">ab-SU</span></code>, Abkhazian as used in the Soviet Union, is now expressed as <code class="docutils literal notranslate"><span class="pre">ab-GE</span></code>, Abkhazian as used in Georgia; and so on for all the other satellite states.</p>
</dd>
</dl>
<p>Use <code class="docutils literal notranslate"><span class="pre">make_intl_data.py</span></code>’s <code class="docutils literal notranslate"><span class="pre">langtags</span></code> mode to update language tag information to the same CLDR version used by ICU:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="s2">&quot;</span><span class="nv">$topsrcdir</span><span class="s2">/js/src/builtin/intl&quot;</span>
$ <span class="c1"># make_intl_data.py requires yaml.</span>
$ <span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$topsrcdir</span><span class="s2">/third_party/python/PyYAML/lib3/&quot;</span>
$ python3 ./make_intl_data.py langtags
</pre></div>
</div>
<p>The CLDR version used will be printed in the header of CLDR-sensitive generated files. For example, <code class="docutils literal notranslate"><span class="pre">js/src/builtin/intl/LanguageTagGenerated.cpp</span></code> currently begins with:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Generated by make_intl_data.py. DO NOT EDIT.</span>
<span class="c1">// Version: CLDR-37</span>
<span class="c1">// URL: https://unicode.org/Public/cldr/37/core.zip</span>
</pre></div>
</div>
</div>
<div class="section" id="updating-spidermonkey-currency-support">
<h5>Updating SpiderMonkey currency support<a class="headerlink" href="#updating-spidermonkey-currency-support" title="Permalink to this headline">¶</a></h5>
<p>Currencies use different numbers of fractional digits in their preferred formatting. Most currencies use two decimal digits; a handful use no fractional digits or some other number. Currency fractional digit is maintained by ISO and must be updated as currencies change their preferred fractional digits or new currencies arise that don’t use two decimal digits.</p>
<p>Currency updates are fairly uncommon, so it’ll be rare to need to update currency info. A <a class="reference external" href="https://www.currency-iso.org/en/home/amendments/newsletter.html">newsletter</a> periodically sends updates about changes.</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">make_intl_data.py</span></code>’s <code class="docutils literal notranslate"><span class="pre">currency</span></code> mode to update currency fractional digit information:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="s2">&quot;</span><span class="nv">$topsrcdir</span><span class="s2">/js/src/builtin/intl&quot;</span>
$ <span class="c1"># make_intl_data.py requires yaml.</span>
$ <span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$topsrcdir</span><span class="s2">/third_party/python/PyYAML/lib3/&quot;</span>
$ python3 ./make_intl_data.py currency
</pre></div>
</div>
</div>
<div class="section" id="updating-spidermonkey-measurement-formatting-support">
<h5>Updating SpiderMonkey measurement formatting support<a class="headerlink" href="#updating-spidermonkey-measurement-formatting-support" title="Permalink to this headline">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">Intl</span></code> API supports formatting numbers as measurement units (for example, “17 meters” or “42 meters per second”). It specifies a list of units that must be supported, that we centrally record in <code class="docutils literal notranslate"><span class="pre">js/src/builtin/intl/SanctionedSimpleUnitIdentifiers.yaml</span></code>, that we verify are supported by ICU and generate supporting files from.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">Intl</span></code>’s list of supported units is ever updated, two separate changes will be required.</p>
<p>First, <code class="docutils literal notranslate"><span class="pre">intl/icu/data_filter.json</span></code> must be updated to incorporate localized strings for the new unit. These strings are stored in <code class="docutils literal notranslate"><span class="pre">icudtNNE.dat</span></code>, so you’ll have to re-update ICU (and likely reimport <code class="docutils literal notranslate"><span class="pre">tzdata</span></code> as well, if it’s been updated since the last ICU update) to rewrite that file.</p>
<p>Second, use <code class="docutils literal notranslate"><span class="pre">make_intl_data.py</span></code>’s <code class="docutils literal notranslate"><span class="pre">units</span></code> mode to update unit handling and associated tests in SpiderMonkey:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="s2">&quot;</span><span class="nv">$topsrcdir</span><span class="s2">/js/src/builtin/intl&quot;</span>
$ <span class="c1"># make_intl_data.py requires yaml.</span>
$ <span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$topsrcdir</span><span class="s2">/third_party/python/PyYAML/lib3/&quot;</span>
$ python3 ./make_intl_data.py units
</pre></div>
</div>
</div>
<div class="section" id="updating-spidermonkey-numbering-systems-support">
<h5>Updating SpiderMonkey numbering systems support<a class="headerlink" href="#updating-spidermonkey-numbering-systems-support" title="Permalink to this headline">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">Intl</span></code> API also supports formatting numbers in various numbering systems (for example, “123“ using Latin numbers or “一二三“ using Han decimal numbers). The list of numbering systems that we must support is stored in <code class="docutils literal notranslate"><span class="pre">js/src/builtin/intl/NumberingSystems.yaml</span></code>. We verify these numbering systems are supported by ICU and generate supporting files from it.</p>
<p>When the list of supported numbering systems needs to be updated, run <code class="docutils literal notranslate"><span class="pre">make_intl_data.py</span></code> with the <code class="docutils literal notranslate"><span class="pre">numbering</span></code> mode to update it and associated tests in SpiderMonkey:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="s2">&quot;</span><span class="nv">$topsrcdir</span><span class="s2">/js/src/builtin/intl&quot;</span>
$ <span class="c1"># make_intl_data.py requires yaml.</span>
$ <span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$topsrcdir</span><span class="s2">/third_party/python/PyYAML/lib3/&quot;</span>
$ python3 ./make_intl_data.py numbering
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../l10n/index.html" class="btn btn-neutral float-right" title="Localization" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="dataintl.html" class="btn btn-neutral float-left" title="UI Internationalization" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>