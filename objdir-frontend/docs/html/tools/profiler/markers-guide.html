

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Markers &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Profiling Memory" href="memory.html" />
    <link rel="prev" title="LUL" href="LUL.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Gecko Profiler</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="buffer.html">Buffers and Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="ci-automation.html">CI Automation</a></li>
<li class="toctree-l2"><a class="reference internal" href="instrumenting-java.html">Instrumenting Java</a></li>
<li class="toctree-l2"><a class="reference internal" href="instrumenting-javascript.html">Instrumenting JavaScript</a></li>
<li class="toctree-l2"><a class="reference internal" href="instrumenting-rust.html">Instrumenting Rust</a></li>
<li class="toctree-l2"><a class="reference internal" href="jstracer.html">JS Tracer</a></li>
<li class="toctree-l2"><a class="reference internal" href="LUL.html">LUL</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Markers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#where-to-define-new-marker-types">Where to Define New Marker Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-define-new-marker-types">How to Define New Marker Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="#marker-architecture-description">Marker Architecture Description</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="memory.html">Profiling Memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="registering-threads.html">Registering Threads</a></li>
<li class="toctree-l2"><a class="reference internal" href="samples-stackwalking.html">Samples and Stack Walking</a></li>
<li class="toctree-l2"><a class="reference internal" href="serialization.html">Serialization</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Gecko Profiler</a> &raquo;</li>
        
      <li>Markers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/tools/profiler/markers-guide.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="markers">
<h1>Markers<a class="headerlink" href="#markers" title="Permalink to this headline">¶</a></h1>
<div class="section" id="where-to-define-new-marker-types">
<h2>Where to Define New Marker Types<a class="headerlink" href="#where-to-define-new-marker-types" title="Permalink to this headline">¶</a></h2>
<p>The first step is to determine the location of the file, based on its dependency for XUL.
If there is no dependency, then it can be defined in the Base Profiler, which can be used
in the most locations in the codebase:</p>
<p><a class="reference external" href="https://searchfox.org/mozilla-central/source/mozglue/baseprofiler/public/BaseProfilerMarkerTypes.h">mozglue/baseprofiler/public/BaseProfilerMarkerTypes.h</a></p>
<p>However, if there is a XUL dependency, then it needs to be defined in the Gecko Profiler.</p>
<p><a class="reference external" href="https://searchfox.org/mozilla-central/source/tools/profiler/public/ProfilerMarkerTypes.h">tools/profiler/public/ProfilerMarkerTypes.h</a></p>
</div>
<div class="section" id="how-to-define-new-marker-types">
<h2>How to Define New Marker Types<a class="headerlink" href="#how-to-define-new-marker-types" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">YourMarker</span> <span class="p">{</span>
  <span class="k">static</span> <span class="k">constexpr</span> <span class="n">Span</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">&gt;</span> <span class="n">MarkerTypeName</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">MakeStringSpan</span><span class="p">(</span><span class="s">&quot;YourMarker&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">static</span> <span class="n">MarkerSchemaWriter</span> <span class="n">MarkerTypeDisplay</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">MarkerSchemaWriter</span> <span class="n">schema</span><span class="p">;</span>
    <span class="k">using</span> <span class="n">S</span> <span class="o">=</span> <span class="n">MarkerSchemaWriter</span><span class="p">;</span>

    <span class="c1">// Determine where this marker shows up in the profiler.firefox.com UI.</span>
    <span class="n">schema</span><span class="p">.</span><span class="n">AddLocations</span><span class="p">(</span><span class="n">S</span><span class="o">::</span><span class="n">Location</span><span class="o">::</span><span class="n">markerChart</span><span class="p">,</span> <span class="n">S</span><span class="o">::</span><span class="n">Location</span><span class="o">::</span><span class="n">markerTable</span><span class="p">);</span>

    <span class="c1">// The labels will show up in tooltips with proper formatting of the values.</span>
    <span class="c1">// In addition, this will help not leak sensitive user information, as information</span>
    <span class="c1">// such as URLs can properly be sanitized.</span>
    <span class="n">schema</span><span class="p">.</span><span class="n">AddKeyLabelFormat</span><span class="p">(</span>
        <span class="s">&quot;myString&quot;</span><span class="p">,</span> <span class="s">&quot;My String&quot;</span><span class="p">,</span> <span class="n">S</span><span class="o">::</span><span class="n">Format</span><span class="o">::</span><span class="n">string</span><span class="p">);</span>
    <span class="n">schema</span><span class="p">.</span><span class="n">AddKeyLabelFormat</span><span class="p">(</span>
        <span class="s">&quot;myBytes&quot;</span><span class="p">,</span> <span class="s">&quot;My Bytes&quot;</span><span class="p">,</span> <span class="n">S</span><span class="o">::</span><span class="n">Format</span><span class="o">::</span><span class="n">bytes</span><span class="p">);</span>
    <span class="n">schema</span><span class="p">.</span><span class="n">AddKeyLabelFormat</span><span class="p">(</span>
        <span class="s">&quot;myUrl&quot;</span><span class="p">,</span> <span class="s">&quot;My URL&quot;</span><span class="p">,</span> <span class="n">S</span><span class="o">::</span><span class="n">Format</span><span class="o">::</span><span class="n">url</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">schema</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">static</span> <span class="kt">void</span> <span class="n">StreamJSONMarkerData</span><span class="p">(</span><span class="n">JSONWriter</span><span class="o">&amp;</span> <span class="n">aWriter</span><span class="p">,</span>
                                    <span class="k">const</span> <span class="n">ProfilerString8View</span><span class="o">&amp;</span> <span class="n">aString</span><span class="p">,</span>
                                    <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">aBytes</span>
                                    <span class="k">const</span> <span class="n">ProfilerString8View</span><span class="o">&amp;</span> <span class="n">aURL</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// This JSONWriter will write out the custom information for this</span>
    <span class="c1">// marker payload. The arguments are populated by the variadic</span>
    <span class="c1">// profiler_add_marker&lt;T&gt; function call.</span>
    <span class="n">aWriter</span><span class="p">.</span><span class="n">StringProperty</span><span class="p">(</span><span class="s">&quot;myString&quot;</span><span class="p">,</span> <span class="n">aString</span><span class="p">);</span>
    <span class="n">aWriter</span><span class="p">.</span><span class="n">IntProperty</span><span class="p">(</span><span class="s">&quot;myBytes&quot;</span><span class="p">,</span> <span class="n">aBytes</span><span class="p">);</span>
    <span class="n">aWriter</span><span class="p">.</span><span class="n">StringProperty</span><span class="p">(</span><span class="s">&quot;aURL&quot;</span><span class="p">,</span> <span class="n">aurl</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Then in your code, this marker can be used like so:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;GeckoProfiler.h&quot;</span><span class="cp"></span>

<span class="n">profiler_add_marker</span><span class="o">&lt;</span><span class="n">YourMarker</span><span class="o">&gt;</span><span class="p">({</span>
    <span class="s">&quot;YourMarker&quot;</span><span class="p">,</span>
    <span class="c1">// The default marker options, see documentation below.</span>
    <span class="n">geckoprofiler</span><span class="o">::</span><span class="n">category</span><span class="o">::</span><span class="n">DOM</span><span class="p">.</span><span class="n">WithOptions</span><span class="p">(</span>
        <span class="n">MarkerTiming</span><span class="o">::</span><span class="n">Instant</span><span class="p">(),</span>
        <span class="n">MarkerInnerWindowId</span><span class="p">(</span><span class="n">innerWindowId</span><span class="p">)),</span>
    <span class="c1">// The rest of the arguments are variadic, and should match the order</span>
    <span class="c1">// in StreamJSONMarkerData.</span>
    <span class="n">myString</span><span class="p">,</span> <span class="n">myBytes</span><span class="p">,</span> <span class="n">myUrl</span><span class="p">);</span>
</pre></div>
</div>
<p>The full list of available categories is located in:</p>
<p><a class="reference external" href="https://searchfox.org/mozilla-central/source/mozglue/baseprofiler/public/ProfilingCategoryList.h">mozglue/baseprofiler/public/ProfilingCategoryList.h</a></p>
</div>
<div class="section" id="marker-architecture-description">
<h2>Marker Architecture Description<a class="headerlink" href="#marker-architecture-description" title="Permalink to this headline">¶</a></h2>
<p>The above sections should give all the information needed for adding your own marker
types. However, if you are wanting to work on the marker architecture itself, this
section will describe how the system works.</p>
<dl class="simple">
<dt>TODO:</dt><dd><ul class="simple">
<li><p>Briefly describe the buffer and serialization.</p></li>
<li><p>Describe the template strategy for generating marker types</p></li>
<li><p>Describe the serialization, and link to profiler front-end docs on marker processing (if they exist)</p></li>
</ul>
</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="memory.html" class="btn btn-neutral float-right" title="Profiling Memory" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="LUL.html" class="btn btn-neutral float-left" title="LUL" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>