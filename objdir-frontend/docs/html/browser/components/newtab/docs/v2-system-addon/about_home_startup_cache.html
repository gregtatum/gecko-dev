

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>The about:home startup cache &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/underscore.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
        <script src="../../../../../_static/language_data.js"></script>
        <script src="../../../../../_static/clipboard.min.js"></script>
        <script src="../../../../../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
    <link rel="next" title="Activity Stream Pings" href="data_dictionary.html" />
    <link rel="prev" title="Firefox Home (New Tab)" href="../index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../../../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../../index.html">Firefox</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../../urlbar/index.html">Address Bar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../BrowserUsageTelemetry.html">Browser Usage Telemetry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../enterprisepolicies/docs/index.html">Enterprise Policies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../extensions/formautofill/docs/index.html">Form Autofill</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Firefox Home (New Tab)</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../index.html#for-jsm-files">For .jsm files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#for-js-jsx-sass-or-css-files">For .js, .jsx, .sass, or .css files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#building-assets-and-running-firefox">Building assets and running Firefox</a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#continuous-development-debugging">Continuous development / debugging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#running-tests">Running tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#code-coverage">Code Coverage</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../index.html#detailed-docs">Detailed Docs</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">The <code class="docutils literal notranslate"><span class="pre">about:home</span></code> startup cache</a></li>
<li class="toctree-l4"><a class="reference internal" href="data_dictionary.html">Activity Stream Pings</a></li>
<li class="toctree-l4"><a class="reference internal" href="data_events.html">Metrics we collect</a></li>
<li class="toctree-l4"><a class="reference internal" href="geo_locale.html">Custom <code class="docutils literal notranslate"><span class="pre">geo</span></code>, <code class="docutils literal notranslate"><span class="pre">locale</span></code>, and update channels</a></li>
<li class="toctree-l4"><a class="reference internal" href="mochitests.html">Mochitests</a></li>
<li class="toctree-l4"><a class="reference internal" href="preferences.html">Preferences</a></li>
<li class="toctree-l4"><a class="reference internal" href="remote_cfr.html">Remote CFR Messages</a></li>
<li class="toctree-l4"><a class="reference internal" href="sections.html">Sections</a></li>
<li class="toctree-l4"><a class="reference internal" href="telemetry.html">Telemetry checklist</a></li>
<li class="toctree-l4"><a class="reference internal" href="tippytop.html">TippyTop in Activity Stream</a></li>
<li class="toctree-l4"><a class="reference internal" href="unit_testing_guide.html">Unit testing</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../installer/windows/installer/index.html">Installer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../toolkit/mozapps/defaultagent/default-browser-agent/index.html">Default Browser Agent</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../content-src/asrouter/docs/index.html">Messaging System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../base/sslerrorreport/index.html">SSL Error Reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../base/tabbrowser/index.html">tabbrowser</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../touchbar/index.html">Touch Bar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../uitour/docs/index.html">UITour</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../payments/docs/index.html">WebPayments UI</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../../index.html">Firefox</a> &raquo;</li>
        
          <li><a href="../index.html">Firefox Home (New Tab)</a> &raquo;</li>
        
      <li>The <code class="docutils literal notranslate"><span class="pre">about:home</span></code> startup cache</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../../../_sources/browser/components/newtab/docs/v2-system-addon/about_home_startup_cache.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="the-about-home-startup-cache">
<h1>The <code class="docutils literal notranslate"><span class="pre">about:home</span></code> startup cache<a class="headerlink" href="#the-about-home-startup-cache" title="Permalink to this headline">¶</a></h1>
<p>By default, a user’s browser session starts with a single window and a single tab, pointed at about:home. This means that it’s important to ensure that <code class="docutils literal notranslate"><span class="pre">about:home</span></code> loads as quickly as possible to provide a fast overall startup experience.</p>
<p><code class="docutils literal notranslate"><span class="pre">about:home</span></code>, which is functionally identical to <code class="docutils literal notranslate"><span class="pre">about:newtab</span></code>, is generated dynamically by calculating an appropriate state object in the parent process, and passing it down to a content process into the React library in order to render the final interactive page. This is problematic during the startup sequence, as calculating that initial state can be computationally expensive, and requires multiple reads from the disk.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">about:home</span></code> startup cache is an attempt to address this expense. It works by assuming that between browser sessions, <code class="docutils literal notranslate"><span class="pre">about:home</span></code> <em>usually</em> doesn’t need to change.</p>
<div class="section" id="components-of-the-about-home-startup-cache-mechanism">
<h2>Components of the <code class="docutils literal notranslate"><span class="pre">about:home</span></code> startup cache mechanism<a class="headerlink" href="#components-of-the-about-home-startup-cache-mechanism" title="Permalink to this headline">¶</a></h2>
<p>There are 3 primary components to the cache mechanism:</p>
<div class="section" id="the-http-cache">
<h3>The HTTP Cache<a class="headerlink" href="#the-http-cache" title="Permalink to this headline">¶</a></h3>
<p>The HTTP cache is normally used for caching webpages retrieved over the network, but seemed like the right fit for storage of the <code class="docutils literal notranslate"><span class="pre">about:home</span></code> cache as well.</p>
<p>The HTTP cache is usually queried by the networking stack when browsing the web. The HTTP cache is, however, not typically queried when accessing <code class="docutils literal notranslate"><span class="pre">chrome://</span></code> or <code class="docutils literal notranslate"><span class="pre">resource://</span></code> URLs, so we have to do it ourselves, manually for the <code class="docutils literal notranslate"><span class="pre">about:home</span></code> case. This means giving <code class="docutils literal notranslate"><span class="pre">about:home</span></code> special capabilities for populating and reading from the HTTP cache. In order to avoid potential security issues, this requires that we sequester <code class="docutils literal notranslate"><span class="pre">about:home</span></code> / <code class="docutils literal notranslate"><span class="pre">about:newtab</span></code> in their own special content process. The “privileged about content process” exists for this purpose, and is also used for <code class="docutils literal notranslate"><span class="pre">about:logins</span></code> and <code class="docutils literal notranslate"><span class="pre">about:certificate</span></code>.</p>
<p>The HTTP cache lives in the parent process, and so any read and write operations need to be initiated in the parent process. Thankfully, however, the HTTP cache accepts data using <code class="docutils literal notranslate"><span class="pre">nsIOutputStream</span></code> and serves it using <code class="docutils literal notranslate"><span class="pre">nsIInputStream</span></code>. We can send <code class="docutils literal notranslate"><span class="pre">nsIInputStream</span></code> over the message manager, and convert an <code class="docutils literal notranslate"><span class="pre">nsIInputStream</span></code> into an <code class="docutils literal notranslate"><span class="pre">nsIOutputStream</span></code>, so we have everything we need to efficiently communicate with the “privileged about content process” to save and retrieve page data.</p>
<p>The official documentation for the HTTP cache <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Mozilla/HTTP_cache">can be found here</a>.</p>
</div>
<div class="section" id="abouthomestartupcache">
<h3><code class="docutils literal notranslate"><span class="pre">AboutHomeStartupCache</span></code><a class="headerlink" href="#abouthomestartupcache" title="Permalink to this headline">¶</a></h3>
<p>This singleton component lives inside of <code class="docutils literal notranslate"><span class="pre">BrowserGlue</span></code> to avoid having to load yet another JSM out of the <code class="docutils literal notranslate"><span class="pre">omni.ja</span></code> file in the parent process during startup.</p>
<p><code class="docutils literal notranslate"><span class="pre">AboutHomeStartupCache</span></code> is responsible for feeding the “privileged about content process” with the <code class="docutils literal notranslate"><span class="pre">nsIInputStream</span></code>’s that it needs to present the initial <code class="docutils literal notranslate"><span class="pre">about:home</span></code> document. It is also responsible for populating the cache with updated versions of <code class="docutils literal notranslate"><span class="pre">about:home</span></code> that are sent by the “privileged about content process”.</p>
<p>Since accessing the HTTP cache is asynchronous, there is an opportunity for a race, where the cache can either be accessed and available before the initial <code class="docutils literal notranslate"><span class="pre">about:home</span></code> is requested, or after. To accommodate for both cases, the <code class="docutils literal notranslate"><span class="pre">AboutHomeStartupCache</span></code> constructs <code class="docutils literal notranslate"><span class="pre">nsIPipe</span></code> instances, which it sends down to the “privileged about content process” as soon as one launches.</p>
<p>If the HTTP cache entry is already available when the process launches, and cached data is available, we connect the cache to the <code class="docutils literal notranslate"><span class="pre">nsIPipe</span></code>’s to stream the data down to the “privileged about content process”.</p>
<p>If the HTTP cache is not yet available, we hold references to those <code class="docutils literal notranslate"><span class="pre">nsIPipe</span></code> instances, and wait until the cache entry is available. Only then do we connect the cache entry to the <code class="docutils literal notranslate"><span class="pre">nsIPipe</span></code> instances to send the data down to the “privileged about content process”.</p>
</div>
<div class="section" id="aboutnewtabservice">
<h3><code class="docutils literal notranslate"><span class="pre">AboutNewTabService</span></code><a class="headerlink" href="#aboutnewtabservice" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">AboutNewTabService</span></code> is used by the <code class="docutils literal notranslate"><span class="pre">AboutRedirector</span></code> in both the parent and content processes to determine how to handle attempts to load <code class="docutils literal notranslate"><span class="pre">about:home</span></code> and <code class="docutils literal notranslate"><span class="pre">about:newtab</span></code>.</p>
<p>There are distinct versions of the <code class="docutils literal notranslate"><span class="pre">AboutNewTabService</span></code> - one for the parent process (<code class="docutils literal notranslate"><span class="pre">BaseAboutNewTabService</span></code>), and one for content processes (<code class="docutils literal notranslate"><span class="pre">AboutNewTabChildService</span></code>, which inherits from <code class="docutils literal notranslate"><span class="pre">BaseAboutNewTabService</span></code>).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">AboutRedirector</span></code>, when running inside of a “privileged about content process” knows to direct attempts to load <code class="docutils literal notranslate"><span class="pre">about:home</span></code> to <code class="docutils literal notranslate"><span class="pre">AboutNewTabChildService</span></code>’s <code class="docutils literal notranslate"><span class="pre">aboutHomeCacheChannel</span></code> method. This method is then responsible for choosing whether or not to return an <code class="docutils literal notranslate"><span class="pre">nsIChannel</span></code> for the cached document, or for the dynamically generated version of <code class="docutils literal notranslate"><span class="pre">about:home</span></code>.</p>
</div>
<div class="section" id="abouthomestartupcachechild">
<h3><code class="docutils literal notranslate"><span class="pre">AboutHomeStartupCacheChild</span></code><a class="headerlink" href="#abouthomestartupcachechild" title="Permalink to this headline">¶</a></h3>
<p>This singleton component lives inside of the “privileged about content process”, and is initialized as soon as the message is received from the parent that includes the <code class="docutils literal notranslate"><span class="pre">nsIInputStream</span></code>’s that will be used to potentially load from the cache.</p>
<p>When the <code class="docutils literal notranslate"><span class="pre">AboutRedirector</span></code> in the “privileged about content process” notices that a request has been made to <code class="docutils literal notranslate"><span class="pre">about:home</span></code>, it asks <code class="docutils literal notranslate"><span class="pre">nsIAboutNewTabService</span></code> to return a new <code class="docutils literal notranslate"><span class="pre">nsIChannel</span></code> for that document. The <code class="docutils literal notranslate"><span class="pre">AboutNewTabChildService</span></code> then checks to see if the <code class="docutils literal notranslate"><span class="pre">AboutHomeStartupCacheChild</span></code> can return an <code class="docutils literal notranslate"><span class="pre">nsIChannel</span></code> for any cached content.</p>
<p>If, at this point, nothing has been streamed from the parent, we fall back to loading the dynamic <code class="docutils literal notranslate"><span class="pre">about:home</span></code> document. This might occur if the cache doesn’t exist yet, or if we were too slow to pull it off of the disk.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">AboutHomeStartupCacheChild</span></code> will also be responsible for generating the cache periodically. Periodically, the <code class="docutils literal notranslate"><span class="pre">AboutNewTabService</span></code> will send down the most up-to-date state for <code class="docutils literal notranslate"><span class="pre">about:home</span></code> from the parent process, and then the <code class="docutils literal notranslate"><span class="pre">AboutHomeStartupCacheChild</span></code> will generate document markup using ReactDOMServer within a <code class="docutils literal notranslate"><span class="pre">ChromeWorker</span></code>. After that’s generated, the “privileged about content process” will send up <code class="docutils literal notranslate"><span class="pre">nsIInputStream</span></code> instances for both the markup and the script for the initial page state. The <code class="docutils literal notranslate"><span class="pre">AboutHomeStartupCache</span></code> singleton inside of <code class="docutils literal notranslate"><span class="pre">BrowserGlue</span></code> is responsible for receiving those <code class="docutils literal notranslate"><span class="pre">nsIInputStream</span></code>’s and persisting them in the HTTP cache for the next start.</p>
</div>
</div>
<div class="section" id="what-is-cached">
<h2>What is cached?<a class="headerlink" href="#what-is-cached" title="Permalink to this headline">¶</a></h2>
<p>Two things are cached:</p>
<ol class="simple">
<li><p>The raw HTML mark-up of <code class="docutils literal notranslate"><span class="pre">about:home</span></code>.</p></li>
<li><p>A small chunk of JavaScript that “hydrates” the markup through the React libraries, allowing the page to become interactive after painting.</p></li>
</ol>
<p>The JavaScript being cached cannot be put directly into the HTML mark-up as inline script due to the CSP of <code class="docutils literal notranslate"><span class="pre">about:home</span></code>, which does not allow inline scripting. Instead, we load a script from <code class="docutils literal notranslate"><span class="pre">about:home?jscache</span></code>. This goes through the same mechanism for retrieving the HTML document from the cache, but instead pulls down the cached script.</p>
<p>If the HTML mark-up is cached, then we presume that the script is also cached. We cannot cache one and not the other. If only one cache exists, or only one has been sent down to the “privileged about content process” by the time the <code class="docutils literal notranslate"><span class="pre">about:home</span></code> document is requested, then we fallback to loading the dynamic <code class="docutils literal notranslate"><span class="pre">about:home</span></code> document.</p>
</div>
<div class="section" id="refreshing-the-cache">
<h2>Refreshing the cache<a class="headerlink" href="#refreshing-the-cache" title="Permalink to this headline">¶</a></h2>
<p>The cache is refreshed periodically by having <code class="docutils literal notranslate"><span class="pre">ActivityStreamMessageChannel</span></code> tell <code class="docutils literal notranslate"><span class="pre">AboutHomeStartupCache</span></code> when it has sent any messages down to the preloaded <code class="docutils literal notranslate"><span class="pre">about:newtab</span></code>. In general, such messages are a good hint that something visual has updated for the next <code class="docutils literal notranslate"><span class="pre">about:newtab</span></code>, and that the cache should probably be refreshed.</p>
<p><code class="docutils literal notranslate"><span class="pre">AboutHomeStartupCache</span></code> debounces notifications about such messages, since they tend to be bursty.</p>
</div>
<div class="section" id="invalidating-the-cache">
<h2>Invalidating the cache<a class="headerlink" href="#invalidating-the-cache" title="Permalink to this headline">¶</a></h2>
<p>It’s possible that the composition or layout of <code class="docutils literal notranslate"><span class="pre">about:home</span></code> will change over time from release to release. When this occurs, it might be desirable to invalidate any pre-existing cache that might exist for a user, so that they don’t see an outdated <code class="docutils literal notranslate"><span class="pre">about:home</span></code> on startup.</p>
<p>To do this, we set a version number on the cache entry, and ensure that the version number is equal to our expectations on startup. If the version number does not match our expectation, then the cache is discarded and the <code class="docutils literal notranslate"><span class="pre">about:home</span></code> document will be rendered dynamically.</p>
<p>The version number is currently set to the application build ID. This means that when the application updates, the cache is invalidated on the first restart after a browser update is applied.</p>
</div>
<div class="section" id="handling-errors">
<h2>Handling errors<a class="headerlink" href="#handling-errors" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">about:home</span></code> is typically the first thing that the user sees upon starting the browser. It is critically important that it function quickly and correctly. If anything happens to go wrong when retrieving or saving to the cache, we should fall back to generating the document dynamically.</p>
<p>As an example, it’s theoretically possible for the browser to crash while in the midst of saving to the cache. In that case, we might have a partial document saved, or a partial script saved - neither of which is acceptable.</p>
<p>Thankfully, the HTTP cache was designed with resilience in mind, so partially written entries are automatically discarded, which allows us to fall back to the dynamic page generation mode.</p>
<p>As additional redundancy to that resilience, we also make sure to create a new nsICacheEntry every time the cache is populated, and write the version metadata as the last step. Since the version metadata is written last, we know that if it’s missing when we try to load the cache that the writing of the page and the script did not complete, and that we should fall back to dynamically rendering the page.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="data_dictionary.html" class="btn btn-neutral float-right" title="Activity Stream Pings" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../index.html" class="btn btn-neutral float-left" title="Firefox Home (New Tab)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>