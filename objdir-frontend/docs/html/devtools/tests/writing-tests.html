

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Automated tests: writing tests &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Debugging Intermittent Test Failures" href="debugging-intermittents.html" />
    <link rel="prev" title="DevTools node tests" href="node-tests.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Firefox DevTools Contributor Docs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#getting-started">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#contributing">Contributing</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#automated-tests">Automated tests</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="README.html">Automated tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="xpcshell.html">xpcshell</a></li>
<li class="toctree-l3"><a class="reference internal" href="mochitest-chrome.html">Chrome mochitests</a></li>
<li class="toctree-l3"><a class="reference internal" href="mochitest-devtools.html">DevTools mochitests</a></li>
<li class="toctree-l3"><a class="reference internal" href="node-tests.html">Node tests</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Writing tests</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#adding-a-new-browser-chrome-test">Adding a new browser chrome test</a></li>
<li class="toctree-l4"><a class="reference internal" href="#leveraging-helpers-in-head-js">Leveraging helpers in <code class="docutils literal notranslate"><span class="pre">head.js</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#shared-head-js-file">Shared head.js file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#electrolysis">Electrolysis</a></li>
<li class="toctree-l4"><a class="reference internal" href="#asynchronous-tests">Asynchronous tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#writing-clean-maintainable-test-code">Writing clean, maintainable test code</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-new-helpers">Adding new helpers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="debugging-intermittents.html">Debugging intermittent failures</a></li>
<li class="toctree-l3"><a class="reference internal" href="performance-tests.html">Performance tests (DAMP)</a></li>
<li class="toctree-l3"><a class="reference internal" href="writing-perf-tests.html">Writing new performance test</a></li>
<li class="toctree-l3"><a class="reference internal" href="writing-perf-tests.html#how-to-name-your-test-and-register-it">How to name your test and register it?</a></li>
<li class="toctree-l3"><a class="reference internal" href="writing-perf-tests.html#how-to-run-your-new-test">How to run your new test?</a></li>
<li class="toctree-l3"><a class="reference internal" href="writing-perf-tests-example.html">Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="writing-perf-tests-tips.html">Advanced tips</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#files-and-directories">Files and directories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#tool-architectures">Tool Architectures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#frontend">Frontend</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#backend">Backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#preferences">Preferences</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#about-this-documentation">About this documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Firefox DevTools Contributor Docs</a> &raquo;</li>
        
      <li>Automated tests: writing tests</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/devtools/tests/writing-tests.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="automated-tests-writing-tests">
<h1>Automated tests: writing tests<a class="headerlink" href="#automated-tests-writing-tests" title="Permalink to this headline">¶</a></h1>
<!--TODO this file might benefit from being split in other various files. For now it's just taken from the wiki with some edits--><div class="section" id="adding-a-new-browser-chrome-test">
<h2>Adding a new browser chrome test<a class="headerlink" href="#adding-a-new-browser-chrome-test" title="Permalink to this headline">¶</a></h2>
<p>It’s almost always a better idea to create a new test file rather than to add new test cases to an existing one.</p>
<p>This prevents test files from growing up to the point where they timeout for running too long. Test systems may be under lots of stress at time and run a lot slower than your regular local environment.</p>
<p>It also helps with making tests more maintainable: with many small files, it’s easier to track a problem rather than in one huge file.</p>
<div class="section" id="creating-the-new-file">
<h3>Creating the new file<a class="headerlink" href="#creating-the-new-file" title="Permalink to this headline">¶</a></h3>
<p>The first thing you need to do is create a file. This file should go next to the code it’s testing, in the <code class="docutils literal notranslate"><span class="pre">tests</span></code> directory. For example, an inspector test would go into <code class="docutils literal notranslate"><span class="pre">devtools/inspector/test/</span></code>.</p>
</div>
<div class="section" id="naming-the-new-file">
<h3>Naming the new file<a class="headerlink" href="#naming-the-new-file" title="Permalink to this headline">¶</a></h3>
<p>Naming your file is pretty important to help other people get a feeling of what it is supposed to test.
Having said that, the name shouldn’t be too long either.</p>
<p>A good naming convention is <code class="docutils literal notranslate"><span class="pre">browser_&lt;panel&gt;_&lt;short-description&gt;[_N].js</span></code></p>
<p>where:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;panel&gt;</span></code> is one of <code class="docutils literal notranslate"><span class="pre">debugger</span></code>, <code class="docutils literal notranslate"><span class="pre">markupview</span></code>, <code class="docutils literal notranslate"><span class="pre">inspector</span></code>, <code class="docutils literal notranslate"><span class="pre">ruleview</span></code>, etc.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;short-description&gt;</span></code> should be about 3 to 4 words, separated by hyphens (-)</p></li>
<li><p>and optionally add a number at the end if you have several files testing the same thing</p></li>
</ul>
<p>For example: <code class="docutils literal notranslate"><span class="pre">browser_ruleview_completion-existing-property_01.js</span></code></p>
<p>Note that not all existing tests are consistently named. So the rule we try to follow is to <strong>be consistent with how other tests in the same test folder are named</strong>.</p>
</div>
<div class="section" id="basic-structure-of-a-test">
<h3>Basic structure of a test<a class="headerlink" href="#basic-structure-of-a-test" title="Permalink to this headline">¶</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Any copyright is dedicated to the Public Domain.</span>
<span class="cm">http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

<span class="c1">// A detailed description of what the test is supposed to test</span>

<span class="kr">const</span> <span class="nx">TEST_URL</span> <span class="o">=</span> <span class="nx">TEST_URL_ROOT</span> <span class="o">+</span> <span class="s2">&quot;doc_some_test_page.html&quot;</span><span class="p">;</span>

<span class="nx">add_task</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span><span class="p">()</span> <span class="p">{</span>
<span class="k">yield</span> <span class="nx">addTab</span><span class="p">(</span><span class="nx">TEST_URL_ROOT</span><span class="p">);</span>
<span class="kd">let</span> <span class="p">{</span><span class="nx">toolbox</span><span class="p">,</span> <span class="nx">inspector</span><span class="p">,</span> <span class="nx">view</span><span class="p">}</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">openRuleView</span><span class="p">();</span>
<span class="k">yield</span> <span class="nx">selectNode</span><span class="p">(</span><span class="s2">&quot;#testNode&quot;</span><span class="p">,</span> <span class="nx">inspector</span><span class="p">);</span>
<span class="k">yield</span> <span class="nx">checkSomethingFirst</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
<span class="k">yield</span> <span class="nx">checkSomethingElse</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
<span class="p">});</span>

<span class="kd">function</span><span class="o">*</span> <span class="nx">checkSomethingFirst</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
<span class="cm">/* ... do something ... this function can yield */</span>
<span class="p">}</span>

<span class="kd">function</span><span class="o">*</span> <span class="nx">checkSomethingElse</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
<span class="cm">/* ... do something ... this function can yield */</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="referencing-the-new-file">
<h3>Referencing the new file<a class="headerlink" href="#referencing-the-new-file" title="Permalink to this headline">¶</a></h3>
<p>For your test to be run, it needs to be referenced in the <code class="docutils literal notranslate"><span class="pre">browser.ini</span></code> file that you’ll find in the same directory. For example: <code class="docutils literal notranslate"><span class="pre">browser/devtools/debugger/test/browser.ini</span></code></p>
<p>Add a line with your file name between square brackets, and make sure that the list of files <strong>is always sorted by alphabetical order</strong> (some lists can be really long, so the alphabetical order helps in finding and reasoning about things).</p>
<p>For example, if you were to add the test from the previous section, you’d add this to <code class="docutils literal notranslate"><span class="pre">browser.ini</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[browser_ruleview_completion-existing-property_01.js]</span>
</pre></div>
</div>
</div>
<div class="section" id="adding-support-files">
<h3>Adding support files<a class="headerlink" href="#adding-support-files" title="Permalink to this headline">¶</a></h3>
<p>Sometimes your test may need to open an HTML file in a tab, and it may also need to load CSS or JavaScript. For this to work, you’ll need to…</p>
<ol class="simple">
<li><p>place these files in the same directory, and also</p></li>
<li><p>reference them in the <code class="docutils literal notranslate"><span class="pre">browser.ini</span></code> file.</p></li>
</ol>
<p>There’s a naming convention for support files: <code class="docutils literal notranslate"><span class="pre">doc_&lt;support-some-test&gt;.html</span></code></p>
<p>But again, often names do not follow this convention, so try to follow the style of the other support files currently in the same test directory.</p>
<p>To reference your new support file, add its filename in the <code class="docutils literal notranslate"><span class="pre">support-files</span></code> section of <code class="docutils literal notranslate"><span class="pre">browser.ini</span></code>, also making sure this section is in alphabetical order.</p>
<p>Support files can be accessed via a local server that is started while tests are running. This server is accessible at <a class="reference external" href="http://example.com/browser/">http://example.com/browser/</a>. See the <code class="docutils literal notranslate"><span class="pre">head.js</span> <span class="pre">section</span></code> below for more information.</p>
</div>
</div>
<div class="section" id="leveraging-helpers-in-head-js">
<h2>Leveraging helpers in <code class="docutils literal notranslate"><span class="pre">head.js</span></code><a class="headerlink" href="#leveraging-helpers-in-head-js" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">head.js</span></code> is a special support file that is loaded in the scope the test runs in, before the test starts. It contains global helpers that are useful for most tests. Read through the head.js file in your test directory to see what functions are there and therefore avoid duplicating code.</p>
<p>Each panel in DevTools has its own test directory with its own <code class="docutils literal notranslate"><span class="pre">head.js</span></code>, so you’ll find different things in each panel’s <code class="docutils literal notranslate"><span class="pre">head.js</span></code> file.</p>
<p>For example, the head.js files in the <code class="docutils literal notranslate"><span class="pre">markupview</span></code> and <code class="docutils literal notranslate"><span class="pre">styleinspector</span></code> test folders contain these useful functions and constants:</p>
<ul class="simple">
<li><p>Base URLs for support files: <code class="docutils literal notranslate"><span class="pre">TEST_URL_ROOT</span></code>. This avoids having to duplicate the http://example.com/browser/browser/devtools/styleinspector/ URL fragment in all tests,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">waitForExplicitFinish()</span></code> is called in <code class="docutils literal notranslate"><span class="pre">head.js</span></code> once and for all<!--TODO: what does this even mean?-->. All tests are asynchronous, so there’s no need to call it again in each and every test,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">auto-cleanup</span></code>: the toolbox is closed automatically and all tabs are closed,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tab</span> <span class="pre">addTab(url)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{toolbox,</span> <span class="pre">inspector}</span> <span class="pre">openInspector()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{toolbox,</span> <span class="pre">inspector,</span> <span class="pre">view}</span> <span class="pre">openRuleView()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">selectNode(selectorOrNode,</span> <span class="pre">inspector)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">node</span> <span class="pre">getNode(selectorOrNode)</span></code></p></li>
<li><p>…</p></li>
</ul>
</div>
<div class="section" id="shared-head-js-file">
<h2>Shared head.js file<a class="headerlink" href="#shared-head-js-file" title="Permalink to this headline">¶</a></h2>
<p>A <a class="reference external" href="https://searchfox.org/mozilla-central/source/devtools/client/shared/test/shared-head.js">shared-head.js</a> file has been introduced to avoid duplicating code in various <code class="docutils literal notranslate"><span class="pre">head.js</span></code> files.</p>
<p>It’s important to know whether or not the <code class="docutils literal notranslate"><span class="pre">shared.js</span></code> in your test directory already imports <code class="docutils literal notranslate"><span class="pre">shared-head.js</span></code> (look for a <code>Services.scriptloader.loadSubScript</code> call), as common helpers in <code class="docutils literal notranslate"><span class="pre">shared-head.js</span></code> might be useful for your test.</p>
<p>If you’re planning to work on a lot of new tests, it might be worth the time actually importing <code class="docutils literal notranslate"><span class="pre">shared-head.js</span></code> in your <code class="docutils literal notranslate"><span class="pre">head.js</span></code> if it isn’t here already.</p>
</div>
<div class="section" id="electrolysis">
<h2>Electrolysis<a class="headerlink" href="#electrolysis" title="Permalink to this headline">¶</a></h2>
<p>E10S is the codename for Firefox multi-process, and what that means for us is that the process in which the test runs isn’t the same as the one in which the test content page runs.</p>
<p>You can learn more about E10S <a class="reference external" href="https://timtaubert.de/blog/2011/08/firefox-electrolysis-101/">from this blog post</a>, <a class="reference external" href="https://wiki.mozilla.org/Electrolysis">the Electrolysis wiki page</a> and the page on <a class="reference external" href="https://wiki.mozilla.org/Electrolysis/e10s_test_tips">tests and E10s</a>.</p>
<p>One of the direct consequences of E10S on tests is that you cannot retrieve and manipulate objects from the content page as you’d do without E10S.</p>
<p>So when creating a new test, if this test needs to access the content page in any way, you can use <a class="reference external" href="https://developer.mozilla.org/en-US/docs/The_message_manager">the message manager</a> to communicate with a script loaded in the content process to do things for you instead of accessing objects in the page directly.</p>
<p>You can use the helper <code class="docutils literal notranslate"><span class="pre">ContentTask.spawn()</span></code> for this. See <a class="reference external" href="https://searchfox.org/mozilla-central/search?q=ContentTask.spawn%28&amp;path=devtools%2Fclient">this list of DevTools tests that use that helper for examples</a>.</p>
<p>Note that a lot of tests only need to access the DevTools UI anyway, and don’t need to interact with the content process at all. Since the UI lives in the same process as the test, you won’t need to use the message manager to access it.</p>
</div>
<div class="section" id="asynchronous-tests">
<h2>Asynchronous tests<a class="headerlink" href="#asynchronous-tests" title="Permalink to this headline">¶</a></h2>
<p>Most browser chrome DevTools tests are asynchronous. One of the reasons why they are asynchronous is that the code needs to register event handlers for various user interactions in the tools and then simulate these interactions. Another reason is that most DevTools operations are done asynchronously via the debugger protocol.</p>
<p>Here are a few things to keep in mind with regards to asynchronous testing:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">head.js</span></code> already calls <code class="docutils literal notranslate"><span class="pre">waitForExplicitFinish()</span></code> so there’s no need for your new test to do it too.</p></li>
<li><p>Using <code class="docutils literal notranslate"><span class="pre">add_task</span></code> with a generator function means that you can yield calls to functions that return promises. It also means your main test function can be written to almost look like synchronous code, by adding <code class="docutils literal notranslate"><span class="pre">yield</span></code> before calls to asynchronous functions. For example:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">test</span> <span class="k">of</span> <span class="nx">testData</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">yield</span> <span class="nx">testCompletion</span><span class="p">(</span><span class="nx">test</span><span class="p">,</span> <span class="nx">editor</span><span class="p">,</span> <span class="nx">view</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Each call to <code class="docutils literal notranslate"><span class="pre">testCompletion</span></code> is asynchronous, but the code doesn’t need to rely on nested callbacks and maintain an index, a standard for loop can be used.</p>
<!--TODO: I think the following paragraph might be slightly outdated--><ul class="simple">
<li><p>Define your test functions as generators that yield, no need for them to be tasks since they are called from one already. In some cases you’ll need to return promises anyway (if you’re adding a new helper function to head.js for example). If this is the case, it sometimes is best to define your function like so:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nx">myHelperFunction</span> <span class="o">=</span> <span class="nx">Task</span><span class="p">.</span><span class="nx">async</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span><span class="p">()</span> <span class="p">{</span>
	<span class="p">...</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
<div class="section" id="writing-clean-maintainable-test-code">
<h2>Writing clean, maintainable test code<a class="headerlink" href="#writing-clean-maintainable-test-code" title="Permalink to this headline">¶</a></h2>
<p>Test code is as important as feature code itself, it helps avoiding regressions of course, but it also helps understanding complex parts of the code that would be otherwise hard to grasp.</p>
<p>Since we find ourselves working with test code a large portion of our time, we should spend the time and energy it takes to make this time enjoyable.</p>
<div class="section" id="logs-and-comments">
<h3>Logs and comments<a class="headerlink" href="#logs-and-comments" title="Permalink to this headline">¶</a></h3>
<p>Reading test output logs isn’t exactly fun and it takes time but is needed at times. Make sure your test generates enough logs by using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;doing something now&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>it helps a lot knowing around which lines the test fails, if it fails.</p>
<p>One good rule of thumb is if you’re about to add a JS line comment in your test to explain what the code below is about to test, write the same comment in an <code class="docutils literal notranslate"><span class="pre">info()</span></code> instead.</p>
<p>Also add a description at the top of the file to help understand what this test is about. The file name is often not long enough to convey everything you need to know about the test. Understanding a test often teaches you about the feature itself.</p>
<p>Not really a comment, but don’t forget to “use strict”;</p>
</div>
<div class="section" id="callbacks-and-promises">
<h3>Callbacks and promises<a class="headerlink" href="#callbacks-and-promises" title="Permalink to this headline">¶</a></h3>
<p>Avoid multiple nested callbacks or chained promises. They make it hard to read the code.</p>
<p>Thanks to <code class="docutils literal notranslate"><span class="pre">add_task</span></code>, it’s easy to write asynchronous code that looks like flat, synchronous, code.</p>
</div>
<div class="section" id="clean-up-after-yourself">
<h3>Clean up after yourself<a class="headerlink" href="#clean-up-after-yourself" title="Permalink to this headline">¶</a></h3>
<p>Do not expose global variables in your test file, they may end up causing bugs that are hard to track. Most functions in <code class="docutils literal notranslate"><span class="pre">head.js</span></code> return useful instances of the DevTools panels, and you can pass these as arguments to your sub functions, no need to store them in the global scope.
This avoids having to remember nullifying them at the end.</p>
<p>If your test needs to toggle user preferences, make sure you reset these preferences when the test ends. Do not reset them at the end of the test function though because if your test fails, the preferences will never be reset. Use the <code class="docutils literal notranslate"><span class="pre">registerCleanupFunction</span></code> helper instead.</p>
<p>It may be a good idea to do the reset in <code class="docutils literal notranslate"><span class="pre">head.js</span></code>.</p>
</div>
<div class="section" id="write-small-maintainable-code">
<h3>Write small, maintainable code<a class="headerlink" href="#write-small-maintainable-code" title="Permalink to this headline">¶</a></h3>
<p>Split your main test function into smaller test functions with self explanatory names.</p>
<p>Make sure your test files are small. If you are working on a new feature, you can create a new test each time you add a new functionality, a new button to the UI for instance. This helps having small, incremental tests and can also help writing test while coding.</p>
<p>If your test is just a sequence of functions being called to do the same thing over and over again, it may be better to describe the test steps in an array instead and just have one function that runs each item of the array. See the following example</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">TESTS</span> <span class="o">=</span> <span class="p">[</span>
	<span class="p">{</span><span class="nx">desc</span><span class="o">:</span> <span class="s2">&quot;add a class&quot;</span><span class="p">,</span> <span class="nx">cssSelector</span><span class="o">:</span> <span class="s2">&quot;#id1&quot;</span><span class="p">,</span> <span class="nx">makeChanges</span><span class="o">:</span> <span class="kd">function</span><span class="o">*</span><span class="p">()</span> <span class="p">{...}},</span>
	<span class="p">{</span><span class="nx">desc</span><span class="o">:</span> <span class="s2">&quot;change href&quot;</span><span class="p">,</span> <span class="nx">cssSelector</span><span class="o">:</span> <span class="s2">&quot;a.the-link&quot;</span><span class="p">,</span> <span class="nx">makeChanges</span><span class="o">:</span> <span class="kd">function</span><span class="o">*</span><span class="p">()</span> <span class="p">{...}},</span>
	<span class="p">...</span>
<span class="p">];</span>

<span class="nx">add_task</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">yield</span> <span class="nx">addTab</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">);</span>
	<span class="kd">let</span> <span class="p">{</span><span class="nx">toolbox</span><span class="p">,</span> <span class="nx">inspector</span><span class="p">}</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">openInspector</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">step</span> <span class="k">of</span> <span class="nx">TESTS</span><span class="p">)</span> <span class="p">{</span>
	  <span class="nx">info</span><span class="p">(</span><span class="s2">&quot;Testing step: &quot;</span> <span class="o">+</span> <span class="nx">step</span><span class="p">.</span><span class="nx">desc</span><span class="p">);</span>
	  <span class="k">yield</span> <span class="nx">selectNode</span><span class="p">(</span><span class="nx">step</span><span class="p">.</span><span class="nx">cssSelector</span><span class="p">,</span> <span class="nx">inspector</span><span class="p">);</span>
	  <span class="k">yield</span> <span class="nx">step</span><span class="p">.</span><span class="nx">makeChanges</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
<p>As shown in this code example, you can add as many test cases as you want in the TESTS array and the actual test code will remain very short, and easy to understand and maintain (note that when looping through test arrays, it’s always a good idea to add a “desc” property that will be used in an info() log output).</p>
</div>
<div class="section" id="avoid-exceptions">
<h3>Avoid exceptions<a class="headerlink" href="#avoid-exceptions" title="Permalink to this headline">¶</a></h3>
<p>Even when they’re not failing the test, exceptions are bad because they pollute the logs and make them harder to read.
They’re also bad because when your test is run as part of a test suite and if an other, unrelated, test fails then the exceptions may give wrong information to the person fixing the unrelated test.</p>
<p>After your test has run locally, just make sure it doesn’t output exceptions by scrolling through the logs.</p>
<p>Often, non-blocking exceptions may be caused by hanging protocol requests that haven’t been responded to yet when the tools get closed at the end of the test. Make sure you register to the right events and give time to the tools to update themselves before moving on.</p>
</div>
<div class="section" id="avoid-test-timeouts">
<h3>Avoid test timeouts<a class="headerlink" href="#avoid-test-timeouts" title="Permalink to this headline">¶</a></h3>
<!--TODO: this recommendation is conflicting with the above recommendation. What? --><p>When tests fail, it’s far better to have them fail and end immediately with an exception that will help fix it rather than have them hang until they hit the timeout and get killed.</p>
</div>
</div>
<div class="section" id="adding-new-helpers">
<h2>Adding new helpers<a class="headerlink" href="#adding-new-helpers" title="Permalink to this headline">¶</a></h2>
<p>In some cases, you may want to extract some common code from your test to use it another another test.</p>
<ul class="simple">
<li><p>If this is very common code that all tests could use, then add it to <code class="docutils literal notranslate"><span class="pre">devtools/client/shared/test/shared-head.js</span></code>.</p></li>
<li><p>If this is common code specific to a given tool, then add it to the corresponding <code class="docutils literal notranslate"><span class="pre">head.js</span></code> file.</p></li>
<li><p>If it isn’t common enough to live in <code class="docutils literal notranslate"><span class="pre">head.js</span></code>, then it may be a good idea to create a helper file to avoid duplication anyway. Here’s how to create a helper file:</p></li>
<li><p>Create a new file in your test director. The naming convention should be <code class="docutils literal notranslate"><span class="pre">helper_&lt;description_of_the_helper&gt;.js</span></code></p></li>
<li><p>Add it to the browser.ini support-files section, making sure it is sorted alphabetically</p></li>
<li><p>Load the helper file in the tests</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">browser/devtools/markupview/test/head.js</span></code> has a handy <code class="docutils literal notranslate"><span class="pre">loadHelperScript(fileName)</span></code> function that you can use.</p></li>
<li><p>The file will be loaded in the test global scope, so any global function or variables it defines will be available (just like <code class="docutils literal notranslate"><span class="pre">head.js</span></code>).</p></li>
<li><p>Use the special ESLint comment <code class="docutils literal notranslate"><span class="pre">/*</span> <span class="pre">import-globals-from</span> <span class="pre">helper_file.js</span> <span class="pre">*/</span></code> to prevent ESLint errors for undefined variables.</p></li>
</ul>
<p>In all cases, new helper functions should be properly commented with an jsdoc comment block.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="debugging-intermittents.html" class="btn btn-neutral float-right" title="Debugging Intermittent Test Failures" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="node-tests.html" class="btn btn-neutral float-left" title="DevTools node tests" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>