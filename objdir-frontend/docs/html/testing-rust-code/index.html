

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Testing &amp; Debugging Rust Code &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Internationalization" href="../intl/index.html" />
    <link rel="prev" title="Code coverage" href="../tools/code-coverage/index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Testing &amp; Debugging Rust Code</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#testing-mozilla-crates">Testing Mozilla crates</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#rust-tests">Rust tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gtests">GTests</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#testing-third-party-crates">Testing third-party crates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#debugging-rust-code">Debugging Rust code</a></li>
<li class="toctree-l2"><a class="reference internal" href="#logging-from-rust-code">Logging from Rust code</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#rust-logging">Rust logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gecko-logging">Gecko logging</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Testing &amp; Debugging Rust Code</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/testing-rust-code/index.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="testing-debugging-rust-code">
<h1>Testing &amp; Debugging Rust Code<a class="headerlink" href="#testing-debugging-rust-code" title="Permalink to this headline">¶</a></h1>
<p>This page explains how to test and debug Rust code in Firefox.</p>
<p>The <a class="reference external" href="../build/buildsystem/rust.html">build documentation</a> explains how to add
new Rust code to Firefox. The <a class="reference external" href="../writing-rust-code">code documentation</a>
explains how to write and work with Rust code in Firefox.</p>
<div class="section" id="testing-mozilla-crates">
<h2>Testing Mozilla crates<a class="headerlink" href="#testing-mozilla-crates" title="Permalink to this headline">¶</a></h2>
<p>Rust code will naturally be tested as part of system tests such as Mochitests.
This section describes the two methods for unit testing of individual Rust
crates. Which method should be used depends on the circumstances.</p>
<div class="section" id="rust-tests">
<h3>Rust tests<a class="headerlink" href="#rust-tests" title="Permalink to this headline">¶</a></h3>
<p>If a Mozilla crate has “normal” Rust tests (i.e. <code class="docutils literal notranslate"><span class="pre">#[test]</span></code> functions that run
with <code class="docutils literal notranslate"><span class="pre">cargo</span> <span class="pre">test</span></code>), you can add the crate’s name to <code class="docutils literal notranslate"><span class="pre">RUST_TESTS</span></code> in
<a class="reference external" href="https://searchfox.org/mozilla-central/source/toolkit/library/rust/moz.build">toolkit/library/rust/moz.build</a>.
(Cargo features can be activated for Rust tests by adding them to
<code class="docutils literal notranslate"><span class="pre">RUST_TEST_FEATURES</span></code> in the same file.)</p>
<p>Rust tests are run with <code class="docutils literal notranslate"><span class="pre">./mach</span> <span class="pre">rusttests</span></code>. They run on automation in a couple
of <code class="docutils literal notranslate"><span class="pre">rusttests</span></code> jobs, but not on all platforms.</p>
<p>Rust tests have one major restriction: they cannot link against Gecko symbols.
Therefore, Rust tests cannot be used for crates that use Gecko crates like
<code class="docutils literal notranslate"><span class="pre">nsstring</span></code> and <code class="docutils literal notranslate"><span class="pre">xpcom</span></code>.</p>
<p>It’s also possible to use <code class="docutils literal notranslate"><span class="pre">RUST_TESTS</span></code> in a different <code class="docutils literal notranslate"><span class="pre">moz.build</span></code> file. See
<code class="docutils literal notranslate"><span class="pre">testing/geckodriver/moz.build</span></code> and the <a class="reference external" href="../testing/geckodriver/Testing.html">geckodriver testing docs</a> for an
example.</p>
</div>
<div class="section" id="gtests">
<h3>GTests<a class="headerlink" href="#gtests" title="Permalink to this headline">¶</a></h3>
<p>Another way to unit test a Mozilla crate is by writing a GTest that uses FFI to
call into Rust code. This requires the following steps.</p>
<ul class="simple">
<li><p>Create a new test crate whose name is the same as the name of crate being
tested, with a <code class="docutils literal notranslate"><span class="pre">-gtest</span></code> suffix.</p></li>
<li><p>Add to the test crate a Rust file, a C++ file containing GTest <code class="docutils literal notranslate"><span class="pre">TEST()</span></code>
functions that use FFI to call into the Rust file, a <code class="docutils literal notranslate"><span class="pre">Cargo.toml</span></code> file that
references the Rust file, and a <code class="docutils literal notranslate"><span class="pre">moz.build</span></code> file that references the C++
file.</p></li>
<li><p>Add an entry to the <code class="docutils literal notranslate"><span class="pre">[dependencies]</span></code> section in
<a class="reference external" href="https://searchfox.org/mozilla-central/source/toolkit/library/gtest/rust/Cargo.toml">toolkit/library/gtest/rust/Cargo.toml</a>.</p></li>
<li><p>Add an <code class="docutils literal notranslate"><span class="pre">extern</span> <span class="pre">crate</span></code> entry to
<a class="reference external" href="https://searchfox.org/mozilla-central/source/toolkit/library/gtest/rust/lib.rs">toolkit/library/gtest/rust/lib.rs</a>.</p></li>
</ul>
<p>See
<a class="reference external" href="https://searchfox.org/mozilla-central/source/xpcom/rust/gtest/nsstring">xpcom/rust/gtest/nsstring/</a>
for a simple example. (Note that the <code class="docutils literal notranslate"><span class="pre">moz.build</span></code> file is in the parent
directory for that crate.)</p>
<p>A Rust GTest can be run like any other GTest via <code class="docutils literal notranslate"><span class="pre">./mach</span> <span class="pre">gtest</span></code>, using the C++
<code class="docutils literal notranslate"><span class="pre">TEST()</span></code> functions as the starting point.</p>
<p>Unlike Rust tests, GTests can be used when linking against Gecko symbols is required.</p>
</div>
</div>
<div class="section" id="testing-third-party-crates">
<h2>Testing third-party crates<a class="headerlink" href="#testing-third-party-crates" title="Permalink to this headline">¶</a></h2>
<p>In general we don’t run tests for third-party crates. The assumption is that
these crates are sufficiently well-tested elsewhere.</p>
</div>
<div class="section" id="debugging-rust-code">
<h2>Debugging Rust code<a class="headerlink" href="#debugging-rust-code" title="Permalink to this headline">¶</a></h2>
<p>In theory, Rust code is debuggable much like C++ code, using standard tools
like <code class="docutils literal notranslate"><span class="pre">gdb</span></code>, <code class="docutils literal notranslate"><span class="pre">rr</span></code>, and the Microsoft Visual Studio Debugger. In practice, the
experience can be worse, because shortcomings such as the following can occur.</p>
<ul class="simple">
<li><p>Inability to print local variables, even in non-optimized builds.</p></li>
<li><p>Inability to call generic functions.</p></li>
<li><p>Missing line numbers and stack frames.</p></li>
<li><p>Printing of basic types such as <code class="docutils literal notranslate"><span class="pre">Option</span></code> and <code class="docutils literal notranslate"><span class="pre">Vec</span></code> is sometimes sub-optimal.
If you see a warning “Missing auto-load script at offset 0 in section
<code class="docutils literal notranslate"><span class="pre">.debug_gdb_scripts</span></code>” when starting <code class="docutils literal notranslate"><span class="pre">gdb</span></code>, the <code class="docutils literal notranslate"><span class="pre">rust-gdb</span></code> wrapper may give
better results.</p></li>
</ul>
</div>
<div class="section" id="logging-from-rust-code">
<h2>Logging from Rust code<a class="headerlink" href="#logging-from-rust-code" title="Permalink to this headline">¶</a></h2>
<div class="section" id="rust-logging">
<h3>Rust logging<a class="headerlink" href="#rust-logging" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">RUST_LOG</span></code> environment variable (from the <code class="docutils literal notranslate"><span class="pre">env_logger</span></code> crate) can be used
to enable logging to stderr from Rust code in Firefox. The logging macros from
the <code class="docutils literal notranslate"><span class="pre">log</span></code> crate can be used. In order of importance, they are: <code class="docutils literal notranslate"><span class="pre">error!</span></code>,
<code class="docutils literal notranslate"><span class="pre">warn!</span></code>, <code class="docutils literal notranslate"><span class="pre">info!</span></code>, <code class="docutils literal notranslate"><span class="pre">debug!</span></code>, <code class="docutils literal notranslate"><span class="pre">trace!</span></code>.</p>
<p>For example, to show all log messages of <code class="docutils literal notranslate"><span class="pre">info</span></code> level or higher, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RUST_LOG</span><span class="o">=</span><span class="n">info</span> <span class="n">firefox</span>
</pre></div>
</div>
<p>Module-level logging can also be specified, see the <a class="reference external" href="https://docs.rs/env_logger/">documentation</a> for the
<code class="docutils literal notranslate"><span class="pre">env_logger</span></code> crate for details.</p>
<p>To restrict logging to child processes, use <code class="docutils literal notranslate"><span class="pre">RUST_LOG_CHILD</span></code> instead of
<code class="docutils literal notranslate"><span class="pre">RUST_LOG</span></code>.</p>
</div>
<div class="section" id="gecko-logging">
<h3>Gecko logging<a class="headerlink" href="#gecko-logging" title="Permalink to this headline">¶</a></h3>
<p>Rust logging can also be forwarded to the <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Mozilla/Developer_guide/Gecko_Logging">Gecko logger</a> for capture via
<code class="docutils literal notranslate"><span class="pre">MOZ_LOG</span></code> and <code class="docutils literal notranslate"><span class="pre">MOZ_LOG_FILE</span></code>.</p>
<ul class="simple">
<li><p>When parsing modules from <code class="docutils literal notranslate"><span class="pre">MOZ_LOG</span></code>, modules containing <code class="docutils literal notranslate"><span class="pre">::</span></code> are considered
to be Rust modules. To log everything in a top-level module like
<code class="docutils literal notranslate"><span class="pre">neqo_transport</span></code>, specify it as <code class="docutils literal notranslate"><span class="pre">neqo_transport::*</span></code>. For example:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MOZ_LOG</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span><span class="n">sync</span><span class="p">,</span><span class="n">nsHostResolver</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="n">neqo_transport</span><span class="p">::</span><span class="o">*</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="n">proxy</span><span class="p">:</span><span class="mi">5</span> <span class="n">firefox</span>
</pre></div>
</div>
<ul class="simple">
<li><p>When logging from a submodule the <code class="docutils literal notranslate"><span class="pre">::*</span></code> is allowed but isn’t necessary.
So these two lines are equivalent:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MOZ_LOG</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span><span class="n">sync</span><span class="p">,</span><span class="n">neqo_transport</span><span class="p">::</span><span class="n">recovery</span><span class="p">:</span><span class="mi">5</span> <span class="n">firefox</span>
<span class="n">MOZ_LOG</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span><span class="n">sync</span><span class="p">,</span><span class="n">neqo_transport</span><span class="p">::</span><span class="n">recovery</span><span class="p">::</span><span class="o">*</span><span class="p">:</span><span class="mi">5</span> <span class="n">firefox</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">debug!</span></code> and <code class="docutils literal notranslate"><span class="pre">trace!</span></code> logs will not appear in non-debug builds. This is due
to our use of the <code class="docutils literal notranslate"><span class="pre">release_max_level_info</span></code> feature in the <code class="docutils literal notranslate"><span class="pre">log</span></code> crate.</p></li>
<li><p>When using both <code class="docutils literal notranslate"><span class="pre">MOZ_LOG</span></code> and <code class="docutils literal notranslate"><span class="pre">RUST_LOG</span></code>, modules that are specified in
<code class="docutils literal notranslate"><span class="pre">MOZ_LOG</span></code> will not appear in <code class="docutils literal notranslate"><span class="pre">RUST_LOG</span></code>.</p></li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../intl/index.html" class="btn btn-neutral float-right" title="Internationalization" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../tools/code-coverage/index.html" class="btn btn-neutral float-left" title="Code coverage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>