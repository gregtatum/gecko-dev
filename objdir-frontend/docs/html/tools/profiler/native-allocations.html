

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Native Allocations &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Registering Threads" href="registering-threads.html" />
    <link rel="prev" title="Markers" href="markers-guide.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Gecko Profiler</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="buffer.html">Buffers and Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="ci-automation.html">CI Automation</a></li>
<li class="toctree-l2"><a class="reference internal" href="counters.html">Counters</a></li>
<li class="toctree-l2"><a class="reference internal" href="instrumenting-java.html">Instrumenting Java</a></li>
<li class="toctree-l2"><a class="reference internal" href="instrumenting-javascript.html">Instrumenting JavaScript</a></li>
<li class="toctree-l2"><a class="reference internal" href="instrumenting-rust.html">Instrumenting Rust</a></li>
<li class="toctree-l2"><a class="reference internal" href="jstracer.html">JS Tracer</a></li>
<li class="toctree-l2"><a class="reference internal" href="LUL.html">LUL</a></li>
<li class="toctree-l2"><a class="reference internal" href="markers-guide.html">Markers</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Native Allocations</a></li>
<li class="toctree-l2"><a class="reference internal" href="registering-threads.html">Registering Threads</a></li>
<li class="toctree-l2"><a class="reference internal" href="samples-stackwalking.html">Samples and Stack Walking</a></li>
<li class="toctree-l2"><a class="reference internal" href="serialization.html">Serialization</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Gecko Profiler</a> &raquo;</li>
        
      <li>Native Allocations</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/tools/profiler/native-allocations.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="native-allocations">
<h1>Native Allocations<a class="headerlink" href="#native-allocations" title="Permalink to this headline">¶</a></h1>
<p>The profiler can sample allocations and de-allocations from malloc using the
“Native Allocations” feature. This can be enabled by going to <cite>about:profiling</cite> and
enabling the “Native Allocations” checkbox. It is only available in Nightly, as it
uses a technique of hooking into malloc that could be a little more risky to apply to
the broader population of Firefox users.</p>
<p>This implementation is located in: <a class="reference external" href="https://searchfox.org/mozilla-central/source/tools/profiler/core/memory_hooks.cpp">tools/profiler/core/memory_hooks.cpp</a></p>
<p>It works by hooking into all of the malloc calls. When the profiler is running, it
performs a <a class="reference external" href="https://en.wikipedia.org/wiki/Bernoulli_trial">Bernoulli trial</a>, that will pass for a given probability of per-byte
allocated. What this means is that larger allocations have a higher chance of being
recorded compared to smaller allocations. Currently, there is no way to configure
the per-byte probability.</p>
<p>This infrastructure is quite similar to DMD, but with the additional motiviations of
making it easy to turn on and use with the profiler. The overhead is quite high,
especially on systems with more expensive stack walking, like Linux. Turning off
thee “Native Stacks” feature can help lower overhead, but will give less information.</p>
<p>For more information on analyzing these profiles, see the <a class="reference external" href="https://profiler.firefox.com/docs/#/./memory-allocations">Firefox Profiler docs</a>.</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="registering-threads.html" class="btn btn-neutral float-right" title="Registering Threads" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="markers-guide.html" class="btn btn-neutral float-left" title="Markers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>