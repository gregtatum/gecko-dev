

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Partial Update Generation &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Signing" href="signing.html" />
    <link rel="prev" title="Setting Up An Update Server" href="setting-up-an-update-server.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">TaskCluster Task-Graph Generation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="taskgraph.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="mach.html">Taskcluster Mach commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="loading.html">Loading Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="transforms.html">Transforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="optimization.html">Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="docker-images.html">Docker Images</a></li>
<li class="toctree-l2"><a class="reference internal" href="cron.html">Periodic Taskgraphs</a></li>
<li class="toctree-l2"><a class="reference internal" href="try.html">Try</a></li>
<li class="toctree-l2"><a class="reference internal" href="actions.html">Actions</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="release-promotion.html">Release Promotion</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="release-promotion.html#release-promotion-phases">Release Promotion Phases</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="release-promotion.html#in-depth-relpro-guide">In-depth relpro guide</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="release-promotion-action.html">Release Promotion Action</a></li>
<li class="toctree-l4"><a class="reference internal" href="balrog.html">Balrog in Release Promotion</a></li>
<li class="toctree-l4"><a class="reference internal" href="setting-up-an-update-server.html">Setting Up An Update Server</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Partial Update Generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="signing.html">Signing</a></li>
<li class="toctree-l4"><a class="reference internal" href="partner-repacks.html">Partner repacks</a></li>
<li class="toctree-l4"><a class="reference internal" href="partner-attribution.html">Partner attribution</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="versioncontrol.html">Version Control in CI</a></li>
<li class="toctree-l2"><a class="reference internal" href="config.html">Taskcluster Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="how-tos.html">How Tos</a></li>
<li class="toctree-l2"><a class="reference internal" href="task-graph.html">Task Graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference.html">Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">TaskCluster Task-Graph Generation</a> &raquo;</li>
        
          <li><a href="release-promotion.html">Release Promotion</a> &raquo;</li>
        
      <li>Partial Update Generation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/taskcluster/partials.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="partial-update-generation">
<h1>Partial Update Generation<a class="headerlink" href="#partial-update-generation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Windows, Mac and Linux releases have partial updates, to reduce
the file size end-users have to download in order to receive new
versions. These are created using a docker image, some Python,
<code class="docutils literal notranslate"><span class="pre">mbsdiff</span></code>, and the tools in <code class="docutils literal notranslate"><span class="pre">tools/update-packaging</span></code></p>
<p>The task has been called ‘Funsize’ for quite some time. This might
make sense depending on what brands of chocolate bar are available
near you.</p>
</div>
<div class="section" id="how-the-task-works">
<h2>How the Task Works<a class="headerlink" href="#how-the-task-works" title="Permalink to this headline">¶</a></h2>
<p>Funsize uses a docker image that’s built in-tree, named funsize-update-generator.
The image contains some Python to examine the task definition and determine
what needs to be done, but it downloads tools like <code class="docutils literal notranslate"><span class="pre">mar</span></code> and <code class="docutils literal notranslate"><span class="pre">mbsdiff</span></code>
from either locations specified in the task definition, or default mozilla-central
locations.</p>
<p>The ‘extra’ section of the task definition contains most of the payload, under
the ‘funsize’ key. In here is a list of partials that this specific task will
generate, and each entry includes the earlier (or ‘from’) version, and the most
recent (or ‘to’) version, which for most releases will likely be a taskcluster
artifact.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;to_mar&quot;</span><span class="p">:</span> <span class="s2">&quot;https://tc.net/api/queue/v1/task/EWtBFqVuT-WqG3tGLxWhmA/artifacts/public/build/ach/target.complete.mar&quot;</span><span class="p">,</span>
   <span class="nt">&quot;product&quot;</span><span class="p">:</span> <span class="s2">&quot;Firefox&quot;</span><span class="p">,</span>
   <span class="nt">&quot;dest_mar&quot;</span><span class="p">:</span> <span class="s2">&quot;target-60.0b8.partial.mar&quot;</span><span class="p">,</span>
   <span class="nt">&quot;locale&quot;</span><span class="p">:</span> <span class="s2">&quot;ach&quot;</span><span class="p">,</span>
   <span class="nt">&quot;from_mar&quot;</span><span class="p">:</span> <span class="s2">&quot;http://archive.mozilla.org/pub/firefox/candidates/60.0b8-candidates/build1/update/linux-i686/ach/firefox-60.0b8.complete.mar&quot;</span><span class="p">,</span>
   <span class="nt">&quot;update_number&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
   <span class="nt">&quot;platform&quot;</span><span class="p">:</span> <span class="s2">&quot;linux32&quot;</span><span class="p">,</span>
   <span class="nt">&quot;previousVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;60.0b8&quot;</span><span class="p">,</span>
   <span class="nt">&quot;previousBuildNumber&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
   <span class="nt">&quot;branch&quot;</span><span class="p">:</span> <span class="s2">&quot;mozilla-beta&quot;</span>
 <span class="p">}</span>
</pre></div>
</div>
<p>The ‘update number’ indicates how many released versions there are between ‘to’ and the current ‘from’.
For example, if we are building a partial update for the current nightly from the previous one, the update
number will be 1. For the release before that, it will be 2. This lets us use generic output artifact
names that we can rename in the later <code class="docutils literal notranslate"><span class="pre">beetmover</span></code> tasks.</p>
<p>Inside the task, for each partial it has been told to generate, it will download, unpack and virus
scan the ‘from_mar’ and ‘to_mar’, download the tools, and run <code class="docutils literal notranslate"><span class="pre">make_incremental_update.sh</span></code> from
<code class="docutils literal notranslate"><span class="pre">tools/update-packaging</span></code>.</p>
<p>If a scope is given for a set of temporary S3 credentials, the task will use a caching script,
to allow re-use of the diffs made for larger files. Some of the larger files are not localised,
and this allows us to save a lot of compute time.</p>
</div>
<div class="section" id="for-releases">
<h2>For Releases<a class="headerlink" href="#for-releases" title="Permalink to this headline">¶</a></h2>
<p>Partials are made as part of the <code class="docutils literal notranslate"><span class="pre">promote</span></code> task group. The previous
versions used to create the update are specified in ship-it by
Release Management.</p>
</div>
<div class="section" id="nightly-partials">
<h2>Nightly Partials<a class="headerlink" href="#nightly-partials" title="Permalink to this headline">¶</a></h2>
<p>Since nightly releases don’t appear in ship-it, the partials to create
are determined in the decision task. This was controversial, and so here
are the assumptions and reasons, so that when an alternative solution is
discovered, we can assess it in context:</p>
<ol class="arabic simple">
<li><p>Balrog is the source of truth for previous nightly releases.</p></li>
<li><p>Re-running a task should produce the same results.</p></li>
<li><p>A task’s input and output should be specified in the definition.</p></li>
<li><p>A task transform should avoid external dependencies. This is to
increase the number of scenarios in which ‘mach taskgraph’ works.</p></li>
<li><p>A task graph doesn’t explicitly know that it’s intended for nightlies,
only that specific tasks are only present for nightly.</p></li>
<li><p>The decision task is explicitly told that its target is nightly
using the target-tasks-method argument.</p></li>
</ol>
<ol class="loweralpha simple">
<li><p>From 2 and 3, this means that the partials task itself cannot query
balrog for the history, as it may get different results when re-run,
and hides the inputs and outputs from the task definition.</p></li>
<li><p>From 4, anything run by ‘mach taskgraph’ is an inappropriate place
to query Balrog, even if it results in a repeatable task graph.</p></li>
<li><p>Since these restrictions don’t apply to the decision task, and given
6, we can query Balrog in the decision task if the target-tasks-method
given contains ‘nightly’, such as ‘nightly_desktop’ or ‘nightly_linux’</p></li>
</ol>
<p>Using the decision task involves making fewer, larger queries to Balrog,
and storing the results for task graph regeneration and later audit. At
the moment this data is stored in the <code class="docutils literal notranslate"><span class="pre">parameters</span></code> under the label
<code class="docutils literal notranslate"><span class="pre">release_history</span></code>, since the parameters are an existing method for
passing data to the task transforms, but a case could be made
for adding a separate store, as it’s a significantly larger number of
records than anything else in the parameters.</p>
</div>
<div class="section" id="nightly-partials-and-beetmover">
<h2>Nightly Partials and Beetmover<a class="headerlink" href="#nightly-partials-and-beetmover" title="Permalink to this headline">¶</a></h2>
<p>A release for a specific platform and locale may not have a history of
prior releases that can be used to build partial updates. This could be
for a variety of reasons, such as a new locale, or a hiatus in nightly
releases creating too long a gap in the history.</p>
<p>This means that the <code class="docutils literal notranslate"><span class="pre">partials</span></code> and <code class="docutils literal notranslate"><span class="pre">partials-signing</span></code> tasks may have
nothing to do for a platform and locale. If this is true, then the tasks
are filtered out in the <code class="docutils literal notranslate"><span class="pre">transform</span></code>.</p>
<p>This does mean that the downstream task, <code class="docutils literal notranslate"><span class="pre">beetmover-repackage</span></code> can not
rely on the <code class="docutils literal notranslate"><span class="pre">partials-signing</span></code> task existing. It depends on both the
<code class="docutils literal notranslate"><span class="pre">partials-signing</span></code> and <code class="docutils literal notranslate"><span class="pre">repackage-signing</span></code> task, and chooses which
to depend on in the transform.</p>
<p>If there is a history in the <code class="docutils literal notranslate"><span class="pre">parameters</span></code> <code class="docutils literal notranslate"><span class="pre">release_history</span></code> section
then <code class="docutils literal notranslate"><span class="pre">beetmover-repackage</span></code> will depend on <code class="docutils literal notranslate"><span class="pre">partials-signing</span></code>.
Otherwise, it will depend on <code class="docutils literal notranslate"><span class="pre">repackage-signing</span></code>.</p>
<p>This is not ideal, as it results in unclear logic in the task graph
generation. It will be improved.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="signing.html" class="btn btn-neutral float-right" title="Signing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="setting-up-an-update-server.html" class="btn btn-neutral float-left" title="Setting Up An Update Server" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>