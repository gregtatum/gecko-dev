

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Utilities for implementing APIs &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="WebExtensions Javascript Component Reference" href="reference.html" />
    <link rel="prev" title="Incognito Implementation" href="incognito.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Toolkit</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../mozapps/extensions/addon-manager/index.html">Add-on Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../crashes/crash-manager/index.html">Crash Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../crashreporter/crashreporter/index.html">Crash Reporter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../featuregates/featuregates/index.html">Feature Gates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../search/index.html">Search Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../normandy/normandy/index.html">Shield Recipe Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../messaging-system/docs/index.html">Messaging System Schemas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pictureinpicture/pictureinpicture/index.html">Picture-in-Picture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../prompts/prompts/index.html">Prompts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/subprocess/toolkit_modules/subprocess/index.html">Subprocess Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../telemetry/index.html">Telemetry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../glean/index.html">Firefox on Glean (FOG)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/toolkit_modules/index.html">Toolkit Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../content/toolkit_widgets/index.html">Toolkit Widgets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../url-classifier/url-classifier/index.html">URL Classifier</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">WebExtensions API Development</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="background.html">Background</a></li>
<li class="toctree-l3"><a class="reference internal" href="basics.html">API Implementation Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="schema.html">API Schemas</a></li>
<li class="toctree-l3"><a class="reference internal" href="functions.html">Implementing a function</a></li>
<li class="toctree-l3"><a class="reference internal" href="events.html">Implementing an event</a></li>
<li class="toctree-l3"><a class="reference internal" href="manifest.html">Implementing a manifest property</a></li>
<li class="toctree-l3"><a class="reference internal" href="lifecycle.html">Managing the Extension Lifecycle</a></li>
<li class="toctree-l3"><a class="reference internal" href="incognito.html">Incognito Implementation</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Utilities for implementing APIs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#windowmanager">WindowManager</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tabmanager">TabManager</a></li>
<li class="toctree-l4"><a class="reference internal" href="#extensionsettingsstore">ExtensionSettingsStore</a></li>
<li class="toctree-l4"><a class="reference internal" href="#extensionpreferencesmanager">ExtensionPreferencesManager</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ess-vs-epm">ESS vs. EPM</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-ess-epm-with-experimental-apis">Using ESS/EPM with experimental APIs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="reference.html">WebExtensions Javascript Component Reference</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Toolkit</a> &raquo;</li>
        
          <li><a href="index.html">WebExtensions API Development</a> &raquo;</li>
        
      <li>Utilities for implementing APIs</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../../_sources/toolkit/components/extensions/webextensions/other.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="utilities-for-implementing-apis">
<h1>Utilities for implementing APIs<a class="headerlink" href="#utilities-for-implementing-apis" title="Permalink to this headline">¶</a></h1>
<p>This page covers some utility classes that are useful for
implementing WebExtension APIs:</p>
<div class="section" id="windowmanager">
<h2>WindowManager<a class="headerlink" href="#windowmanager" title="Permalink to this headline">¶</a></h2>
<p>This class manages the mapping between the opaque window identifiers used
in the <a class="reference external" href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/API/windows">browser.windows</a> API.
See the reference docs <a class="reference external" href="reference.html#windowmanager-class">here</a>.</p>
</div>
<div class="section" id="tabmanager">
<h2>TabManager<a class="headerlink" href="#tabmanager" title="Permalink to this headline">¶</a></h2>
<p>This class manages the mapping between the opaque tab identifiers used
in the <a class="reference external" href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/API/tabs">browser.tabs</a> API.
See the reference docs <a class="reference external" href="reference.html#tabmanager-class">here</a>.</p>
</div>
<div class="section" id="extensionsettingsstore">
<h2>ExtensionSettingsStore<a class="headerlink" href="#extensionsettingsstore" title="Permalink to this headline">¶</a></h2>
<p>ExtensionSettingsStore (ESS) is used for storing changes to settings that are
requested by extensions, and for finding out what the current value
of a setting should be, based on the precedence chain or a specific selection
made (typically) by the user.</p>
<p>When multiple extensions request to make a change to a particular
setting, the most recently installed extension will be given
precedence.</p>
<p>It is also possible to select a specific extension (or no extension, which
infers user-set) to control a setting.  This will typically only happen via
ExtensionPreferencesManager described below.  When this happens, precedence
control is not used until either a new extension is installed, or the controlling
extension is disabled or uninstalled.  If user-set is specifically chosen,
precedence order will only be returned to by installing a new extension that
takes control of the setting.</p>
<p>ESS will manage what has control over a setting through any
extension state changes (ie. install, uninstall, enable, disable).</p>
<div class="section" id="notifications">
<h3>Notifications:<a class="headerlink" href="#notifications" title="Permalink to this headline">¶</a></h3>
<div class="section" id="extension-setting-changed">
<h4>“extension-setting-changed”:<a class="headerlink" href="#extension-setting-changed" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>When a setting changes an event is emitted via the apiManager. It contains
the following:</p>
<ul class="simple">
<li><p><em>action</em>: one of select, remove, enable, disable</p></li>
<li><p><em>id</em>: the id of the extension for which the setting has changed, may be null
if the setting has returned to default or user set.</p></li>
<li><p><em>type</em>: The type of setting altered.  This is defined by the module using ESS.
If the setting is controlled through the ExtensionPreferencesManager below,
the value will be “prefs”.</p></li>
<li><p><em>key</em>: The name of the setting altered.</p></li>
<li><p><em>item</em>: The new value, if any that has taken control of the setting.</p></li>
</ul>
</div></blockquote>
</div>
</div>
</div>
<div class="section" id="extensionpreferencesmanager">
<h2>ExtensionPreferencesManager<a class="headerlink" href="#extensionpreferencesmanager" title="Permalink to this headline">¶</a></h2>
<p>ExtensionPreferencesManager (EPM) is used to manage what extensions may control a
setting that results in changing a preference.  EPM adds additional logic on top
of ESS to help manage the preference values based on what is in control of a
setting.</p>
<div class="section" id="defining-a-setting-in-an-api">
<h3>Defining a setting in an API<a class="headerlink" href="#defining-a-setting-in-an-api" title="Permalink to this headline">¶</a></h3>
<p>A preference setting is defined in an API module by calling EPM.addSetting.  addSetting
allows the API to use callbacks that can handle setting preferences as needed.  Since
the setting is defined at runtime, the API module must be loaded as necessary by EPM
to properly manage settings.</p>
<p>In the api module definition (e.g. ext-toolkit.json), the api must use <cite>“settings”: true</cite>
so the management code can discover which API modules to load in order to manage a
setting.  See browserSettings[1] as an example.</p>
<p>Settings that are exposed to the user in <a class="reference external" href="about:preferences">about:preferences</a> also require special handling.
We typically show that an extension is in control of the preference, and prevent changes
to the setting.  Some settings may allow the user to choose which extension (or none) has
control of the setting.</p>
</div>
<div class="section" id="preferences-behavior">
<h3>Preferences behavior<a class="headerlink" href="#preferences-behavior" title="Permalink to this headline">¶</a></h3>
<p>To actually set a setting, the module must call EPM.setSetting.  This is typically done
via an extension API, such as browserSettings.settingName.set({ …value data… }), though
it may be done at other times, such as during extension startup or install in a modules
onManifest handler.</p>
<p>Preferences are not always changed when an extension uses an API that results in a call
to EPM.setSetting.  When setSetting is called, the values are stored by ESS (above), and if
the extension currently has control, or the setting is controllable by the extension, then
the preferences would be updated.</p>
<p>The preferences would also potentially be updated when installing, enabling, disabling or
uninstalling an extension, or by a user action in <a class="reference external" href="about:preferences">about:preferences</a> (or other UI that
allows controlling the preferences).  If all extensions that use a preference setting are
disabled or uninstalled, the prior user-set or default values would be returned to.</p>
<p>An extension may watch for changes using the onChange api (e.g. browserSettings.settingName.onChange).</p>
<p>[1] <a class="reference external" href="https://searchfox.org/mozilla-central/rev/04d8e7629354bab9e6a285183e763410860c5006/toolkit/components/extensions/ext-toolkit.json#19">https://searchfox.org/mozilla-central/rev/04d8e7629354bab9e6a285183e763410860c5006/toolkit/components/extensions/ext-toolkit.json#19</a></p>
</div>
<div class="section" id="id1">
<h3>Notifications:<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="section" id="extension-setting-changed-name">
<h4>“extension-setting-changed:<em>name</em>”:<a class="headerlink" href="#extension-setting-changed-name" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>When a setting controlled by EPM changes an event is emitted via the apiManager. It contains
no other data.  This is used primarily to implement the onChange API.</p>
</div></blockquote>
</div>
</div>
</div>
<div class="section" id="ess-vs-epm">
<h2>ESS vs. EPM<a class="headerlink" href="#ess-vs-epm" title="Permalink to this headline">¶</a></h2>
<p>An API may use ESS when it needs to allow an extension to store a setting value that
affects how Firefox works, but does not result in setting a preference.  An example
is allowing an extension to change the newTab value in the newTab service.</p>
<p>An API should use EPM when it needs to allow an extension to change a preference.</p>
</div>
<div class="section" id="using-ess-epm-with-experimental-apis">
<h2>Using ESS/EPM with experimental APIs<a class="headerlink" href="#using-ess-epm-with-experimental-apis" title="Permalink to this headline">¶</a></h2>
<p>Properly managing settings values depends on the ability to load any modules that
define a setting.  Since experimental APIs are defined inside the extension, there
are situations where settings defined in experimental APIs may not be correctly
managed.  The could result in a preference remaining set by the extension after
the extension is disabled or installed, especially when that state is updated during
safe mode.</p>
<p>Extensions making use of settings in an experimental API should practice caution,
potentially unsetting the values when the extension is shutdown.  Values used for
the setting could be stored in the extensions locale storage, and restored into
EPM when the extension is started again.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="reference.html" class="btn btn-neutral float-right" title="WebExtensions Javascript Component Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="incognito.html" class="btn btn-neutral float-left" title="Incognito Implementation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>