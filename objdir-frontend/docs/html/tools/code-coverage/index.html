

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Code coverage &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Testing &amp; Debugging Rust Code" href="../../testing-rust-code/index.html" />
    <link rel="prev" title="Performance Testing" href="../../testing/perfdocs/index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/geckoview/index.html">Welcome to GeckoViewâ€™s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Code coverage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#what-is-code-coverage">What is Code Coverage?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#firefox-code-coverage-reports">Firefox Code Coverage reports</a></li>
<li class="toctree-l2"><a class="reference internal" href="#c-c-code-coverage-on-firefox">C/C++ Code Coverage on Firefox</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#generate-code-coverage-report-from-a-try-build-or-any-other-ci-build">Generate Code Coverage report from a try build (or any other CI build)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#generate-report-using-a-one-click-loaner">Generate report using a one-click loaner</a></li>
<li class="toctree-l4"><a class="reference internal" href="#generate-report-locally">Generate report locally</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#creating-your-own-coverage-build">Creating your own Coverage Build</a></li>
<li class="toctree-l3"><a class="reference internal" href="#debugging-failing-tests-on-the-try-server">Debugging Failing Tests on the Try Server</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#js-debugger-per-test-code-coverage-on-firefox">JS Debugger Per Test Code Coverage on Firefox</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#generate-per-test-code-coverage-from-a-try-build-or-any-other-treeherder-build">Generate Per Test Code Coverage from a try build (or any other treeherder build)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generate-per-test-code-coverage-locally">Generate Per Test Code Coverage Locally</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Code coverage</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/tools/code-coverage/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="code-coverage">
<h1>Code coverage<a class="headerlink" href="#code-coverage" title="Permalink to this headline">Â¶</a></h1>
<div class="section" id="what-is-code-coverage">
<h2>What is Code Coverage?<a class="headerlink" href="#what-is-code-coverage" title="Permalink to this headline">Â¶</a></h2>
<p><strong>Code coverage</strong> essentially measures how often certain lines are hit,
branches taken or conditions met in a program, given some test that you
run on it.</p>
<p>There are two very important things to keep in mind when talking about
code coverage:</p>
<ul class="simple">
<li><p>If a certain branch of code is not hit at all while running tests,
then those tests will never be able to find a bug in this particular
piece of the code.</p></li>
<li><p>If a certain branch of code is executed (even very often), this still
is not a clear indication of the <em>quality of a test</em>. It could be
that a test exercises the code but does not actually check that the
code performs <em>correctly</em>.</p></li>
</ul>
<p>As a conclusion, we can use code coverage to find areas that need (more)
tests, but we cannot use it to confirm that certain areas are well
tested.</p>
</div>
<div class="section" id="firefox-code-coverage-reports">
<h2>Firefox Code Coverage reports<a class="headerlink" href="#firefox-code-coverage-reports" title="Permalink to this headline">Â¶</a></h2>
<p>We automatically run code coverage builds and tests on all
mozilla-central runs, for Linux and Windows. C/C++, Rust and JavaScript
are supported.</p>
<p>The generated reports can be found at <a class="reference external" href="https://coverage.moz.tools/">https://coverage.moz.tools/</a>. The
reports can be filtered by platform and/or test suite.</p>
<p>We also generate a report of all totally uncovered files, which can be
found at <a class="reference external" href="https://coverage.moz.tools/#view=zero">https://coverage.moz.tools/#view=zero</a>. You can use this to find
areas of code that should be tested, or code that is no longer used
(dead code, which could be removed).</p>
</div>
<div class="section" id="c-c-code-coverage-on-firefox">
<h2>C/C++ Code Coverage on Firefox<a class="headerlink" href="#c-c-code-coverage-on-firefox" title="Permalink to this headline">Â¶</a></h2>
<p>There are several ways to get C/C++ coverage information for
mozilla-central, including creating your own coverage builds. The next
sections describe the available options.</p>
<div class="section" id="generate-code-coverage-report-from-a-try-build-or-any-other-ci-build">
<h3>Generate Code Coverage report from a try build (or any other CI build)<a class="headerlink" href="#generate-code-coverage-report-from-a-try-build-or-any-other-ci-build" title="Permalink to this headline">Â¶</a></h3>
<p>To spin a code coverage build, you need to select the linux64-ccov
platform (use â€“full when using the fuzzy selector to get the ccov
builds to show up).</p>
<p>E.g. for a try build:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>./mach try fuzzy -q <span class="s1">&#39;linux64-ccov&#39;</span>
</pre></div>
</div>
<p>There are two options now, you can either generate the report locally or
use a one-click loaner.</p>
<div class="section" id="generate-report-using-a-one-click-loaner">
<h4>Generate report using a one-click loaner<a class="headerlink" href="#generate-report-using-a-one-click-loaner" title="Permalink to this headline">Â¶</a></h4>
<p>Select the B job on Treeherder and get a one-click loaner.</p>
<p>In the loaner, download and execute the script
<a class="reference external" href="https://github.com/mozilla/code-coverage/blob/master/report/firefox_code_coverage/codecoverage.py">https://github.com/mozilla/code-coverage/blob/master/report/firefox_code_coverage/codecoverage.py</a>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>wget https://raw.githubusercontent.com/mozilla/code-coverage/master/report/firefox_code_coverage/codecoverage.py
python codecoverage.py
</pre></div>
</div>
<p>This command will automatically generate a HTML report of the code
coverage information in the <strong>report</strong> subdirectory in your current
working directory.</p>
</div>
<div class="section" id="generate-report-locally">
<h4>Generate report locally<a class="headerlink" href="#generate-report-locally" title="Permalink to this headline">Â¶</a></h4>
<p>Prerequisites:</p>
<ul class="simple">
<li><p>Download the Python script at
<a class="reference external" href="https://github.com/mozilla/code-coverage/blob/master/report/firefox_code_coverage/codecoverage.py">https://github.com/mozilla/code-coverage/blob/master/report/firefox_code_coverage/codecoverage.py</a>.</p></li>
</ul>
<p>Given a treeherder linux64-ccov build (with its branch, e.g.
`mozilla-central` or `try`, and revision, the tip commit hash of your
push), run the following command:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python codecoverage.py PATH/TO/MOZILLA/SRC/DIR/ BRANCH REVISION
</pre></div>
</div>
<p>This command will automatically download code coverage artifacts from
the treeherder build and generate an HTML report of the code coverage
information. The report will be stored in the <strong>report</strong> subdirectory in
your current working directory.</p>
</div>
</div>
<div class="section" id="creating-your-own-coverage-build">
<h3>Creating your own Coverage Build<a class="headerlink" href="#creating-your-own-coverage-build" title="Permalink to this headline">Â¶</a></h3>
<p>On Linux, Windows and Mac OS X it is straightforward to generate an
instrumented build using GCC or Clang. Adding the following lines to
your <code class="docutils literal notranslate"><span class="pre">.mozconfig</span></code> file should be sufficient:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Enable code coverage</span>
ac_add_options --enable-coverage

<span class="c1"># Needed for e10s:</span>
<span class="c1"># With the sandbox, content processes can&#39;t write updated coverage counters in the gcda files.</span>
ac_add_options --disable-sandbox
</pre></div>
</div>
<p>Some additional options might be needed, check the code-coverage
mozconfigs used on CI to be sure:
browser/config/mozconfigs/linux64/code-coverage,
browser/config/mozconfigs/win64/code-coverage,
browser/config/mozconfigs/macosx64/code-coverage.</p>
<p>Make sure you are not running with <a class="reference internal" href="../../contributing/build/artifact_builds.html#understanding-artifact-builds"><span class="std std-ref">artifact build</span></a>
enabled, as it can prevent coverage artifacts from being created.</p>
<p>You can then create your build as usual. Once the build is complete, you
can run any tests/tools you would like to run and the coverage data gets
automatically written to special files. In order to view/process this
data, we recommend using the
<a class="reference external" href="https://github.com/mozilla/grcov">grcov</a> tool, a tool to manage and
visualize gcov results. You can also use the same process explained
earlier for CI builds.</p>
</div>
<div class="section" id="debugging-failing-tests-on-the-try-server">
<h3>Debugging Failing Tests on the Try Server<a class="headerlink" href="#debugging-failing-tests-on-the-try-server" title="Permalink to this headline">Â¶</a></h3>
<p>When code coverage is run through a push to try, all the data that is
created is ingested by ActiveData and processed into a different data
format for analysis. Anytime a code coverage run generates *.gcda and
*.gcno files, ActiveData starts working. Now, sometimes, a test will
permanently fail when it is running on a build that is instrumented with
GCOV. To debug these issues without overloading ActiveData with garbage
coverage data, open the file
<a class="reference external" href="https://searchfox.org/mozilla-central/source/taskcluster/taskgraph/transforms/tests.py#516">taskcluster/taskgraph/transforms/tests.py</a>
and add the following line,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;mozharness&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;extra-options&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--disable-ccov-upload&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>right after this line of code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;mozharness&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;extra-options&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--code-coverage&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now when you push to try to debug some failing tests, or anything else,
there will not be any code coverage artifacts uploaded from the build
machines or from the test machines.</p>
</div>
</div>
<div class="section" id="js-debugger-per-test-code-coverage-on-firefox">
<h2>JS Debugger Per Test Code Coverage on Firefox<a class="headerlink" href="#js-debugger-per-test-code-coverage-on-firefox" title="Permalink to this headline">Â¶</a></h2>
<p>There are two ways to get javascript per test code coverage information
for mozilla-central. The next sections describe these options.</p>
<div class="section" id="generate-per-test-code-coverage-from-a-try-build-or-any-other-treeherder-build">
<h3>Generate Per Test Code Coverage from a try build (or any other treeherder build)<a class="headerlink" href="#generate-per-test-code-coverage-from-a-try-build-or-any-other-treeherder-build" title="Permalink to this headline">Â¶</a></h3>
<p>To spin a code coverage build, you need to select the linux64-jsdcov
platform. E.g. for a try build:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>./mach try fuzzy -q <span class="s1">&#39;linux64-jsdcov&#39;</span>
</pre></div>
</div>
<p>This produces JavaScript Object Notation (JSON) files that can be
downloaded from the treeherder testing machines and processed or
analyzed locally.</p>
</div>
<div class="section" id="generate-per-test-code-coverage-locally">
<h3>Generate Per Test Code Coverage Locally<a class="headerlink" href="#generate-per-test-code-coverage-locally" title="Permalink to this headline">Â¶</a></h3>
<p>To generate the JSON files containing coverage information locally, simply
add an extra argument called <code class="docutils literal notranslate"><span class="pre">--jscov-dir-prefix</span></code> which accepts a
directory as itâ€™s input and stores the resulting data in that directory.
For example, to collect code coverage for the entire Mochitest suite:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>./mach mochitest --jscov-dir-prefix /PATH/TO/COVERAGE/DIR/
</pre></div>
</div>
<p>Currently, only the Mochitest and Xpcshell test suites have this
capability.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../testing-rust-code/index.html" class="btn btn-neutral float-right" title="Testing &amp; Debugging Rust Code" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../../testing/perfdocs/index.html" class="btn btn-neutral float-left" title="Performance Testing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>