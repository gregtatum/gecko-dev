

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>JSActors &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Main Thread Actors" href="mainthread.html" />
    <link rel="prev" title="DOM IPC" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../browser/index.html">Firefox</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">DOM</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">DOM IPC</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">JSActors</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#jsprocessactor">JSProcessActor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#jswindowactor">JSWindowActor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#communication-with-actors">Communication with actors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-to-port-from-message-manager-and-framescripts-to-jswindowactors">How to port from message manager and framescripts to JSWindowActors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#registering-a-new-actor">Registering a new actor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#minimal-example-actors">Minimal Example Actors</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#and-more">And more</a></li>
<li class="toctree-l3"><a class="reference internal" href="mainthread.html">Main Thread Actors</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../navigation/index.html">DOM Navigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../workersAndStorage/index.html">DOM Workers &amp; Storage</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">DOM</a> &raquo;</li>
        
          <li><a href="index.html">DOM IPC</a> &raquo;</li>
        
      <li>JSActors</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/dom/ipc/jsactors.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="jsactors">
<h1>JSActors<a class="headerlink" href="#jsactors" title="Permalink to this headline">¶</a></h1>
<p>In the Fission world, the preferred method of communication between between things-that-may-live-in-a-different-process are JSActors.</p>
<p>At the time of this writing, Fission offers the following JSActors:</p>
<ul class="simple">
<li><p><cite>JSProcessActor</cite>, to communicate between the a child process and its parent;</p></li>
<li><p><cite>JSWindowActor</cite>, to communicate between a frame and its parent.</p></li>
</ul>
<div class="section" id="jsprocessactor">
<h2>JSProcessActor<a class="headerlink" href="#jsprocessactor" title="Permalink to this headline">¶</a></h2>
<div class="section" id="what-are-jsprocessactors">
<h3>What are JSProcessActors?<a class="headerlink" href="#what-are-jsprocessactors" title="Permalink to this headline">¶</a></h3>
<p>A JSProcess pair (see below) is the preferred method of communication between a child process and a parent process.</p>
<p>In the Fission world, JSProcessActors are the replacement for e10s-era <em>process scripts</em>.</p>
</div>
<div class="section" id="the-life-of-a-jsprocessactor-pair">
<h3>The life of a JSProcessActor pair<a class="headerlink" href="#the-life-of-a-jsprocessactor-pair" title="Permalink to this headline">¶</a></h3>
<p>JSProcessActors always exist by pair:</p>
<ul class="simple">
<li><p>one instance of <cite>JSProcessActorChild</cite>, which lives in the child process – for instance, <cite>MyActorChild</cite>;</p></li>
<li><p>one instance of <cite>JSProcessActorParent</cite>, which lives in the parent process – for instance, <cite>MyActorParent</cite>.</p></li>
</ul>
<p>The pair is instantiated lazily, upon the first call to <cite>getActor(“MyActor”)</cite> (see below). Note that if a
parent process has several children, the parent process will typically host several instances of <cite>MyActorParent</cite>
whereas the children will each host a single instance of <cite>MyActorChild</cite>.</p>
<p>JSProcessActor primitives allow sending and receiving messages <em>within the pair</em>. As of this writing,
JSProcessActor does not offer primitives for broadcasting, enumerating, etc.</p>
<p>The pair dies when the child process dies.</p>
<div class="section" id="about-actor-names">
<h4>About actor names<a class="headerlink" href="#about-actor-names" title="Permalink to this headline">¶</a></h4>
<p>Note that the names
<cite>MyActorChild</cite> and <cite>MyActorParent</cite> are meaningful – suffixes <cite>Child</cite> and <cite>Parent</cite> are how <cite>getActor(…)</cite> finds
the correct classes to load within the JS code.</p>
</div>
</div>
</div>
<div class="section" id="jswindowactor">
<h2>JSWindowActor<a class="headerlink" href="#jswindowactor" title="Permalink to this headline">¶</a></h2>
<div class="section" id="what-are-jswindowactors">
<h3>What are JSWindowActors?<a class="headerlink" href="#what-are-jswindowactors" title="Permalink to this headline">¶</a></h3>
<p>A JSWindowActor pair (see below) is the preferred method of communication between a frame and its parent, regardless of whether the frame
and parent live in the same process or in distinct processes.</p>
<p>In the Fission world, JSWindowActors are the replacement for <em>framescripts</em>. Framescripts were how we structured code to be aware of the parent (UI) and child (content) separation, including establishing the communication channel between the two (via the Frame Message Manager).</p>
<p>However, the framescripts had no way to establish further process separation downwards (that is, for out-of-process iframes). JSWindowActors will be the replacement.</p>
</div>
<div class="section" id="how-are-they-structured">
<h3>How are they structured?<a class="headerlink" href="#how-are-they-structured" title="Permalink to this headline">¶</a></h3>
<div class="section" id="a-review-of-the-current-message-manager-mechanism">
<h4>A review of the current Message Manager mechanism<a class="headerlink" href="#a-review-of-the-current-message-manager-mechanism" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There are actually several types of Message Managers: Frame Message Managers, Window Message Managers, Group Message Managers and Process Message Managers. For the purposes of this documentation, it’s simplest to refer to all of these mechanisms altogether as the “Message Manager mechanism”. Most of the examples in this document will be operating on the assumption that the Message Manager is a Frame Message Manager, which is the most commonly used one.</p>
</div>
<p>Currently, in the post <a class="reference external" href="https://wiki.mozilla.org/Electrolysis">Electrolysis Project</a> Firefox codebase, we have code living in the parent process (UI) that is in plain JS (.js files) or in JS modules (.jsm files). In the child process (hosting the content), we use framescripts (.js) and also JS modules. The framescripts are instantiated once per top-level frame (or, in simpler terms, once per tab). This code has access to all of the DOM from the web content, including all iframes within it.</p>
<p>The two processes communicate via the Frame Message Manager (mm) using the <code class="docutils literal notranslate"><span class="pre">sendAsyncMessage</span></code> / <code class="docutils literal notranslate"><span class="pre">receiveMessage</span></code> API, and any code in the parent can communicate with any code in the child (and vice versa), by just listening to the messages of interest.</p>
<p>The Frame Message Manager communication mechanism follows a publish / subscribe pattern similar to how Events work in Firefox:</p>
<ol class="arabic simple">
<li><p>Something exposes a mechanism for subscribing to notifications (<code class="docutils literal notranslate"><span class="pre">addMessageListener</span></code> for the Frame Message Manager, <code class="docutils literal notranslate"><span class="pre">addEventListener</span></code> for Events).</p></li>
<li><p>The subscriber is responsible for unsubscribing when there’s no longer interest in the notifications (<code class="docutils literal notranslate"><span class="pre">removeMessageListener</span></code> for the Frame Message Manager, <code class="docutils literal notranslate"><span class="pre">removeEventListener</span></code> for Events).</p></li>
<li><p>Any number of subscribers can be attached at any one time.</p></li>
</ol>
<div class="figure align-default">
<a class="reference internal image-reference" href="../../_images/Fission-framescripts.png"><img alt="../../_images/Fission-framescripts.png" src="../../_images/Fission-framescripts.png" style="width: 320px; height: 200px;" /></a>
</div>
</div>
<div class="section" id="how-jswindowactors-differ-from-the-frame-message-manager">
<h4>How JSWindowActors differ from the Frame Message Manager<a class="headerlink" href="#how-jswindowactors-differ-from-the-frame-message-manager" title="Permalink to this headline">¶</a></h4>
<p>For Fission, the JSWindowActors replacing framescripts will be structured in pairs. A pair of JSWindowActors will be instantiated lazily: one in the parent and one in the child process, and a direct channel of communication between the two will be established. The JSWindowActor in the parent must extend the global <code class="docutils literal notranslate"><span class="pre">JSWindowActorParent</span></code> class, and the JSWindowActor in the child must extend the global <code class="docutils literal notranslate"><span class="pre">JSWindowActorChild</span></code> class.</p>
<p>The JSWindowActor mechanism is similar to how <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Mozilla/IPDL/Tutorial">IPC Actors</a> work in the native layer of Firefox:</p>
<ol class="arabic simple">
<li><p>Every Actor has one counterpart in another process that they can communicate directly with.</p></li>
<li><p>Every Actor inherits a common communications API from a parent class.</p></li>
<li><p>Every Actor has a name that ends in either <code class="docutils literal notranslate"><span class="pre">Parent</span></code> or <code class="docutils literal notranslate"><span class="pre">Child</span></code>.</p></li>
<li><p>There is no built-in mechanism for subscribing to messages. When one JSWindowActor sends a message, the counterpart JSWindowActor on the other side will receive it without needing to explicitly listen for it.</p></li>
</ol>
<p>Other notable differences between JSWindowActor’s and Message Manager / framescripts:</p>
<ol class="arabic">
<li><p>Each JSWindowActor pair is associated with a particular frame. For example, given the following DOM hierarchy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">browser</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://www.example.com&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">iframe</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://www.a.com&quot;</span> <span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="n">iframe</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://www.b.com&quot;</span> <span class="o">/&gt;</span>
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">JSWindowActorParent</span> <span class="pre">/</span> <span class="pre">``JSWindowActorChild</span></code> pair instantiated for either of the <code class="docutils literal notranslate"><span class="pre">iframe</span></code>’s would only be sending messages to and from that <code class="docutils literal notranslate"><span class="pre">iframe</span></code>.</p>
</li>
<li><p>There’s only one pair per actor type, per frame.</p>
<p>For example, suppose we have a <code class="docutils literal notranslate"><span class="pre">ContextMenu</span></code> actor. The parent process can have up to N instances of the <code class="docutils literal notranslate"><span class="pre">ContextMenuParent</span></code> actor, where N is the number of frames that are currently loaded. For any individual frame though, there’s only ever one <cite>ContextMenuChild</cite> associated with that frame.</p>
</li>
<li><p>We can no longer assume full, synchronous access to the frame tree, even in content processes.</p>
<p>This is a natural consequence of splitting frames to run out-of-process.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">JSWindowActorChild</span></code>’s live as long as the <code class="docutils literal notranslate"><span class="pre">WindowGlobalChild</span></code> they’re associated with.</p></li>
</ol>
<blockquote>
<div><p>If in the previously mentioned DOM hierarchy, one of the <code class="docutils literal notranslate"><span class="pre">&lt;iframe&gt;</span></code>’s unload, any associated JSWindowActor pairs will be torn down.</p>
</div></blockquote>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>JSWindowActors are “managed” by the WindowGlobal IPC Actors, and are implemented as JS classes (subclasses of <code class="docutils literal notranslate"><span class="pre">JSWindowActorParent</span></code> and <code class="docutils literal notranslate"><span class="pre">JSWindowActorChild</span></code>) instantiated when requested for any particular window. Like the Frame Message Manager, they are ultimately using IPC Actors to communicate under the hood.</p>
</div>
<div class="figure align-default">
<a class="reference internal image-reference" href="../../_images/Fission-actors-diagram.png"><img alt="../../_images/Fission-actors-diagram.png" src="../../_images/Fission-actors-diagram.png" style="width: 233px; height: 240px;" /></a>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Like the Message Manager, JSWindowActors are implemented for both in-process and out-of-process frame communication. This means that porting to JSWindowActors can be done immediately without waiting for out-of-process iframes to be enabled.</p>
</div>
</div>
</div>
</div>
<div class="section" id="communication-with-actors">
<h2>Communication with actors<a class="headerlink" href="#communication-with-actors" title="Permalink to this headline">¶</a></h2>
<div class="section" id="sending-messages">
<h3>Sending messages<a class="headerlink" href="#sending-messages" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">JSActor</span></code> base class exposes two methods for sending messages. Both methods are asynchronous.
There <strong>is no way to send messages synchronously</strong> with <code class="docutils literal notranslate"><span class="pre">JSActor</span></code>.</p>
<div class="section" id="sendasyncmessage">
<h4><code class="docutils literal notranslate"><span class="pre">sendAsyncMessage</span></code><a class="headerlink" href="#sendasyncmessage" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>sendAsyncMessage(“SomeMessage”, value);</p>
</div></blockquote>
<p>Where <cite>value</cite> is anything  that can be serialized using the structured clone algorithm. Additionally, a <code class="docutils literal notranslate"><span class="pre">nsIPrincipal</span></code> can be sent without having to manually serializing and deserializing it.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Cross Process Object Wrappers (CPOWs) cannot be sent over JSWindowActors.</p>
</div>
</div>
<div class="section" id="sendquery">
<h4><code class="docutils literal notranslate"><span class="pre">sendQuery</span></code><a class="headerlink" href="#sendquery" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>Promise&lt;any&gt; sendQuery(“SomeMessage”, value);</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">sendQuery</span></code> improves upon <code class="docutils literal notranslate"><span class="pre">sendAsyncMessage</span></code> by returning a <code class="docutils literal notranslate"><span class="pre">Promise</span></code>. The receiver of the message must then return a <code class="docutils literal notranslate"><span class="pre">Promise</span></code> that can eventually resolve into a value - at which time the <code class="docutils literal notranslate"><span class="pre">sendQuery</span></code> <code class="docutils literal notranslate"><span class="pre">Promise</span></code> resolves with that value.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">sendQuery</span></code> method arguments follow the same conventions as <code class="docutils literal notranslate"><span class="pre">sendAsyncMessage</span></code>, with the second argument being a structured clone.</p>
</div>
</div>
<div class="section" id="receiving-messages">
<h3>Receiving messages<a class="headerlink" href="#receiving-messages" title="Permalink to this headline">¶</a></h3>
<div class="section" id="receivemessage">
<h4><code class="docutils literal notranslate"><span class="pre">receiveMessage</span></code><a class="headerlink" href="#receivemessage" title="Permalink to this headline">¶</a></h4>
<p>To receive messages, you need to implement</p>
<blockquote>
<div><p>receiveMessage(value)</p>
</div></blockquote>
<p>The method receives a single argument, which is the de-serialized arguments that were sent via either <code class="docutils literal notranslate"><span class="pre">sendAsyncMessage</span></code> or <code class="docutils literal notranslate"><span class="pre">sendQuery</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If <cite>receiveMessage</cite> is responding to a <cite>sendQuery</cite>, it MUST return a <code class="docutils literal notranslate"><span class="pre">Promise</span></code> for that message.</p>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Using <code class="docutils literal notranslate"><span class="pre">sendQuery</span></code>, and the <code class="docutils literal notranslate"><span class="pre">receiveMessage</span></code> is able to return a value right away? Try using <code class="docutils literal notranslate"><span class="pre">Promise.resolve(value);</span></code> to return <code class="docutils literal notranslate"><span class="pre">value</span></code>, or you could also make your <code class="docutils literal notranslate"><span class="pre">receiveMessage</span></code> method an async function, presuming none of the other messages it handles need to get a non-Promise return value.</p>
</div>
</div>
</div>
<div class="section" id="other-methods-that-can-be-overridden">
<h3>Other methods that can be overridden<a class="headerlink" href="#other-methods-that-can-be-overridden" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">constructor()</span></code></p>
<p>If there’s something you need to do as soon as the <code class="docutils literal notranslate"><span class="pre">JSActor</span></code> is instantiated, the <code class="docutils literal notranslate"><span class="pre">constructor</span></code> function is a great place to do that.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>At this point the infrastructure for sending messages is not ready yet and objects such as <code class="docutils literal notranslate"><span class="pre">manager</span></code> or <code class="docutils literal notranslate"><span class="pre">browsingContext</span></code> are not available.</p>
</div>
<div class="section" id="observe-subject-topic-data">
<h4><code class="docutils literal notranslate"><span class="pre">observe(subject,</span> <span class="pre">topic,</span> <span class="pre">data)</span></code><a class="headerlink" href="#observe-subject-topic-data" title="Permalink to this headline">¶</a></h4>
<p>If you register your Actor to listen for <code class="docutils literal notranslate"><span class="pre">nsIObserver</span></code> notifications, implement an <code class="docutils literal notranslate"><span class="pre">observe</span></code> method with the above signature to handle the notification.</p>
</div>
<div class="section" id="handleevent-event">
<h4><code class="docutils literal notranslate"><span class="pre">handleEvent(event)</span></code><a class="headerlink" href="#handleevent-event" title="Permalink to this headline">¶</a></h4>
<p>If you register your Actor to listen for content events, implement a <code class="docutils literal notranslate"><span class="pre">handleEvent</span></code> method with the above signature to handle the event.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Only JSWindowActors can register to listen for content events.</p>
</div>
</div>
<div class="section" id="actorcreated">
<h4><code class="docutils literal notranslate"><span class="pre">actorCreated</span></code><a class="headerlink" href="#actorcreated" title="Permalink to this headline">¶</a></h4>
<p>This method is called immediately <em>after</em> a child actor is created and initialized. Unlike the actor’s constructor, it is possible to do things like access the actor’s content window and send messages from this callback.</p>
</div>
<div class="section" id="willdestroy">
<h4><code class="docutils literal notranslate"><span class="pre">willDestroy</span></code><a class="headerlink" href="#willdestroy" title="Permalink to this headline">¶</a></h4>
<p>This method is called when we know that the <cite>JSActor</cite> pair is going to be destroyed because the associated BrowsingContext is going away. You should override this method if you have any cleanup you need to do before going away.</p>
<p>You can also use <code class="docutils literal notranslate"><span class="pre">willDestroy</span></code> as a last opportunity to send messages to the other side, as the communications channel at this point is still running.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This method cannot be async.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As a <cite>JSProcessActorChild</cite> is destroyed when its process dies, a <cite>JSProcessActorChild</cite> will never receive this call.</p>
</div>
</div>
<div class="section" id="diddestroy">
<h4><code class="docutils literal notranslate"><span class="pre">didDestroy</span></code><a class="headerlink" href="#diddestroy" title="Permalink to this headline">¶</a></h4>
<p>This is another point to clean-up an Actor before it is destroyed, but at this point, no communication is possible with the other side.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This method cannot be async.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As a <cite>JSProcessActorChild</cite> is destroyed when its process dies, a <cite>JSProcessActorChild</cite> will never receive this call.</p>
</div>
</div>
</div>
<div class="section" id="other-things-exposed-on-a-jswindowactorparent">
<h3>Other things exposed on a JSWindowActorParent<a class="headerlink" href="#other-things-exposed-on-a-jswindowactorparent" title="Permalink to this headline">¶</a></h3>
<div class="section" id="canonicalbrowsingcontext">
<h4><code class="docutils literal notranslate"><span class="pre">CanonicalBrowsingContext</span></code><a class="headerlink" href="#canonicalbrowsingcontext" title="Permalink to this headline">¶</a></h4>
<p>TODO</p>
</div>
<div class="section" id="windowglobalparent">
<h4><code class="docutils literal notranslate"><span class="pre">WindowGlobalParent</span></code><a class="headerlink" href="#windowglobalparent" title="Permalink to this headline">¶</a></h4>
<p>TODO</p>
</div>
</div>
<div class="section" id="other-things-exposed-on-a-jswindowactorchild">
<h3>Other things exposed on a JSWindowActorChild<a class="headerlink" href="#other-things-exposed-on-a-jswindowactorchild" title="Permalink to this headline">¶</a></h3>
<div class="section" id="browsingcontext">
<h4><code class="docutils literal notranslate"><span class="pre">BrowsingContext</span></code><a class="headerlink" href="#browsingcontext" title="Permalink to this headline">¶</a></h4>
<p>TODO</p>
</div>
<div class="section" id="windowglobalchild">
<h4><code class="docutils literal notranslate"><span class="pre">WindowGlobalChild</span></code><a class="headerlink" href="#windowglobalchild" title="Permalink to this headline">¶</a></h4>
<p>TODO</p>
</div>
<div class="section" id="helpful-getters">
<h4>Helpful getters<a class="headerlink" href="#helpful-getters" title="Permalink to this headline">¶</a></h4>
<p>A number of helpful getters exist on a <code class="docutils literal notranslate"><span class="pre">JSWindowActorChild</span></code>, including:</p>
<div class="section" id="this-document">
<h5><code class="docutils literal notranslate"><span class="pre">this.document</span></code><a class="headerlink" href="#this-document" title="Permalink to this headline">¶</a></h5>
<p>The currently loaded document in the frame associated with this <code class="docutils literal notranslate"><span class="pre">JSWindowActorChild</span></code>.</p>
</div>
<div class="section" id="this-contentwindow">
<h5><code class="docutils literal notranslate"><span class="pre">this.contentWindow</span></code><a class="headerlink" href="#this-contentwindow" title="Permalink to this headline">¶</a></h5>
<p>The outer window for the frame associated with this <code class="docutils literal notranslate"><span class="pre">JSWindowActorChild</span></code>.</p>
</div>
<div class="section" id="this-docshell">
<h5><code class="docutils literal notranslate"><span class="pre">this.docShell</span></code><a class="headerlink" href="#this-docshell" title="Permalink to this headline">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">nsIDocShell</span></code> for the frame associated with this <code class="docutils literal notranslate"><span class="pre">JSWindowActorChild</span></code>.</p>
<p>See <a class="reference external" href="https://searchfox.org/mozilla-central/source/dom/chrome-webidl/JSWindowActor.webidl">JSWindowActor.webidl</a> for more detail on exactly what is exposed on both <code class="docutils literal notranslate"><span class="pre">JSWindowActorParent</span></code> and <code class="docutils literal notranslate"><span class="pre">JSWindowActorChild</span></code> implementations.</p>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-port-from-message-manager-and-framescripts-to-jswindowactors">
<h2>How to port from message manager and framescripts to JSWindowActors<a class="headerlink" href="#how-to-port-from-message-manager-and-framescripts-to-jswindowactors" title="Permalink to this headline">¶</a></h2>
<div class="section" id="message-manager-actors">
<span id="fission-message-manager-actors"></span><h3>Message Manager Actors<a class="headerlink" href="#message-manager-actors" title="Permalink to this headline">¶</a></h3>
<p>While the JSWindowActor mechanism was being designed and developed, large sections of our framescripts were converted to an “actor style” pattern to make eventual porting to JSWindowActors easier. These Actors use the Message Manager under the hood, but made it much easier to shrink our framescripts, and also allowed us to gain significant memory savings by having the actors be lazily instantiated.</p>
<p>You can find the list of Message Manager Actors (or “Legacy Actors”) in <a class="reference external" href="https://searchfox.org/mozilla-central/source/browser/components/BrowserGlue.jsm">BrowserGlue.jsm</a> and <a class="reference external" href="https://searchfox.org/mozilla-central/source/toolkit/modules/ActorManagerParent.jsm">ActorManagerParent.jsm</a>, in the <code class="docutils literal notranslate"><span class="pre">LEGACY_ACTORS</span></code> lists.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The split in Message Manager Actors defined between <code class="docutils literal notranslate"><span class="pre">BrowserGlue</span></code> and <code class="docutils literal notranslate"><span class="pre">ActorManagerParent</span></code> is mainly to keep Firefox Desktop specific Actors separate from Actors that can (in theory) be instantiated for non-Desktop browsers (like Fennec and GeckoView-based browsers). Firefox Desktop-specific Actors should be registered in <code class="docutils literal notranslate"><span class="pre">BrowserGlue</span></code>. Shared “toolkit” Actors should go into <code class="docutils literal notranslate"><span class="pre">ActorManagerParent</span></code>.</p>
</div>
<p>“Porting” these Actors often means doing what is necessary in order to move their registration entries from <code class="docutils literal notranslate"><span class="pre">LEGACY_ACTORS</span></code> to the <code class="docutils literal notranslate"><span class="pre">JSWINDOWACTORS</span></code> list.</p>
</div>
<div class="section" id="figuring-out-the-lifetime-of-a-new-actor-pair">
<h3>Figuring out the lifetime of a new Actor pair<a class="headerlink" href="#figuring-out-the-lifetime-of-a-new-actor-pair" title="Permalink to this headline">¶</a></h3>
<p>In the old model, framescript were loaded and executed as soon as possible by the top-level frame. In the JSWindowActor model, the Actors are much lazier, and only instantiate when:</p>
<ol class="arabic simple">
<li><p>They’re instantiated explicitly by calling <code class="docutils literal notranslate"><span class="pre">getActor</span></code> on a <code class="docutils literal notranslate"><span class="pre">WindowGlobal</span></code>, and passing in the name of the Actor.</p></li>
<li><p>A message is sent to them.</p></li>
<li><p>A pre-defined <code class="docutils literal notranslate"><span class="pre">nsIObserver</span></code> observer notification fires with the subject of the notification corresponding to an inner or outer window.</p></li>
<li><p>A pre-defined content Event fires.</p></li>
</ol>
<p>Making the Actors lazy like this saves on processing time to get a frame ready to load web pages, as well as the overhead of loading the Actor into memory.</p>
<p>When porting a framescript to JSWindowActors, often the first question to ask is: what’s the entrypoint? At what point should the Actors instantiate and become active?</p>
<p>For example, when porting the content area context menu for Firefox, it was noted that the <code class="docutils literal notranslate"><span class="pre">contextmenu</span></code> event firing in content was a natural event to wait for to instantiate the Actor pair. Once the <code class="docutils literal notranslate"><span class="pre">ContextMenuChild</span></code> instantiated, the <code class="docutils literal notranslate"><span class="pre">handleEvent</span></code> method was used to inspect the event and prepare a message to be sent to the <code class="docutils literal notranslate"><span class="pre">ContextMenuParent</span></code>. This example can be found by looking at the patch for the <a class="reference external" href="https://hg.mozilla.org/mozilla-central/rev/adc60720b7b8">Context Menu Fission Port</a>.</p>
</div>
<div class="section" id="using-contentdomreference-instead-of-cpows">
<span id="fission-registering-a-new-jswindowactor"></span><h3>Using ContentDOMReference instead of CPOWs<a class="headerlink" href="#using-contentdomreference-instead-of-cpows" title="Permalink to this headline">¶</a></h3>
<p>Despite being outlawed as a way of synchronously accessing the properties of objects in other processes, CPOWs ended up being useful as a way of passing handles for DOM elements between processes.</p>
<p>CPOW messages, however, cannot be sent over the JSWindowActor communications pipe, so this handy mechanism will no longer work.</p>
<p>Instead, a new module called <a class="reference external" href="https://searchfox.org/mozilla-central/source/toolkit/modules/ContentDOMReference.jsm">ContentDOMReference.jsm</a> has been created which supplies the same capability. See that file for documentation.</p>
</div>
<div class="section" id="how-to-start-porting-parent-process-browser-code-to-use-jswindowactors">
<h3>How to start porting parent-process browser code to use JSWindowActors<a class="headerlink" href="#how-to-start-porting-parent-process-browser-code-to-use-jswindowactors" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="#fission-message-manager-actors"><span class="std std-ref">Message Manager Actors</span></a> work made it much easier to migrate away from framescripts towards something that is similar to <code class="docutils literal notranslate"><span class="pre">JSWindowActors</span></code>. It did not, however, substantially change how the parent process interacted with those framescripts.</p>
<p>So when porting code to work with <code class="docutils literal notranslate"><span class="pre">JSWindowActors</span></code>, we find that this is often where the time goes - refactoring the parent process browser code to accommodate the new <code class="docutils literal notranslate"><span class="pre">JSWindowActor</span></code> model.</p>
<p>Usually, the first thing to do is to find a reasonable name for your actor pair, and get them registered (see <a class="reference internal" href="#fission-registering-a-new-jswindowactor"><span class="std std-ref">Using ContentDOMReference instead of CPOWs</span></a>), even if the actors implementations themselves are nothing but unmodified subclasses of <code class="docutils literal notranslate"><span class="pre">JSWindowActorParent</span></code> and <code class="docutils literal notranslate"><span class="pre">JSWindowActorChild</span></code>.</p>
<p>Next, it’s often helpful to find and note all of the places where <code class="docutils literal notranslate"><span class="pre">sendAsyncMessage</span></code> is being used to send messages through the old message manager interface for the component you’re porting, and where any messages listeners are defined.</p>
<p>Let’s look at a hypothetical example. Suppose we’re porting part of the Page Info dialog, which scans each frame for useful information to display in the dialog. Given a chunk of code like this:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// This is some hypothetical Page Info dialog code.</span>

<span class="kd">let</span> <span class="nx">mm</span> <span class="o">=</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">messageManager</span><span class="p">;</span>
<span class="nx">mm</span><span class="p">.</span><span class="nx">sendAsyncMessage</span><span class="p">(</span><span class="s2">&quot;PageInfo:getInfoFromAllFrames&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">someArgument</span><span class="o">:</span> <span class="mf">123</span> <span class="p">});</span>

<span class="c1">// ... and then later on</span>

<span class="nx">mm</span><span class="p">.</span><span class="nx">addMessageListener</span><span class="p">(</span><span class="s2">&quot;PageInfo:info&quot;</span><span class="p">,</span> <span class="nx">async</span> <span class="kd">function</span> <span class="nx">onmessage</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="p">});</span>
</pre></div>
</div>
<p>If a <code class="docutils literal notranslate"><span class="pre">PageInfo</span></code> pair of <code class="docutils literal notranslate"><span class="pre">JSWindowActor</span></code>’s is registered, it might be tempting to simply replace the first part with:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nx">actor</span> <span class="o">=</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">browsingContext</span><span class="p">.</span><span class="nx">currentWindowGlobal</span><span class="p">.</span><span class="nx">getActor</span><span class="p">(</span><span class="s2">&quot;PageInfo&quot;</span><span class="p">);</span>
<span class="nx">actor</span><span class="p">.</span><span class="nx">sendAsyncMessage</span><span class="p">(</span><span class="s2">&quot;PageInfo:getInfoFromAllFrames&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">someArgument</span><span class="o">:</span> <span class="mf">123</span> <span class="p">});</span>
</pre></div>
</div>
<p>However, if any of the frames on the page are running in their own process, they’re not going to receive that <code class="docutils literal notranslate"><span class="pre">PageInfo:getInfoFromAllFrames</span></code> message. Instead, in this case, we should walk the <code class="docutils literal notranslate"><span class="pre">BrowsingContext</span></code> tree, and instantiate a <code class="docutils literal notranslate"><span class="pre">PageInfo</span></code> actor for each global, and send one message each to get information for each frame. Perhaps something like this:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nx">contextsToVisit</span> <span class="o">=</span> <span class="p">[</span><span class="nx">browser</span><span class="p">.</span><span class="nx">browsingContext</span><span class="p">];</span>
<span class="k">while</span> <span class="p">(</span><span class="nx">contextsToVisit</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">currentContext</span> <span class="o">=</span> <span class="nx">contextsToVisit</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
  <span class="kd">let</span> <span class="nx">global</span> <span class="o">=</span> <span class="nx">currentContext</span><span class="p">.</span><span class="nx">currentWindowGlobal</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">global</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">continue</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">actor</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">getActor</span><span class="p">(</span><span class="s2">&quot;PageInfo&quot;</span><span class="p">);</span>
  <span class="nx">actor</span><span class="p">.</span><span class="nx">sendAsyncMessage</span><span class="p">(</span><span class="s2">&quot;PageInfo:getInfoForFrame&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">someArgument</span><span class="o">:</span> <span class="mf">123</span> <span class="p">});</span>

  <span class="nx">contextsToVisit</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">currentContext</span><span class="p">.</span><span class="nx">children</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The original <code class="docutils literal notranslate"><span class="pre">&quot;PageInfo:info&quot;</span></code> message listener will need to be updated, too. Any responses from the <code class="docutils literal notranslate"><span class="pre">PageInfoChild</span></code> actor will end up being passed to the <code class="docutils literal notranslate"><span class="pre">receiveMessage</span></code> method of the <code class="docutils literal notranslate"><span class="pre">PageInfoParent</span></code> actor. It will be necessary to pass that information along to the interested party (in this case, the dialog code which is showing the table of interesting Page Info).</p>
<p>It might be necessary to refactor or rearchitect the original senders and consumers of message manager messages in order to accommodate the <code class="docutils literal notranslate"><span class="pre">JSWindowActor</span></code> model. Sometimes it’s also helpful to have a singleton management object that manages all <code class="docutils literal notranslate"><span class="pre">JSWindowActorParent</span></code> instances and does something with their results.</p>
</div>
<div class="section" id="where-to-store-state">
<h3>Where to store state<a class="headerlink" href="#where-to-store-state" title="Permalink to this headline">¶</a></h3>
<p>It’s not a good idea to store any state within a <code class="docutils literal notranslate"><span class="pre">JSWindowActorChild</span></code> that you want to last beyond the lifetime of its <code class="docutils literal notranslate"><span class="pre">BrowsingContext</span></code>. An out-of-process <code class="docutils literal notranslate"><span class="pre">&lt;iframe&gt;</span></code> can be closed at any time, and if it’s the only one for a particular content process, that content process will soon be shut down, and any state you may have stored there will go away.</p>
<p>Your best bet for storing state is in the parent process.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>If each individual frame needs state, consider using a <code class="docutils literal notranslate"><span class="pre">WeakMap</span></code> in the parent process, mapping <code class="docutils literal notranslate"><span class="pre">CanonicalBrowsingContext</span></code>’s with that state. That way, if the associates frames ever go away, you don’t have to do any cleaning up yourself.</p>
</div>
<p>If you have state that you want multiple <code class="docutils literal notranslate"><span class="pre">JSWindowActorParent</span></code>’s to have access to, consider having a “manager” of those <code class="docutils literal notranslate"><span class="pre">JSWindowActorParent</span></code>’s inside of the same .jsm file to hold that state.</p>
</div>
</div>
<div class="section" id="registering-a-new-actor">
<h2>Registering a new actor<a class="headerlink" href="#registering-a-new-actor" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">ChromeUtils</span></code> exposes an API for registering actors, but both <code class="docutils literal notranslate"><span class="pre">BrowserGlue</span></code> and <code class="docutils literal notranslate"><span class="pre">ActorManagerParent</span></code> are the main entry points where the registration occurs. If you want to register an actor,
you should add it either to <code class="docutils literal notranslate"><span class="pre">JSPROCESSACTORS</span></code> or <code class="docutils literal notranslate"><span class="pre">JSWINDOWACTORS</span></code> in either of those two files.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">JS*ACTORS</span></code> objects, each key is the name of the actor pair (example: <code class="docutils literal notranslate"><span class="pre">ContextMenu</span></code>), and the associated value is an <code class="docutils literal notranslate"><span class="pre">Object</span></code> of registration parameters.</p>
<p>The full list of registration parameters can be found:</p>
<ul class="simple">
<li><p>for JSProcessActor in file <a class="reference external" href="https://searchfox.org/mozilla-central/source/dom/chrome-webidl/JSWindowActor.webidl">JSProcessActor.webidl</a> as <code class="docutils literal notranslate"><span class="pre">WindowActorOptions</span></code>, <code class="docutils literal notranslate"><span class="pre">ProcessActorSidedOptions</span></code> and <code class="docutils literal notranslate"><span class="pre">ProcessActorChildOptions</span></code>.</p></li>
<li><p>for JSWindowActor in file <a class="reference external" href="https://searchfox.org/mozilla-central/source/dom/chrome-webidl/JSWindowActor.webidl">JSWindowActor.webidl</a> as <code class="docutils literal notranslate"><span class="pre">WindowActorOptions</span></code>, <code class="docutils literal notranslate"><span class="pre">WindowActorSidedOptions</span></code> and <code class="docutils literal notranslate"><span class="pre">WindowActorChildOptions</span></code>.</p></li>
</ul>
<p>Here’s an example <code class="docutils literal notranslate"><span class="pre">JSWindowActor</span></code> registration pulled from <code class="docutils literal notranslate"><span class="pre">BrowserGlue.jsm</span></code>:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">Plugin</span><span class="o">:</span> <span class="p">{</span>
   <span class="nx">kind</span><span class="o">:</span> <span class="s2">&quot;JSWindowActor&quot;</span><span class="p">,</span>
   <span class="nx">parent</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">moduleURI</span><span class="o">:</span> <span class="s2">&quot;resource:///actors/PluginParent.jsm&quot;</span><span class="p">,</span>
   <span class="p">},</span>
   <span class="nx">child</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">moduleURI</span><span class="o">:</span> <span class="s2">&quot;resource:///actors/PluginChild.jsm&quot;</span><span class="p">,</span>
     <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
       <span class="nx">PluginBindingAttached</span><span class="o">:</span> <span class="p">{</span> <span class="nx">capture</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">wantUntrusted</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
       <span class="nx">PluginCrashed</span><span class="o">:</span> <span class="p">{</span> <span class="nx">capture</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
       <span class="nx">PluginOutdated</span><span class="o">:</span> <span class="p">{</span> <span class="nx">capture</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
       <span class="nx">PluginInstantiated</span><span class="o">:</span> <span class="p">{</span> <span class="nx">capture</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
       <span class="nx">PluginRemoved</span><span class="o">:</span> <span class="p">{</span> <span class="nx">capture</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
       <span class="nx">HiddenPlugin</span><span class="o">:</span> <span class="p">{</span> <span class="nx">capture</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
     <span class="p">},</span>

     <span class="nx">observers</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;decoder-doctor-notification&quot;</span><span class="p">],</span>
   <span class="p">},</span>

   <span class="nx">allFrames</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
 <span class="p">},</span>
</pre></div>
</div>
<p>This example is for the JSWindowActor implementation of click-to-play for Flash.</p>
<p>Let’s examine parent registration:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">parent</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">moduleURI</span><span class="o">:</span> <span class="s2">&quot;resource:///actors/PluginParent.jsm&quot;</span><span class="p">,</span>
<span class="p">},</span>
</pre></div>
</div>
<p>Here, we’re declaring that class <code class="docutils literal notranslate"><span class="pre">PluginParent</span></code> (here, a subclass of <code class="docutils literal notranslate"><span class="pre">JSWindowActorParent</span></code>) is defined and exported from module <code class="docutils literal notranslate"><span class="pre">PluginParent.jsm</span></code>. That’s all we have to say for the parent (main process) side of things.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It’s not sufficient to just add a new .jsm file to the actors subdirectories. You also need to update the <code class="docutils literal notranslate"><span class="pre">moz.build</span></code> files in the same directory to get the <code class="docutils literal notranslate"><span class="pre">resource://</span></code> linkages set up correctly.</p>
</div>
<p>Let’s look at the second chunk:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span>  <span class="nx">child</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">moduleURI</span><span class="o">:</span> <span class="s2">&quot;resource:///actors/PluginChild.jsm&quot;</span><span class="p">,</span>
    <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">PluginBindingAttached</span><span class="o">:</span> <span class="p">{</span> <span class="nx">capture</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">wantUntrusted</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
      <span class="nx">PluginCrashed</span><span class="o">:</span> <span class="p">{</span> <span class="nx">capture</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
      <span class="nx">PluginOutdated</span><span class="o">:</span> <span class="p">{</span> <span class="nx">capture</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
      <span class="nx">PluginInstantiated</span><span class="o">:</span> <span class="p">{</span> <span class="nx">capture</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
      <span class="nx">PluginRemoved</span><span class="o">:</span> <span class="p">{</span> <span class="nx">capture</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
      <span class="nx">HiddenPlugin</span><span class="o">:</span> <span class="p">{</span> <span class="nx">capture</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="p">},</span>

    <span class="nx">observers</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;decoder-doctor-notification&quot;</span><span class="p">],</span>
  <span class="p">},</span>

  <span class="nx">allFrames</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
<span class="p">},</span>
</pre></div>
</div>
<p>We’re similarly declaring where the <code class="docutils literal notranslate"><span class="pre">PluginChild</span></code> subclassing <code class="docutils literal notranslate"><span class="pre">JSWindowActorChild</span></code> can be found.</p>
<p>Next, we declare the content events, if fired in a BrowsingContext, will cause the JSWindowActor pair to instantiate if it doesn’t already exist, and then have <code class="docutils literal notranslate"><span class="pre">handleEvent</span></code> called on the <code class="docutils literal notranslate"><span class="pre">PluginChild</span></code> instance. For each event name, an Object of event listener options can be passed. You can use the same event listener options as accepted by <code class="docutils literal notranslate"><span class="pre">addEventListener</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Content events make sense for <code class="docutils literal notranslate"><span class="pre">JSWindowActorChild</span></code> (which <em>have</em> a content) but are ignored for <code class="docutils literal notranslate"><span class="pre">JSProcessActorChild</span></code> (which don’t).</p>
</div>
<p>Next, we declare that <code class="docutils literal notranslate"><span class="pre">PluginChild</span></code> should observe the <code class="docutils literal notranslate"><span class="pre">decoder-doctor-notification</span></code> <code class="docutils literal notranslate"><span class="pre">nsIObserver</span></code> notification. When that observer notification fires, the <code class="docutils literal notranslate"><span class="pre">PluginChild</span></code> actor will be instantiated for the <code class="docutils literal notranslate"><span class="pre">BrowsingContext</span></code> corresponding to the inner or outer window that is the subject argument of the observer notification, and the <code class="docutils literal notranslate"><span class="pre">observe</span></code> method on that <code class="docutils literal notranslate"><span class="pre">PluginChild</span></code> implementation will be called. If you need this functionality to work with other subjects, please file a bug.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Unlike <code class="docutils literal notranslate"><span class="pre">JSWindowActorChild</span></code> subclasses, observer topics specified for <code class="docutils literal notranslate"><span class="pre">JSProcessActorChild</span></code> subclasses will cause those child actor instances to be created and invoke their <code class="docutils literal notranslate"><span class="pre">observe</span></code> method no matter what the subject argument of the observer is.</p>
</div>
<p>Finally, we say that the <code class="docutils literal notranslate"><span class="pre">PluginChild</span></code> actor should apply to <code class="docutils literal notranslate"><span class="pre">allFrames</span></code>. This means that the <code class="docutils literal notranslate"><span class="pre">PluginChild</span></code> is allowed to be loaded in any subframe. If <code class="docutils literal notranslate"><span class="pre">allFrames</span></code> is set to false (the default), the actor will only ever load in the top-level frame.</p>
<div class="section" id="design-considerations-when-adding-a-new-actor">
<h3>Design considerations when adding a new actor<a class="headerlink" href="#design-considerations-when-adding-a-new-actor" title="Permalink to this headline">¶</a></h3>
<p>A few things worth bearing in mind when adding your own actor registration:</p>
<ul class="simple">
<li><p>Any <code class="docutils literal notranslate"><span class="pre">child</span></code> or <code class="docutils literal notranslate"><span class="pre">parent</span></code> side you register <strong>must</strong> have a <code class="docutils literal notranslate"><span class="pre">moduleURI</span></code> property.</p></li>
<li><p>You do not need to have both <code class="docutils literal notranslate"><span class="pre">child</span></code> and <code class="docutils literal notranslate"><span class="pre">parent</span></code> modules, and should avoid having actor sides that do nothing but send messages. The process without a defined module will still get an actor, and you can send messages from that side, but cannot receive them via <code class="docutils literal notranslate"><span class="pre">receiveMessage</span></code>. Note that you <strong>can</strong> also use <code class="docutils literal notranslate"><span class="pre">sendQuery</span></code> from this side, enabling you to handle a response from the other process despite not having a <code class="docutils literal notranslate"><span class="pre">receiveMessage</span></code> method.</p></li>
<li><p>If you are writing a JSWindowActor, consider whether you really need <code class="docutils literal notranslate"><span class="pre">allFrames</span></code> - it’ll save memory and CPU time if we don’t need to instantiate the actor for subframes.</p></li>
<li><p>When copying/moving “Legacy” <a class="reference internal" href="#fission-message-manager-actors"><span class="std std-ref">Message Manager Actors</span></a>, remove their <code class="docutils literal notranslate"><span class="pre">messages</span></code> properties. They are no longer necessary.</p></li>
</ul>
</div>
</div>
<div class="section" id="minimal-example-actors">
<h2>Minimal Example Actors<a class="headerlink" href="#minimal-example-actors" title="Permalink to this headline">¶</a></h2>
<div class="section" id="get-a-jswindowactor">
<h3>Get a JSWindowActor<a class="headerlink" href="#get-a-jswindowactor" title="Permalink to this headline">¶</a></h3>
<p><strong>Define an Actor</strong></p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// resource://testing-common/TestWindowParent.jsm</span>
<span class="kd">var</span> <span class="nx">EXPORTED_SYMBOLS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TestWindowParent&quot;</span><span class="p">];</span>
<span class="kr">class</span> <span class="nx">TestParent</span> <span class="kr">extends</span> <span class="nx">JSWindowActorParent</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// resource://testing-common/TestWindowChild.jsm</span>
<span class="kd">var</span> <span class="nx">EXPORTED_SYMBOLS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TestWindowChild&quot;</span><span class="p">];</span>
<span class="kr">class</span> <span class="nx">TestChild</span> <span class="kr">extends</span> <span class="nx">JSWindowActorChild</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Get a JS window actor for a specific window</strong></p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// get parent side actor</span>
<span class="kd">let</span> <span class="nx">parentActor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">browsingContext</span><span class="p">.</span><span class="nx">currentWindowGlobal</span><span class="p">.</span><span class="nx">getActor</span><span class="p">(</span><span class="s2">&quot;TestWindow&quot;</span><span class="p">);</span>

<span class="c1">// get child side actor</span>
<span class="kd">let</span> <span class="nx">childActor</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">windowGlobalChild</span><span class="p">.</span><span class="nx">getActor</span><span class="p">(</span><span class="s2">&quot;TestWindow&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="get-a-jsprocessactor">
<h3>Get a JSProcessActor<a class="headerlink" href="#get-a-jsprocessactor" title="Permalink to this headline">¶</a></h3>
<p><strong>Define an Actor</strong></p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// resource://testing-common/TestProcessParent.jsm</span>
<span class="kd">var</span> <span class="nx">EXPORTED_SYMBOLS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TestProcessParent&quot;</span><span class="p">];</span>
<span class="kr">class</span> <span class="nx">TestParent</span> <span class="kr">extends</span> <span class="nx">JSProcessActorParent</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// resource://testing-common/TestProcessChild.jsm</span>
<span class="kd">var</span> <span class="nx">EXPORTED_SYMBOLS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TestProcessChild&quot;</span><span class="p">];</span>
<span class="kr">class</span> <span class="nx">TestChild</span> <span class="kr">extends</span> <span class="nx">JSProcessActorChild</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Get a JS process actor for a specific process</strong></p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// get parent side actor</span>
<span class="kd">let</span> <span class="nx">parentActor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">browser</span>
  <span class="p">.</span><span class="nx">browsingContext</span>
  <span class="p">.</span><span class="nx">currentWindowGlobal</span>
  <span class="p">.</span><span class="nx">domProcess</span>
  <span class="p">.</span><span class="nx">getActor</span><span class="p">(</span><span class="s2">&quot;TestProcess&quot;</span><span class="p">);</span>

<span class="c1">// get child side actor</span>
<span class="kd">let</span> <span class="nx">childActor</span> <span class="o">=</span> <span class="nx">ChromeUtils</span><span class="p">.</span><span class="nx">domProcessChild</span>
  <span class="p">.</span><span class="nx">getActor</span><span class="p">(</span><span class="s2">&quot;TestProcess&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="and-more">
<h1>And more<a class="headerlink" href="#and-more" title="Permalink to this headline">¶</a></h1>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="mainthread.html" class="btn btn-neutral float-right" title="Main Thread Actors" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="DOM IPC" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>