

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Remote agent overall architecture &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Remote agent overall architecture</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/remote/doc/remote/chitecture.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="remote-agent-overall-architecture">
<h1>Remote agent overall architecture<a class="headerlink" href="#remote-agent-overall-architecture" title="Permalink to this headline">¶</a></h1>
<p>This document will cover the Remote Agent architecture by following the sequence of steps needed to start the agent, connect a client and debug a target.</p>
<div class="section" id="remote-agent-startup">
<h2>Remote Agent startup<a class="headerlink" href="#remote-agent-startup" title="Permalink to this headline">¶</a></h2>
<p>Everything starts with <code class="docutils literal notranslate"><span class="pre">RemoteAgent</span></code> class.
This singleton handles command lines arguments (–remote-debugging-port) to eventually
start a server listening on the TCP port 9222 (or the one specified by the command line).
The browser target websocket URL will be printed to stderr.
To do that this component glue together three main high level components:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">server/HTTPD</span></code>
This is a copy of httpd.js, from /netwerk/ folder. This is a JS implementation of an http server.
This will be used to implement the various http endpoints of CDP.
There is a few static URL implemented by <code class="docutils literal notranslate"><span class="pre">JSONHandler</span></code> and one dynamic URL per target.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">JSONHandler</span></code>
This implements the following three static http endpoints:</p>
<ul>
<li><p>/json/version:
Returns information about the runtime as well as the url of the browser target websocket url.</p></li>
<li><p>/json/list:
Returns a list of all debuggable targets with, for each, their dynamic websocket URL.
For now it only reports tabs, but will report workers and addons as soon as we support them.
The main browser target is the only one target not listed here.</p></li>
<li><p>/json/protocol:
Returns a big dictionary describing the supported protocol.
This is currently hard coded and returns the full CDP protocol schema, including APIs we don’t support.
We have a future intention to fix this and report only what Firefox implements.
You can connect to these websocket URL in order to debug things.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">targets/Targets</span></code>
This component is responsible of maintaining the list of all debuggable targets.
For now it can be either:</p>
<ul>
<li><p>The main browser target
A special target which allows to inspect the browser, but not any particular tab.
This is implemented by <code class="docutils literal notranslate"><span class="pre">targets/MainProcessTarget</span></code> and is instantiated on startup.</p></li>
<li><p>Tab targets
Each opened tab will have a related <code class="docutils literal notranslate"><span class="pre">targets/TabTarget</span></code> instantiated on their opening,
or on server startup for already opened ones.
Each target aims at focusing on one particular context. This context is typically running in one
particular environment. This can be a particular process or thread.
In the future, we will most likely support targets for workers and add-ons.
All targets inherit from <code class="docutils literal notranslate"><span class="pre">targets/Target</span></code>.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="connecting-to-websocket-endpoints">
<h2>Connecting to Websocket endpoints<a class="headerlink" href="#connecting-to-websocket-endpoints" title="Permalink to this headline">¶</a></h2>
<p>Each target’s websocket URL will be registered as a HTTP endpoint via <code class="docutils literal notranslate"><span class="pre">server/HTTPD:registerPathHandler</span></code>.
(This registration is done from <code class="docutils literal notranslate"><span class="pre">RemoteAgent:init</span></code>)
Once a HTTP request happens, <code class="docutils literal notranslate"><span class="pre">server/HTTPD</span></code> will call the <code class="docutils literal notranslate"><span class="pre">handle</span></code> method on the object passed to <code class="docutils literal notranslate"><span class="pre">registerPathHandler</span></code>.
For static endpoints registered by <code class="docutils literal notranslate"><span class="pre">JSONHandler</span></code>, this will call <code class="docutils literal notranslate"><span class="pre">JSONHandler:handle</span></code> and return a JSON string as http body.
For target’s endpoint, it is slightly more complicated as it requires a special handshake to morph the HTTP connection into a WebSocket one.
The WebSocket is then going to be long lived and be used to inspect the target over time.
When a request is made to a target URL, <code class="docutils literal notranslate"><span class="pre">targets/Target:handle</span></code> is called and:</p>
<ul class="simple">
<li><p>delegate the complex HTTP to WebSocket handshake operation to <code class="docutils literal notranslate"><span class="pre">server/WebSocketHandshake:upgrade</span></code>
In return we retrieve a WebSocket object.</p></li>
<li><p>hand over this WebSocket to <code class="docutils literal notranslate"><span class="pre">server/WebSocketTransport</span></code>
and get a transport object in return. The transport implements a basic JSON stream over WebSocket. With that, you can send and receive JSON objects over a WebSocket connection.</p></li>
<li><p>hand over the transport to a freshly instantiated <code class="docutils literal notranslate"><span class="pre">Connection</span></code>
The Connection has two goals:</p>
<ul>
<li><p>Interpret incoming CDP packets by reading the JSON object attribute (<code class="docutils literal notranslate"><span class="pre">id</span></code>, <code class="docutils literal notranslate"><span class="pre">method</span></code>, <code class="docutils literal notranslate"><span class="pre">params</span></code> and <code class="docutils literal notranslate"><span class="pre">sessionId</span></code>)
This is done in <code class="docutils literal notranslate"><span class="pre">Connection:onPacket</span></code>.</p></li>
<li><p>Format outgoing CDP packets by writing the right JSON object for command response (<code class="docutils literal notranslate"><span class="pre">id</span></code>, <code class="docutils literal notranslate"><span class="pre">result</span></code> and <code class="docutils literal notranslate"><span class="pre">sessionId</span></code>) and events (<code class="docutils literal notranslate"><span class="pre">method</span></code>, <code class="docutils literal notranslate"><span class="pre">params</span></code> and <code class="docutils literal notranslate"><span class="pre">sessionId</span></code>)</p></li>
<li><p>Redirect CDP packet from/to the right session.
A connection may have more than one session attached to it.</p></li>
</ul>
</li>
<li><p>instantiate the default session
The session is specific to each target kind and all of them inherit from <code class="docutils literal notranslate"><span class="pre">session/Session</span></code>.
For example, tabs targets uses <code class="docutils literal notranslate"><span class="pre">session/TabSession</span></code> and the main browser target uses <code class="docutils literal notranslate"><span class="pre">session/MainProcessSession</span></code>.
Which session class is used is defined by the Target subclass’ constructor, which pass a session class reference to targets/Target:constructor.
A session is mostly responsible of accommodating the eventual cross process/cross thread aspects of the target.
The code we are currently describing (<code class="docutils literal notranslate"><span class="pre">targets/Target:handle</span></code>) is running in the parent process.
The session class receive CDP commands from the connection and first try to execute the Domain commands in the parent process.
Then, if the target actually runs in some other context, the session tries to forward this command to this other context, which can be a thread or a process.
Typically, the <code class="docutils literal notranslate"><span class="pre">sessions/TabSession</span></code> forward the CDP command to the content process where the tab is running.
It also redirects back the command response as well as Domain events from that process back to the parent process in order to
forward them to the connection.
Sessions will be using the <code class="docutils literal notranslate"><span class="pre">Domains</span></code> class as an helper to manage a list of Domain implementations in a given context.</p></li>
</ul>
</div>
<div class="section" id="debugging-additional-targets">
<h2>Debugging additional Targets<a class="headerlink" href="#debugging-additional-targets" title="Permalink to this headline">¶</a></h2>
<p>From a given connection you can know about the other potential targets.
You typically do that via <code class="docutils literal notranslate"><span class="pre">Target.setDiscoverTargets()</span></code>, which will emit <code class="docutils literal notranslate"><span class="pre">Target.targetCreated</span></code> events providing a target ID.
You may create a new session for the new target by handing the ID to <code class="docutils literal notranslate"><span class="pre">Target.attachToTarget()</span></code>, which will return a session ID.
“Target” here is a reference to the CDP Domain implemented in <code class="docutils literal notranslate"><span class="pre">domains/parent/Target.jsm</span></code>. That is different from <code class="docutils literal notranslate"><span class="pre">targets/Target</span></code>
class which is an implementation detail of the Remote Agent.</p>
<p>Then, there is two ways to communicate with the other targets:</p>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">Target.sendMessageToTarget()</span></code> and <code class="docutils literal notranslate"><span class="pre">Target.receivedMessageFromTarget</span></code>
You will manually send commands via the <code class="docutils literal notranslate"><span class="pre">Target.sendMessageToTarget()</span></code> command and receive command’s response as well as events via <code class="docutils literal notranslate"><span class="pre">Target.receivedMessageFromTarget</span></code>.
In both cases, a session ID attribute is passed in the command or event arguments in order to select which additional target you are communicating with.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">Target.attachToTarget({</span> <span class="pre">flatten:</span> <span class="pre">true</span> <span class="pre">})</span></code> and include <code class="docutils literal notranslate"><span class="pre">sessionId</span></code> in CDP packets
This requires a special client, which will use the <code class="docutils literal notranslate"><span class="pre">sessionId</span></code> returned by <code class="docutils literal notranslate"><span class="pre">Target.attachToTarget()</span></code> in order to spawn a distinct client instance.
This client will re-use the same WebSocket connection, but every single CDP packet will contain an additional <code class="docutils literal notranslate"><span class="pre">sessionId</span></code> attribute.
This helps distinguish packets which relate to the original target as well as the multiple additional targets you may attach to.</p></li>
</ul>
<p>In both cases, <code class="docutils literal notranslate"><span class="pre">Target.attachToTarget()</span></code> is special as it will spawn <code class="docutils literal notranslate"><span class="pre">session/TabSession</span></code> for the tab you are attaching to.
This is the codepath creating non-default session. The default session is related to the target you originally connected to,
so that you don’t need any ID for this one. When you want to debug more than one target over a single connection
you need additional sessions, which will have a unique ID.
<code class="docutils literal notranslate"><span class="pre">Target.attachToTarget</span></code> will compute this ID and instantiate a new session bound to the given target.
This additional session will be managed by the <code class="docutils literal notranslate"><span class="pre">Connection</span></code> class, which will then redirect CDP packets to the
right session when you are using flatten session.</p>
</div>
<div class="section" id="cross-process-layers">
<h2>Cross Process / Layers<a class="headerlink" href="#cross-process-layers" title="Permalink to this headline">¶</a></h2>
<p>Because targets may runs in different contexts, the remote agent code runs in different processes.
The main and startup code of the Remote agent code runs in the parent process.
The handling of the command line as well as all the HTTP and WebSocket work is all done in the parent process.
The browser target is also all implemented in the parent process.
But when it comes to a tab target, as the tab runs in the content process, we have to run code there as well.
Let’s start from the <code class="docutils literal notranslate"><span class="pre">sessions/TabSession</span></code> class, which has already been described.
We receive here JSON packets from the WebSocket connection and we are in the parent process.
In this class, we route the messages to the parent process domains first.
If there is no implementation of the domain or the particular method,
we forward the command to a <code class="docutils literal notranslate"><span class="pre">session/ContentProcessSession</span></code> which runs in the tab’s content process.
These two Session classes will interact with each other in order to forward back the returned value
of the method we just called, as well as piping back any event being sent by a Domain implemented in any
of the two processes.</p>
</div>
<div class="section" id="organizational-chart-of-all-the-classes">
<h2>Organizational chart of all the classes<a class="headerlink" href="#organizational-chart-of-all-the-classes" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>            ┌─────────────────────────────────────────────────┐
            │                                                 │
          1 ▼                                                 │
    ┌───────────────┐     1 ┌───────────────┐     1..n┌───────────────┐
    │  RemoteAgent  │──────▶│  HttpServer   │◀───────▶│  JsonHandler  │
    └───────────────┘       └───────────────┘ 1       └───────────────┘
            │
            │
            │              1 ┌────────────┐ 1
            └───────────────▶│  Targets   │◀─┐
                             └────────────┘  │
                                    │        │
                                    ▼ 1..n   │
                             ┌────────────┐  │
           ┌─────────────────│ Target  [1]│  │
           │                 └────────────┘  │
           │                        ▲ 1      │
           ▼ 1..n                   │        │
    ┌────────────┐       1..n┌────────────┐  │
    │ Connection │◀─────────▶│ Session [2]│──┘
    └────────────┘ 1         └────────────┘
           │                      1 ▲
           │                        │
           ▼ 1                      ▼ 1
┌────────────────────┐       ┌────────────┐       1..n┌────────────┐
│ WebSocketTransport │       │  Domains   │──────────▶│ Domain  [3]│
└────────────────────┘       └────────────┘           └────────────┘
</pre></div>
</div>
<p>[1] Target is inherited by TabTarget and MainProcessTarget.
[2] Session is inherited by TabSession and MainProcessSession.
[3] Domain is inherited by Log, Page, Browser, Target…. i.e. all domain implementations. From both domains/parent and domains/content folders.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>