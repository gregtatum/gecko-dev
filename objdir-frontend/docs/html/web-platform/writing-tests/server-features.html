

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Server Features &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Python Handlers" href="python-handlers/index.html" />
    <link rel="prev" title="File Name Flags" href="file-names.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">web-platform-tests documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#video-introduction-transcript">Video Introduction (transcript)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#github">GitHub</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#table-of-contents">Table of Contents</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../test-suite-design.html">Test Suite Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="../intro-video-transcript.html">“Introduction to WPT” video transcript</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running-tests/index.html">Running Tests</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Writing Tests</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="index.html#test-types">Test Types</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#submitting-tests">Submitting Tests</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="index.html#table-of-contents">Table of Contents</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reviewing-tests/index.html">Reviewing Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../admin/index.html">Project Administration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">web-platform-tests documentation</a> &raquo;</li>
        
          <li><a href="index.html">Writing Tests</a> &raquo;</li>
        
      <li>Server Features</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/web-platform/writing-tests/server-features.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="server-features">
<h1>Server Features<a class="headerlink" href="#server-features" title="Permalink to this headline">¶</a></h1>
<p>For many tests, writing one or more static HTML files is
sufficient. However there are a large class of tests for which this
approach is insufficient, including:</p>
<ul class="simple">
<li><p>Tests that require cross-domain access</p></li>
<li><p>Tests that depend on setting specific headers or status codes</p></li>
<li><p>Tests that need to inspect the browser-sent request</p></li>
<li><p>Tests that require state to be stored on the server</p></li>
<li><p>Tests that require precise timing of the response.</p></li>
</ul>
<p>To make writing such tests possible, we are using a number of
server-side components designed to make it easy to manipulate the
precise details of the response:</p>
<ul class="simple">
<li><p><em>wptserve</em>, a custom Python HTTP server</p></li>
<li><p><em>pywebsocket</em>, an existing websockets server</p></li>
<li><p><em>tools/quic</em>, a custom Python 3 QUIC server using <code class="docutils literal notranslate"><span class="pre">aioquic</span></code></p></li>
</ul>
<p>wptserve is a Python-based web server. By default it serves static
files in the test suite. For more sophisticated requirements, several
mechanisms are available to take control of the response. These are
outlined below.</p>
<div class="section" id="tests-involving-multiple-origins">
<h2>Tests Involving Multiple Origins<a class="headerlink" href="#tests-involving-multiple-origins" title="Permalink to this headline">¶</a></h2>
<p>Our test servers are guaranteed to be accessible through two domains
and five subdomains under each. The ‘main’ domain is unnamed; the
other is called ‘alt’. These subdomains are: <code class="docutils literal notranslate"><span class="pre">www</span></code>, <code class="docutils literal notranslate"><span class="pre">www1</span></code>, <code class="docutils literal notranslate"><span class="pre">www2</span></code>,
<code class="docutils literal notranslate"><span class="pre">天気の良い日</span></code>, and <code class="docutils literal notranslate"><span class="pre">élève</span></code>; there is also <code class="docutils literal notranslate"><span class="pre">nonexistent</span></code> which is
guaranteed not to resolve. In addition, the HTTP server listens on two
ports, and the WebSockets server on one. These subdomains and ports
must be used for cross-origin tests.</p>
<p>Tests must not hardcode the hostname of the server that they expect to
be running on or the port numbers, as these are not guaranteed by the
test environment. Instead they can get this information in one of two
ways:</p>
<ul class="simple">
<li><p>From script, using the <code class="docutils literal notranslate"><span class="pre">location</span></code> API.</p></li>
<li><p>By using a textual substitution feature of the server.</p></li>
</ul>
<p>In order for the latter to work, a file must either have a name of the form
<code class="docutils literal notranslate"><span class="pre">{name}.sub.{ext}</span></code> e.g. <code class="docutils literal notranslate"><span class="pre">example-test.sub.html</span></code> or be referenced through a URL
containing <code class="docutils literal notranslate"><span class="pre">pipe=sub</span></code> in the query string e.g. <code class="docutils literal notranslate"><span class="pre">example-test.html?pipe=sub</span></code>.
The substitution syntax uses <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">}}</span></code> to delimit items for substitution. For
example to substitute in the main host name, one would write: <code class="docutils literal notranslate"><span class="pre">{{host}}</span></code>.</p>
<p>To get full domains, including subdomains, there is the <code class="docutils literal notranslate"><span class="pre">hosts</span></code> dictionary,
where the first dimension is the name of the domain, and the second the
subdomain. For example, <code class="docutils literal notranslate"><span class="pre">{{hosts[][www]}}</span></code> would give the <code class="docutils literal notranslate"><span class="pre">www</span></code> subdomain under
the main (unnamed) domain, and <code class="docutils literal notranslate"><span class="pre">{{hosts[alt][élève]}}</span></code> would give the <code class="docutils literal notranslate"><span class="pre">élève</span></code>
subdomain under the alt domain.</p>
<p>For mostly historic reasons, the subdomains of the main domain are
also available under the <code class="docutils literal notranslate"><span class="pre">domains</span></code> dictionary; this is identical to
<code class="docutils literal notranslate"><span class="pre">hosts[]</span></code>.</p>
<p>Ports are also available on a per-protocol basis. For example,
<code class="docutils literal notranslate"><span class="pre">{{ports[ws][0]}}</span></code> is replaced with the first (and only) WebSockets port, while
<code class="docutils literal notranslate"><span class="pre">{{ports[http][1]}}</span></code> is replaced with the second HTTP port.</p>
<p>The request URL itself can be used as part of the substitution using the
<code class="docutils literal notranslate"><span class="pre">location</span></code> dictionary, which has entries matching the <code class="docutils literal notranslate"><span class="pre">window.location</span></code> API.
For example, <code class="docutils literal notranslate"><span class="pre">{{location[host]}}</span></code> is replaced by <code class="docutils literal notranslate"><span class="pre">hostname:port</span></code> for the
current request, matching <code class="docutils literal notranslate"><span class="pre">location.host</span></code>.</p>
</div>
<div class="section" id="tests-requiring-special-headers">
<h2>Tests Requiring Special Headers<a class="headerlink" href="#tests-requiring-special-headers" title="Permalink to this headline">¶</a></h2>
<p>For tests requiring that a certain HTTP header is set to some static
value, a file with the same path as the test file except for an an
additional <code class="docutils literal notranslate"><span class="pre">.headers</span></code> suffix may be created. For example for
<code class="docutils literal notranslate"><span class="pre">/example/test.html</span></code>, the headers file would be
<code class="docutils literal notranslate"><span class="pre">/example/test.html.headers</span></code>. This file consists of lines of the form</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">header</span><span class="o">-</span><span class="n">name</span><span class="p">:</span> <span class="n">header</span><span class="o">-</span><span class="n">value</span>
</pre></div>
</div>
<p>For example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">big5</span>
</pre></div>
</div>
<p>To apply the same headers to all files in a directory use a
<code class="docutils literal notranslate"><span class="pre">__dir__.headers</span></code> file. This will only apply to the immediate
directory and not subdirectories.</p>
<p>Headers files may be used in combination with substitutions by naming
the file e.g. <code class="docutils literal notranslate"><span class="pre">test.html.sub.headers</span></code>.</p>
</div>
<div class="section" id="tests-requiring-full-control-over-the-http-response">
<h2>Tests Requiring Full Control Over The HTTP Response<a class="headerlink" href="#tests-requiring-full-control-over-the-http-response" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="python-handlers/index.html">Python Handlers</a></li>
<li class="toctree-l1"><a class="reference internal" href="server-pipes.html">wptserve Pipes</a></li>
</ul>
</div>
<p>For full control over the request and response, the server provides the ability
to write <code class="docutils literal notranslate"><span class="pre">.asis</span></code> files; these are served as literal HTTP responses. In other
words, they are sent byte-for-byte to the server without adding an HTTP status
line, headers, or anything else. This makes them suitable for testing
situations where the precise bytes on the wire are static, and control over the
timing is unnecessary, but the response does not conform to HTTP requirements.</p>
<p>The server also provides the ability to write <a class="reference internal" href="python-handlers/index.html"><span class="doc">Python
“handlers”</span></a>–Python scripts that have access to request
data and can manipulate the content and timing of the response. Responses are
also influenced by <a class="reference internal" href="server-pipes.html"><span class="doc">the pipe query string parameter</span></a>.</p>
</div>
<div class="section" id="tests-requiring-http-2-0">
<h2>Tests Requiring HTTP/2.0<a class="headerlink" href="#tests-requiring-http-2-0" title="Permalink to this headline">¶</a></h2>
<p>The server now has a prototype HTTP/2.0 server which gives you access to
some of the HTTP/2.0 specific functionality. Currently, the server is off
by default and needs to be run using <code class="docutils literal notranslate"><span class="pre">./wpt</span> <span class="pre">serve</span> <span class="pre">--h2</span></code> in order to enable it.
The HTTP/2.0 server supports handlers that work per-frame; these, along with the
API are documented in <a class="reference internal" href="h2tests.html"><span class="doc">Writing H2 Tests</span></a>.</p>
<blockquote>
<div><p><b>Important:</b> The HTTP/2.0 server requires you to have Python 2.7.10+
and OpenSSL 1.0.2+. This is because HTTP/2.0 is negotiated using the
<a class="reference external" href="https://tools.ietf.org/html/rfc7301">TLS ALPN</a> extension, which is only
supported in
<a class="reference external" href="https://www.openssl.org/news/openssl-1.0.2-notes.html">OpenSSL 1.0.2</a> and up.</p>
</div></blockquote>
</div>
<div class="section" id="tests-requiring-quic">
<h2>Tests Requiring QUIC<a class="headerlink" href="#tests-requiring-quic" title="Permalink to this headline">¶</a></h2>
<p>We do not support loading a test over QUIC yet, but a test can establish a QUIC
connection to the test server (e.g. for WebTransport, similar to WebSocket).
Since the QUIC server is not yet enabled by default, tests must explicitly
declare that they need access to the QUIC server:</p>
<ul class="simple">
<li><p>For HTML tests (including testharness.js and reference tests), add the
following element:</p></li>
</ul>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;quic&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;true&quot;</span><span class="p">&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>For JavaScript tests (auto-generated tests), add the following comment:</p></li>
</ul>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// META: quic=true</span>
</pre></div>
</div>
<p>The QUIC server is not yet enabled by default, so QUIC tests will be skipped
unless <code class="docutils literal notranslate"><span class="pre">--enable-quic</span></code> is specified to <code class="docutils literal notranslate"><span class="pre">./wpt</span> <span class="pre">run</span></code>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="python-handlers/index.html" class="btn btn-neutral float-right" title="Python Handlers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="file-names.html" class="btn btn-neutral float-left" title="File Name Flags" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>