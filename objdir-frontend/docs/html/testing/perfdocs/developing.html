

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Developing in mozperftest &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Developing in mozperftest</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/testing/perfdocs/developing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="developing-in-mozperftest">
<h1>Developing in mozperftest<a class="headerlink" href="#developing-in-mozperftest" title="Permalink to this headline">¶</a></h1>
<div class="section" id="architecture-overview">
<h2>Architecture overview<a class="headerlink" href="#architecture-overview" title="Permalink to this headline">¶</a></h2>
<p><cite>mozperftest</cite> implements a mach command that is a thin wrapper on the
top of <cite>runner.py</cite>, which allows us to run the tool without having to go through
a mach call. Command arguments are prepared in <cite>argparser.py</cite> and then made
available for the runner.</p>
<p>The runner creates a <cite>MachEnvironment</cite> instance (see <cite>environment.py</cite>) and a
<cite>Metadata</cite> instance (see <cite>metadata.py</cite>). These two objects are shared during the
whole test and used to share data across all parts.</p>
<p>The runner then calls <cite>MachEnvironment.run</cite>,  which is in charge of running the test.
The <cite>MachEnvironment</cite> instance runs a sequence of <strong>layers</strong>.</p>
<p>Layers are classes responsible of one single aspect of a performance test. They
are organized in three categories:</p>
<ul class="simple">
<li><p><strong>system</strong>: anything that sets up and tears down some resources or services
on the system. Existing system layers: <strong>android</strong>, <strong>proxy</strong></p></li>
<li><p><strong>test</strong>: layers that are in charge of running a test to collect metrics.
Existing test layers: <strong>browsertime</strong> and <strong>androidlog</strong></p></li>
<li><p><strong>metrics</strong>: all layers that process the metrics to turn them into usable
metrics. Existing system layers: <strong>perfherder</strong> and <strong>console</strong></p></li>
</ul>
<p>The MachEnvironment instance collects a series of layers for each category and
runs them sequentially.</p>
<p>The goal of this organization is to allow adding new performance tests runners
that will be based on a specific combination of layers. To avoid messy code,
we need to make sure that each layer represents a single aspect of the process
and that is completely independant from other layers (besides sharing the data
through the common environment.)</p>
<p>For instance, we could use <cite>perftest</cite> to run a C++ benchmark by implementing a
new <strong>test</strong> layer.</p>
</div>
<div class="section" id="layer">
<h2>Layer<a class="headerlink" href="#layer" title="Permalink to this headline">¶</a></h2>
<p>A layer is a class that inherits from <cite>mozperftest.layers.Layer</cite> and implements
a few methods and class variables.</p>
<p>List of methods and variables:</p>
<ul class="simple">
<li><p><cite>name</cite>: name of the layer (class variable, mandatory)</p></li>
<li><p><cite>activated</cite>: boolean to activate by default the layer (class variable, False)</p></li>
<li><p><cite>user_exception</cite>: will trigger the <cite>on_exception</cite> hook when an exception occurs</p></li>
<li><p><cite>arguments</cite>: dict containing arguments. Each argument is following
the <cite>argparser</cite> standard</p></li>
<li><p><cite>run(self, medatata)</cite>: called to execute the layer</p></li>
<li><p><cite>setup(self)</cite>: called when the layer is about to be executed</p></li>
<li><p><cite>teardown(self)</cite>: called when the layer is exiting</p></li>
</ul>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">EmailSender</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends an email with the results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;email&quot;</span>
    <span class="n">activated</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">arguments</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;recipient&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;tarek@mozilla.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Recipient&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="n">smtp_server</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">send_email</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_arg</span><span class="p">(</span><span class="s2">&quot;recipient&quot;</span><span class="p">),</span> <span class="n">metadata</span><span class="o">.</span><span class="n">results</span><span class="p">())</span>
</pre></div>
</div>
<p>It can then be added to one of the top functions that are used to create a list
of layers for each category:</p>
<ul class="simple">
<li><p><strong>mozperftest.metrics.pick_metrics</strong> for the metrics category</p></li>
<li><p><strong>mozperftest.system.pick_system</strong> for the system category</p></li>
<li><p><strong>mozperftest.test.pick_browser</strong> for the test category</p></li>
</ul>
<p>And also added in each <cite>get_layers</cite> function in each of those category.
The <cite>get_layers</cite> functions are invoked when building the argument parser.</p>
<p>In our example, adding the <cite>EmailSender</cite> layer will add two new options:</p>
<ul class="simple">
<li><p><strong>–email</strong> a flag to activate the layer</p></li>
<li><p><strong>–email-recipient</strong></p></li>
</ul>
</div>
<div class="section" id="important-layers">
<h2>Important layers<a class="headerlink" href="#important-layers" title="Permalink to this headline">¶</a></h2>
<p><strong>mozperftest</strong> can be used to run performance tests against browsers using the
<strong>browsertime</strong> test layer. It leverages the <a class="reference external" href="https://www.sitespeed.io/documentation/browsertime/">browsertime.js</a> framework and provides
a full integration into Mozilla’s build and CI systems.</p>
<p>Browsertime uses the selenium webdriver client to drive the browser, and
provides some metrics to measure performance during a user journey.</p>
</div>
<div class="section" id="coding-style">
<h2>Coding style<a class="headerlink" href="#coding-style" title="Permalink to this headline">¶</a></h2>
<p>For the coding style, we want to:</p>
<ul class="simple">
<li><p>Follow <a class="reference external" href="https://www.python.org/dev/peps/pep-0257/">PEP 257</a> for docstrings</p></li>
<li><p>Avoid complexity as much as possible</p></li>
<li><p>Use modern Python 3 code (for instance <cite>pathlib</cite> instead of <cite>os.path</cite>)</p></li>
<li><p>Avoid dependencies on Mozilla build projects and frameworks as much as possible
(mozharness, mozbuild, etc), or make sure they are isolated and documented</p></li>
</ul>
</div>
<div class="section" id="landing-patches">
<h2>Landing patches<a class="headerlink" href="#landing-patches" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is mandatory for each patch to have a test. Any change without a test
will be rejected.</p>
</div>
<p>Before landing a patch for mozperftest, make sure you run <cite>perftest-test</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="o">./</span><span class="n">mach</span> <span class="n">perftest</span><span class="o">-</span><span class="n">test</span>
<span class="o">=&gt;</span> <span class="n">black</span> <span class="p">[</span><span class="n">OK</span><span class="p">]</span>
<span class="o">=&gt;</span> <span class="n">flake8</span> <span class="p">[</span><span class="n">OK</span><span class="p">]</span>
<span class="o">=&gt;</span> <span class="n">remove</span> <span class="n">old</span> <span class="n">coverage</span> <span class="n">data</span> <span class="p">[</span><span class="n">OK</span><span class="p">]</span>
<span class="o">=&gt;</span> <span class="n">running</span> <span class="n">tests</span> <span class="p">[</span><span class="n">OK</span><span class="p">]</span>
<span class="o">=&gt;</span> <span class="n">coverage</span>
<span class="n">Name</span>                                             <span class="n">Stmts</span>   <span class="n">Miss</span>  <span class="n">Cover</span>   <span class="n">Missing</span>
<span class="o">------------------------------------------------------------------------------------------</span>
<span class="n">mozperftest</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">notebook</span><span class="o">/</span><span class="n">analyzer</span><span class="o">.</span><span class="n">py</span>         <span class="mi">29</span>      <span class="mi">20</span>     <span class="mi">31</span><span class="o">%</span>    <span class="mi">26</span><span class="o">-</span><span class="mi">36</span><span class="p">,</span> <span class="mi">39</span><span class="o">-</span><span class="mi">42</span><span class="p">,</span> <span class="mi">45</span><span class="o">-</span><span class="mi">51</span>
<span class="o">...</span>
<span class="n">mozperftest</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">proxy</span><span class="o">.</span><span class="n">py</span>                      <span class="mi">37</span>      <span class="mi">0</span>     <span class="mi">100</span><span class="o">%</span>
<span class="o">------------------------------------------------------------------------------------------</span>
<span class="n">TOTAL</span>                                            <span class="mi">1614</span>    <span class="mi">240</span>    <span class="mi">85</span><span class="o">%</span>

<span class="p">[</span><span class="n">OK</span><span class="p">]</span>
</pre></div>
</div>
<p>The command will run <cite>black</cite>, <cite>flake8</cite> and also make sure that the test coverage has not regressed.</p>
<p>You can use the <cite>-s</cite> option to bypass flake8/black to speed up your workflow, but make
sure you do a full tests run. You can also pass the name of one single test module.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>