

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Picture-in-Picture &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Prompts" href="../../prompts/prompts/index.html" />
    <link rel="prev" title="Trigger Listeners" href="../../messaging-system/docs/TriggerActionSchemas/index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Toolkit</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../mozapps/extensions/addon-manager/index.html">Add-on Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../crashes/crash-manager/index.html">Crash Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../crashreporter/crashreporter/index.html">Crash Reporter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../featuregates/featuregates/index.html">Feature Gates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../search/index.html">Search Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../normandy/normandy/index.html">Shield Recipe Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../messaging-system/docs/index.html">Messaging System Schemas</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Picture-in-Picture</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#high-level-overview">High-level overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-picture-in-picture-toggle">The Picture-in-Picture toggle</a></li>
<li class="toctree-l3"><a class="reference internal" href="#video-registration">Video registration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#docstate"><code class="docutils literal notranslate"><span class="pre">docState</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#clicking-on-the-toggle">Clicking on the toggle</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pictureinpicturelauncherchild">PictureInPictureLauncherChild</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pictureinpicturechild">PictureInPictureChild</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pictureinpicture-jsm">PictureInPicture.jsm</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-picture-in-picture-player-window">The Picture-in-Picture player window</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cloning-the-video-frames">Cloning the video frames</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cloneelementvisually"><code class="docutils literal notranslate"><span class="pre">cloneElementVisually</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#stopcloningelementvisually"><code class="docutils literal notranslate"><span class="pre">stopCloningElementVisually</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#iscloningelementvisually"><code class="docutils literal notranslate"><span class="pre">isCloningElementVisually</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../prompts/prompts/index.html">Prompts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/subprocess/toolkit_modules/subprocess/index.html">Subprocess Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../telemetry/index.html">Telemetry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../glean/index.html">Firefox on Glean (FOG)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/toolkit_modules/index.html">Toolkit Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../content/toolkit_widgets/index.html">Toolkit Widgets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../url-classifier/url-classifier/index.html">URL Classifier</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../extensions/webextensions/index.html">WebExtensions API Development</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Toolkit</a> &raquo;</li>
        
      <li>Picture-in-Picture</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../../_sources/toolkit/components/pictureinpicture/pictureinpicture/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="picture-in-picture">
<span id="components-pictureinpicture"></span><h1>Picture-in-Picture<a class="headerlink" href="#picture-in-picture" title="Permalink to this headline">¶</a></h1>
<p>This component makes it possible for a <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> element on a web page to be played within
an always-on-top video player.</p>
<p>This documentation covers the architecture and inner workings of both the mechanism that
displays the <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> in the always-on-top video player, as well as the mechanism that
displays the Picture-in-Picture toggle that overlays <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> elements, which is the primary
method for launching the feature.</p>
<div class="section" id="high-level-overview">
<h2>High-level overview<a class="headerlink" href="#high-level-overview" title="Permalink to this headline">¶</a></h2>
<p>The following diagram tries to illustrate the subcomponents, and how they interact with one another.</p>
<img alt="../../../../_images/PiP-diagram.svg" src="../../../../_images/PiP-diagram.svg" /><p>Let’s suppose that the user has loaded a document with a <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> in it, and they decide to open
it in a Picture-in-Picture window. What happens?</p>
<p>First the <code class="docutils literal notranslate"><span class="pre">PictureInPictureToggleChild</span></code> component notices when <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> elements are added to the
DOM, and monitors the mouse as it moves around the document. Once the mouse intersects a <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code>,
<code class="docutils literal notranslate"><span class="pre">PictureInPictureToggleChild</span></code> causes the Picture-in-Picture toggle to appear on that element.</p>
<p>If the user clicks on that toggle, then the <code class="docutils literal notranslate"><span class="pre">PictureInPictureToggleChild</span></code> dispatches a chrome-only
<code class="docutils literal notranslate"><span class="pre">MozTogglePictureInPicture</span></code> event on the video, which is handled by the <code class="docutils literal notranslate"><span class="pre">PictureInPictureLauncherChild</span></code> actor
for that document. The reason for the indirection via the event is that the media context menu can also
trigger Picture-in-Picture by dispatching the same event on the video. Upon handling the event, the
<code class="docutils literal notranslate"><span class="pre">PictureInPictureLauncherChild</span></code> actor then sends a <code class="docutils literal notranslate"><span class="pre">PictureInPicture:Request</span></code> message to the parent process.
The parent process opens up the always-on-top player window, with a remote <code class="docutils literal notranslate"><span class="pre">&lt;xul:browser&gt;</span></code> that runs in
the same content process as the original <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code>. The parent then sends a message to the player
window’s remote <code class="docutils literal notranslate"><span class="pre">&lt;xul:browser&gt;</span></code> loaded in the player window. A <code class="docutils literal notranslate"><span class="pre">PictureInPictureChild</span></code> actor
is instantiated for the empty document loaded inside of the player window browser. This
<code class="docutils literal notranslate"><span class="pre">PictureInPictureChild</span></code> actor constructs its own <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> element, and then tells Gecko to clone the
frames from the original <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> to the newly created <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code>.</p>
<p>At this point, the video is displaying in the Picture-in-Picture player window.</p>
<p>Next, we’ll discuss the individual subcomponents, and how they operate at a more detailed level.</p>
</div>
<div class="section" id="the-picture-in-picture-toggle">
<h2>The Picture-in-Picture toggle<a class="headerlink" href="#the-picture-in-picture-toggle" title="Permalink to this headline">¶</a></h2>
<p>One of the primary challenges faced when developing this feature was the fact that, in practice, mouse
events tend not to reach <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> elements. This is usually because the <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> element is
contained within a hierarchy of other DOM elements that are capturing and handling any events that
come down. This often occurs on sites that construct their own video controls. This is why we cannot
simply use a <code class="docutils literal notranslate"><span class="pre">mouseover</span></code> event handler on the <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> UAWidget - on sites that do the event
capturing, we’ll never receive those events and the toggle will not be accessible.</p>
<p>Other times, the problem is that the video is overlaid with a semi or fully transparent element
which captures any mouse events that would normally be dispatched to the underlying <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code>.
This can occur, for example, on sites that want to display an overlay when the video is paused.</p>
<p>To work around this problem, the <cite>PictureInPictureToggleChild</cite> actor class samples the latest
<code class="docutils literal notranslate"><span class="pre">mousemove</span></code> event every <code class="docutils literal notranslate"><span class="pre">MOUSEMOVE_PROCESSING_DELAY_MS</span></code> milliseconds, and then calls
<code class="docutils literal notranslate"><span class="pre">nsIDOMWindowUtils.nodesFromRect</span></code> with the <code class="docutils literal notranslate"><span class="pre">aOnlyVisible</span></code> argument to get the full
list of visible nodes that exist underneath a 1x1 rect positioned at the mouse cursor.</p>
<p>If a <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> is in that list, then we reach into its shadow root, and update some
attributes to tell it to maybe show the toggle.</p>
<p>The underlying <code class="docutils literal notranslate"><span class="pre">UAWidget</span></code> for the video is defined in <code class="docutils literal notranslate"><span class="pre">videocontrols.js</span></code>, and ultimately
chooses whether or not to display the toggle based on the following heuristics:</p>
<ol class="arabic simple">
<li><p>Is the video less than 45 seconds?</p></li>
<li><p>Is either the width or the height of the video less than 160px?</p></li>
<li><p>Is the video silent?</p></li>
</ol>
<p>If any of the above is true, the underlying <code class="docutils literal notranslate"><span class="pre">UAWidget</span></code> will hide the toggle, since it’s
unlikely that the user will want to pop the video out into an always-on-top player window.</p>
</div>
<div class="section" id="video-registration">
<h2>Video registration<a class="headerlink" href="#video-registration" title="Permalink to this headline">¶</a></h2>
<p>Sampling the latest <code class="docutils literal notranslate"><span class="pre">mousemove</span></code> event every <code class="docutils literal notranslate"><span class="pre">MOUSEMOVE_PROCESSING_DELAY_MS</span></code> is not free,
computationally speaking, so we only do this if there are one or more <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> elements
visible on the page. We use an <code class="docutils literal notranslate"><span class="pre">IntersectionObserver</span></code> to notice when there is a <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code>
within the viewport, and if there are 1 or more <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> elements visible, then we start
sampling the <code class="docutils literal notranslate"><span class="pre">mousemove</span></code> event.</p>
<p>Videos are added to the <code class="docutils literal notranslate"><span class="pre">IntersectionObserver</span></code> when they are added to the DOM by listening
for the <code class="docutils literal notranslate"><span class="pre">UAWidgetSetupOrChange</span></code> event. This is considered being “registered”.</p>
</div>
<div class="section" id="docstate">
<h2><code class="docutils literal notranslate"><span class="pre">docState</span></code><a class="headerlink" href="#docstate" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">PictureInPictureChild.jsm</span></code> contains a <code class="docutils literal notranslate"><span class="pre">WeakMap</span></code> mapping <code class="docutils literal notranslate"><span class="pre">document</span></code>’s to various information
that <code class="docutils literal notranslate"><span class="pre">PictureInPictureToggleChild</span></code> wants to retain for the lifetime of that <code class="docutils literal notranslate"><span class="pre">document</span></code>. For
example, whether or not we’re in the midst of handling the user clicking down on their pointer
device. Any state that needs to be remembered should be added to the <code class="docutils literal notranslate"><span class="pre">docState</span></code> <code class="docutils literal notranslate"><span class="pre">WeakMap</span></code>.</p>
</div>
<div class="section" id="clicking-on-the-toggle">
<h2>Clicking on the toggle<a class="headerlink" href="#clicking-on-the-toggle" title="Permalink to this headline">¶</a></h2>
<p>If the user clicks on the Picture-in-Picture toggle, we don’t want the underlying webpage to
know that this happened, since this could result in unexpected behaviour, like a page
navigation (for example, if the <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> is a long-running advertisement that navigates
upon click).</p>
<p>To accomplish this, we listen for all events fired on a mouse click on the root window during
the capturing phase. This allows us to handle the events before they are dispatched to content.</p>
<p>The first event that is fired, <code class="docutils literal notranslate"><span class="pre">pointerdown</span></code>, is captured, and we check the <code class="docutils literal notranslate"><span class="pre">docState</span></code> to see
whether or not we’re showing a toggle on any videos. If so, we check the coordinates of that
toggle against the coordinates of the <code class="docutils literal notranslate"><span class="pre">pointerdown</span></code> event to determine if the user is clicking
on the toggle. If so, we set a flag in the <code class="docutils literal notranslate"><span class="pre">docState</span></code> so that any subsequent events from the
click (like <code class="docutils literal notranslate"><span class="pre">mousedown</span></code>, <code class="docutils literal notranslate"><span class="pre">mouseup</span></code>, <code class="docutils literal notranslate"><span class="pre">pointerup</span></code>, <code class="docutils literal notranslate"><span class="pre">click</span></code>) are captured and suppressed.
If the <code class="docutils literal notranslate"><span class="pre">pointerdown</span></code> event didn’t occur within a toggle, we let the events pass through as
normal.</p>
<p>If we determine that the click has occurred on the toggle, a <code class="docutils literal notranslate"><span class="pre">MozTogglePictureInPicture</span></code> event
is dispatched on the underlying <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code>. This event is handled by the separate
<code class="docutils literal notranslate"><span class="pre">PictureInPictureLauncherChild</span></code> class.</p>
</div>
<div class="section" id="pictureinpicturelauncherchild">
<h2>PictureInPictureLauncherChild<a class="headerlink" href="#pictureinpicturelauncherchild" title="Permalink to this headline">¶</a></h2>
<p>A small actor class whose only responsibility is to tell the parent process to open an always-on-top-window by sending a <code class="docutils literal notranslate"><span class="pre">PictureInPicture:Request</span></code> message to its parent actor.</p>
<p>Currently, this only occurs when a chrome-only <code class="docutils literal notranslate"><span class="pre">MozTogglePictureInPicture</span></code> event is dispatched by the <code class="docutils literal notranslate"><span class="pre">PictureInPictureToggleChild</span></code> when the user clicks the Picture-in-Picture toggle button.</p>
</div>
<div class="section" id="pictureinpicturechild">
<h2>PictureInPictureChild<a class="headerlink" href="#pictureinpicturechild" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">PictureInPictureChild</span></code> actor class will run in a content process containing a video, and is instantiated when the player window’s <cite>player.js</cite> script runs its initialization. A <code class="docutils literal notranslate"><span class="pre">PictureInPictureChild</span></code> maps an individual <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code>
to a player window instance. It creates an always-on-top window, and sets up a new <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> inside of this window to clone frames from another <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code>
(which will be in the same process, and have its own <code class="docutils literal notranslate"><span class="pre">PictureInPictureChild</span></code>). Creating this window also causes the new <code class="docutils literal notranslate"><span class="pre">PictureInPictureChild</span></code> to be created.
This instance will monitor the originating <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> for changes, and to receive commands from the player window if the user wants to control the <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code>.</p>
</div>
<div class="section" id="pictureinpicture-jsm">
<h2>PictureInPicture.jsm<a class="headerlink" href="#pictureinpicture-jsm" title="Permalink to this headline">¶</a></h2>
<p>This module runs in the parent process, and is also the scope where all <code class="docutils literal notranslate"><span class="pre">PictureInPictureParent</span></code> instances reside. <code class="docutils literal notranslate"><span class="pre">PictureInPicture.jsm</span></code>’s job is to send and receive messages from <code class="docutils literal notranslate"><span class="pre">PictureInPictureChild</span></code> instances, and to react appropriately.</p>
<p>Critically, <code class="docutils literal notranslate"><span class="pre">PictureInPicture.jsm</span></code> is responsible for opening up the always-on-top player window, and passing the relevant information about the <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> to be displayed to it.</p>
</div>
<div class="section" id="the-picture-in-picture-player-window">
<h2>The Picture-in-Picture player window<a class="headerlink" href="#the-picture-in-picture-player-window" title="Permalink to this headline">¶</a></h2>
<p>The Picture-in-Picture player window is a chrome-privileged window that loads an XHTML document. That document contains a remote <code class="docutils literal notranslate"><span class="pre">&lt;browser&gt;</span></code> element which is repurposed during window initialization to load in the same content process as the originating <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code>.</p>
<p>The player window is where the player controls are defined, like “Play” and “Pause”. When the user interacts with the player controls, a message is sent down to the appropriate <code class="docutils literal notranslate"><span class="pre">PictureInPictureChild</span></code> to call the appropriate method on the underlying <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> element in the originating tab.</p>
</div>
<div class="section" id="cloning-the-video-frames">
<h2>Cloning the video frames<a class="headerlink" href="#cloning-the-video-frames" title="Permalink to this headline">¶</a></h2>
<p>While it appears as if the video is moving from the original <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> element to the player window, what’s actually occurring is that the video frames are being <em>cloned</em> to the player window <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> element. This cloning is done at the platform level using a privileged method on the <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code> element: <code class="docutils literal notranslate"><span class="pre">cloneElementVisually</span></code>.</p>
<div class="section" id="cloneelementvisually">
<h3><code class="docutils literal notranslate"><span class="pre">cloneElementVisually</span></code><a class="headerlink" href="#cloneelementvisually" title="Permalink to this headline">¶</a></h3>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="nx">video</span><span class="p">.</span><span class="nx">cloneElementVisually</span><span class="p">(</span><span class="nx">otherVideo</span><span class="p">);</span>
</pre></div>
</div>
<p>This will clone the frames being decoded for <code class="docutils literal notranslate"><span class="pre">video</span></code> and display them on the <code class="docutils literal notranslate"><span class="pre">otherVideo</span></code> element as well. The returned Promise resolves once the cloning has successfully started.</p>
</div>
<div class="section" id="stopcloningelementvisually">
<h3><code class="docutils literal notranslate"><span class="pre">stopCloningElementVisually</span></code><a class="headerlink" href="#stopcloningelementvisually" title="Permalink to this headline">¶</a></h3>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="k">void</span> <span class="nx">video</span><span class="p">.</span><span class="nx">stopCloningElementVisually</span><span class="p">();</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">video</span></code> is being cloned visually to another element, calling this method will stop the cloning.</p>
</div>
<div class="section" id="iscloningelementvisually">
<h3><code class="docutils literal notranslate"><span class="pre">isCloningElementVisually</span></code><a class="headerlink" href="#iscloningelementvisually" title="Permalink to this headline">¶</a></h3>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">boolean</span> <span class="nx">video</span><span class="p">.</span><span class="nx">isCloningElementVisually</span><span class="p">;</span>
</pre></div>
</div>
<p>A read-only value that returns <code class="docutils literal notranslate"><span class="pre">true</span></code> if <code class="docutils literal notranslate"><span class="pre">video</span></code> is being cloned visually.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../prompts/prompts/index.html" class="btn btn-neutral float-right" title="Prompts" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../../messaging-system/docs/TriggerActionSchemas/index.html" class="btn btn-neutral float-left" title="Trigger Listeners" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>