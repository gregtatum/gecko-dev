

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Writing an Actor &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="How to register an actor" href="actor-registration.html" />
    <link rel="prev" title="How to handle E10S in actors" href="actor-e10s-handling.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Firefox DevTools Contributor Docs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#getting-started">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#contributing">Contributing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#automated-tests">Automated tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#files-and-directories">Files and directories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#tool-architectures">Tool Architectures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#frontend">Frontend</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#backend">Backend</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="protocol.html">Remote Debugging Protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="client-api.html">Client API</a></li>
<li class="toctree-l3"><a class="reference internal" href="debugger-api.html">Debugger API</a></li>
<li class="toctree-l3"><a class="reference internal" href="backward-compatibility.html">Backward Compatibility</a></li>
<li class="toctree-l3"><a class="reference internal" href="actor-hierarchy.html">Actors Organization</a></li>
<li class="toctree-l3"><a class="reference internal" href="actor-e10s-handling.html">Handling Multi-Processes in Actors</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Writing Actors With protocol.js</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#a-simple-hello-world">A Simple Hello World</a></li>
<li class="toctree-l4"><a class="reference internal" href="#arguments">Arguments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#returning-json">Returning JSON</a></li>
<li class="toctree-l4"><a class="reference internal" href="#types-and-marshalling">Types and Marshalling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#nullables">Nullables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#actors">Actors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#lifetimes">Lifetimes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#events">Events</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">Lifetimes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#custom-front-methods">Custom Front Methods</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">Lifetimes</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="actor-registration.html">Registering A New Actor</a></li>
<li class="toctree-l3"><a class="reference internal" href="actor-best-practices.html">Actor Best Practices</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#preferences">Preferences</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#about-this-documentation">About this documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/geckoview/index.html">Welcome to GeckoViewâ€™s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Firefox DevTools Contributor Docs</a> &raquo;</li>
        
      <li>Writing an Actor</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/devtools/backend/protocol.js.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="writing-an-actor">
<h1>Writing an Actor<a class="headerlink" href="#writing-an-actor" title="Permalink to this headline">Â¶</a></h1>
<div class="section" id="a-simple-hello-world">
<h2>A Simple Hello World<a class="headerlink" href="#a-simple-hello-world" title="Permalink to this headline">Â¶</a></h2>
<p>Hereâ€™s a simple Hello World actor.  It is a global actor (not associated with a given browser tab).
It has two parts: a spec and an implementation. The spec would go somewhere like
<code class="docutils literal notranslate"><span class="pre">devtools/shared/specs/hello-world.js</span></code> and would look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="p">{</span><span class="n">Arg</span><span class="p">,</span> <span class="n">RetVal</span><span class="p">,</span> <span class="n">generateActorSpec</span><span class="p">}</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&quot;devtools/shared/protocol&quot;</span><span class="p">);</span>

<span class="n">const</span> <span class="n">helloWorldSpec</span> <span class="o">=</span> <span class="n">generateActorSpec</span><span class="p">({</span>
  <span class="n">typeName</span><span class="p">:</span> <span class="s2">&quot;helloWorld&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">I</span><span class="s1">&#39;ll explain types later, I promise.</span>

  <span class="n">methods</span><span class="p">:</span> <span class="p">{</span>
    <span class="n">sayHello</span><span class="p">:</span> <span class="p">{</span>
      <span class="o">//</span> <span class="n">The</span> <span class="n">request</span> <span class="n">packet</span> <span class="n">template</span><span class="o">.</span>  <span class="n">There</span> <span class="n">are</span> <span class="n">no</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">so</span>
      <span class="o">//</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">empty</span><span class="o">.</span>  <span class="n">The</span> <span class="n">framework</span> <span class="n">will</span> <span class="n">add</span> <span class="n">the</span> <span class="s2">&quot;type&quot;</span> <span class="ow">and</span> <span class="s2">&quot;to&quot;</span>
      <span class="o">//</span> <span class="n">request</span> <span class="n">properties</span><span class="o">.</span>
      <span class="n">request</span><span class="p">:</span> <span class="p">{},</span>

      <span class="o">//</span> <span class="n">The</span> <span class="n">response</span> <span class="n">packet</span> <span class="n">template</span><span class="o">.</span>  <span class="n">The</span> <span class="k">return</span> <span class="n">value</span> <span class="n">of</span> <span class="n">the</span> <span class="n">function</span>
      <span class="o">//</span> <span class="n">will</span> <span class="n">be</span> <span class="n">plugged</span> <span class="ow">in</span> <span class="n">where</span> <span class="n">the</span> <span class="n">RetVal</span><span class="p">()</span> <span class="n">appears</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">template</span><span class="o">.</span>
      <span class="n">response</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">greeting</span><span class="p">:</span> <span class="n">RetVal</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="o">//</span> <span class="s2">&quot;string&quot;</span> <span class="ow">is</span> <span class="n">the</span> <span class="k">return</span> <span class="n">value</span> <span class="nb">type</span><span class="o">.</span>
      <span class="p">}</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">});</span>

<span class="o">//</span> <span class="n">Expose</span> <span class="n">the</span> <span class="n">spec</span> <span class="n">so</span> <span class="n">it</span> <span class="n">can</span> <span class="n">be</span> <span class="n">imported</span> <span class="n">by</span> <span class="n">the</span> <span class="n">implementation</span><span class="o">.</span>
<span class="n">exports</span><span class="o">.</span><span class="n">helloWorldSpec</span> <span class="o">=</span> <span class="n">helloWorldSpec</span><span class="p">;</span>
</pre></div>
</div>
<p>The actor implementation would go somewhere like
<code class="docutils literal notranslate"><span class="pre">devtools/server/actors/hello-world.js</span></code> and would look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">protocol</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&quot;devtools/shared/protocol&quot;</span><span class="p">);</span>
<span class="n">const</span> <span class="p">{</span><span class="n">helloWorldSpec</span><span class="p">}</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&quot;devtools/shared/specs/hello-world&quot;</span><span class="p">);</span>

<span class="n">const</span> <span class="n">HelloActor</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">ActorClassWithSpec</span><span class="p">(</span><span class="n">helloWorldSpec</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">initialize</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">protocol</span><span class="o">.</span><span class="n">Actor</span><span class="o">.</span><span class="n">prototype</span><span class="o">.</span><span class="n">initialize</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span> <span class="o">//</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">worst</span> <span class="n">part</span> <span class="n">of</span> <span class="n">heritage</span><span class="o">.</span>
  <span class="p">},</span>

  <span class="n">sayHello</span><span class="p">:</span> <span class="n">function</span> <span class="p">()</span> <span class="p">{</span>
   <span class="k">return</span> <span class="s2">&quot;hello&quot;</span><span class="p">;</span>
  <span class="p">},</span>
<span class="p">});</span>

<span class="o">//</span> <span class="n">You</span> <span class="n">also</span> <span class="n">need</span> <span class="n">to</span> <span class="n">export</span> <span class="n">the</span> <span class="n">actor</span> <span class="k">class</span> <span class="nc">in</span> <span class="n">your</span> <span class="n">module</span> <span class="k">for</span> <span class="n">discovery</span><span class="o">.</span>
<span class="n">exports</span><span class="o">.</span><span class="n">HelloActor</span> <span class="o">=</span> <span class="n">HelloActor</span><span class="p">;</span>
</pre></div>
</div>
<p>To activate your actor, register it in the <code class="docutils literal notranslate"><span class="pre">addBrowserActors</span></code> method in <code class="docutils literal notranslate"><span class="pre">server/actors/utils/actor-registry.js</span></code>.
The registration code would look something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">this</span><span class="o">.</span><span class="n">registerModule</span><span class="p">(</span><span class="s2">&quot;devtools/server/actors/hello-world&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">prefix</span><span class="p">:</span> <span class="s2">&quot;hello&quot;</span><span class="p">,</span>
  <span class="n">constructor</span><span class="p">:</span> <span class="s2">&quot;HelloActor&quot;</span><span class="p">,</span>
  <span class="nb">type</span><span class="p">:</span> <span class="p">{</span> <span class="k">global</span><span class="p">:</span> <span class="n">true</span> <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Your spec allows the actor to support a <code class="docutils literal notranslate"><span class="pre">sayHello</span></code> request.
A request/reply will look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-&gt;</span> <span class="p">{</span> <span class="n">to</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">actorID</span><span class="o">&gt;</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;sayHello&quot;</span> <span class="p">}</span>
<span class="o">&lt;-</span> <span class="p">{</span> <span class="n">from</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">actorID</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">greeting</span><span class="p">:</span> <span class="s2">&quot;hello&quot;</span> <span class="p">}</span>
</pre></div>
</div>
<p>Now we can create a client side object.  We call these <em>front</em> objects and
they typically go in <code class="docutils literal notranslate"><span class="pre">devtools/client/fronts/</span></code>.</p>
<p>Hereâ€™s the front for the HelloActor:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">HelloFront</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">FrontClassWithSpec</span><span class="p">(</span><span class="n">helloWorldSpec</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">initialize</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">protocol</span><span class="o">.</span><span class="n">Front</span><span class="o">.</span><span class="n">prototype</span><span class="o">.</span><span class="n">initialize</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">form</span><span class="p">);</span>
    <span class="o">//</span> <span class="n">This</span> <span class="n">call</span> <span class="n">may</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">required</span> <span class="n">but</span> <span class="n">it</span><span class="s1">&#39;s a good idea. It will</span>
    <span class="o">//</span> <span class="n">guarantee</span> <span class="n">that</span> <span class="n">your</span> <span class="n">instance</span> <span class="ow">is</span> <span class="n">managed</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">pool</span><span class="o">.</span>
    <span class="n">this</span><span class="o">.</span><span class="n">manage</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Note that there is no <code class="docutils literal notranslate"><span class="pre">sayHello</span></code> method.  The FrontClass will generate a method on the Front object that matches the method declaration in the Actor class.</p>
<p>The generated methods will return a Promise.  That promise will resolve to the RetVal of the actor method.</p>
<p>So if we have a reference to a HelloFront object, we can issue a <code class="docutils literal notranslate"><span class="pre">sayHello</span></code> request:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hello</span><span class="o">.</span><span class="n">sayHello</span><span class="p">()</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">greeting</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">greeting</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<p>How do you get an initial reference to the front?  Thatâ€™s a bit tricky, but basically there are two ways:</p>
<ul class="simple">
<li><p>Manually</p></li>
<li><p>Magically</p></li>
</ul>
<p>Manually - If youâ€™re using a DevToolsClient instance, you can discover the actorID manually and create a Front for it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">hello</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HelloFront</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="p">{</span> <span class="n">actor</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">hello</span> <span class="n">actorID</span><span class="o">&gt;</span> <span class="p">});</span>
</pre></div>
</div>
<p>Magically - Once you have an initial reference to a protocol.js object, it can return other protocol.js objects and fronts will automatically be created.</p>
</div>
<div class="section" id="arguments">
<h2>Arguments<a class="headerlink" href="#arguments" title="Permalink to this headline">Â¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">sayHello</span></code> has no arguments, so letâ€™s add a method that does take arguments.
Hereâ€™s an adjustment to the spec:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">methods</span><span class="p">:</span> <span class="p">{</span>
  <span class="n">echo</span><span class="p">:</span> <span class="p">{</span>
    <span class="n">request</span><span class="p">:</span> <span class="p">{</span> <span class="n">echo</span><span class="p">:</span> <span class="n">Arg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">},</span>
    <span class="n">response</span><span class="p">:</span> <span class="p">{</span> <span class="n">echoed</span><span class="p">:</span> <span class="n">RetVal</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Hereâ€™s an adjustment to the implementation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">str</span> <span class="o">+</span> <span class="s2">&quot;... &quot;</span> <span class="o">+</span> <span class="nb">str</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This tells the library to place the 0th argument, which should be a string, in the <code class="docutils literal notranslate"><span class="pre">echo</span></code> property of the request packet.</p>
<p>This will generate a request handler whose request and response packets look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="n">to</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">actorID</span><span class="o">&gt;</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="n">echo</span><span class="p">:</span> <span class="o">&lt;</span><span class="nb">str</span><span class="o">&gt;</span> <span class="p">}</span>
<span class="p">{</span> <span class="n">from</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">actorID</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">echoed</span><span class="p">:</span> <span class="o">&lt;</span><span class="nb">str</span><span class="o">&gt;</span> <span class="p">}</span>
</pre></div>
</div>
<p>The client usage should be predictable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hello</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="nb">str</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">assert</span><span class="p">(</span><span class="nb">str</span> <span class="o">===</span> <span class="s2">&quot;hello... hello...&quot;</span><span class="p">)</span> <span class="p">})</span>
</pre></div>
</div>
<p>The library tries hard to make using fronts feel like natural javascript (or as natural as you believe promises are, I guess).  When building the response it will put the return value of the function where RetVal() is specified in the response template, and on the client side it will use the value in that position when resolving the promise.</p>
</div>
<div class="section" id="returning-json">
<h2>Returning JSON<a class="headerlink" href="#returning-json" title="Permalink to this headline">Â¶</a></h2>
<p>Maybe your response is an object. Hereâ€™s an example of a spec:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">methods</span><span class="p">:</span> <span class="p">{</span>
  <span class="n">addOneTwice</span><span class="p">:</span> <span class="p">{</span>
    <span class="n">request</span><span class="p">:</span> <span class="p">{</span> <span class="n">a</span><span class="p">:</span> <span class="n">Arg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">),</span> <span class="n">b</span><span class="p">:</span> <span class="n">Arg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="p">},</span>
    <span class="n">response</span><span class="p">:</span> <span class="p">{</span> <span class="n">ret</span><span class="p">:</span> <span class="n">RetVal</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Hereâ€™s an example implementation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">addOneTwice</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This will generate a response packet that looks like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="n">from</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">actorID</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">ret</span><span class="p">:</span> <span class="p">{</span> <span class="n">a</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span> <span class="p">}</span> <span class="p">}</span>
</pre></div>
</div>
<p>Thatâ€™s probably unnecessary nesting (if youâ€™re sure you wonâ€™t be returning an object with â€˜fromâ€™ as a key!), so you can just replace <code class="docutils literal notranslate"><span class="pre">response</span></code> with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">response</span><span class="p">:</span> <span class="n">RetVal</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>and now your packet will look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="n">from</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">actorID</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="types-and-marshalling">
<h2>Types and Marshalling<a class="headerlink" href="#types-and-marshalling" title="Permalink to this headline">Â¶</a></h2>
<p>Things have been pretty simple up to this point - all the arguments weâ€™ve passed in have been javascript primitives.  But for some types (most importantly Actor types, which Iâ€™ll get to eventually), we canâ€™t just copy them into a JSON packet and expect it to work, we need to marshal things ourselves.</p>
<p>Again, the protocol lib tries hard to provide a natural API to actors and clients, and sometime that natural API might involve object APIs. Iâ€™m going to use a wickedly contrived example, bear with me.  Letâ€™s say I have a small object that contains a number and has a few methods associated with it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">Incrementor</span> <span class="o">=</span> <span class="n">function</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">this</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">Incrementor</span><span class="o">.</span><span class="n">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">increment</span><span class="p">:</span> <span class="n">function</span> <span class="p">()</span> <span class="p">{</span> <span class="n">this</span><span class="o">.</span><span class="n">value</span><span class="o">++</span> <span class="p">},</span>
    <span class="n">decrement</span><span class="p">:</span> <span class="n">function</span> <span class="p">()</span> <span class="p">{</span> <span class="n">this</span><span class="o">.</span><span class="n">value</span><span class="o">--</span> <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>and I want to return it from a backend function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">spec</span><span class="p">:</span>
<span class="n">methods</span><span class="p">:</span> <span class="p">{</span>
  <span class="n">getIncrementor</span><span class="p">:</span> <span class="p">{</span>
    <span class="n">request</span><span class="p">:</span> <span class="p">{</span> <span class="n">number</span><span class="p">:</span> <span class="n">Arg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="p">},</span>
    <span class="n">response</span><span class="p">:</span> <span class="p">{</span> <span class="n">value</span><span class="p">:</span> <span class="n">RetVal</span><span class="p">(</span><span class="s2">&quot;incrementor&quot;</span><span class="p">)</span> <span class="p">}</span> <span class="o">//</span> <span class="n">We</span><span class="s1">&#39;ll define &quot;incrementor&quot; below.</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">implementation</span><span class="p">:</span>
<span class="n">getIncrementor</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">new</span> <span class="n">Incrementor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>I want that response to look like <code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">from:</span> <span class="pre">&lt;actorID&gt;,</span> <span class="pre">value:</span> <span class="pre">&lt;number&gt;</span> <span class="pre">}</span></code>, but the client side needs to know to return an Incrementor, not a primitive number.  So letâ€™s tell the protocol lib about Incrementors:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">protocol</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">addType</span><span class="p">(</span><span class="s2">&quot;incrementor&quot;</span><span class="p">,</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">When</span> <span class="n">writing</span> <span class="n">to</span> <span class="n">a</span> <span class="n">protocol</span> <span class="n">packet</span><span class="p">,</span> <span class="n">just</span> <span class="n">send</span> <span class="n">the</span> <span class="n">value</span>
    <span class="n">write</span><span class="p">:</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>

    <span class="o">//</span> <span class="n">When</span> <span class="n">reading</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">protocol</span> <span class="n">packet</span><span class="p">,</span> <span class="n">wrap</span> <span class="k">with</span> <span class="n">an</span> <span class="n">Incrementor</span>
    <span class="o">//</span> <span class="nb">object</span><span class="o">.</span>
    <span class="n">read</span><span class="p">:</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">new</span> <span class="n">Incrementor</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="p">});</span>
</pre></div>
</div>
<p>And now our client can use the API as expected:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">front</span><span class="o">.</span><span class="n">getIncrementor</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">incrementor</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">incrementor</span><span class="o">.</span><span class="n">increment</span><span class="p">();</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">incrementor</span><span class="o">.</span><span class="n">value</span> <span class="o">===</span> <span class="mi">6</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<p>You can do the same thing with arguments:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">spec</span><span class="p">:</span>
<span class="n">methods</span><span class="p">:</span> <span class="p">{</span>
  <span class="n">passIncrementor</span><span class="p">:</span> <span class="p">{</span>
    <span class="n">request</span><span class="p">:</span> <span class="p">{</span> <span class="n">Arg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;incrementor&quot;</span><span class="p">)</span> <span class="p">},</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">implementation</span><span class="p">:</span>
<span class="n">passIncrementor</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="n">inc</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">w</span><span class="o">.</span><span class="n">increment</span><span class="p">();</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">incrementor</span><span class="o">.</span><span class="n">value</span> <span class="o">===</span> <span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">front</span><span class="o">.</span><span class="n">passIncrementor</span><span class="p">(</span><span class="n">new</span> <span class="n">Incrementor</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span>
</pre></div>
</div>
<p>The library provides primitiive <code class="docutils literal notranslate"><span class="pre">boolean</span></code>, <code class="docutils literal notranslate"><span class="pre">number</span></code>, <code class="docutils literal notranslate"><span class="pre">string</span></code>, and <code class="docutils literal notranslate"><span class="pre">json</span></code> types.</p>
<p>Moving right along, letâ€™s say you want to pass/return an array of Incrementors.  You can just prepend <code class="docutils literal notranslate"><span class="pre">array:</span></code> to the type name:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">spec</span><span class="p">:</span>
<span class="n">methods</span><span class="p">:</span> <span class="p">{</span>
  <span class="n">incrementAll</span><span class="p">:</span> <span class="p">{</span>
    <span class="n">request</span><span class="p">:</span> <span class="p">{</span> <span class="n">incrementors</span><span class="p">:</span> <span class="n">Arg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;array:incrementor&quot;</span><span class="p">)</span> <span class="p">},</span>
    <span class="n">response</span><span class="p">:</span> <span class="p">{</span> <span class="n">incrementors</span><span class="p">:</span> <span class="n">RetVal</span><span class="p">(</span><span class="s2">&quot;array:incrementor&quot;</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">implementation</span><span class="p">:</span>
<span class="n">incrementAll</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="n">incrementors</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">incrementors</span><span class="o">.</span><span class="n">forEach</span><span class="p">(</span><span class="n">incrementor</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">incrementor</span><span class="o">.</span><span class="n">increment</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">incrementors</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can use an iterator in place of an array as an argument or return value, and the library will handle the conversion automatically.</p>
<p>Or maybe you want to return a dictionary where one item is a incrementor.  To do this you need to tell the type system which members of the dictionary need custom marshallers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">protocol</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">addDictType</span><span class="p">(</span><span class="s2">&quot;contrivedObject&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">incrementor</span><span class="p">:</span> <span class="s2">&quot;incrementor&quot;</span><span class="p">,</span>
  <span class="n">incrementorArray</span><span class="p">:</span> <span class="s2">&quot;array:incrementor&quot;</span>
<span class="p">});</span>

<span class="o">//</span> <span class="n">spec</span><span class="p">:</span>
<span class="n">methods</span><span class="p">:</span> <span class="p">{</span>
  <span class="n">reallyContrivedExample</span><span class="p">:</span> <span class="p">{</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">RetVal</span><span class="p">(</span><span class="s2">&quot;contrivedObject&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">implementations</span><span class="p">:</span>
<span class="n">reallyContrivedExample</span><span class="p">:</span> <span class="n">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="o">/*</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">b</span> <span class="n">are</span> <span class="n">primitives</span> <span class="ow">and</span> <span class="n">so</span> <span class="n">don</span><span class="s1">&#39;t need to be called out specifically in addDictType */</span>
    <span class="n">a</span><span class="p">:</span> <span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="s2">&quot;world&quot;</span><span class="p">,</span>
    <span class="n">incrementor</span><span class="p">:</span> <span class="n">new</span> <span class="n">Incrementor</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">incrementorArray</span><span class="p">:</span> <span class="p">[</span><span class="n">new</span> <span class="n">Incrementor</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">new</span> <span class="n">Incrementor</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">front</span><span class="o">.</span><span class="n">reallyContrivedExample</span><span class="p">()</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">obj</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">a</span> <span class="o">==</span> <span class="s2">&quot;hello&quot;</span><span class="p">);</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">b</span> <span class="o">==</span> <span class="s2">&quot;world&quot;</span><span class="p">);</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">incrementor</span><span class="o">.</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">incrementorArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">incrementorArray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
<div class="section" id="nullables">
<h2>Nullables<a class="headerlink" href="#nullables" title="Permalink to this headline">Â¶</a></h2>
<p>If an argument, return value, or dict property can be null/undefined, you can prepend <code class="docutils literal notranslate"><span class="pre">nullable:</span></code> to the type name:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;nullable:incrementor&quot;</span><span class="p">,</span>  <span class="o">//</span> <span class="n">Can</span> <span class="n">be</span> <span class="n">null</span><span class="o">/</span><span class="n">undefined</span> <span class="ow">or</span> <span class="n">an</span> <span class="n">incrementor</span>
<span class="s2">&quot;array:nullable:incrementor&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">An</span> <span class="n">array</span> <span class="n">of</span> <span class="n">incrementors</span> <span class="n">that</span> <span class="n">can</span> <span class="n">have</span> <span class="n">holes</span><span class="o">.</span>
<span class="s2">&quot;nullable:array:incrementor&quot;</span> <span class="o">//</span> <span class="n">Either</span> <span class="n">null</span><span class="o">/</span><span class="n">undefined</span> <span class="ow">or</span> <span class="n">an</span> <span class="n">array</span> <span class="n">of</span> <span class="n">incrementors</span> <span class="n">without</span> <span class="n">holes</span><span class="o">.</span>
</pre></div>
</div>
</div>
<div class="section" id="actors">
<h2>Actors<a class="headerlink" href="#actors" title="Permalink to this headline">Â¶</a></h2>
<p>Probably the most common objects that need custom martialing are actors themselves.  These are more interesting than the Incrementor object, but by default theyâ€™re somewhat easy to work with.  Letâ€™s add a ChildActor implementation that will be returned by the HelloActor (which is rapidly becoming the OverwhelminglyComplexActor):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">spec</span><span class="p">:</span>
<span class="n">const</span> <span class="n">childActorSpec</span> <span class="o">=</span> <span class="n">generateActorSpec</span><span class="p">({</span>
  <span class="n">actorType</span><span class="p">:</span> <span class="s2">&quot;childActor&quot;</span><span class="p">,</span>
  <span class="n">methods</span><span class="p">:</span> <span class="p">{</span>
    <span class="n">getGreeting</span><span class="p">:</span> <span class="p">{</span>
      <span class="n">response</span><span class="p">:</span> <span class="p">{</span> <span class="n">greeting</span><span class="p">:</span> <span class="n">RetVal</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">},</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="o">//</span> <span class="n">implementation</span><span class="p">:</span>
<span class="n">const</span> <span class="n">ChildActor</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">ActorClassWithSpec</span><span class="p">(</span><span class="n">childActorSpec</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">initialize</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">protocol</span><span class="o">.</span><span class="n">Actor</span><span class="o">.</span><span class="n">prototype</span><span class="o">.</span><span class="n">initialize</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>
    <span class="n">this</span><span class="o">.</span><span class="n">greeting</span> <span class="o">=</span> <span class="s2">&quot;hello from &quot;</span> <span class="o">+</span> <span class="nb">id</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="n">getGreeting</span><span class="p">:</span> <span class="n">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">this</span><span class="o">.</span><span class="n">greeting</span><span class="p">;</span>
  <span class="p">},</span>
<span class="p">});</span>

<span class="n">exports</span><span class="o">.</span><span class="n">ChildActor</span> <span class="o">=</span> <span class="n">ChildActor</span><span class="p">;</span>

<span class="n">const</span> <span class="n">ChildFront</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">FrontClassWithSpec</span><span class="p">(</span><span class="n">childActorSpec</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">initialize</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">protocol</span><span class="o">.</span><span class="n">Front</span><span class="o">.</span><span class="n">prototype</span><span class="o">.</span><span class="n">initialize</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">form</span><span class="p">);</span>
  <span class="p">},</span>
<span class="p">});</span>
</pre></div>
</div>
<p>The library will register a marshaller for the actor type itself, using typeName as its tag.</p>
<p>So we can now add the following code to HelloActor:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">spec</span><span class="p">:</span>
<span class="n">methods</span><span class="p">:</span> <span class="p">{</span>
  <span class="n">getChild</span><span class="p">:</span> <span class="p">{</span>
    <span class="n">request</span><span class="p">:</span> <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Arg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">},</span>
    <span class="n">response</span><span class="p">:</span> <span class="p">{</span> <span class="n">child</span><span class="p">:</span> <span class="n">RetVal</span><span class="p">(</span><span class="s2">&quot;childActor&quot;</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">implementation</span><span class="p">:</span>
<span class="n">getChild</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">ChildActor</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="nb">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">front</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="s2">&quot;child1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">childFront</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">childFront</span><span class="o">.</span><span class="n">getGreeting</span><span class="p">();</span>
<span class="p">})</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">greeting</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">assert</span><span class="p">(</span><span class="nb">id</span> <span class="o">===</span> <span class="s2">&quot;hello from child1&quot;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<p>The conversation will look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="n">to</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">actorID</span><span class="o">&gt;</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;getChild&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;child1&quot;</span> <span class="p">}</span>
<span class="p">{</span> <span class="n">from</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">actorID</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">child</span><span class="p">:</span> <span class="p">{</span> <span class="n">actor</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">childActorID</span><span class="o">&gt;</span> <span class="p">}}</span>
<span class="p">{</span> <span class="n">to</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">childActorID</span><span class="o">&gt;</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;getGreeting&quot;</span> <span class="p">}</span>
<span class="p">{</span> <span class="n">from</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">childActorID</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">greeting</span><span class="p">:</span> <span class="s2">&quot;hello from child1&quot;</span> <span class="p">}</span>
</pre></div>
</div>
<p>But the ID is the only interesting part of this made-up example.  Youâ€™re never going to want a reference to a ChildActor without checking its ID.  Making an extra request just to get that id is wasteful.  You really want the first response to look like <code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">from:</span> <span class="pre">&lt;actorID&gt;,</span> <span class="pre">child:</span> <span class="pre">{</span> <span class="pre">actor:</span> <span class="pre">&lt;childActorID&gt;,</span> <span class="pre">greeting:</span> <span class="pre">&quot;hello</span> <span class="pre">from</span> <span class="pre">child1&quot;</span> <span class="pre">}</span> <span class="pre">}</span></code></p>
<p>You can customize the marshalling of an actor by providing a <code class="docutils literal notranslate"><span class="pre">form</span></code> method in the <code class="docutils literal notranslate"><span class="pre">ChildActor</span></code> class:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">form</span><span class="p">:</span> <span class="n">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">actor</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">actorID</span><span class="p">,</span>
        <span class="n">greeting</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">greeting</span>
    <span class="p">}</span>
<span class="p">},</span>
</pre></div>
</div>
<p>And you can demarshal in the <code class="docutils literal notranslate"><span class="pre">ChildFront</span></code> class by implementing a matching <code class="docutils literal notranslate"><span class="pre">form</span></code> method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">form</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="n">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">this</span><span class="o">.</span><span class="n">actorID</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">actor</span><span class="p">;</span>
    <span class="n">this</span><span class="o">.</span><span class="n">greeting</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">greeting</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now you can use the id immediately:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">front</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="s2">&quot;child1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">child</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">assert</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">greeting</span> <span class="o">===</span> <span class="s2">&quot;child1) });</span>
</pre></div>
</div>
<p>You may come across a situation where you want to customize the output of a <code class="docutils literal notranslate"><span class="pre">form</span></code> method depending on the operation being performed.  For example, imagine that ChildActor is a bit more complex, with a, b, c, and d members:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ChildActor</span><span class="p">:</span>
    <span class="n">form</span><span class="p">:</span> <span class="n">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">actor</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">actorID</span><span class="p">,</span>
            <span class="n">greeting</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">greeting</span><span class="p">,</span>
            <span class="n">a</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">a</span><span class="p">,</span>
            <span class="n">b</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
            <span class="n">c</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>
            <span class="n">d</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">d</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="n">ChildFront</span><span class="p">:</span>
    <span class="n">form</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="n">form</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">this</span><span class="o">.</span><span class="n">actorID</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">actorID</span><span class="p">;</span>
        <span class="n">this</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">id</span><span class="p">;</span>
        <span class="n">this</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">a</span><span class="p">;</span>
        <span class="n">this</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">b</span><span class="p">;</span>
        <span class="n">this</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">c</span><span class="p">;</span>
        <span class="n">this</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">d</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>And imagine you want to change â€˜câ€™ and return the object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// Oops!  If a type is going to return references to itself or any other
// type that isn&#39;t fully registered yet, you need to predeclare the type.
types.addActorType(&quot;childActor&quot;);

...

// spec:
methods: {
  changeC: {
    request: { newC: Arg(0) },
    response: { self: RetVal(&quot;childActor&quot;) }
  }
}

// implementation:
changeC: function (newC) {
  c = newC;
  return this;
}

...

childFront.changeC(&#39;hello&#39;).then(ret =&gt; { assert(ret === childFront); assert(childFront.c === &quot;hello&quot;) });
</pre></div>
</div>
<p>Now our response will look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="n">from</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">childActorID</span><span class="o">&gt;</span><span class="p">,</span> <span class="bp">self</span><span class="p">:</span> <span class="p">{</span> <span class="n">actor</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">childActorID</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">greeting</span><span class="p">:</span> <span class="o">&lt;</span><span class="nb">id</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">a</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">d</span><span class="o">&gt;</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="lifetimes">
<h2>Lifetimes<a class="headerlink" href="#lifetimes" title="Permalink to this headline">Â¶</a></h2>
<p>No, I donâ€™t want to talk about lifetimes quite yet.</p>
</div>
<div class="section" id="events">
<h2>Events<a class="headerlink" href="#events" title="Permalink to this headline">Â¶</a></h2>
<p>Your actor has great news!</p>
<p>Actors are subclasses of jetpack <code class="docutils literal notranslate"><span class="pre">EventTarget</span></code>, so you can just emit events.
Hereâ€™s how youâ€™d set it up in a spec:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>events: {
  &quot;good-news&quot;: {
    type: &quot;goodNews&quot;, // event target naming and packet naming are at odds, and we want both to be natural!
    news: Arg(0)
  }
}

methods: {
  giveGoodNews: {
    request: { news: Arg(0) }
  }
}
</pre></div>
</div>
<p>Hereâ€™s how the implementation would look:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">EventEmitter</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&quot;devtools/shared/event-emitter&quot;</span><span class="p">);</span>

<span class="o">//</span> <span class="n">In</span> <span class="n">your</span> <span class="n">protocol</span><span class="o">.</span><span class="n">ActorClassWithSpec</span> <span class="n">definition</span><span class="p">:</span>
<span class="n">giveGoodNews</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="n">news</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">EventEmitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="s2">&quot;good-news&quot;</span><span class="p">,</span> <span class="n">news</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now you can listen to events on a front:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>front.on(&quot;good-news&quot;, news =&gt; {
  console.log(`Got some good news: ${news}\n`);
});
front.giveGoodNews().then(() =&gt; { console.log(&quot;request returned.&quot;) });
</pre></div>
</div>
<p>If you want to modify the argument that will be passed to event listeners callbacks, you
can use <code class="docutils literal notranslate"><span class="pre">before(eventName,</span> <span class="pre">fn)</span></code> in the front definition. This can only be used once for a
given <code class="docutils literal notranslate"><span class="pre">eventName</span></code>. The <code class="docutils literal notranslate"><span class="pre">fn</span></code> function will be called before emitting the event via
the EventEmitter API on the Front, and its return value will be passed to the event
listener callbacks. If <code class="docutils literal notranslate"><span class="pre">fn</span></code> is async, the event will only be emitted after <code class="docutils literal notranslate"><span class="pre">fn</span></code> call resolves.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">In</span> <span class="n">front</span> <span class="n">file</span><span class="p">,</span> <span class="n">most</span> <span class="n">probably</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">constructor</span><span class="p">:</span>
<span class="n">this</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="s2">&quot;good-news&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">(</span><span class="n">news</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">news</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot; - &quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="o">//</span> <span class="n">In</span> <span class="nb">any</span> <span class="n">consumer</span>
<span class="n">front</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;good-news&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">(</span><span class="n">news</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">news</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<p>So if the server sent the following array: <code class="docutils literal notranslate"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3]</span></code>, the console.log in the consumer
would print <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">-</span> <span class="pre">2</span> <span class="pre">-</span> <span class="pre">3</span></code>.</p>
<p>On a somewhat related note, not every method needs to be request/response.  Just like an actor can emit a one-way event, a method can be marked as a one-way request.  Maybe we donâ€™t care about giveGoodNews returning anything:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">spec</span><span class="p">:</span>
<span class="n">methods</span><span class="p">:</span> <span class="p">{</span>
  <span class="n">giveGoodNews</span><span class="p">:</span> <span class="p">{</span>
    <span class="n">request</span><span class="p">:</span> <span class="p">{</span> <span class="n">news</span><span class="p">:</span> <span class="n">Arg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">},</span>
    <span class="n">oneway</span><span class="p">:</span> <span class="n">true</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">implementation</span><span class="p">:</span>
<span class="n">giveGoodNews</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="n">news</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">emit</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="s2">&quot;good-news&quot;</span><span class="p">,</span> <span class="n">news</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2>Lifetimes<a class="headerlink" href="#id1" title="Permalink to this headline">Â¶</a></h2>
<p>No, letâ€™s talk about custom front methods instead.</p>
</div>
<div class="section" id="custom-front-methods">
<h2>Custom Front Methods<a class="headerlink" href="#custom-front-methods" title="Permalink to this headline">Â¶</a></h2>
<p>You might have some bookkeeping to do before issuing a request.  Letâ€™s say youâ€™re calling <code class="docutils literal notranslate"><span class="pre">echo</span></code>, but you want to count the number of times you issue that request.  Just use the <code class="docutils literal notranslate"><span class="pre">custom</span></code> tag in your front implementation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span><span class="p">:</span> <span class="n">custom</span><span class="p">(</span><span class="n">function</span> <span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">this</span><span class="o">.</span><span class="n">numEchos</span><span class="o">++</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">this</span><span class="o">.</span><span class="n">_echo</span><span class="p">(</span><span class="nb">str</span><span class="p">);</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="n">impl</span><span class="p">:</span> <span class="s2">&quot;_echo&quot;</span>
<span class="p">})</span>
</pre></div>
</div>
<p>This puts the generated implementation in <code class="docutils literal notranslate"><span class="pre">_echo</span></code> instead of <code class="docutils literal notranslate"><span class="pre">echo</span></code>, letting you implement <code class="docutils literal notranslate"><span class="pre">echo</span></code> as needed.  If you leave out the <code class="docutils literal notranslate"><span class="pre">impl</span></code>, it just wonâ€™t generate the implementation at all.  Youâ€™re on your own.</p>
</div>
<div class="section" id="id2">
<h2>Lifetimes<a class="headerlink" href="#id2" title="Permalink to this headline">Â¶</a></h2>
<p>OK, I canâ€™t think of any more ways to put this off.  The remote debugging protocol has the concept of a <em>parent</em> for each actor.  This is to make distributed memory management a bit easier.  Basically, any descendents of an actor will be destroyed if the actor is destroyed.</p>
<p>Other than that, the basic protocol makes no guarantees about lifetime.  Each interface defined in the protocol will need to discuss and document its approach to lifetime management (although there are a few common patterns).</p>
<p>The protocol library will maintain the child/parent relationships for you, but it needs some help deciding what the child/parent relationships are.</p>
<p>The default parent of an object is the first object that returns it after it is created.  So to revisit our earlier HelloActor <code class="docutils literal notranslate"><span class="pre">getChild</span></code> implementation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">spec</span><span class="p">:</span>
<span class="n">methods</span><span class="p">:</span> <span class="p">{</span>
  <span class="n">getChild</span><span class="p">:</span> <span class="p">{</span>
    <span class="n">request</span><span class="p">:</span> <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
    <span class="n">response</span><span class="p">:</span> <span class="p">{</span> <span class="n">child</span><span class="p">:</span> <span class="n">RetVal</span><span class="p">(</span><span class="s2">&quot;childActor&quot;</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">implementation</span><span class="p">:</span>
<span class="n">getChild</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">new</span> <span class="n">ChildActor</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="nb">id</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The ChildActorâ€™s parent is the HelloActor, because itâ€™s the one that created it.</p>
<p>You can customize this behavior in two ways.  The first is by defining a <code class="docutils literal notranslate"><span class="pre">marshallPool</span></code> property in your actor.  Imagine a new ChildActor method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">spec</span><span class="p">:</span>
<span class="n">methods</span><span class="p">:</span> <span class="p">{</span>
  <span class="n">getSibling</span><span class="p">:</span> <span class="p">{</span>
    <span class="n">request</span><span class="p">:</span> <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
    <span class="n">response</span><span class="p">:</span> <span class="p">{</span> <span class="n">child</span><span class="p">:</span> <span class="n">RetVal</span><span class="p">(</span><span class="s2">&quot;childActor&quot;</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">implementation</span><span class="p">:</span>
<span class="n">getSibling</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">new</span> <span class="n">ChildActor</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="nb">id</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This creates a new child actor owned by the current child actor.  But in this example we want all actors created by the child to be owned by the HelloActor.  So we can define a <code class="docutils literal notranslate"><span class="pre">defaultParent</span></code> property that makes use of the <code class="docutils literal notranslate"><span class="pre">parent</span></code> property provided by the Actor class:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">get</span> <span class="n">marshallPool</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">this</span><span class="o">.</span><span class="n">parent</span> <span class="p">}</span>
</pre></div>
</div>
<p>The front needs to provide a matching <code class="docutils literal notranslate"><span class="pre">defaultParent</span></code> property that returns an owning front, to make sure the client and server lifetimes stay synced.</p>
<p>For more complex situations, you can define your own lifetime properties.  Take this new pair of HelloActor methods:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// When the &quot;temp&quot; lifetime is specified, look for the _temporaryParent attribute as the owner.
types.addLifetime(&quot;temp&quot;, &quot;_temporaryParent&quot;);

// spec:
methods: {
  getTemporaryChild: {
    request: { id: Arg(0) },
    response: {
      child: RetVal(&quot;temp:childActor&quot;) // use the lifetime name here to specify the expected lifetime.
    }
  },
  clearTemporaryChildren: {
    oneway: true
  }
}

// implementation:
getTemporaryChild: function (id) {
  if (!this._temporaryParent) {
    // Create an actor to serve as the parent for all temporary children and explicitly
    // add it as a child of this actor.
    this._temporaryParent = new Actor(this.conn));
    this.manage(this._temporaryParent);
  }
  return new ChildActor(this.conn, id);
}

clearTemporaryChildren: function () {
  if (this._temporaryParent) {
    this._temporaryParent.destroy();
    delete this._temporaryParent;
  }
}
</pre></div>
</div>
<p>This will require some matching work on the front:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>getTemporaryChild: protocol.custom(function (id) {
    if (!this._temporaryParent) {
        this._temporaryParent = this.manage(new Front(this.client));
    }
    return this._getTemporaryChild(id);
}, {
    impl: &quot;_getTemporaryChild&quot;
}),

clearTemporaryChildren: protocol.custom(function (id) {
    if (this._temporaryParent) {
        this._temporaryParent.destroy();
        delete this._temporaryParent;
    }
    return this._clearTemporaryChildren();
}, {
    impl: &quot;_clearTemporaryChildren&quot;
})
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="actor-registration.html" class="btn btn-neutral float-right" title="How to register an actor" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="actor-e10s-handling.html" class="btn btn-neutral float-left" title="How to handle E10S in actors" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>