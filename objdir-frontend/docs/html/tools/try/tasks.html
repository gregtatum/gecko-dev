

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Task Generation &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Build System" href="../../build/buildsystem/index.html" />
    <link rel="prev" title="Presets" href="presets.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../mach/index.html">Mach</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Try Server</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#using-try">Using Try</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#attaching-new-jobs-from-a-review">Attaching new jobs from a review</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#table-of-contents">Table of Contents</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="configuration.html">Configuring Try</a></li>
<li class="toctree-l3"><a class="reference internal" href="selectors/index.html">Selectors</a></li>
<li class="toctree-l3"><a class="reference internal" href="presets.html">Presets</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Task Generation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#configuring-watchman">Configuring Watchman</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#indices-and-tables">Indices and tables</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Try Server</a> &raquo;</li>
        
      <li>Task Generation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/tools/try/tasks.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="task-generation">
<h1>Task Generation<a class="headerlink" href="#task-generation" title="Permalink to this headline">¶</a></h1>
<p>Many selectors (including <code class="docutils literal notranslate"><span class="pre">chooser</span></code>, <code class="docutils literal notranslate"><span class="pre">coverage</span></code> and <code class="docutils literal notranslate"><span class="pre">fuzzy</span></code>) source their available tasks
directly from the <a class="reference internal" href="../../taskcluster/index.html#taskcluster-task-graph-generation"><span class="std std-ref">taskgraph</span></a> module by building the taskgraph
locally. This means that the list of available tasks will never be stale. While this is very
powerful, it comes with a large enough performance cost to get annoying (around twenty seconds).</p>
<p>The result of the taskgraph generation will be cached, so this penalty will only be incurred
whenever a file in the <code class="docutils literal notranslate"><span class="pre">/taskcluster</span></code> directory is modified. Unfortunately this directory changes
pretty frequently, so developers can expect to rebuild the cache each time they pull in
<code class="docutils literal notranslate"><span class="pre">mozilla-central</span></code>. Developers who regularly work on <code class="docutils literal notranslate"><span class="pre">/taskcluster</span></code> can expect to rebuild even
more frequently.</p>
<div class="section" id="configuring-watchman">
<h2>Configuring Watchman<a class="headerlink" href="#configuring-watchman" title="Permalink to this headline">¶</a></h2>
<p>It’s possible to bypass this penalty completely by using the file watching service <a class="reference external" href="https://facebook.github.io/watchman/">watchman</a>. If
you use the <code class="docutils literal notranslate"><span class="pre">fsmonitor</span></code> mercurial extension, you already have <code class="docutils literal notranslate"><span class="pre">watchman</span></code> installed.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you aren’t using <a class="reference external" href="https://www.mercurial-scm.org/wiki/FsMonitorExtension">fsmonitor</a> but end up installng watchman anyway, you
might as well enable it for a faster Mercurial experience.</p>
</div>
<p>Otherwise, <a class="reference external" href="https://facebook.github.io/watchman/docs/install.html">install watchman</a>. If using Linux you’ll likely run into the <a class="reference external" href="https://facebook.github.io/watchman/docs/install.html#linux-inotify-limits">inotify limits</a> outlined
on that page due to the size of <code class="docutils literal notranslate"><span class="pre">mozilla-central</span></code>. You can <a class="reference external" href="https://github.com/guard/listen/wiki/Increasing-the-amount-of-inotify-watchers">read this page</a> for more information
on how to bump the limits permanently.</p>
<p>Next run the following commands:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> path/to/mozilla-central
$ watchman -j &lt; tools/tryselect/watchman.json
</pre></div>
</div>
<p>You should see output like:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;4.9.0&quot;</span><span class="p">,</span>
    <span class="nt">&quot;triggerid&quot;</span><span class="p">:</span> <span class="s2">&quot;rebuild-taskgraph-cache&quot;</span><span class="p">,</span>
    <span class="nt">&quot;disposition&quot;</span><span class="p">:</span> <span class="s2">&quot;created&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>That’s it. Now anytime a file under <code class="docutils literal notranslate"><span class="pre">/taskcluster</span></code> is modified (either by your editor, or by
updating version control), the taskgraph cache will be rebuilt in the background, allowing you to
skip the wait the next time you run <code class="docutils literal notranslate"><span class="pre">mach</span> <span class="pre">try</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Watchman triggers are persistent and don’t need to be added more than once.
See <a class="reference internal" href="#managing-triggers">Managing Triggers</a> for how to remove a trigger.</p>
</div>
<p>You can test that everything is working by running these commands:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ <span class="nv">statedir</span><span class="o">=</span><span class="sb">`</span>mach python -c <span class="s2">&quot;from mozboot.util import get_state_dir; print(get_state_dir(srcdir=True))&quot;</span><span class="sb">`</span>
$ rm -rf <span class="nv">$statedir</span>/cache/taskgraph
$ touch taskcluster/mach_commands.py
<span class="c1"># wait a minute for generation to trigger and finish</span>
$ ls <span class="nv">$statedir</span>/cache/taskgraph
</pre></div>
</div>
<p>If the <code class="docutils literal notranslate"><span class="pre">target_task_set</span></code> file exists, you are good to go. If not you can look at the <code class="docutils literal notranslate"><span class="pre">watchman</span></code>
log to see if there were any errors. This typically lives somewhere like
<code class="docutils literal notranslate"><span class="pre">/usr/local/var/run/watchman/$USER-state/log</span></code>. In this case please file a bug under <code class="docutils literal notranslate"><span class="pre">Firefox</span>
<span class="pre">Build</span> <span class="pre">System</span> <span class="pre">::</span> <span class="pre">Try</span></code> and include the relevant portion of the log.</p>
<div class="section" id="running-watchman-on-startup">
<h3>Running Watchman on Startup<a class="headerlink" href="#running-watchman-on-startup" title="Permalink to this headline">¶</a></h3>
<p>Watchman is both a client and a service all in one. When running a <code class="docutils literal notranslate"><span class="pre">watchman</span></code> command, the client
binary will start the service in the background if it isn’t running. This means on reboot the
service won’t be running and you’ll need to start the service each time by invoking the client
binary (e.g by running <code class="docutils literal notranslate"><span class="pre">watchman</span> <span class="pre">version</span></code>).</p>
<p>If you’d like this to happen automatically, you can use your favourite platform specific way of
running commands at startup (<code class="docutils literal notranslate"><span class="pre">crontab</span></code>, <code class="docutils literal notranslate"><span class="pre">rc.local</span></code>, etc.). Watchman stores separate state for
each user, so be sure you run the command as the user that set up the triggers.</p>
<div class="section" id="setting-up-a-systemd-service">
<h4>Setting up a systemd Service<a class="headerlink" href="#setting-up-a-systemd-service" title="Permalink to this headline">¶</a></h4>
<p>If <code class="docutils literal notranslate"><span class="pre">systemd</span></code> is an option you can create a service:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Watchman for %i</span>
<span class="na">After</span><span class="o">=</span><span class="s">network.target</span>

<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">simple</span>
<span class="na">User</span><span class="o">=</span><span class="s">%i</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/local/bin/watchman --log-level 1 watch-list -f</span>
<span class="na">ExecStop</span><span class="o">=</span><span class="s">/usr/local/bin/watchman shutdown-server</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>
</div>
<p>Save this to a file called <code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/watchman&#64;.service</span></code>. Then run:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ sudo systemctl <span class="nb">enable</span> watchman@<span class="nv">$USER</span>.service
$ sudo systemctl start watchman@<span class="nv">$USER</span>.service
</pre></div>
</div>
<p>The next time you reboot, the watchman service should start automatically.</p>
</div>
</div>
<div class="section" id="managing-triggers">
<h3>Managing Triggers<a class="headerlink" href="#managing-triggers" title="Permalink to this headline">¶</a></h3>
<p>When adding a trigger watchman writes it to disk. Typically it’ll be a path similar to
<code class="docutils literal notranslate"><span class="pre">/usr/local/var/run/watchman/$USER-state/state</span></code>. While editing that file by hand would work, the
watchman binary provides an interface for managing your triggers.</p>
<p>To see all directories you are currently watching:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ watchman watch-list
</pre></div>
</div>
<p>To view triggers that are active in a specified watch:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ watchman trigger-list &lt;path&gt;
</pre></div>
</div>
<p>To delete a trigger from a specified watch:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ watchman trigger-del &lt;path&gt; &lt;name&gt;
</pre></div>
</div>
<p>In the above two examples, replace <code class="docutils literal notranslate"><span class="pre">&lt;path&gt;</span></code> with the path of the watch, presumably
<code class="docutils literal notranslate"><span class="pre">mozilla-central</span></code>. Using <code class="docutils literal notranslate"><span class="pre">.</span></code> works as well if that is already your working directory. For more
information on managing triggers and a reference of other commands, see the <a class="reference external" href="https://facebook.github.io/watchman/docs/cmd/trigger.html">official docs</a>.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../build/buildsystem/index.html" class="btn btn-neutral float-right" title="Build System" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="presets.html" class="btn btn-neutral float-left" title="Presets" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>