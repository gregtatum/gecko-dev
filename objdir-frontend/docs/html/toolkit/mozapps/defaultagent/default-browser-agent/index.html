

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Default Browser Agent &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Messaging System" href="../../../../browser/components/newtab/content-src/asrouter/docs/index.html" />
    <link rel="prev" title="Helper" href="../../../../browser/installer/windows/installer/Helper.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../../browser/index.html">Firefox</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../../browser/urlbar/index.html">Address Bar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../browser/BrowserUsageTelemetry.html">Browser Usage Telemetry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../browser/components/enterprisepolicies/docs/index.html">Enterprise Policies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../browser/extensions/formautofill/docs/index.html">Form Autofill</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../browser/components/newtab/docs/index.html">Firefox Home (New Tab)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../browser/installer/windows/installer/index.html">Installer</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Default Browser Agent</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#scheduled-task">Scheduled Task</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#remote-disablement">Remote Disablement</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#data-management">Data Management</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pref-reflection">Pref Reflection</a></li>
<li class="toctree-l4"><a class="reference internal" href="#default-browser-setting">Default Browser Setting</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../browser/components/newtab/content-src/asrouter/docs/index.html">Messaging System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../browser/base/sslerrorreport/index.html">SSL Error Reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../browser/base/tabbrowser/index.html">tabbrowser</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../browser/touchbar/index.html">Touch Bar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../browser/components/uitour/docs/index.html">UITour</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../browser/components/payments/docs/index.html">WebPayments UI</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../../browser/index.html">Firefox</a> &raquo;</li>
        
      <li>Default Browser Agent</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../../_sources/toolkit/mozapps/defaultagent/default-browser-agent/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="default-browser-agent">
<h1>Default Browser Agent<a class="headerlink" href="#default-browser-agent" title="Permalink to this headline">¶</a></h1>
<p>The Default Browser Agent is a Windows-only scheduled task which runs in the background to collect and submit data about the browser that the user has set as their OS default (that is, the browser that will be invoked by the operating system to open web links that the user clicks on in other programs). Its purpose is to help Mozilla understand user’s default browser choices and, in the future, to engage with users at a time when they may not be actively running Firefox.</p>
<p>For information about the specific data that the agent sends, see <a class="reference internal" href="../../../components/telemetry/data/default-browser-ping.html"><span class="doc">the ping documentation</span></a>.</p>
<div class="section" id="scheduled-task">
<h2>Scheduled Task<a class="headerlink" href="#scheduled-task" title="Permalink to this headline">¶</a></h2>
<p>The agent runs as a <a class="reference external" href="https://docs.microsoft.com/en-us/windows/win32/taskschd/about-the-task-scheduler">Windows scheduled task</a>. The scheduled task executes all of the agent’s primary functions; all of its other functions relate to managing the task. The Windows installer is responsible for creating (and the uninstaller for removing) the agent’s task entry, but the code for actually doing this resides in the agent itself, and the installers simply call it using dedicated command line parameters (<code class="docutils literal notranslate"><span class="pre">register-task</span></code> and <code class="docutils literal notranslate"><span class="pre">uninstall</span></code>). The <a class="reference internal" href="../../../../browser/installer/windows/installer/Helper.html"><span class="doc">PostUpdate</span></a> code also calls the agent to update any properties of an existing task registration that need to be updated, or to create one during an application update if none exists.</p>
<p>The tasks are normal entries in the Windows Task Scheduler, managed using <a class="reference external" href="https://docs.microsoft.com/en-us/windows/win32/api/_taskschd/">its Win32 API</a>. They’re created in a tasks folder called “Mozilla” (or whatever the application’s vendor name is), and there’s one for each installation of Firefox (or other Mozilla application). The task is set to run automatically every 24 hours starting at the time it’s registered (with the first run being 24 hours after that), or the nearest time after that the computer is awake. The task is configured with one action, which is to run the agent binary with the command line parameter <code class="docutils literal notranslate"><span class="pre">do-task</span></code>, the command that invokes the actual agent functionality.</p>
<p>The default browser agent needs to run as some OS-level user, as opposed to, say, <code class="docutils literal notranslate"><span class="pre">LOCAL</span> <span class="pre">SERVICE</span></code>, in order to read the user’s default browser setting. Therefore, the default browser agent runs as the user that ran the Firefox installer (although always without elevation, whether the installer had it or not).</p>
<div class="section" id="remote-disablement">
<h3>Remote Disablement<a class="headerlink" href="#remote-disablement" title="Permalink to this headline">¶</a></h3>
<p>The default browser agent can be remotely disabled and (re-)enabled.  Each time the scheduled task runs it queries <a class="reference external" href="https://remote-settings.readthedocs.io/en/latest/">Firefox Remote Settings</a> to determine if the agent has been remotely disabled or (re-)enabled.</p>
<p>If the default browser agent is disabled by policy, remote disablement will not be checked.  However, the notification functionality of the agent is distinct from the telemetry functionality of the agent, and remote disablement must apply to both functions.  Therefore, even if the user has opted out of sending telemetry (by policy or by preference), the agent must check for remote disablement.  For a user who is currently opted out of telemetry, they will not be opted in due to the default browser agent being remotely (re-)enabled.</p>
</div>
</div>
<div class="section" id="data-management">
<h2>Data Management<a class="headerlink" href="#data-management" title="Permalink to this headline">¶</a></h2>
<p>The default browser agent has to be able to work with settings at several different levels: a Firefox profile, an OS user, a Firefox installation, and the entire system. This need creates an information architecture mismatch between all of those things, mostly because no Firefox profile is available to the agent while it’s running; it’s not really feasible to either directly use or to clone Firefox’s profile selection functionality, and even if we could select a profile, whatever code we might use to actually work with it would have the same problems. So, in order to allow for controlling the agent from Firefox, certain settings are mirrored from Firefox to a location where the agent can read them. Since the agent operates in the context only of an OS-level user, that means that in this situation a single OS-level user who uses multiple Firefox profiles may be able to observe the agent’s settings changing as the different profiles race to be the active mirror, without them knowingly taking any action.</p>
<div class="section" id="pref-reflection">
<h3>Pref Reflection<a class="headerlink" href="#pref-reflection" title="Permalink to this headline">¶</a></h3>
<p>The agent needs to be able to read (but not set) values that have their canonical representation in the form of Firefox prefs. This means those pref values have to be copied out to a place where the agent can read them. The Windows registry was chosen as that place; it’s easier to use than a file, and we already have keys there which are reserved by Firefox. Specifically, the subkey used for these prefs is <code class="docutils literal notranslate"><span class="pre">HKEY_CURRENT_USER\Software\[app</span> <span class="pre">vendor</span> <span class="pre">name]\[app</span> <span class="pre">name]\Default</span> <span class="pre">Browser</span> <span class="pre">Agent\</span></code>. During Firefox startup, the values of the prefs that control the agent are reflected to this key, and those values are updated whenever the prefs change after that.</p>
<p>The list of reflected prefs includes the global telemetry opt-out pref <code class="docutils literal notranslate"><span class="pre">datareporting.healthreport.uploadEnabled</span></code> and a pref called <code class="docutils literal notranslate"><span class="pre">default-browser-agent.enabled</span></code>, which can enable or disable the entire agent. The agent checks these registry-reflected pref values when its scheduled task runs, they do not actually prevent the scheduled task from running.</p>
<p>Enterprise policies also exist to perform the same functions as these prefs. These work the same way as all other Firefox policies and <a class="reference external" href="https://github.com/mozilla/policy-templates/blob/master/README.md">the documentation for those</a> explains how to use them.</p>
<p>In addition, the following Firefox Remote Settings prefs are reflected: <code class="docutils literal notranslate"><span class="pre">services.settings.server</span></code> and <code class="docutils literal notranslate"><span class="pre">security.content.signature.root_hash</span></code>.  The former is the service endpoint to consult for remote-disablement and the latter is used to secure the content of queries to that service endpoint.</p>
</div>
<div class="section" id="default-browser-setting">
<h3>Default Browser Setting<a class="headerlink" href="#default-browser-setting" title="Permalink to this headline">¶</a></h3>
<p>The agent is responsible for reporting both the user’s current default browser and their previous default browser. Nothing in the operating system records past associations, so the agent must do this for itself. First, it gets the current default browser by calling <a class="reference external" href="https://docs.microsoft.com/en-us/windows/win32/api/shobjidl_core/nf-shobjidl_core-iapplicationassociationregistration-querycurrentdefault">IApplicationAssociationRegistration::QueryCurrentDefault</a> for the <code class="docutils literal notranslate"><span class="pre">http</span></code> protocol. It then checks that against a value stored in its own registry key and, if those are different, it knows that the default browser has changed, and records the new and old defaults.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../../../browser/components/newtab/content-src/asrouter/docs/index.html" class="btn btn-neutral float-right" title="Messaging System" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../../../../browser/installer/windows/installer/Helper.html" class="btn btn-neutral float-left" title="Helper" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>