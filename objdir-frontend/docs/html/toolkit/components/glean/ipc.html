

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Inter-process Communication (IPC) &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="New Metrics and Pings" href="new_definitions_file.html" />
    <link rel="prev" title="FOG code organization" href="code_organization.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Toolkit</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../mozapps/extensions/addon-manager/index.html">Add-on Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../crashes/crash-manager/index.html">Crash Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../crashreporter/crashreporter/index.html">Crash Reporter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../featuregates/featuregates/index.html">Feature Gates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../search/index.html">Search Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../normandy/normandy/index.html">Shield Recipe Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../messaging-system/docs/index.html">Messaging System Schemas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pictureinpicture/pictureinpicture/index.html">Picture-in-Picture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../prompts/prompts/index.html">Prompts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/subprocess/toolkit_modules/subprocess/index.html">Subprocess Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../telemetry/index.html">Telemetry</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Firefox on Glean (FOG)</a><ul class="current">
<li class="toctree-l3"><a class="reference external" href="https://github.com/mozilla/glean/">Glean SDK Source</a></li>
<li class="toctree-l3"><a class="reference external" href="https://mozilla.github.io/glean/book/index.html">Glean SDK Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="code_organization.html">FOG code organization</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Inter-process Communication (IPC)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#design">Design</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="new_definitions_file.html">New Metrics and Pings</a></li>
<li class="toctree-l3"><a class="reference internal" href="new_metric_types.html">Adding a New Metric Type</a></li>
<li class="toctree-l3"><a class="reference internal" href="preferences.html">Preferences</a></li>
<li class="toctree-l3"><a class="reference internal" href="storage.html">Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="style_guide.html">FOG Documentation Style Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="updating_parser.html">Updating glean_parser</a></li>
<li class="toctree-l3"><a class="reference internal" href="updating_sdk.html">Updating the Glean SDK</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/toolkit_modules/index.html">Toolkit Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../content/toolkit_widgets/index.html">Toolkit Widgets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../url-classifier/url-classifier/index.html">URL Classifier</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extensions/webextensions/index.html">WebExtensions API Development</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Toolkit</a> &raquo;</li>
        
          <li><a href="index.html">Firefox on Glean (FOG)</a> &raquo;</li>
        
      <li>Inter-process Communication (IPC)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/toolkit/components/glean/ipc.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="inter-process-communication-ipc">
<h1>Inter-process Communication (IPC)<a class="headerlink" href="#inter-process-communication-ipc" title="Permalink to this headline">¶</a></h1>
<p>Firefox Desktop is a multi-process desktop application.
Code requiring instrumentation may be on any of its processes,
so FOG needs to provide facilities to enable that.</p>
<div class="section" id="design">
<h2>Design<a class="headerlink" href="#design" title="Permalink to this headline">¶</a></h2>
<p>The IPC Design of FOG was worked out in
<a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1618253">bug 1618253</a>.</p>
<p>It centred around a few specific concepts:</p>
<div class="section" id="forbidding-non-commutative-operations">
<h3>Forbidding Non-Commutative Operations<a class="headerlink" href="#forbidding-non-commutative-operations" title="Permalink to this headline">¶</a></h3>
<p>Because we cannot nicely impose a canonical ordering of metric operations across all processes,
FOG forbids non-<a class="reference external" href="https://en.wikipedia.org/wiki/Commutative_property">commutative</a>
metric operations in some circumstances.</p>
<p>For example,
<code class="docutils literal notranslate"><span class="pre">Add()</span></code>-ing to a Counter metric works from multiple processes because the order doesn’t matter.
However, given a String metric being <code class="docutils literal notranslate"><span class="pre">Set()</span></code> from multiple processes simultaneously,
which value should it take?</p>
<p>This ambiguity is not a good foundation to build trust on,
so we forbid setting a String metric from multiple processes.</p>
<p><strong>TODO</strong>: Expand on what, exactly, is forbidden and when.
Do we permit actions on string metrics so long as they only happen on one process?
Do we forbid any actions on string metrics from non-main processes?
See <a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1647730">bug 1647730</a>.</p>
</div>
<div class="section" id="process-agnosticism">
<h3>Process Agnosticism<a class="headerlink" href="#process-agnosticism" title="Permalink to this headline">¶</a></h3>
<p>For metric types that can be used cross-process,
FOG provides no facility for identifying which process the instrumentation is on.</p>
<p>What this means is that if you accumulate to a
<a class="reference external" href="https://mozilla.github.io/glean/book/user/metrics/timing_distribution.html">Timing Distribution</a>
in multiple processes,
all the samples from all the processes will be combined in the same metric.</p>
<p>If you wish to distinguish samples from different process types,
you will need multiple metrics and inline code to select the proper one for the given process.
For example:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">XRE_GetProcessType</span><span class="p">()</span> <span class="o">==</span> <span class="n">GeckoProcessType_Default</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">mozilla</span><span class="o">::</span><span class="n">glean</span><span class="o">::</span><span class="n">performance</span><span class="o">::</span><span class="n">cache_size</span><span class="p">.</span><span class="n">Accumulate</span><span class="p">(</span><span class="n">numBytes</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="n">mozilla</span><span class="o">::</span><span class="n">glean</span><span class="o">::</span><span class="n">performance</span><span class="o">::</span><span class="n">non_main_process_cache_size</span><span class="p">.</span><span class="n">Accumulate</span><span class="p">(</span><span class="n">numBytes</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="scheduling">
<h3>Scheduling<a class="headerlink" href="#scheduling" title="Permalink to this headline">¶</a></h3>
<p>FOG makes no guarantee about when non-main-process metric values are sent across IPC.
FOG will try its best to schedule opportunistically in idle moments.</p>
<p>There are a few cases where we provide more firm guarantees:</p>
<div class="section" id="tests">
<h4>Tests<a class="headerlink" href="#tests" title="Permalink to this headline">¶</a></h4>
<p>There are test-only APIs in Rust, C++,
and Javascript that expose when a complete flush of child process metric values has completed.
See <a class="reference internal" href="testing.html"><span class="doc">the test documentation</span></a> for more details.</p>
</div>
<div class="section" id="built-in-pings">
<h4>Built-in Pings<a class="headerlink" href="#built-in-pings" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://mozilla.github.io/glean/book/user/pings/index.html">Built-in pings</a>
will send only after all metric values from all child processes have been collected.</p>
<p>We cannot at this time provide the same guarantee for
<a class="reference external" href="https://mozilla.github.io/glean/book/user/pings/custom.html">Custom Pings</a>.</p>
</div>
<div class="section" id="shutdown">
<h4>Shutdown<a class="headerlink" href="#shutdown" title="Permalink to this headline">¶</a></h4>
<p>We will make a best effort during an orderly shutdown to flush all pending data in child processes.</p>
</div>
</div>
<div class="section" id="mechanics">
<h3>Mechanics<a class="headerlink" href="#mechanics" title="Permalink to this headline">¶</a></h3>
<p>At present
(see <a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1641989">bug 1641989</a>)
FOG uses messages on the PContent protocol.
This enables communication between content child processes and the parent process.</p>
<p>The rough design is that the Parent can request an immediate flush of pending data,
and each Child can decide to flush its pending data whenever it wishes.</p>
<p>Pending Data is a buffer of bytes generated by <code class="docutils literal notranslate"><span class="pre">bincode</span></code> in Rust in the Child,
handed off to C++, passed over IPC,
then given back to <code class="docutils literal notranslate"><span class="pre">bincode</span></code> in Rust on the Parent.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="new_definitions_file.html" class="btn btn-neutral float-right" title="New Metrics and Pings" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="code_organization.html" class="btn btn-neutral float-left" title="FOG code organization" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>