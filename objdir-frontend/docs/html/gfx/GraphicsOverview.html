

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Graphics Overview &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Layers History" href="LayersHistory.html" />
    <link rel="prev" title="Graphics" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Graphics</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Graphics Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#work-in-progress-possibly-incorrect-or-incomplete">Work in progress. Possibly incorrect or incomplete.</a></li>
<li class="toctree-l3"><a class="reference internal" href="#jargon">Jargon</a></li>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#retained-layers">(Retained) Layers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compositing">Compositing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#render-and-retain-layer-elements">Render and retain layer elements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-the-layer-tree">Creating the layer tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="#refresh-driver">Refresh Driver</a></li>
<li class="toctree-l4"><a class="reference internal" href="#layers">Layers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rendering-each-layer">Rendering each layer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tiling-vs-buffer-rotation-vs-full-paint">Tiling vs. Buffer Rotation vs. Full paint</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compositing-for-the-final-result">Compositing for the final result</a></li>
<li class="toctree-l4"><a class="reference internal" href="#graphics-api">Graphics API</a></li>
<li class="toctree-l4"><a class="reference internal" href="#moz2d">Moz2D</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">Compositing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#image-decoding">Image Decoding</a></li>
<li class="toctree-l4"><a class="reference internal" href="#image-animation">Image Animation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#historical-documents">Historical Documents</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="LayersHistory.html">Layers History</a></li>
<li class="toctree-l2"><a class="reference internal" href="OffMainThreadPainting.html">Off Main Thread Painting</a></li>
<li class="toctree-l2"><a class="reference internal" href="AsyncPanZoom.html">Asynchronous Panning and Zooming</a></li>
<li class="toctree-l2"><a class="reference internal" href="AdvancedLayers.html">Advanced Layers</a></li>
<li class="toctree-l2"><a class="reference internal" href="Silk.html">Silk Overview</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Graphics</a> &raquo;</li>
        
      <li>Graphics Overview</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/gfx/GraphicsOverview.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="graphics-overview">
<h1>Graphics Overview<a class="headerlink" href="#graphics-overview" title="Permalink to this headline">¶</a></h1>
<div class="section" id="work-in-progress-possibly-incorrect-or-incomplete">
<h2>Work in progress. Possibly incorrect or incomplete.<a class="headerlink" href="#work-in-progress-possibly-incorrect-or-incomplete" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="jargon">
<h2>Jargon<a class="headerlink" href="#jargon" title="Permalink to this headline">¶</a></h2>
<p>There’s a lot of jargon in the graphics stack. We try to maintain a list
of common words and acronyms <a class="reference external" href="https://wiki.mozilla.org/Platform/GFX/Jargon">here</a>.</p>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The graphics systems is responsible for rendering (painting, drawing)
the frame tree (rendering tree) elements as created by the layout
system. Each leaf in the tree has content, either bounded by a rectangle
(or perhaps another shape, in the case of SVG.)</p>
<p>The simple approach for producing the result would thus involve
traversing the frame tree, in a correct order, drawing each frame into
the resulting buffer and displaying (printing non-withstanding) that
buffer when the traversal is done. It is worth spending some time on the
“correct order” note above. If there are no overlapping frames, this is
fairly simple - any order will do, as long as there is no background. If
there is background, we just have to worry about drawing that first.
Since we do not control the content, chances are the page is more
complicated. There are overlapping frames, likely with transparency, so
we need to make sure the elements are draw “back to front”, in layers,
so to speak. Layers are an important concept, and we will revisit them
shortly, as they are central to fixing a major issue with the above
simple approach.</p>
<p>While the above simple approach will work, the performance will suffer.
Each time anything changes in any of the frames, the complete process
needs to be repeated, everything needs to be redrawn. Further, there is
very little space to take advantage of the modern graphics (GPU)
hardware, or multi-core computers. If you recall from the previous
sections, the frame tree is only accessible from the UI thread, so while
we’re doing all this work, the UI is basically blocked.</p>
<div class="section" id="retained-layers">
<h3>(Retained) Layers<a class="headerlink" href="#retained-layers" title="Permalink to this headline">¶</a></h3>
<p>Layers framework was introduced to address the above performance issues,
by having a part of the design address each item. At the high level:</p>
<ol class="arabic simple">
<li><p>We create a layer tree. The leaf elements of the tree contain all
frames (possibly multiple frames per leaf).</p></li>
<li><p>We render each layer tree element and cache (retain) the result.</p></li>
<li><p>We composite (combine) all the leaf elements into the final result.</p></li>
</ol>
<p>Let’s examine each of these steps, in reverse order.</p>
</div>
<div class="section" id="compositing">
<h3>Compositing<a class="headerlink" href="#compositing" title="Permalink to this headline">¶</a></h3>
<p>We use the term composite as it implies that the order is important. If
the elements being composited overlap, whether there is transparency
involved or not, the order in which they are combined will effect the
result. Compositing is where we can use some of the power of the modern
graphics hardware. It is optimal for doing this job. In the scenarios
where only the position of individual frames changes, without the
content inside them changing, we see why caching each layer would be
advantageous - we only need to repeat the final compositing step,
completely skipping the layer tree creation and the rendering of each
leaf, thus speeding up the process considerably.</p>
<p>Another benefit is equally apparent in the context of the stated
deficiencies of the simple approach. We can use the available graphics
hardware accelerated APIs to do the compositing step. Direct3D, OpenGL
can be used on different platforms and are well suited to accelerate
this step.</p>
<p>Finally, we can now envision performing the compositing step on a
separate thread, unblocking the UI thread for other work, and doing more
work in parallel. More on this below.</p>
<p>It is important to note that the number of operations in this step is
proportional to the number of layer tree (leaf) elements, so there is
additional work and complexity involved, when the layer tree is large.</p>
</div>
<div class="section" id="render-and-retain-layer-elements">
<h3>Render and retain layer elements<a class="headerlink" href="#render-and-retain-layer-elements" title="Permalink to this headline">¶</a></h3>
<p>As we saw, the compositing step benefits from caching the intermediate
result. This does result in the extra memory usage, so needs to be
considered during the layer tree creation. Beyond the caching, we can
accelerate the rendering of each element by (indirectly) using the
available platform APIs (e.g., Direct2D, CoreGraphics, even some of the
3D APIs like OpenGL or Direct3D) as available. This is actually done
through a platform independent API (see Moz2D) below, but is important
to realize it does get accelerated appropriately.</p>
</div>
<div class="section" id="creating-the-layer-tree">
<h3>Creating the layer tree<a class="headerlink" href="#creating-the-layer-tree" title="Permalink to this headline">¶</a></h3>
<p>We need to create a layer tree (from the frames tree), which will give
us the correct result while striking the right balance between a layer
per frame element and a single layer for the complete frames tree. As
was mentioned above, there is an overhead in traversing the whole tree
and caching each of the elements, balanced by the performance
improvements. Some of the performance improvements are only noticed when
something changes (e.g., one element is moving, we only need to redo the
compositing step).</p>
</div>
<div class="section" id="refresh-driver">
<h3>Refresh Driver<a class="headerlink" href="#refresh-driver" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="layers">
<h3>Layers<a class="headerlink" href="#layers" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="rendering-each-layer">
<h3>Rendering each layer<a class="headerlink" href="#rendering-each-layer" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="tiling-vs-buffer-rotation-vs-full-paint">
<h3>Tiling vs. Buffer Rotation vs. Full paint<a class="headerlink" href="#tiling-vs-buffer-rotation-vs-full-paint" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="compositing-for-the-final-result">
<h3>Compositing for the final result<a class="headerlink" href="#compositing-for-the-final-result" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="graphics-api">
<h3>Graphics API<a class="headerlink" href="#graphics-api" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="moz2d">
<h3>Moz2D<a class="headerlink" href="#moz2d" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>The Moz2D graphics API, part of the Azure project, is a
cross-platform interface onto the various graphics backends that
Gecko uses for rendering such as Direct2D (1.0 and 1.1), Skia, Cairo,
Quartz, and NV Path. Adding a new graphics platform to Gecko is
accomplished by adding a backend to Moz2D.
See <a class="reference external" href="https://wiki.mozilla.org/Platform/GFX/Moz2D">Moz2D documentation on wiki</a>.</p></li>
</ul>
</div>
<div class="section" id="id1">
<h3>Compositing<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="image-decoding">
<h3>Image Decoding<a class="headerlink" href="#image-decoding" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="image-animation">
<h3>Image Animation<a class="headerlink" href="#image-animation" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="historical-documents">
<h2><a class="reference external" href="http://www.youtube.com/watch?v=lLZQz26-kms">Historical Documents</a><a class="headerlink" href="#historical-documents" title="Permalink to this headline">¶</a></h2>
<p>A number of posts and blogs that will give you more details or more
background, or reasoning that led to different solutions and approaches.</p>
<ul class="simple">
<li><p>2010-01 <a class="reference external" href="http://www.basschouten.com/blog1.php/layers-cross-platform-acceleration">Layers: Cross Platform Acceleration</a></p></li>
<li><p>2010-04 <a class="reference external" href="http://robert.ocallahan.org/2010/04/layers_01.html">Layers</a></p></li>
<li><p>2010-07 <a class="reference external" href="http://robert.ocallahan.org/2010/07/retained-layers_16.html">Retained Layers</a></p></li>
<li><p>2011-04 <a class="reference external" href="https://web.archive.org/web/20140604005804/https://blog.mozilla.org/joe/2011/04/26/introducing-the-azure-project/">Introduction</a></p></li>
<li><p>2011-07 <a class="reference external" href="http://chrislord.net/index.php/2011/07/25/shadow-layers-and-learning-by-failing/%20Shadow">Layers</a></p></li>
<li><p>2011-09 <a class="reference external" href="http://robert.ocallahan.org/2011/09/graphics-api-design.html">Graphics API Design</a></p></li>
<li><p>2012-04 <a class="reference external" href="http://muizelaar.blogspot.ca/2012/04/azure-canvas-on-os-x.html">Moz2D Canvas on OSX</a></p></li>
<li><p>2012-05 <a class="reference external" href="http://featherweightmusings.blogspot.co.uk/2012/05/mask-layers_26.html">Mask Layers</a></p></li>
<li><p>2013-07 <a class="reference external" href="http://www.basschouten.com/blog1.php">Graphics related</a></p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="LayersHistory.html" class="btn btn-neutral float-right" title="Layers History" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Graphics" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>