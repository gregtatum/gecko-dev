

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Optimization and SCHEDULES &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Docker Images" href="docker-images.html" />
    <link rel="prev" title="Optimization Process" href="optimization-process.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">TaskCluster Task-Graph Generation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="taskgraph.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="mach.html">Taskcluster Mach commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="loading.html">Loading Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="transforms.html">Transforms</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="optimization.html">Optimization</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="optimization.html#optimization-strategies">Optimization Strategies</a></li>
<li class="toctree-l3"><a class="reference internal" href="optimization.html#optimizing-target-tasks">Optimizing Target Tasks</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="optimization.html#more-information">More Information</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="optimization-process.html">Optimization Process</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Optimization and SCHEDULES</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="docker-images.html">Docker Images</a></li>
<li class="toctree-l2"><a class="reference internal" href="cron.html">Periodic Taskgraphs</a></li>
<li class="toctree-l2"><a class="reference internal" href="try.html">Try</a></li>
<li class="toctree-l2"><a class="reference internal" href="actions.html">Actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="release-promotion.html">Release Promotion</a></li>
<li class="toctree-l2"><a class="reference internal" href="versioncontrol.html">Version Control in CI</a></li>
<li class="toctree-l2"><a class="reference internal" href="config.html">Taskcluster Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="how-tos.html">How Tos</a></li>
<li class="toctree-l2"><a class="reference internal" href="task-graph.html">Task Graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference.html">Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">TaskCluster Task-Graph Generation</a> &raquo;</li>
        
          <li><a href="optimization.html">Optimization</a> &raquo;</li>
        
      <li>Optimization and SCHEDULES</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/taskcluster/optimization-schedules.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="optimization-and-schedules">
<h1>Optimization and SCHEDULES<a class="headerlink" href="#optimization-and-schedules" title="Permalink to this headline">¶</a></h1>
<p>Most optimization of builds and tests is handled with <code class="docutils literal notranslate"><span class="pre">SCHEDULES</span></code>.
The concept is this: we allocate tasks into named components, and associate a set of such components to each file in the source tree.
Given a set of files changed in a push, we then calculate the union of components affected by each file, and remove tasks that are not tagged with any of them.</p>
<p>This optimization system is intended to be <em>conservative</em>.
It represents what could <em>possibly</em> be affected, rather than any intuitive notion of what tasks would be useful to run for changes to a particular file.
For example:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dom/url/URL.cpp</span></code> schedules tasks on all platform and could potentially cause failures in any test suite</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dom/system/mac/CoreLocationLocationProvider.mm</span></code> could not possibly affect any platform but <code class="docutils literal notranslate"><span class="pre">macosx</span></code>, but potentially any test suite</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">python/mozbuild/mozbuild/preprocessor.py</span></code> could possibly affect any platform, and should also schedule Python lint tasks</p></li>
</ul>
<div class="section" id="exclusive-and-inclusive">
<h2>Exclusive and Inclusive<a class="headerlink" href="#exclusive-and-inclusive" title="Permalink to this headline">¶</a></h2>
<p>The first wrinkle in this “simple” plan is that there are a lot of files, and for the most part they all affect most components.
But there are some components which are only affected by a well-defined set of files.
For example, a Python lint component need only be scheduled when Python files are changed.</p>
<p>We divide the components into “exclusive” and “inclusive” components.
Absent any other configuration, any file in the repository is assumed to affect all of the exclusive components and none of the inclusive components.</p>
<p>Exclusive components can be thought of as a series of families.
For example, the platform (linux, windows, macosx, android) is a component family.
The test suite (mochitest, reftest, xpcshell, etc.) is another.
By default, source files are associated with every component in every family.
This means tasks tagged with an exclusive component will <em>always</em> run, unless none of the modified source files are associated with that component.</p>
<p>But what if we only want to run a particular task when a pre-determined file is modified?
This is where inclusive components are used.
Any task tagged with an inclusive component will <em>only</em> be run when a source file associated with that component is modified.
Lint tasks and well separated unittest tasks are good examples of things you might want to schedule inclusively.</p>
<p>A good way to keep this straight is to think of exclusive platform-family components (<code class="docutils literal notranslate"><span class="pre">macosx</span></code>, <code class="docutils literal notranslate"><span class="pre">android</span></code>, <code class="docutils literal notranslate"><span class="pre">windows</span></code>, <code class="docutils literal notranslate"><span class="pre">linux</span></code>) and inclusive linting components (<code class="docutils literal notranslate"><span class="pre">py-lint</span></code>, <code class="docutils literal notranslate"><span class="pre">js-lint</span></code>).
An arbitrary file in the repository affects all platform families, but does not necessarily require a lint run.
But we can configure mac-only files such as <code class="docutils literal notranslate"><span class="pre">CoreLocationLocationProvider.mm</span></code> to affect exclusively <code class="docutils literal notranslate"><span class="pre">macosx</span></code>, and Python files like <code class="docutils literal notranslate"><span class="pre">preprocessor.py</span></code> to affect <code class="docutils literal notranslate"><span class="pre">py-lint</span></code> in addition to the exclusive components.</p>
<p>It is also possible to define a file as affecting an inclusive component and nothing else.
For example, the source code and configuration for the Python linting tasks does not affect any tasks other than linting.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Most unit test suite tasks are allocated to components for their platform family and for the test suite.
This indicates that if a platform family is affected (for example, <code class="docutils literal notranslate"><span class="pre">android</span></code>) then the builds for that platform should execute as well as the full test suite.
If only a single suite is affected (for example, by a change to a reftest source file), then the reftests should execute for all platforms.</p>
<p>However, some test suites, for which the set of contributing files are well-defined, are represented as inclusive components.
These components will not be executed by default for any platform families, but only when one or more of the contributing files are changed.</p>
</div>
</div>
<div class="section" id="specification">
<h2>Specification<a class="headerlink" href="#specification" title="Permalink to this headline">¶</a></h2>
<p>Components are defined as either inclusive or exclusive in <a class="reference internal" href="../python/mozbuild.html#module-mozbuild.schedules" title="mozbuild.schedules"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mozbuild.schedules</span></code></a>.</p>
<div class="section" id="file-annotation">
<h3>File Annotation<a class="headerlink" href="#file-annotation" title="Permalink to this headline">¶</a></h3>
<p>Files are annotated with their affected components in <code class="docutils literal notranslate"><span class="pre">moz.build</span></code> files with stanzas like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Files</span><span class="p">(</span><span class="s1">&#39;**/*.py&#39;</span><span class="p">):</span>
    <span class="n">SCHEDULES</span><span class="o">.</span><span class="n">inclusive</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;py-lint&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>for inclusive components and</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Files</span><span class="p">(</span><span class="s1">&#39;*gradle*&#39;</span><span class="p">):</span>
    <span class="n">SCHEDULES</span><span class="o">.</span><span class="n">exclusive</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;android&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>for exclusive components.
Note the use of <code class="docutils literal notranslate"><span class="pre">+=</span></code> for inclusive compoenents (as this is adding to the existing set of affected components) but <code class="docutils literal notranslate"><span class="pre">=</span></code> for exclusive components (as this is resetting the affected set to something smaller).
For cases where an inclusive component is affected exclusively (such as the python-lint configuration in the example above), that component can be assigned to <code class="docutils literal notranslate"><span class="pre">SCHEDULES.exclusive</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Files</span><span class="p">(</span><span class="s1">&#39;**/pep8rc&#39;</span><span class="p">):</span>
    <span class="n">SCHEDULES</span><span class="o">.</span><span class="n">exclusive</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;py-lint&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>If multiple stanzas set <code class="docutils literal notranslate"><span class="pre">SCHEDULES.exclusive</span></code>, the last one will take precedence.  Thus the following
will set <code class="docutils literal notranslate"><span class="pre">SCHEDULES.exclusive</span></code> to <code class="docutils literal notranslate"><span class="pre">hpux</span></code> for all files except those under <code class="docutils literal notranslate"><span class="pre">docs/</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Files</span><span class="p">(</span><span class="s1">&#39;**&#39;</span><span class="p">):</span>
    <span class="n">SCHEDULES</span><span class="o">.</span><span class="n">exclusive</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hpux&#39;</span><span class="p">]</span>

<span class="k">with</span> <span class="n">Files</span><span class="p">(</span><span class="s1">&#39;**/docs&#39;</span><span class="p">):</span>
    <span class="n">SCHEDULES</span><span class="o">.</span><span class="n">exclusive</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;docs&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="task-annotation">
<h3>Task Annotation<a class="headerlink" href="#task-annotation" title="Permalink to this headline">¶</a></h3>
<p>Tasks are annotated with the components they belong to using the <code class="docutils literal notranslate"><span class="pre">&quot;skip-unless-schedules&quot;</span></code> optimization, which takes a list of components for this task:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;optimization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;skip-unless-schedules&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;windows&#39;</span><span class="p">,</span> <span class="s1">&#39;gtest&#39;</span><span class="p">]}</span>
</pre></div>
</div>
<p>For tests, this value is set automatically by the test transform based on the suite name and the platform family, doing the correct thing for inclusive test suites.
Tests can also use a variety of other optimizers, such as <code class="docutils literal notranslate"><span class="pre">relevant_tests</span></code>, <code class="docutils literal notranslate"><span class="pre">bugbug</span></code> (uses machine learning) or <code class="docutils literal notranslate"><span class="pre">backstop</span></code> (ensures regressions aren’t missed).</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="docker-images.html" class="btn btn-neutral float-right" title="Docker Images" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="optimization-process.html" class="btn btn-neutral float-left" title="Optimization Process" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>