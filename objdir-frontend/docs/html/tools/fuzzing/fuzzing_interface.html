

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Fuzzing Interface &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Sanitizer" href="../sanitizer/index.html" />
    <link rel="prev" title="Fuzzing" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Fuzzing</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Fuzzing Interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-can-be-tested">What can be tested?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reproducing-bugs-for-existing-fuzzing-targets">Reproducing bugs for existing fuzzing targets</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#using-existing-builds">Using existing builds</a></li>
<li class="toctree-l4"><a class="reference internal" href="#local-build-requirements-and-flags">Local build requirements and flags</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#developing-new-fuzzing-targets">Developing new fuzzing targets</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#determine-if-the-fuzzing-interface-is-the-right-tool">Determine if the fuzzing interface is the right tool</a></li>
<li class="toctree-l4"><a class="reference internal" href="#develop-the-fuzzing-code">Develop the fuzzing code</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-instrumentation-to-the-code-being-tested">Add instrumentation to the code being tested</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-your-code">Build your code</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-your-code-and-building-a-corpus">Running your code and building a corpus</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#js-engine-specifics">JS Engine Specifics</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#implementing-in-c">Implementing in C++</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementing-in-js">Implementing in JS</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#troubleshooting">Troubleshooting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#fuzzing-interface-error-no-testing-callback-found">Fuzzing Interface: Error: No testing callback found</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mach-build-doesn-t-seem-to-update-my-fuzzing-code"><code class="docutils literal notranslate"><span class="pre">mach</span> <span class="pre">build</span></code> doesn’t seem to update my fuzzing code</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#what-is-fuzzing">What is Fuzzing?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#why-fuzzing-helps-you">Why Fuzzing Helps You</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#levels-of-fuzzing-in-firefox-gecko">Levels of Fuzzing in Firefox/Gecko</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#code-process-requirements-for-fuzzing">Code/Process Requirements for Fuzzing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Fuzzing</a> &raquo;</li>
        
      <li>Fuzzing Interface</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/tools/fuzzing/fuzzing_interface.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="fuzzing-interface">
<h1>Fuzzing Interface<a class="headerlink" href="#fuzzing-interface" title="Permalink to this headline">¶</a></h1>
<p>The fuzzing interface is glue code living in mozilla-central in order to
make it easier for developers and security researchers to test C/C++
code with either <a class="reference external" href="https://llvm.org/docs/LibFuzzer.html">libFuzzer</a> or
<a class="reference external" href="http://lcamtuf.coredump.cx/afl/">afl-fuzz</a>.</p>
<p>These fuzzing tools, are based on <em>compile-time instrumentation</em> to measure
things like branch coverage and more advanced heuristics per fuzzing test.
Doing so allows these tools to progress through code with little to no custom
logic/knowledge implemented in the fuzzer itself. Usually, the only thing
these tools need is a code “shim” that provides the entry point for the fuzzer
to the code to be tested. We call this additional code a <em>fuzzing target</em> and
the rest of this manual describes how to implement and work with these targets.</p>
<p>As for the tools used with these targets, we currently recommend the use of
libFuzzer over afl-fuzz, as the latter is no longer maintained while libFuzzer
is being actively developed. Furthermore, libFuzzer has some advanced
instrumentation features (e.g. value profiling to deal with complicated
comparisons in code), making it overall more effective.</p>
<div class="section" id="what-can-be-tested">
<h2>What can be tested?<a class="headerlink" href="#what-can-be-tested" title="Permalink to this headline">¶</a></h2>
<p>The interface can be used to test all C/C++ code that either ends up in
<code class="docutils literal notranslate"><span class="pre">libxul</span></code> (more precisely, the gtest version of <code class="docutils literal notranslate"><span class="pre">libxul</span></code>) <strong>or</strong> is
part of the JS engine.</p>
<p>Note that this is not the right testing approach for testing the full
browser as a whole. It is rather meant for component-based testing
(especially as some components cannot be easily separated out of the
full build).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Note:</strong> If you are working on the JS engine (trying to reproduce a
bug or seeking to develop a new fuzzing target), then please also read
the <span class="xref std std-ref">JS Engine Specifics Section</span> at the end
of this documentation, as the JS engine offers additional options for
implementing and running fuzzing targets.</p>
</div>
</div>
<div class="section" id="reproducing-bugs-for-existing-fuzzing-targets">
<h2>Reproducing bugs for existing fuzzing targets<a class="headerlink" href="#reproducing-bugs-for-existing-fuzzing-targets" title="Permalink to this headline">¶</a></h2>
<p>If you are working on a bug that involves an existing fuzzing interface target,
you have two options for reproducing the issue:</p>
<div class="section" id="using-existing-builds">
<h3>Using existing builds<a class="headerlink" href="#using-existing-builds" title="Permalink to this headline">¶</a></h3>
<p>We have several fuzzing builds in CI that you can simply download. We recommend
using <code class="docutils literal notranslate"><span class="pre">fuzzfetch</span></code> for this purpose, as it makes downloading and unpacking
these builds much easier.</p>
<p>You can install <code class="docutils literal notranslate"><span class="pre">fuzzfetch</span></code> from
<a class="reference external" href="https://github.com/MozillaSecurity/fuzzfetch">Github</a> or
<a class="reference external" href="https://pypi.org/project/fuzzfetch/">via pip</a>.</p>
<p>Afterwards, you can run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python -m fuzzfetch -a --fuzzing --gtest -n firefox-fuzzing
</pre></div>
</div>
<p>to fetch the latest optimized build. Alternatively, we offer non-ASan debug builds
which you can download using</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python -m fuzzfetch -d --fuzzing --gtest -n firefox-fuzzing
</pre></div>
</div>
<p>In both commands, <code class="docutils literal notranslate"><span class="pre">firefox-fuzzing</span></code> indicates the name of the directory that
will be created for the download.</p>
<p>Afterwards, you can reproduce the bug using</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ FUZZER=TargetName firefox-fuzzing/firefox test.bin
</pre></div>
</div>
<p>assuming that <code class="docutils literal notranslate"><span class="pre">TargetName</span></code> is the name of the fuzzing target specified in the
bug you are working on and <code class="docutils literal notranslate"><span class="pre">test.bin</span></code> is the attached testcase.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Note:</strong> You should not export the <code class="docutils literal notranslate"><span class="pre">FUZZER</span></code> variable permanently
in your shell, especially if you plan to do local builds. If the <code class="docutils literal notranslate"><span class="pre">FUZZER</span></code>
variable is exported, it will affect the build process.</p>
</div>
<p>If the CI builds don’t meet your requirements and you need a local build instead,
you can follow the steps below to create one:</p>
</div>
<div class="section" id="local-build-requirements-and-flags">
<h3>Local build requirements and flags<a class="headerlink" href="#local-build-requirements-and-flags" title="Permalink to this headline">¶</a></h3>
<p>You will need a Linux environment with a recent Clang. Using the Clang downloaded
by <code class="docutils literal notranslate"><span class="pre">./mach</span> <span class="pre">bootstrap</span></code> or a newer version is recommended.</p>
<p>The only build flag required to enable the fuzzing targets is <code class="docutils literal notranslate"><span class="pre">--enable-fuzzing</span></code>,
so adding</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ac_add_options</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">fuzzing</span>
</pre></div>
</div>
<p>to your <code class="docutils literal notranslate"><span class="pre">.mozconfig</span></code> is already sufficient for producing a fuzzing build.
However, for improved crash handling capabilities and to detect additional errors,
it is strongly recommended to combine libFuzzer with <a class="reference internal" href="../sanitizer/asan.html#address-sanitizer"><span class="std std-ref">AddressSanitizer</span></a>
by adding</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ac_add_options</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">address</span><span class="o">-</span><span class="n">sanitizer</span>
</pre></div>
</div>
<p>at least for optimized builds and bugs requiring ASan to reproduce at all
(e.g. you are working on a bug where ASan reports a memory safety violation
of some sort).</p>
<p>Once your build is complete, you <strong>must</strong> additionally run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ./mach gtest dontruntests
</pre></div>
</div>
<p>to force the gtest libxul to be built.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Note:</strong> If you modify any code, please ensure that you run <strong>both</strong> build
commands to ensure that the gtest libxul is also rebuilt. It is a common mistake
to only run <code class="docutils literal notranslate"><span class="pre">./mach</span> <span class="pre">build</span></code> and miss the second command.</p>
</div>
<p>Once these steps are complete, you can reproduce the bug locally using the same
steps as described above for the downloaded builds.</p>
</div>
</div>
<div class="section" id="developing-new-fuzzing-targets">
<h2>Developing new fuzzing targets<a class="headerlink" href="#developing-new-fuzzing-targets" title="Permalink to this headline">¶</a></h2>
<p>Developing a new fuzzing target using the fuzzing interface only requires a few steps.</p>
<div class="section" id="determine-if-the-fuzzing-interface-is-the-right-tool">
<h3>Determine if the fuzzing interface is the right tool<a class="headerlink" href="#determine-if-the-fuzzing-interface-is-the-right-tool" title="Permalink to this headline">¶</a></h3>
<p>The fuzzing interface is not suitable for every kind of testing. In particular
if your testing requires the full browser to be running, then you might want to
look into other testing methods.</p>
<p>The interface uses the <code class="docutils literal notranslate"><span class="pre">ScopedXPCOM</span></code> implementation to provide an environment
in which XPCOM is available and initialized. You can initialize further subsystems
that you might require, but you are responsible yourself for any kind of
initialization steps.</p>
<p>There is (in theory) no limit as to how far you can take browser initialization.
However, the more subsystems are involved, the more problems might occur due to
non-determinism and loss of performance.</p>
<p>If you are unsure if the fuzzing interface is the right approach for you or you
require help in evaluating what could be done for your particular task, please
don’t hestitate to <span class="xref std std-ref">contact us</span>.</p>
</div>
<div class="section" id="develop-the-fuzzing-code">
<h3>Develop the fuzzing code<a class="headerlink" href="#develop-the-fuzzing-code" title="Permalink to this headline">¶</a></h3>
<div class="section" id="where-to-put-your-fuzzing-code">
<h4>Where to put your fuzzing code<a class="headerlink" href="#where-to-put-your-fuzzing-code" title="Permalink to this headline">¶</a></h4>
<p>The code using the fuzzing interface usually lives in a separate directory
called <code class="docutils literal notranslate"><span class="pre">fuzztest</span></code> that is on the same level as gtests. If your component
has no gtests, then a subdirectory either in tests or in your main directory
will work. If such a directory does not exist yet in your component, then you
need to create one with a suitable <code class="docutils literal notranslate"><span class="pre">moz.build</span></code>. See  <a class="reference external" href="https://searchfox.org/mozilla-central/source/dom/media/webrtc/transport/fuzztest/moz.build">the transport target
for an example</a></p>
<p>In order to include the new subdirectory into the build process, you will
also have to modify the toplevel <code class="docutils literal notranslate"><span class="pre">moz.build</span></code> file accordingly. For this
purpose, you should add your directory to <code class="docutils literal notranslate"><span class="pre">TEST_DIRS</span></code> only if <code class="docutils literal notranslate"><span class="pre">FUZZING_INTERFACES</span></code>
is set. See again <a class="reference external" href="https://searchfox.org/mozilla-central/rev/de7676288a78b70d2b9927c79493adbf294faad5/media/mtransport/moz.build#18-24">the transport target for an example</a>.</p>
</div>
<div class="section" id="how-your-code-should-look-like">
<h4>How your code should look like<a class="headerlink" href="#how-your-code-should-look-like" title="Permalink to this headline">¶</a></h4>
<p>In order to define your fuzzing target <code class="docutils literal notranslate"><span class="pre">MyTarget</span></code>, you only need to implement 2 functions:</p>
<ol class="arabic">
<li><p>A one-time initialization function.</p>
<p>At startup, the fuzzing interface calls this function <strong>once</strong>, so this can
be used to perform one-time operations like initializing subsystems or parsing
extra fuzzing options.</p>
<p>This function is the equivalent of the <a class="reference external" href="https://llvm.org/docs/LibFuzzer.html#startup-initialization">LLVMFuzzerInitialize</a>
function and has the same signature. However, with our fuzzing interface,
it won’t be resolved by its name, so it can be defined <code class="docutils literal notranslate"><span class="pre">static</span></code> and called
whatever you prefer. Note that the function should always <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">0</span></code> and
can (except for the return), remain empty.</p>
<p>For the sake of this documentation, we assume that you have <code class="docutils literal notranslate"><span class="pre">static</span> <span class="pre">int</span> <span class="pre">FuzzingInitMyTarget(int*</span> <span class="pre">argc,</span> <span class="pre">char***</span> <span class="pre">argv);</span></code></p>
</li>
<li><p>The fuzzing iteration function.</p>
<p>This is where the actual fuzzing happens, and this function is the equivalent
of <a class="reference external" href="https://llvm.org/docs/LibFuzzer.html#fuzz-target">LLVMFuzzerTestOneInput</a>.
Again, the difference to the fuzzing interface is that the function won’t be
resolved by its name. In addition, we offer two different possible signatures
for this function, either</p>
<p><code class="docutils literal notranslate"><span class="pre">static</span> <span class="pre">int</span> <span class="pre">FuzzingRunMyTarget(const</span> <span class="pre">uint8_t*</span> <span class="pre">data,</span> <span class="pre">size_t</span> <span class="pre">size);</span></code></p>
<p>or</p>
<p><code class="docutils literal notranslate"><span class="pre">static</span> <span class="pre">int</span> <span class="pre">FuzzingRunMyTarget(nsCOMPtr&lt;nsIInputStream&gt;</span> <span class="pre">inputStream);</span></code></p>
<p>The latter is just a wrapper around the first one for implementations that
usually work with streams. No matter which of the two signatures you choose
to work with, the only thing you need to implement inside the function
is the use of the provided data with your target implementation. This can
mean to simply feed the data to your target, using the data to drive operations
on the target API, or a mix of both.</p>
<p>While doing so, you should avoid altering global state in a permanent way,
using additional sources of data/randomness or having code run beyond the
lifetime of the iteration function (e.g. on another thread), for one simple
reason: Coverage-guided fuzzing tools depend on the <strong>deterministic</strong> nature
of the iteration function. If the same input to this function does not lead
to the same execution when run twice (e.g. because the resulting state depends
on multiple successive calls or because of additional external influences),
then the tool will not be able to reproduce its fuzzing progress and perform
badly. Dealing with this restriction can be challenging e.g. when dealing
with asynchronous targets that run multi-threaded, but can usually be managed
by synchronizing execution on all threads at the end of the iteration function.
For implementations accumulating global state, it might be necessary to
(re)initialize this global state in each iteration, rather than doing it once
in the initialization function, even if this costs additional performance.</p>
<p>Note that unlike the vanilla libFuzzer approach, you are allowed to <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">1</span></code>
in this function to indicate that an input is “bad”. Doing so will cause
libFuzzer to discard the input, no matter if it generated new coverage or not.
This is particularly useful if you have means to internally detect and catch
bad testcase behavior such as timeouts/excessive resource usage etc. to avoid
these tests to end up in your corpus.</p>
</li>
</ol>
<p>Once you have implemented the two functions, the only thing remaining is to
register them with the fuzzing interface. For this purpose, we offer two
macros, depending on which iteration function signature you used. If you
sticked to the classic signature using buffer and size, you can simply use</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;FuzzingInterface.h&quot;</span>

<span class="o">//</span> <span class="n">Your</span> <span class="n">includes</span> <span class="ow">and</span> <span class="n">code</span>

<span class="n">MOZ_FUZZING_INTERFACE_RAW</span><span class="p">(</span><span class="n">FuzzingInitMyTarget</span><span class="p">,</span> <span class="n">FuzzingRunMyTarget</span><span class="p">,</span> <span class="n">MyTarget</span><span class="p">);</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">MyTarget</span></code> is the name of the target and will be used later to decide
at runtime which target should be used.</p>
<p>If instead you went for the streaming interface, you need a different include,
but the macro invocation is quite similar:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;FuzzingInterfaceStream.h&quot;</span>

<span class="o">//</span> <span class="n">Your</span> <span class="n">includes</span> <span class="ow">and</span> <span class="n">code</span>

<span class="n">MOZ_FUZZING_INTERFACE_STREAM</span><span class="p">(</span><span class="n">FuzzingInitMyTarget</span><span class="p">,</span> <span class="n">FuzzingRunMyTarget</span><span class="p">,</span> <span class="n">MyTarget</span><span class="p">);</span>
</pre></div>
</div>
<p>For a live example, see also the <a class="reference external" href="https://searchfox.org/mozilla-central/source/dom/media/webrtc/transport/fuzztest/stun_parser_libfuzz.cpp">implementation of the STUN fuzzing target</a>.</p>
</div>
</div>
<div class="section" id="add-instrumentation-to-the-code-being-tested">
<h3>Add instrumentation to the code being tested<a class="headerlink" href="#add-instrumentation-to-the-code-being-tested" title="Permalink to this headline">¶</a></h3>
<p>libFuzzer requires that the code you are trying to test is instrumented
with special compiler flags. Fortunately, adding these on a per-directory basis
can be done just by including the following directive in each <code class="docutils literal notranslate"><span class="pre">moz.build</span></code>
file that builds code under test:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add libFuzzer configuration directives</span>
<span class="n">include</span><span class="p">(</span><span class="s1">&#39;/tools/fuzzing/libfuzzer-config.mozbuild&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The include already does the appropriate configuration checks to be only
active in fuzzing builds, so you don’t have to guard this in any way.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Note:</strong> This include modifies <cite>CFLAGS</cite> and <cite>CXXFLAGS</cite> accordingly
but this only works for source files defined in this particular
directory. The flags are <strong>not</strong> propagated to subdirectories automatically
and you have to ensure that each directory that builds source files
for your target has the include added to its <code class="docutils literal notranslate"><span class="pre">moz.build</span></code> file.</p>
</div>
<p>By keeping the instrumentation limited to the parts that are actually being
tested using this tool, you not only increase the performance but also potentially
reduce the amount of noise that libFuzzer sees.</p>
</div>
<div class="section" id="build-your-code">
<h3>Build your code<a class="headerlink" href="#build-your-code" title="Permalink to this headline">¶</a></h3>
<p>See the <span class="xref std std-ref">Build instructions above</span> for instructions
how to modify your <code class="docutils literal notranslate"><span class="pre">.mozconfig</span></code> to create the appropriate build.</p>
</div>
<div class="section" id="running-your-code-and-building-a-corpus">
<h3>Running your code and building a corpus<a class="headerlink" href="#running-your-code-and-building-a-corpus" title="Permalink to this headline">¶</a></h3>
<p>You need to set the following environment variable to enable running the
fuzzing code inside Firefox instead of the regular browser.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">FUZZER=name</span></code></p></li>
</ul>
<p>Where <code class="docutils literal notranslate"><span class="pre">name</span></code> is the name of your fuzzing module that you specified
when calling the <code class="docutils literal notranslate"><span class="pre">MOZ_FUZZING_INTERFACE_RAW</span></code> macro. For the example
above, this would be <code class="docutils literal notranslate"><span class="pre">MyTarget</span></code> or <code class="docutils literal notranslate"><span class="pre">StunParser</span></code> for the live example.</p>
<p>Now when you invoke the firefox binary in your build directory with the
<code class="docutils literal notranslate"><span class="pre">-help=1</span></code> parameter, you should see the regular libFuzzer help. On
Linux for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ FUZZER=StunParser obj-asan/dist/bin/firefox -help=1
</pre></div>
</div>
<p>You should see an output similar to this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Running</span> <span class="n">Fuzzer</span> <span class="n">tests</span><span class="o">...</span>
<span class="n">Usage</span><span class="p">:</span>

<span class="n">To</span> <span class="n">run</span> <span class="n">fuzzing</span> <span class="k">pass</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">directories</span><span class="o">.</span>
<span class="n">obj</span><span class="o">-</span><span class="n">asan</span><span class="o">/</span><span class="n">dist</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">firefox</span> <span class="p">[</span><span class="o">-</span><span class="n">flag1</span><span class="o">=</span><span class="n">val1</span> <span class="p">[</span><span class="o">-</span><span class="n">flag2</span><span class="o">=</span><span class="n">val2</span> <span class="o">...</span><span class="p">]</span> <span class="p">]</span> <span class="p">[</span><span class="n">dir1</span> <span class="p">[</span><span class="n">dir2</span> <span class="o">...</span><span class="p">]</span> <span class="p">]</span>

<span class="n">To</span> <span class="n">run</span> <span class="n">individual</span> <span class="n">tests</span> <span class="n">without</span> <span class="n">fuzzing</span> <span class="k">pass</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">files</span><span class="p">:</span>
<span class="n">obj</span><span class="o">-</span><span class="n">asan</span><span class="o">/</span><span class="n">dist</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">firefox</span> <span class="p">[</span><span class="o">-</span><span class="n">flag1</span><span class="o">=</span><span class="n">val1</span> <span class="p">[</span><span class="o">-</span><span class="n">flag2</span><span class="o">=</span><span class="n">val2</span> <span class="o">...</span><span class="p">]</span> <span class="p">]</span> <span class="n">file1</span> <span class="p">[</span><span class="n">file2</span> <span class="o">...</span><span class="p">]</span>

<span class="n">Flags</span><span class="p">:</span> <span class="p">(</span><span class="n">strictly</span> <span class="ow">in</span> <span class="n">form</span> <span class="o">-</span><span class="n">flag</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
 <span class="n">verbosity</span>                      <span class="mi">1</span>       <span class="n">Verbosity</span> <span class="n">level</span><span class="o">.</span>
 <span class="n">seed</span>                           <span class="mi">0</span>       <span class="n">Random</span> <span class="n">seed</span><span class="o">.</span> <span class="n">If</span> <span class="mi">0</span><span class="p">,</span> <span class="n">seed</span> <span class="ow">is</span> <span class="n">generated</span><span class="o">.</span>
 <span class="n">runs</span>                           <span class="o">-</span><span class="mi">1</span>      <span class="n">Number</span> <span class="n">of</span> <span class="n">individual</span> <span class="n">test</span> <span class="n">runs</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">infinite</span> <span class="n">runs</span><span class="p">)</span><span class="o">.</span>
 <span class="n">max_len</span>                        <span class="mi">0</span>       <span class="n">Maximum</span> <span class="n">length</span> <span class="n">of</span> <span class="n">the</span> <span class="n">test</span> <span class="nb">input</span><span class="o">.</span> <span class="n">If</span> <span class="mi">0</span><span class="p">,</span> <span class="n">libFuzzer</span> <span class="n">tries</span> <span class="n">to</span> <span class="n">guess</span> <span class="n">a</span> <span class="n">good</span> <span class="n">value</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">corpus</span> <span class="ow">and</span> <span class="n">reports</span> <span class="n">it</span><span class="o">.</span>
<span class="o">...</span>
</pre></div>
</div>
<div class="section" id="reproducing-a-crash">
<h4>Reproducing a Crash<a class="headerlink" href="#reproducing-a-crash" title="Permalink to this headline">¶</a></h4>
<p>In order to reproduce a crash from a given test file, simply put the
file as the only argument on the command line, e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ FUZZER=StunParser obj-asan/dist/bin/firefox test.bin
</pre></div>
</div>
<p>This should reproduce the given problem.</p>
</div>
<div class="section" id="fuzzmanager-and-libfuzzer">
<h4>FuzzManager and libFuzzer<a class="headerlink" href="#fuzzmanager-and-libfuzzer" title="Permalink to this headline">¶</a></h4>
<p>Our FuzzManager project comes with a harness for running libFuzzer with
an optional connection to a FuzzManager server instance. Note that this
connection is not mandatory, even without a server you can make use of
the local harness.</p>
<p>You can find the harness
<a class="reference external" href="https://github.com/MozillaSecurity/FuzzManager/tree/master/misc/afl-libfuzzer">here</a>.</p>
<p>An example invocation for the harness to use with StunParser could look
like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUZZER</span><span class="o">=</span><span class="n">StunParser</span> <span class="n">python</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">afl</span><span class="o">-</span><span class="n">libfuzzer</span><span class="o">-</span><span class="n">daemon</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">fuzzmanager</span> \
    <span class="o">--</span><span class="n">stats</span> <span class="n">libfuzzer</span><span class="o">-</span><span class="n">stunparser</span><span class="o">.</span><span class="n">stats</span> <span class="o">--</span><span class="n">libfuzzer</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="n">reduce</span><span class="o">-</span><span class="nb">min</span> <span class="mi">500</span> <span class="o">--</span><span class="n">libfuzzer</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="n">reduce</span> <span class="mi">30</span> \
    <span class="o">--</span><span class="n">tool</span> <span class="n">libfuzzer</span><span class="o">-</span><span class="n">stunparser</span> <span class="o">--</span><span class="n">libfuzzer</span> <span class="o">--</span><span class="n">libfuzzer</span><span class="o">-</span><span class="n">instances</span> <span class="mi">6</span> <span class="n">obj</span><span class="o">-</span><span class="n">asan</span><span class="o">/</span><span class="n">dist</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">firefox</span> \
    <span class="o">-</span><span class="n">max_len</span><span class="o">=</span><span class="mi">256</span> <span class="o">-</span><span class="n">use_value_profile</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span><span class="n">rss_limit_mb</span><span class="o">=</span><span class="mi">3000</span> <span class="n">corpus</span><span class="o">-</span><span class="n">stunparser</span>
</pre></div>
</div>
<p>What this does is</p>
<ul class="simple">
<li><p>run libFuzzer on the <code class="docutils literal notranslate"><span class="pre">StunParser</span></code> target with 6 parallel instances
using the corpus in the <code class="docutils literal notranslate"><span class="pre">corpus-stunparser</span></code> directory (with the
specified libFuzzer options such as <code class="docutils literal notranslate"><span class="pre">-max_len</span></code> and
<code class="docutils literal notranslate"><span class="pre">-use_value_profile</span></code>)</p></li>
<li><p>automatically reduce the corpus and restart if it grew by 30% (and
has at least 500 files)</p></li>
<li><p>use FuzzManager (need a local <code class="docutils literal notranslate"><span class="pre">.fuzzmanagerconf</span></code> and a
<code class="docutils literal notranslate"><span class="pre">firefox.fuzzmanagerconf</span></code> binary configuration as described in the
FuzzManager manual) and submit crashes as <code class="docutils literal notranslate"><span class="pre">libfuzzer-stunparser</span></code>
tool</p></li>
<li><p>write statistics to the <code class="docutils literal notranslate"><span class="pre">libfuzzer-stunparser.stats</span></code> file</p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="js-engine-specifics">
<h2>JS Engine Specifics<a class="headerlink" href="#js-engine-specifics" title="Permalink to this headline">¶</a></h2>
<p>The fuzzing interface can also be used for testing the JS engine, in fact there
are two separate options to implement and run fuzzing targets:</p>
<div class="section" id="implementing-in-c">
<h3>Implementing in C++<a class="headerlink" href="#implementing-in-c" title="Permalink to this headline">¶</a></h3>
<p>Similar to the fuzzing interface in Firefox, you can implement your target in
entirely C++ with very similar interfaces compared to what was described before.</p>
<p>There are a few minor differences though:</p>
<ol class="arabic">
<li><p>All of the fuzzing targets live in <cite>js/src/fuzz-tests</cite>.</p></li>
<li><p>All of the code is linked into a separate binary called <cite>fuzz-tests</cite>,
similar to how all JSAPI tests end up in <cite>jsapi-tests</cite>. In order for this
binary to be built, you must build a JS shell with <code class="docutils literal notranslate"><span class="pre">--enable-fuzzing</span></code>
<strong>and</strong> <code class="docutils literal notranslate"><span class="pre">--enable-tests</span></code>. Again, this can and should be combined with
AddressSanitizer for maximum effectiveness. This also means that there is no
need to (re)build gtests when dealing with a JS fuzzing target and using
a shell as part of a full browser build.</p></li>
<li><p>The harness around the JS implementation already provides you with an
initialized <code class="docutils literal notranslate"><span class="pre">JSContext</span></code> and global object. You can access these in
your target by declaring</p>
<p><code class="docutils literal notranslate"><span class="pre">extern</span> <span class="pre">JS::PersistentRootedObject</span> <span class="pre">gGlobal;</span></code></p>
<p>and</p>
<p><code class="docutils literal notranslate"><span class="pre">extern</span> <span class="pre">JSContext*</span> <span class="pre">gCx;</span></code></p>
<p>but there is no obligation for you to use these.</p>
</li>
</ol>
<p>For a live example, see also the <a class="reference external" href="https://searchfox.org/mozilla-central/source/js/src/fuzz-tests/testStructuredCloneReader.cpp">implementation of the StructuredCloneReader target</a>.</p>
</div>
<div class="section" id="implementing-in-js">
<h3>Implementing in JS<a class="headerlink" href="#implementing-in-js" title="Permalink to this headline">¶</a></h3>
<p>In addition to the C++ targets, you can also implement targets in JavaScript
using the JavaScript Runtime (JSRT) fuzzing approach. Using this approach is
not only much simpler (since you don’t need to know anything about the
JSAPI or engine internals), but it also gives you full access to everything
defined in the JS shell, including handy functions such as <code class="docutils literal notranslate"><span class="pre">timeout()</span></code>.</p>
<p>Of course, this approach also comes with disadvantages: Calling into JS and
performing the fuzzing operations there costs performance. Also, there is more
chance for causing global side-effects or non-determinism compared to a
fairly isolated C++ target.</p>
<p>As a rule of thumb, you should implement the target in JS if</p>
<ul class="simple">
<li><p>you don’t know C++ and/or how to use the JSAPI (after all, a JS fuzzing target is better than none),</p></li>
<li><p>your target is expected to have lots of hangs/timeouts (you can catch these internally),</p></li>
<li><p>or your target is not isolated enough for a C++ target and/or you need specific JS shell functions.</p></li>
</ul>
<p>There is an <a class="reference external" href="https://searchfox.org/mozilla-central/source/js/src/shell/jsrtfuzzing/jsrtfuzzing-example.js">example target</a>
in-tree that shows roughly how to implement such a fuzzing target.</p>
<p>To run such a target, you must run the <code class="docutils literal notranslate"><span class="pre">js</span></code> (shell) binary instead of the
<code class="docutils literal notranslate"><span class="pre">fuzz-tests</span></code> binary and point the <code class="docutils literal notranslate"><span class="pre">FUZZER</span></code> variable to the file containing
your fuzzing target, e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ FUZZER=/path/to/jsrtfuzzing-example.js obj-asan/dist/bin/js --fuzzing-safe --no-threads -- &lt;libFuzzer options here&gt;
</pre></div>
</div>
<p>More elaborate targets can be found in <a class="reference external" href="https://searchfox.org/mozilla-central/source/js/src/fuzz-tests/">js/src/fuzz-tests/</a>.</p>
</div>
</div>
<div class="section" id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<div class="section" id="fuzzing-interface-error-no-testing-callback-found">
<h3>Fuzzing Interface: Error: No testing callback found<a class="headerlink" href="#fuzzing-interface-error-no-testing-callback-found" title="Permalink to this headline">¶</a></h3>
<p>This error means that the fuzzing callback with the name you specified
using the <code class="docutils literal notranslate"><span class="pre">FUZZER</span></code> environment variable could not be found. Reasons
for are typically either a misspelled name or that your code wasn’t
built (check your <code class="docutils literal notranslate"><span class="pre">moz.build</span></code> file and build log).</p>
</div>
<div class="section" id="mach-build-doesn-t-seem-to-update-my-fuzzing-code">
<h3><code class="docutils literal notranslate"><span class="pre">mach</span> <span class="pre">build</span></code> doesn’t seem to update my fuzzing code<a class="headerlink" href="#mach-build-doesn-t-seem-to-update-my-fuzzing-code" title="Permalink to this headline">¶</a></h3>
<p>Keep in mind you always need to run both the <code class="docutils literal notranslate"><span class="pre">mach</span> <span class="pre">build</span></code> and
<code class="docutils literal notranslate"><span class="pre">mach</span> <span class="pre">gtest</span> <span class="pre">dontruntests</span></code> commands in order to update your fuzzing
code. The latter rebuilds the gtest version of <code class="docutils literal notranslate"><span class="pre">libxul</span></code>, containing
your code.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../sanitizer/index.html" class="btn btn-neutral float-right" title="Sanitizer" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Fuzzing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>