

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Address Sanitizer &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="ASan Nightly" href="asan_nightly.html" />
    <link rel="prev" title="Sanitizer" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Sanitizer</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Address Sanitizer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-is-address-sanitizer">What is Address Sanitizer?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#downloading-artifact-builds">Downloading artifact builds</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-try-builds">Creating Try builds</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-local-builds-on-windows">Creating local builds on Windows</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-local-builds-on-linux-or-mac">Creating local builds on Linux or Mac</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#build-prerequisites">Build prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-firefox">Building Firefox</a></li>
<li class="toctree-l4"><a class="reference internal" href="#getting-symbols-in-address-sanitizer-traces">Getting Symbols in Address Sanitizer Traces</a></li>
<li class="toctree-l4"><a class="reference internal" href="#troubleshooting-known-problems">Troubleshooting / Known problems</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#debugging-issues-that-asan-finds">Debugging issues that ASan finds</a></li>
<li class="toctree-l3"><a class="reference internal" href="#leaksanitizer">LeakSanitizer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#frequently-asked-questions-about-asan">Frequently Asked Questions about ASan</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#how-does-asan-work-exactly">How does ASan work exactly?</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="asan_nightly.html">ASan Nightly</a></li>
<li class="toctree-l2"><a class="reference internal" href="memory_sanitizer.html">Memory Sanitizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="tsan.html">Thread Sanitizer</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Sanitizer</a> &raquo;</li>
        
      <li>Address Sanitizer</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/tools/sanitizer/asan.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="address-sanitizer">
<h1>Address Sanitizer<a class="headerlink" href="#address-sanitizer" title="Permalink to this headline">¶</a></h1>
<div class="section" id="what-is-address-sanitizer">
<h2>What is Address Sanitizer?<a class="headerlink" href="#what-is-address-sanitizer" title="Permalink to this headline">¶</a></h2>
<p>Address Sanitizer (ASan) is a fast memory error detector that detects
use-after-free and out-of-bound bugs in C/C++ programs. It uses a
compile-time instrumentation to check all reads and writes during the
execution. In addition, the runtime part replaces the <code class="docutils literal notranslate"><span class="pre">malloc</span></code> and
<code class="docutils literal notranslate"><span class="pre">free</span></code> functions to check dynamically allocated memory. More
information on how ASan works can be found on <a class="reference external" href="https://github.com/google/sanitizers/wiki/AddressSanitizer">the Address Sanitizer
wiki</a>.</p>
<p>A <a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=asan-maintenance">meta bug called asan-maintenance</a>
is maintained to keep track of all the bugs found with ASan.</p>
</div>
<div class="section" id="downloading-artifact-builds">
<h2>Downloading artifact builds<a class="headerlink" href="#downloading-artifact-builds" title="Permalink to this headline">¶</a></h2>
<p>For Linux and Windows users, the easiest way to get Firefox builds with
Address Sanitizer is to download a continuous integration asan build of
mozilla-central (updated at least daily):</p>
<ul class="simple">
<li><p>mozilla-central optimized builds:
<a class="reference external" href="https://firefox-ci-tc.services.mozilla.com/api/index/v1/task/gecko.v2.mozilla-central.latest.firefox.linux64-asan-opt/artifacts/public/build/target.tar.bz2">linux</a>
|
<a class="reference external" href="https://firefox-ci-tc.services.mozilla.com/api/index/v1/task/gecko.v2.mozilla-central.latest.firefox.win64-asan-opt/artifacts/public/build/target.zip">windows</a>
(recommended for testing)</p></li>
<li><p>mozilla-central debug builds:
<a class="reference external" href="https://firefox-ci-tc.services.mozilla.com/api/index/v1/task/gecko.v2.mozilla-central.latest.firefox.linux64-asan-debug/artifacts/public/build/target.tar.bz2">linux</a>
|
<a class="reference external" href="https://firefox-ci-tc.services.mozilla.com/api/index/v1/task/gecko.v2.mozilla-central.latest.firefox.win64-asan-debug/artifacts/public/build/target.zip">windows</a>
(recommended for debugging if the optimized builds don’t do the job)</p></li>
</ul>
<p>The fuzzing team also offers a tool called <code class="docutils literal notranslate"><span class="pre">fuzzfetch</span></code> to download these and many
other CI builds. It makes downloading and unpacking these builds much easier and
can be used not just for fuzzing but for all purposes that require a CI build download.</p>
<p>You can install <code class="docutils literal notranslate"><span class="pre">fuzzfetch</span></code> from
<a class="reference external" href="https://github.com/MozillaSecurity/fuzzfetch">Github</a> or
<a class="reference external" href="https://pypi.org/project/fuzzfetch/">via pip</a>.</p>
<p>Afterwards, you can run e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python -m fuzzfetch --asan -n firefox-asan
</pre></div>
</div>
<p>to get the optimized Linux ASan build mentioned above unpacked into a directory called <code class="docutils literal notranslate"><span class="pre">firefox-asan</span></code>.
The <code class="docutils literal notranslate"><span class="pre">--debug</span></code> and <code class="docutils literal notranslate"><span class="pre">--os</span></code> switches can be used to get the other variants listed above.</p>
</div>
<div class="section" id="creating-try-builds">
<h2>Creating Try builds<a class="headerlink" href="#creating-try-builds" title="Permalink to this headline">¶</a></h2>
<p>If for some reason you can’t use the pre-built binaries mentioned in the
previous section (e.g. you want a non-Linux build or you need to test a
patch), you can either build Firefox yourself (see the following
section) or use the <a class="reference internal" href="../try/index.html#try-server"><span class="std std-ref">try server</span></a> to
create the customized build for you. Pushing to try requires L1 commit
access. If you don’t have this access yet you can request access (see
<a class="reference external" href="https://www.mozilla.org/about/governance/policies/commit/">Becoming A Mozilla
Committer</a>
and <a class="reference external" href="https://www.mozilla.org/about/governance/policies/commit/access-policy/">Mozilla Commit Access
Policy</a>
for the requirements).</p>
<p>The tree contains <a class="reference external" href="https://searchfox.org/mozilla-central/search?q=&amp;case=true&amp;path=browser%2Fconfig%2Fmozconfigs%2F*%2F*asan*">several mozconfig files for creating asan
builds</a>
(the “nightly-asan” files create release builds, whereas the
“debug-asan” files create debug+opt builds). For Linux builds, the
appropriate configuration file is used by the <code class="docutils literal notranslate"><span class="pre">linux64-asan</span></code> target.
If you want to create a macOS or Windows build, you’ll need to copy the
appropriate configuration file over the regular debug configuration
before pushing to try. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="n">browser</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">mozconfigs</span><span class="o">/</span><span class="n">macosx64</span><span class="o">/</span><span class="n">debug</span><span class="o">-</span><span class="n">asan</span> <span class="n">browser</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">mozconfigs</span><span class="o">/</span><span class="n">macosx64</span><span class="o">/</span><span class="n">debug</span>
</pre></div>
</div>
<p>You can then <a class="reference external" href="/tools/try/index.html#using-try">push to Try in the usual
way</a>
and, once the build is complete, download the appropriate build
artifact.</p>
</div>
<div class="section" id="creating-local-builds-on-windows">
<h2>Creating local builds on Windows<a class="headerlink" href="#creating-local-builds-on-windows" title="Permalink to this headline">¶</a></h2>
<p>On Windows, ASan is supported only in 64-bit builds.</p>
<p>Run <code class="docutils literal notranslate"><span class="pre">mach</span> <span class="pre">bootstrap</span></code> to get an updated clang-cl in your
<code class="docutils literal notranslate"><span class="pre">~/.mozbuild</span></code> directory, then use the following
<a class="reference internal" href="../../setup/configuring_build_options.html#configuring-build-options"><span class="std std-ref">mozconfig</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ac_add_options --target=x86_64-pc-mingw32
ac_add_options --host=x86_64-pc-mingw32

ac_add_options --enable-address-sanitizer
ac_add_options --disable-jemalloc

export CC=&quot;clang-cl.exe&quot;
export CXX=&quot;clang-cl.exe&quot;

export LDFLAGS=&quot;clang_rt.asan_dynamic-x86_64.lib clang_rt.asan_dynamic_runtime_thunk-x86_64.lib&quot;
CLANG_LIB_DIR=&quot;$(cd ~/.mozbuild/clang/lib/clang/*/lib/windows &amp;&amp; pwd)&quot;
export MOZ_CLANG_RT_ASAN_LIB_PATH=&quot;${CLANG_LIB_DIR}/clang_rt.asan_dynamic-x86_64.dll&quot;
export LIB=$LIB:$CLANG_LIB_DIR
</pre></div>
</div>
<p>If you want to use a different LLVM (see the <a class="reference internal" href="../../setup/windows_build.html#building-firefox-on-windows"><span class="std std-ref">clang-cl instructions</span></a>),
alter CLANG_LIB_DIR as appropriate.</p>
<p>If you launch an ASan build under WinDbg, you may see spurious
first-chance Access Violation exceptions. These come from ASan creating
shadow memory pages on demand, and can be ignored. Run <code class="docutils literal notranslate"><span class="pre">sxi</span> <span class="pre">av</span></code> to
ignore these exceptions. (You will still catch second-chance Access
Violation exceptions if you actually crash.)</p>
<p>LeakSanitizer (LSan) is not supported on Windows.</p>
</div>
<div class="section" id="creating-local-builds-on-linux-or-mac">
<h2>Creating local builds on Linux or Mac<a class="headerlink" href="#creating-local-builds-on-linux-or-mac" title="Permalink to this headline">¶</a></h2>
<div class="section" id="build-prerequisites">
<h3>Build prerequisites<a class="headerlink" href="#build-prerequisites" title="Permalink to this headline">¶</a></h3>
<div class="section" id="llvm-clang">
<h4>LLVM/Clang<a class="headerlink" href="#llvm-clang" title="Permalink to this headline">¶</a></h4>
<p>The ASan instrumentation is implemented as an LLVM pass and integrated
into Clang. Any clang version that is capable of compiling Firefox has
everything needed to do an ASAN build.</p>
</div>
</div>
<div class="section" id="building-firefox">
<h3>Building Firefox<a class="headerlink" href="#building-firefox" title="Permalink to this headline">¶</a></h3>
<div class="section" id="getting-the-source">
<h4>Getting the source<a class="headerlink" href="#getting-the-source" title="Permalink to this headline">¶</a></h4>
<p>Using that or any later revision, all you need to do is to <a class="reference internal" href="../../contributing/vcs/mercurial.html#mercurial-overview"><span class="std std-ref">get yourself
a clone of mozilla-central</span></a>.</p>
</div>
<div class="section" id="adjusting-the-build-configuration">
<h4>Adjusting the build configuration<a class="headerlink" href="#adjusting-the-build-configuration" title="Permalink to this headline">¶</a></h4>
<p>Create the build configuration file <code class="docutils literal notranslate"><span class="pre">mozconfig</span></code> with the following
content in your mozilla-central directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Combined .mozconfig file for ASan on Linux+Mac</span>

<span class="n">mk_add_options</span> <span class="n">MOZ_OBJDIR</span><span class="o">=</span><span class="nd">@TOPSRCDIR</span><span class="o">@/</span><span class="n">objdir</span><span class="o">-</span><span class="n">ff</span><span class="o">-</span><span class="n">asan</span>

<span class="c1"># Enable ASan specific code and build workarounds</span>
<span class="n">ac_add_options</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">address</span><span class="o">-</span><span class="n">sanitizer</span>

<span class="c1"># Add ASan to our compiler flags</span>
<span class="n">export</span> <span class="n">CFLAGS</span><span class="o">=</span><span class="s2">&quot;-fsanitize=address -Dxmalloc=myxmalloc -fPIC&quot;</span>
<span class="n">export</span> <span class="n">CXXFLAGS</span><span class="o">=</span><span class="s2">&quot;-fsanitize=address -Dxmalloc=myxmalloc -fPIC&quot;</span>

<span class="c1"># Additionally, we need the ASan flag during linking. Normally, our C/CXXFLAGS would</span>
<span class="c1"># be used during linking as well but there is at least one place in our build where</span>
<span class="c1"># our CFLAGS are not added during linking.</span>
<span class="c1"># Note: The use of this flag causes Clang to automatically link the ASan runtime :)</span>
<span class="n">export</span> <span class="n">LDFLAGS</span><span class="o">=</span><span class="s2">&quot;-fsanitize=address&quot;</span>

<span class="c1"># These three are required by ASan</span>
<span class="n">ac_add_options</span> <span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">jemalloc</span>
<span class="n">ac_add_options</span> <span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">crashreporter</span>
<span class="n">ac_add_options</span> <span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">elf</span><span class="o">-</span><span class="n">hack</span>

<span class="c1"># Keep symbols to symbolize ASan traces later</span>
<span class="n">export</span> <span class="n">MOZ_DEBUG_SYMBOLS</span><span class="o">=</span><span class="mi">1</span>
<span class="n">ac_add_options</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">debug</span><span class="o">-</span><span class="n">symbols</span>
<span class="n">ac_add_options</span> <span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">install</span><span class="o">-</span><span class="n">strip</span>

<span class="c1"># Settings for an opt build (preferred)</span>
<span class="c1"># The -gline-tables-only ensures that all the necessary debug information for ASan</span>
<span class="c1"># is present, but the rest is stripped so the resulting binaries are smaller.</span>
<span class="n">ac_add_options</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">optimize</span><span class="o">=</span><span class="s2">&quot;-O2 -gline-tables-only&quot;</span>
<span class="n">ac_add_options</span> <span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">debug</span>

<span class="c1"># Settings for a debug+opt build</span>
<span class="c1">#ac_add_options --enable-optimize</span>
<span class="c1">#ac_add_options --enable-debug</span>

<span class="c1"># MacOSX only: Uncomment and adjust this path to match your SDK</span>
<span class="c1"># ac_add_options --with-macos-sdk=/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.8.sdk</span>
</pre></div>
</div>
<p>You may also need this, as seen in
<code class="docutils literal notranslate"><span class="pre">browser/config/mozconfigs/linux64/nightly-asan</span></code> (the config file used
for Address Sanitizer builds used for automated testing):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ASan specific options on Linux</span>
<span class="n">ac_add_options</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">valgrind</span>
</pre></div>
</div>
</div>
<div class="section" id="starting-the-build-process">
<h4>Starting the build process<a class="headerlink" href="#starting-the-build-process" title="Permalink to this headline">¶</a></h4>
<p>Now you start the build process using the regular <code class="docutils literal notranslate"><span class="pre">./mach</span> <span class="pre">build</span></code>
command.</p>
</div>
<div class="section" id="starting-firefox">
<h4>Starting Firefox<a class="headerlink" href="#starting-firefox" title="Permalink to this headline">¶</a></h4>
<p>After the build has completed, <code class="docutils literal notranslate"><span class="pre">./mach</span> <span class="pre">run</span></code> with the usual options for
running in a debugger (<code class="docutils literal notranslate"><span class="pre">gdb</span></code>, <code class="docutils literal notranslate"><span class="pre">lldb</span></code>, <code class="docutils literal notranslate"><span class="pre">rr</span></code>, etc.) work fine, as do
the <code class="docutils literal notranslate"><span class="pre">--disable-e10s</span></code> and other options.</p>
</div>
<div class="section" id="building-only-the-javascript-shell">
<h4>Building only the JavaScript shell<a class="headerlink" href="#building-only-the-javascript-shell" title="Permalink to this headline">¶</a></h4>
<p>If you want to build only the JavaScript shell instead of doing a full
Firefox build, the build script below will probably help you to do so.
Execute this script in the <code class="docutils literal notranslate"><span class="pre">js/src/</span></code> subdirectory and pass a directory
name as the first parameter. The build will then be created in a new
subdirectory with that name.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#! /bin/sh

if [ -z $1 ] ; then
     echo &quot;usage: $0 &lt;dirname&gt;&quot;
elif [ -d $1 ] ; then
     echo &quot;directory $1 already exists&quot;
else
     autoconf2.13
     mkdir $1
     cd $1
     CC=&quot;clang&quot; \
     CXX=&quot;clang++&quot; \
     CFLAGS=&quot;-fsanitize=address&quot; \
     CXXFLAGS=&quot;-fsanitize=address&quot; \
     LDFLAGS=&quot;-fsanitize=address&quot; \
     ../configure --enable-debug --enable-optimize --enable-address-sanitizer --disable-jemalloc
fi
</pre></div>
</div>
</div>
</div>
<div class="section" id="getting-symbols-in-address-sanitizer-traces">
<h3>Getting Symbols in Address Sanitizer Traces<a class="headerlink" href="#getting-symbols-in-address-sanitizer-traces" title="Permalink to this headline">¶</a></h3>
<p>By default, ASan traces are unsymbolized and only print the
binary/library and a memory offset instead. In order to get more useful
traces, containing symbols, there are two approaches.</p>
<div class="section" id="using-the-llvm-symbolizer-recommended">
<h4>Using the LLVM Symbolizer (recommended)<a class="headerlink" href="#using-the-llvm-symbolizer-recommended" title="Permalink to this headline">¶</a></h4>
<p>LLVM ships with a symbolizer binary that ASan will readily use to
immediately output symbolized traces. To use it, just set the
environment variable <code class="docutils literal notranslate"><span class="pre">ASAN_SYMBOLIZER_PATH</span></code> to reflect the location of
your <code class="docutils literal notranslate"><span class="pre">llvm-symbolizer</span></code> binary, before running the process. This
program is usually included in an LLVM distribution. Stacks without
symbols can also be post-processed, see bellow.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Warning:</strong> On OS X, the content sandbox prevents the symbolizer
from running. To use llvm-symbolizer on ASan output from a
content process, the content sandbox must be disabled. This can be
done by setting <code class="docutils literal notranslate"><span class="pre">MOZ_DISABLE_CONTENT_SANDBOX=1</span></code> in your run
environment. Setting this in .mozconfig has no effect.</p>
</div>
</div>
</div>
<div class="section" id="post-processing-traces-with-asan-symbolize-py">
<h4>Post-Processing Traces with asan_symbolize.py<a class="headerlink" href="#post-processing-traces-with-asan-symbolize-py" title="Permalink to this headline">¶</a></h4>
<p>Instead of using the llvm-symbolizer binary, you can also pipe the
output through the <code class="docutils literal notranslate"><span class="pre">asan_symbolize.py</span></code> script, shipped with LLVM
(<code class="docutils literal notranslate"><span class="pre">$LLVM_HOME/projects/compiler-rt/lib/asan/scripts/asan_symbolize.py</span></code>),
often included in LLVM distributions. The disadvantage is that the
script will need to use <code class="docutils literal notranslate"><span class="pre">addr2line</span></code> to get the symbols, which means
that every library will have to be loaded into memory
(including``libxul``, which takes a bit).</p>
<p>However, in certain situations it makes sense to use this script. For
example, if you have/received an unsymbolized trace, then you can still
use the script to turn it into a symbolized trace, given that you can
get the original binaries that produced the unsymbolized trace. In order
for the script to work in such cases, you need to ensure that the paths
in the trace point to the actual binaries, or change the paths
accordingly.</p>
<p>Since the output of the <code class="docutils literal notranslate"><span class="pre">asan_symbolize.py</span></code> script is still mangled,
you might want to pipe the output also through <code class="docutils literal notranslate"><span class="pre">c++filt</span></code> afterwards.</p>
</div>
</div>
<div class="section" id="troubleshooting-known-problems">
<h3>Troubleshooting / Known problems<a class="headerlink" href="#troubleshooting-known-problems" title="Permalink to this headline">¶</a></h3>
<div class="section" id="cannot-specify-o-when-generating-multiple-output-files">
<h4>Cannot specify -o when generating multiple output files<a class="headerlink" href="#cannot-specify-o-when-generating-multiple-output-files" title="Permalink to this headline">¶</a></h4>
<p>If you get the error
“<code class="docutils literal notranslate"><span class="pre">cannot</span> <span class="pre">specify</span> <span class="pre">-o</span> <span class="pre">when</span> <span class="pre">generating</span> <span class="pre">multiple</span> <span class="pre">output</span> <span class="pre">files&quot;</span></code> from
clang, disable <code class="docutils literal notranslate"><span class="pre">elf-hack</span></code> in your <code class="docutils literal notranslate"><span class="pre">mozconfig</span></code> to work around the
issue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ac_add_options</span> <span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">elf</span><span class="o">-</span><span class="n">hack</span>
</pre></div>
</div>
</div>
<div class="section" id="optimized-build">
<h4>Optimized build<a class="headerlink" href="#optimized-build" title="Permalink to this headline">¶</a></h4>
<p>Since <a class="reference external" href="https://github.com/google/sanitizers/issues/20">an issue with -O2/-Os and
ASan</a>
has been resolved, the regular optimizations used by Firefox should work
without any problems. The optimized build has only a barely noticeable
speed penalty and seems to be even faster than regular debug builds.</p>
</div>
<div class="section" id="no-addresssanitizer-libc-interceptors-initialized-shows-after-running-mach-run">
<h4>No “AddressSanitizer: <strong>libc</strong> interceptors initialized” shows after running ./mach run<a class="headerlink" href="#no-addresssanitizer-libc-interceptors-initialized-shows-after-running-mach-run" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ASAN_OPTIONS=verbosity=2 ./mach run
</pre></div>
</div>
<p>Use the above command instead</p>
</div>
<div class="section" id="an-admin-user-name-and-password-is-required-to-enter-developer-mode">
<h4>“An admin user name and password” is required to enter Developer Mode<a class="headerlink" href="#an-admin-user-name-and-password-is-required-to-enter-developer-mode" title="Permalink to this headline">¶</a></h4>
<p>Please enable <strong>Developer</strong> <strong>mode</strong> by:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ /usr/sbin/DevToolsSecurity -enable
Developer mode is now enabled.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="debugging-issues-that-asan-finds">
<h2>Debugging issues that ASan finds<a class="headerlink" href="#debugging-issues-that-asan-finds" title="Permalink to this headline">¶</a></h2>
<p>When ASan discovers an issue it will simply print an error message and
exit the app. To stop the app in a debugger before ASan exits it, set a
breakpoint on <code class="docutils literal notranslate"><span class="pre">__asan::ReportGenericError</span></code>. For more info on using
ASan and debugging issues that it uncovers, see the page <a class="reference external" href="https://github.com/google/sanitizers/wiki/AddressSanitizerAndDebugger">Address
sanitizer and a
debugger</a>
page on the upstream wiki.</p>
<p><code class="docutils literal notranslate"><span class="pre">__asan_describe_address(pointer)</span></code> issued at the debugger prompt or
even directly in the code allows outputting lots of information about
this memory address (thread and stack of allocation, of deallocation,
whether or not it is a bit outside a known buffer, thread and stack of
allocation of this buffer, etc.). This can be useful to understand where
some buffer that is not aligned was allocated, when doing SIMD work, for
example.</p>
<p><a class="reference external" href="https://rr-project.org/">rr</a> (Linux x86 only) works great with ASan
and combined, this combo allows doing some very powerful debugging
strategies.</p>
</div>
<div class="section" id="leaksanitizer">
<h2>LeakSanitizer<a class="headerlink" href="#leaksanitizer" title="Permalink to this headline">¶</a></h2>
<p>LeakSanitizer (LSan) is a special execution mode for regular ASan. It
takes advantage of how ASan tracks the set of live blocks at any given
point to print out the allocation stack of any block that is still alive
at shutdown, but is not reachable from the stack, according to a
conservative scan. This is very useful for detecting leaks of things
such as <code class="docutils literal notranslate"><span class="pre">char*</span></code> that do not participate in the usual Gecko shutdown
leak detection. LSan is supported on x86_64 Linux and OS X.</p>
<p>LSan is enabled by default in ASan builds, as of more recent versions of
Clang. To make an ASan build not run LSan, set the environment variable
<code class="docutils literal notranslate"><span class="pre">ASAN_OPTIONS</span></code> to <code class="docutils literal notranslate"><span class="pre">detect_leaks=0</span></code> (or add it as an entry to a
<code class="docutils literal notranslate"><span class="pre">:</span></code>-separated list if it is already set to something). If you want to
enable it when it is not for some reason, set it to 1 instead of 0. If
LSan is enabled and you are using a non-debug build, you will also want
to set the environment variable <code class="docutils literal notranslate"><span class="pre">MOZ_CC_RUN_DURING_SHUTDOWN=1</span></code>, to
ensure that we run shutdown GCs and CCs to avoid spurious leaks.</p>
<p>If an object that is reported by LSan is intentionally never freed, a
symbol can be added to <code class="docutils literal notranslate"><span class="pre">build/sanitizers/lsan_suppressions.txt</span></code> to get
LSan to ignore it.</p>
<p>For some more information on LSan, see the <a class="reference external" href="https://github.com/google/sanitizers/wiki/AddressSanitizerLeakSanitizer">Leak Sanitizer wiki
page</a>.</p>
<p>A <a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=lsan">meta bug called lsan</a>
is maintained to keep track of all the bugs found with LSan.</p>
</div>
<div class="section" id="frequently-asked-questions-about-asan">
<h2>Frequently Asked Questions about ASan<a class="headerlink" href="#frequently-asked-questions-about-asan" title="Permalink to this headline">¶</a></h2>
<div class="section" id="how-does-asan-work-exactly">
<h3>How does ASan work exactly?<a class="headerlink" href="#how-does-asan-work-exactly" title="Permalink to this headline">¶</a></h3>
<p>More information on how ASan works can be found on <a class="reference external" href="https://github.com/google/sanitizers/wiki/AddressSanitizer">the Address Sanitizer wiki</a>.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="asan_nightly.html" class="btn btn-neutral float-right" title="ASan Nightly" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Sanitizer" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>