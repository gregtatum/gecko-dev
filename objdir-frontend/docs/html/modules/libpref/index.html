

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>libpref &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Remote Protocol" href="../../remote/index.html" />
    <link rel="prev" title="WebIDL" href="../../dom/bindings/webidl/index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">libpref</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#high-level-design">High-level design</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#keys">Keys</a></li>
<li class="toctree-l3"><a class="reference internal" href="#basic-values">Basic values</a></li>
<li class="toctree-l3"><a class="reference internal" href="#complex-values">Complex values</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pref-branches">Pref Branches</a></li>
<li class="toctree-l3"><a class="reference internal" href="#threads">Threads</a></li>
<li class="toctree-l3"><a class="reference internal" href="#notifications">Notifications</a></li>
<li class="toctree-l3"><a class="reference internal" href="#static-prefs">Static prefs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#loading-and-saving">Loading and Saving</a></li>
<li class="toctree-l3"><a class="reference internal" href="#about-support">about:support</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sync">Sync</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rust">Rust</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cost-of-a-pref">Cost of a pref</a></li>
<li class="toctree-l3"><a class="reference internal" href="#guidelines">Guidelines</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#low-level-details">Low-level details</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#parent-process-startup">Parent process startup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#child-process-startup-parent-side">Child process startup (parent side)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#child-process-startup-child-side">Child process startup (child side)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pref-lookups">Pref lookups</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pref-changes">Pref changes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pref-deletions">Pref deletions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>libpref</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/modules/libpref/index.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="libpref">
<h1>libpref<a class="headerlink" href="#libpref" title="Permalink to this headline">¶</a></h1>
<p>libpref is a generic key/value store that is used to implement <em>prefs</em>, a term
that encompasses a variety of things.</p>
<ul class="simple">
<li><p>Feature enable/disable flags (e.g. <code class="docutils literal notranslate"><span class="pre">dom.IntersectionObserver.enabled</span></code>,
<code class="docutils literal notranslate"><span class="pre">xpinstall.signatures.required</span></code>).</p></li>
<li><p>User preferences (e.g. things set from <code class="docutils literal notranslate"><span class="pre">about:preferences</span></code>)</p></li>
<li><p>Internal application parameters (e.g.
<code class="docutils literal notranslate"><span class="pre">javascript.options.mem.nursery.max_kb</span></code>).</p></li>
<li><p>Testing and debugging flags (e.g. <code class="docutils literal notranslate"><span class="pre">network.dns.native-is-localhost</span></code>).</p></li>
<li><p>Things that might need locking in an enterprise installation.</p></li>
<li><p>Application data (e.g.
<code class="docutils literal notranslate"><span class="pre">browser.onboarding.tour.onboarding-tour-addons.completed</span></code>,
<code class="docutils literal notranslate"><span class="pre">services.sync.clients.lastSync</span></code>).</p></li>
<li><p>A cheap and dirty form of IPC(!) (some devtools prefs).</p></li>
</ul>
<p>Some of these (particularly the last two) are not an ideal use of libpref.</p>
<p>The C++ API is in the <code class="docutils literal notranslate"><span class="pre">Preferences</span></code> class. The XPIDL API is in the
<code class="docutils literal notranslate"><span class="pre">nsIPrefService</span></code> and <code class="docutils literal notranslate"><span class="pre">nsIPrefBranch</span></code> interfaces.</p>
<div class="section" id="high-level-design">
<h2>High-level design<a class="headerlink" href="#high-level-design" title="Permalink to this headline">¶</a></h2>
<div class="section" id="keys">
<h3>Keys<a class="headerlink" href="#keys" title="Permalink to this headline">¶</a></h3>
<p>Keys (a.k.a. <em>pref names</em>) are 8-bit strings, and ASCII in practice. The
convention is to use a dotted segmented form, e.g. <code class="docutils literal notranslate"><span class="pre">foo.bar.baz</span></code>, but the
segments have no built-in meaning.</p>
<p>Naming is inconsistent, e.g. segments have various forms: <code class="docutils literal notranslate"><span class="pre">foo_bar</span></code>,
<code class="docutils literal notranslate"><span class="pre">foo-bar</span></code>, <code class="docutils literal notranslate"><span class="pre">fooBar</span></code>, etc. Pref names for feature flags are likewise
inconsistent: <code class="docutils literal notranslate"><span class="pre">foo.enabled</span></code>, <code class="docutils literal notranslate"><span class="pre">foo.enable</span></code>, <code class="docutils literal notranslate"><span class="pre">foo.disable</span></code>, <code class="docutils literal notranslate"><span class="pre">fooEnabled</span></code>,
<code class="docutils literal notranslate"><span class="pre">enable-foo</span></code>, <code class="docutils literal notranslate"><span class="pre">foo.enabled.bar</span></code>, etc.</p>
<p>The grouping of prefs into families, via pref name segments, is ad hoc. Some of
these families are closely related, e.g. there are many font prefs that are
present for every language script.</p>
<p>Some prefs only make sense when considered in combination with other prefs.</p>
<p>Many pref names are known at compile time, but some are computed at runtime.</p>
</div>
<div class="section" id="basic-values">
<h3>Basic values<a class="headerlink" href="#basic-values" title="Permalink to this headline">¶</a></h3>
<p>The basic types of pref values are bools, 32-bit ints, and 8-bit C strings.</p>
<p>Strings are used to encode many types of data: identifiers, alphanumeric IDs,
UUIDs, SHA1 hashes, CSS color hex values, large integers that don’t fit into
32-bit ints (e.g. timestamps), directory names, URLs, comma-separated lists,
space-separated lists, JSON blobs, etc. There is a 1 MiB length limit on string
values; longer strings are rejected outright.</p>
<p><strong>Problem:</strong> The C string encoding is unclear; some API functions deal with
unrestricted 8-bit strings (i.e. Latin1), but some require UTF-8.</p>
<p>There is some API support for faking floats, by converting them from/to strings when getting/setting.</p>
<p><strong>Problem:</strong> confusion between ints and floats can lead to bugs.</p>
<p>Each pref consists of a default value and/or a user value. Default values can
be initialized from file at startup, and can be added and modified at runtime
via the API. User values can be initialized from file at startup, and can be
added, modified and removed at runtime via the API and <code class="docutils literal notranslate"><span class="pre">about:config</span></code>.</p>
<p>If both values are present the user value takes precedence for most operations,
though there are operations that specifically work on the default value.</p>
<p>If a user value is set to the same value as the default value, the user value
is removed, unless the pref is marked as <em>sticky</em> at startup.</p>
<p><strong>Problem:</strong> it would be better to have a clear notion of “reset to default”,
at least for prefs that have a default value.</p>
<p>Prefs can be locked. This prevents them from being given a user value, or
hides the existing user value if there is one.</p>
</div>
<div class="section" id="complex-values">
<h3>Complex values<a class="headerlink" href="#complex-values" title="Permalink to this headline">¶</a></h3>
<p>There is API support for some complex values.</p>
<p><code class="docutils literal notranslate"><span class="pre">nsIFile</span></code> objects are handled by storing the filename as a string, similar to
how floats are faked by storing them as strings.</p>
<p><code class="docutils literal notranslate"><span class="pre">nsIPrefLocalizedString</span></code> objects are ones for which the default value
specifies a properties file that contains an entry whose name matches the
prefname. When gotten, the value from that entry is put into the user value.
When set, the given value just overwrites the user value, like a string pref.</p>
<p><strong>Problem:</strong> this is weird and unlike all the other pref types.</p>
<p><code class="docutils literal notranslate"><span class="pre">nsIRelativeFilePref</span></code> objects are only used in comm-central.</p>
</div>
<div class="section" id="pref-branches">
<h3>Pref Branches<a class="headerlink" href="#pref-branches" title="Permalink to this headline">¶</a></h3>
<p>XPIDL-based access to prefs is via <code class="docutils literal notranslate"><span class="pre">nsIPrefBranch</span></code>/<code class="docutils literal notranslate"><span class="pre">nsPrefBranch</span></code>, which
lets you specify a branch of the pref tree (e.g. <code class="docutils literal notranslate"><span class="pre">font.</span></code>) and pref names work
relative to that point.</p>
<p>This API can be used from C++, but for C++ code there is also direct access
through the <code class="docutils literal notranslate"><span class="pre">Preferences</span></code> class, which uses absolute pref names.</p>
</div>
<div class="section" id="threads">
<h3>Threads<a class="headerlink" href="#threads" title="Permalink to this headline">¶</a></h3>
<p>For the most part, all the basic API functions only work on the main thread.
However, there are two exceptions to this.</p>
<p>The narrow exception is that the Servo traversal thread is allowed to get pref
values. This only occurs when the main thread is paused, which makes it safe.
(Note: <a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1474789">bug 1474789</a>
indicates that this may not be true.)</p>
<p>The broad exception is that static prefs can have a cached copy of a pref value
that can be accessed from other threads. See below.</p>
</div>
<div class="section" id="notifications">
<h3>Notifications<a class="headerlink" href="#notifications" title="Permalink to this headline">¶</a></h3>
<p>There is a notification API for being told when a pref’s value changes. C++
code can register a callback function and JS code can register an observer (via
<code class="docutils literal notranslate"><span class="pre">nsIObserver</span></code>, which requires XPCOM). In both cases, the registered entity
will be notified when the value of the named pref value changes, or when the
value of any pref matching a given prefix changes. E.g. all font pref changes
can be observed by adding a <code class="docutils literal notranslate"><span class="pre">font.</span></code> prefix-matching observer.</p>
<p>See also the section on static prefs below.</p>
</div>
<div class="section" id="static-prefs">
<h3>Static prefs<a class="headerlink" href="#static-prefs" title="Permalink to this headline">¶</a></h3>
<p>There is a special kind of pref called a static pref. Static prefs are defined
in <code class="docutils literal notranslate"><span class="pre">StaticPrefList.yaml</span></code>.</p>
<p>If a static pref is defined in both <code class="docutils literal notranslate"><span class="pre">StaticPrefList.yaml</span></code> and a pref data
file, the latter definition will take precedence. A pref shouldn’t appear in
both <code class="docutils literal notranslate"><span class="pre">StaticPrefList.yaml</span></code> and <code class="docutils literal notranslate"><span class="pre">all.js</span></code>, but it may make sense for a pref
to appear in both <code class="docutils literal notranslate"><span class="pre">StaticPrefList.yaml</span></code> and an app-specific pref data file
such as <code class="docutils literal notranslate"><span class="pre">firefox.js</span></code>.</p>
<p>Each static pref has a <em>mirror</em> kind.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">always</span></code>: A C++ <em>mirror variable</em> is associated with the pref. The variable
is always kept in sync with the pref value. This kind is common.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">once</span></code>: A C++ mirror variable is associated with the pref. The variable is
synced once with the pref’s value at startup, and then does not change. This
kind is less common, and mostly used for graphics prefs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">never</span></code>: No C++ mirror variable is associated with the pref. This is much
like a normal pref.</p></li>
</ul>
<p>An <code class="docutils literal notranslate"><span class="pre">always</span></code> or <code class="docutils literal notranslate"><span class="pre">once</span></code> static pref can only be used for prefs with
bool/int/float values, not strings or complex values.</p>
<p>Each mirror variable is read-only, accessible via a getter function.</p>
<p>Mirror variables have two benefits. First, they allow C++ and Rust code to get
the pref value directly from the variable instead of requiring a slow hash
table lookup, which is important for prefs that are consulted frequently.
Second, they allow C++ and Rust code to get the pref value off the main thread.
The mirror variable must have an atomic type if it is read off the main thread,
and assertions ensure this.</p>
<p>Note that mirror variables could be implemented via vanilla callbacks without
API support, except for one detail: libpref gives their callbacks higher
priority than normal callbacks, ensuring that any static pref will be
up-to-date if read by a normal callback.</p>
<p><strong>Problem:</strong> It is not clear what should happen to a static pref’s mirror
variable if the pref is deleted? Currently there is a missing
<code class="docutils literal notranslate"><span class="pre">NotifyCallbacks()</span></code> call so the mirror variable keeps its value from before
the deletion. The cleanest solution is probably to disallow static prefs from
being deleted.</p>
</div>
<div class="section" id="loading-and-saving">
<h3>Loading and Saving<a class="headerlink" href="#loading-and-saving" title="Permalink to this headline">¶</a></h3>
<p>Default pref values are initialized from various pref data files. Notable ones
include:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">modules/libpref/init/all.js</span></code>, used by all products;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">browser/app/profile/firefox.js</span></code>, used by Firefox desktop;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mobile/android/app/mobile.js</span></code>, used by Firefox mobile;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mail/app/profile/all-thunderbird.js</span></code>, used by Thunderbird (in comm-central);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">suite/browser/browser-prefs.js</span></code>, used by SeaMonkey (in comm-central).</p></li>
</ul>
<p>In release builds these are all put into <code class="docutils literal notranslate"><span class="pre">omni.ja</span></code>.</p>
<p>User pref values are initialized from <code class="docutils literal notranslate"><span class="pre">prefs.js</span></code> and (if present)
<code class="docutils literal notranslate"><span class="pre">user.js</span></code>, in the user’s profile. This only happens once, in the parent
process. Note that <code class="docutils literal notranslate"><span class="pre">prefs.js</span></code> is managed by Firefox, and regularly
overwritten. <code class="docutils literal notranslate"><span class="pre">user.js</span></code> is created and managed by the user, and Firefox only
reads it.</p>
<p>These files are not JavaScript; the <code class="docutils literal notranslate"><span class="pre">.js</span></code> suffix is present for historical
reasons. They are read by a custom parser within libpref.</p>
<p>User pref file syntax is slightly more restrictive than default pref file
syntax. In user pref files <code class="docutils literal notranslate"><span class="pre">user_pref</span></code> definitions are allowed but <code class="docutils literal notranslate"><span class="pre">pref</span></code> and
<code class="docutils literal notranslate"><span class="pre">sticky_pref</span></code> definitions are not, and attributes (such as <code class="docutils literal notranslate"><span class="pre">locked</span></code>) are not
allowed.</p>
<p><strong>Problem:</strong> geckodriver has a separate prefs parser in the mozprofile crate.</p>
<p><strong>Problem:</strong> there is no versioning of these files, for either the syntax or
the data. This makes changing the file format difficult.</p>
<p>There are API functions to save modified prefs, either synchronously or
asynchronously (via an off-main-thread runnable), either to the default file
(<code class="docutils literal notranslate"><span class="pre">prefs.js</span></code>) or to a named file. When saving to the default file, no action
will take place if no prefs have been modified.</p>
<p>Also, whenever a pref is modified, we wait 500ms and then automatically do an
off-main-thread save to <code class="docutils literal notranslate"><span class="pre">prefs.js</span></code>. This provides an approximation of
<a class="reference external" href="https://en.wikipedia.org/wiki/ACID#Durability">durability</a>, but it is still
possible for something to go wrong (e.g. a parent process crash) and end up
with recently changed prefs not being saved. (If such a thing happens, it
compromises <a class="reference external" href="https://en.wikipedia.org/wiki/ACID#Atomicity">atomicity</a>, i.e. a
sequence of multiple related pref changes might only get partially written.)</p>
<p>Only prefs whose values have changed from the default are saved to <code class="docutils literal notranslate"><span class="pre">prefs.js.</span></code></p>
<p><strong>Problem:</strong> Each time prefs are saved, the entire file is overwritten – 10s
or even 100s of KiBs – even if only a single value has changed. This happens
at least every 5 minutes, due to sync. Furthermore, various prefs are changed
during and shortly after startup, which can result in 10s of MiBs of disk
activity.</p>
</div>
<div class="section" id="about-support">
<h3>about:support<a class="headerlink" href="#about-support" title="Permalink to this headline">¶</a></h3>
<p>about:support contains an “Important Modified Preferences” table. It contains
all prefs that (a) have had their value changed from the default, and (b) whose
prefix match a whitelist in <code class="docutils literal notranslate"><span class="pre">Troubleshoot.jsm</span></code>. The whitelist matching is to
avoid exposing pref values that might be privacy-sensitive.</p>
<p><strong>Problem:</strong> The whitelist of prefixes is specified separately from the prefs
themselves. Having an attribute on a pref definition would be better.</p>
</div>
<div class="section" id="sync">
<h3>Sync<a class="headerlink" href="#sync" title="Permalink to this headline">¶</a></h3>
<p>On desktop, a pref is synced onto a device via Sync if there is an
accompanying <code class="docutils literal notranslate"><span class="pre">services.sync.prefs.sync.</span></code>-prefixed pref. I.e. the pref
<code class="docutils literal notranslate"><span class="pre">foo.bar</span></code> is synced if the pref <code class="docutils literal notranslate"><span class="pre">services.sync.prefs.sync.foo.bar</span></code> exists
and is true.</p>
<p>Previously, one could push prefs onto a device even if a local
<code class="docutils literal notranslate"><span class="pre">services.sync.prefs.sync.</span></code>-prefixed pref was not present; however this
behavior changed in <a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1538015">bug 1538015</a>
to require the local prefixed pref to be present. The old (insecure) behavior
can be re-enabled by setting a single pref <code class="docutils literal notranslate"><span class="pre">services.sync.prefs.dangerously_allow_arbitrary</span></code>
to true on the target browser - subsequently any pref can be pushed there by
creating a <em>remote</em> <code class="docutils literal notranslate"><span class="pre">services.sync.prefs.sync.</span></code>-prefixed pref.</p>
<p>In practice, only a small subset of prefs (about 70) have a <code class="docutils literal notranslate"><span class="pre">services.sync.prefs.sync.</span></code>-prefixed
pref by default.</p>
<p><strong>Problem:</strong> This is gross. An attribute on the pref definition would be
better, but it might be hard to change that at this point.</p>
<p>The number of synced prefs is small because prefs are synced across versions;
any pref whose meaning might change shouldn’t be synced. Also, we don’t sync
prefs that may differ across different devices (such as a desktop machine
vs. a notebook).</p>
<p>Prefs are not synced on mobile.</p>
</div>
<div class="section" id="rust">
<h3>Rust<a class="headerlink" href="#rust" title="Permalink to this headline">¶</a></h3>
<p>Static prefs mirror variables can be accessed from Rust code via the
<code class="docutils literal notranslate"><span class="pre">static_prefs::pref!</span></code> macro. Other prefs currently cannot be accessed. Parts
of libpref’s C++ API could be made accessible to Rust code fairly
straightforwardly via C bindings, either hand-made or generated.</p>
</div>
<div class="section" id="cost-of-a-pref">
<h3>Cost of a pref<a class="headerlink" href="#cost-of-a-pref" title="Permalink to this headline">¶</a></h3>
<p>The cost of a single pref is low, but the cost of several thousand prefs is
reasonably high, and includes the following.</p>
<ul class="simple">
<li><p>Parsing and initializing at startup.</p></li>
<li><p>IPC costs at startup and on pref value changes.</p></li>
<li><p>Disk writing costs of pref value changes, especially during startup.</p></li>
<li><p>Memory usage for storing the prefs, callbacks and observers, and C++ mirror
variables.</p></li>
<li><p>Complexity: most pref combinations are untested. Some can be set to a bogus
value by a curious user, which can have <a class="reference external" href="https://rejzor.wordpress.com/2015/06/14/improve-firefox-html5-video-playback-performance/">serious effects</a>
(read the comments). Prefs can also have bugs. Real-life examples include
mistyped prefnames, <code class="docutils literal notranslate"><span class="pre">all.js</span></code> entries with incorrect types (e.g. confusing
int vs. float), both of which mean changing the pref value via about:config
or the API would have no effect (see <a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1414150">bug 1414150</a> for examples of
both).</p></li>
<li><p>Sync cost, for synced prefs.</p></li>
</ul>
</div>
<div class="section" id="guidelines">
<h3>Guidelines<a class="headerlink" href="#guidelines" title="Permalink to this headline">¶</a></h3>
<p>We have far too many prefs. This is at least partly because we have had, for a
long time, a culture of “when in doubt, add a pref”. Also, we don’t have any
system — either technical or cultural — for removing unnecessary prefs. See
[bug 90440] (https://bugzilla.mozilla.org/show_bug.cgi?id=90440) for a pref
that was unused for 17 years.</p>
<p>In short, prefs are Firefox’s equivalent of the Windows Registry: a dumping
ground for anything and everything. We should have guidelines for when to add a
pref.</p>
<p>Here are some good reasons to add a pref.</p>
<ul class="simple">
<li><p><em>A user may genuinely want to change it.</em> E.g. it controls a feature that is
adjustable in about:preferences.</p></li>
<li><p><em>To enable/disable new features.</em> Once a feature is mature, consider removing
the pref. A pref expiry mechanism would help with this.</p></li>
<li><p><em>For certain testing/debugging flags.</em> Ideally, these would not be visible in
about:config.</p></li>
</ul>
<p>Here are some less good reasons to add a pref.</p>
<ul class="simple">
<li><p><em>I’m not confident about this numeric parameter (cache size, timeout, etc.)</em>
Get confident! In practice, few if any users will change it. Adding a pref
doesn’t absolve you of the responsibility of finding a good default. Then
make it a code constant.</p></li>
<li><p><em>I need to experiment with different parameters during development.</em> This is
reasonable, but consider removing the pref before landing or once the feature
has matured. An expiry mechanism would help with this.</p></li>
<li><p><em>I sometimes fiddle with this value for debugging or testing.</em>
Is it worth exposing it to the whole world to save yourself a recompile every
once in a while? Consider making it a code constant.</p></li>
<li><p><em>Different values are needed on different platforms.</em> This can be done in
other ways, e.g. <code class="docutils literal notranslate"><span class="pre">#ifdef</span></code> in C++ code.</p></li>
</ul>
<p>These guidelines do not consider application data prefs (i.e. ones that
typically don’t have a default value). They are quite different from the other
kinds. They arguably shouldn’t prefs at all, and should be stored via some
other mechanism.</p>
</div>
</div>
<div class="section" id="low-level-details">
<h2>Low-level details<a class="headerlink" href="#low-level-details" title="Permalink to this headline">¶</a></h2>
<p>The key idea is that the prefs database consists of two pieces. The first is an
initial snapshot of pref values that is created when the first child process is
created. This snapshot is stored in immutable, shared memory, and shared by all
processes.</p>
<p>Pref value changes that occur after this point are stored in a second hash
table. Each process has its own copy of this hash table. When pref values
change in the parent process, it performs IPC to inform child processes about
the changes, so they can update their copy.</p>
<p>The motivation for this design is memory usage. It’s not tenable for every
child process to have a full copy of the prefs database.</p>
<p>Not all child processes need access to prefs. Those that do include web content
processes, the GPU process, and the RDD process.</p>
<div class="section" id="parent-process-startup">
<h3>Parent process startup<a class="headerlink" href="#parent-process-startup" title="Permalink to this headline">¶</a></h3>
<p>The parent process initially has only a hash table.</p>
<p>Early in startup, the parent process loads all of the static prefs and default
prefs (mainly from <code class="docutils literal notranslate"><span class="pre">omni.ja</span></code>) into that hash table. The parent process also
registers C++ mirror variables for static prefs, initializes them, and
registers callbacks so they will be updated appropriately for all subsequent
updates.</p>
<p>Slightly later in startup, the parent process loads all user prefs files,
mainly from the profile directory.</p>
<p>When the first getter for a <code class="docutils literal notranslate"><span class="pre">once</span></code> static pref is called, all the <code class="docutils literal notranslate"><span class="pre">once</span></code>
static prefs have their mirror variables set and special frozen prefs are put
into the hash table. These frozen prefs are copies of the <code class="docutils literal notranslate"><span class="pre">once</span></code> prefs that
are given <code class="docutils literal notranslate"><span class="pre">$$$</span></code> prefixes and suffixes on their names. They are also marked
specially so they are ignored for all cases except when starting a new child
process. They exist so that all child processes can be given the same <code class="docutils literal notranslate"><span class="pre">once</span></code>
values as the parent process.</p>
</div>
<div class="section" id="child-process-startup-parent-side">
<h3>Child process startup (parent side)<a class="headerlink" href="#child-process-startup-parent-side" title="Permalink to this headline">¶</a></h3>
<p>When the first child process is created, the parent process serializes its hash
table into a shared, immutable snapshot. This snapshot is stored in a shared
memory region managed by a <code class="docutils literal notranslate"><span class="pre">SharedPrefMap</span></code> instance. The parent process then
clears the hash table. The hash table is subsequently used only to store
changed pref values.</p>
<p>When any child process is created, the parent process serializes all pref
values present in the hash table (i.e. those that have changed since the
snapshot was made) and stores them in a second, short-lived shared memory
region. This represents the set of changes the child process needs to apply on
top of the snapshot, and allows it to build a hash table which should exactly
match the parent’s.</p>
<p>The parent process passes two file descriptors to the child process, one for
each region of memory. The snapshot is the same for all child processes.</p>
</div>
<div class="section" id="child-process-startup-child-side">
<h3>Child process startup (child side)<a class="headerlink" href="#child-process-startup-child-side" title="Permalink to this headline">¶</a></h3>
<p>Early in child process startup, the prefs service maps in and deserializes both
shared memory regions sent from the parent process, but defers further
initialization until requested by XPCOM initialization. Once that happens,
mirror variables are initialized for static prefs, but no default values are
set in the hash table, and no prefs files are loaded.</p>
<p>Once the mirror variables have been initialized, we dispatch pref change
callbacks for any prefs in the shared snapshot which have user values or are
locked. This causes the mirror variables to be updated.</p>
<p>After that, the changed pref values received from the parent process (via
<code class="docutils literal notranslate"><span class="pre">changedPrefsFd</span></code>) are added to the prefs database. Their values override the
values in the snapshot, and pref change callbacks are dispatched for them as
appropriate. <code class="docutils literal notranslate"><span class="pre">once</span></code> mirror variable are initialized from the special frozen
pref values.</p>
</div>
<div class="section" id="pref-lookups">
<h3>Pref lookups<a class="headerlink" href="#pref-lookups" title="Permalink to this headline">¶</a></h3>
<p>Each prefs database has both a hash table and a shared memory snapshot. A given
pref may have an entry in either or both of these. If a pref exists in both,
the hash table entry takes precedence.</p>
<p>For pref lookups, the hash table is checked first, followed by the shared
snapshot. The entry in the hash table may have the type <code class="docutils literal notranslate"><span class="pre">None</span></code>, in which case
the pref is treated as if it did not exist. The entry in the static snapshot
never has the type <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
<p>For pref enumeration, both maps are enumerated, starting with the hash table.
While iterating over the hash table, any entry with the type <code class="docutils literal notranslate"><span class="pre">None</span></code> is
skipped. While iterating over the shared snapshot, any entry which also exists
in the hash table is skipped. The combined result of the two iterations
represents the full contents of the prefs database.</p>
</div>
<div class="section" id="pref-changes">
<h3>Pref changes<a class="headerlink" href="#pref-changes" title="Permalink to this headline">¶</a></h3>
<p>Pref changes can only be initiated in the parent process. All API methods that
modify prefs fail noisily (with <code class="docutils literal notranslate"><span class="pre">NS_ERROR</span></code>) if run outside the parent
process.</p>
<p>Pref changes that happen before the initial snapshot have been made are simple,
and take place in the hash table. There is no shared snapshot to update, and no
child processes to synchronize with.</p>
<p>Once a snapshot has been created, any changes need to happen in the hash table.</p>
<p>If an entry for a changed pref already exists in the hash table, that entry can
be updated directly. Likewise for prefs that do not exist in either the hash
table or the shared snapshot: a new hash table entry can be created.</p>
<p>More care is needed when a changed pref exists in the snapshot but not in the
hash table. In that case, we create a hash table entry with the same values as
the snapshot entry, and then update it… but <em>only</em> if the changes will have
an effect. If a caller attempts to set a pref to its existing value, we do not
want to waste memory creating an unnecessary hash table entry.</p>
<p>Content processes must be told about any visible pref value changes. (A change
to a default value that is hidden by a user value is unimportant.) When this
happens, <code class="docutils literal notranslate"><span class="pre">ContentParent</span></code> detects the change (via an observer).  It checks the
pref name against a small blacklist of prefixes that child processes should not
care about (this is an optimization to reduce IPC rather than a
capabilities/security consideration), and for string prefs it also checks the
value(s) don’t exceed 4 KiB. If the checks pass, it sends an IPC message
(<code class="docutils literal notranslate"><span class="pre">PreferenceUpdate</span></code>) to the child process, and the child process updates
the pref (default and user value) accordingly.</p>
<p><strong>Problem:</strong> The blacklist of prefixes is specified separately from the prefs
themselves. Having an attribute on a pref definition would be better.</p>
<p><strong>Problem:</strong> The 4 KiB limit can lead to inconsistencies between the parent
process and child processes. E.g. see
<a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1303051#c28">bug 1303051</a>.</p>
</div>
<div class="section" id="pref-deletions">
<h3>Pref deletions<a class="headerlink" href="#pref-deletions" title="Permalink to this headline">¶</a></h3>
<p>Pref deletion is more complicated. If a pref to be deleted exists only in the
hash table of the parent process, its entry can simply be removed. If it exists
in the shared snapshot, however, its hash table entry needs to be kept (or
created), and its type changed to <code class="docutils literal notranslate"><span class="pre">None</span></code>. The presence of this entry masks
the snapshot entry, causing it to be ignored by pref enumerators.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../remote/index.html" class="btn btn-neutral float-right" title="Remote Protocol" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../../dom/bindings/webidl/index.html" class="btn btn-neutral float-left" title="WebIDL" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>