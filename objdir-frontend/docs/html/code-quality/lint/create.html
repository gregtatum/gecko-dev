

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Adding a New Linter to the Tree &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Black" href="linters/black.html" />
    <link rel="prev" title="Running Linters Locally" href="usage.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Code quality</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../static-analysis.html">Static analysis</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Linting</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="usage.html">Running Linters Locally</a></li>
<li class="toctree-l3"><a class="reference internal" href="usage.html#fixing-lint-errors">Fixing Lint Errors</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Adding a New Linter to the Tree</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#linter-requirements">Linter Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#linter-basics">Linter Basics</a></li>
<li class="toctree-l4"><a class="reference internal" href="#linter-types">Linter Types</a></li>
<li class="toctree-l4"><a class="reference internal" href="#linter-definition">Linter Definition</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example">Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#result-definition">Result definition</a></li>
<li class="toctree-l4"><a class="reference internal" href="#automated-testing">Automated testing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bootstrapping-dependencies">Bootstrapping Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-the-linter-to-the-ci">Adding the linter to the CI</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="linters/black.html">Black</a></li>
<li class="toctree-l3"><a class="reference internal" href="linters/clang-format.html">clang-format</a></li>
<li class="toctree-l3"><a class="reference internal" href="linters/clippy.html">clippy</a></li>
<li class="toctree-l3"><a class="reference internal" href="linters/codespell.html">Codespell</a></li>
<li class="toctree-l3"><a class="reference internal" href="linters/cpp-virtual-final.html">cpp virtual final</a></li>
<li class="toctree-l3"><a class="reference internal" href="linters/eslint.html">ESLint</a></li>
<li class="toctree-l3"><a class="reference internal" href="linters/eslint-plugin-mozilla.html">Mozilla ESLint Plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="linters/eslint-plugin-spidermonkey-js.html">Mozilla ESLint SpiderMonkey JS</a></li>
<li class="toctree-l3"><a class="reference internal" href="linters/file-perm.html">File permission</a></li>
<li class="toctree-l3"><a class="reference internal" href="linters/file-whitespace.html">Trailing whitespaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="linters/flake8.html">Flake8</a></li>
<li class="toctree-l3"><a class="reference internal" href="linters/l10n.html">L10n</a></li>
<li class="toctree-l3"><a class="reference internal" href="linters/license.html">License</a></li>
<li class="toctree-l3"><a class="reference internal" href="linters/lintpref.html">Lintpref</a></li>
<li class="toctree-l3"><a class="reference internal" href="linters/mingw-capitalization.html">MinGW capitalization</a></li>
<li class="toctree-l3"><a class="reference internal" href="linters/perfdocs.html">PerfDocs</a></li>
<li class="toctree-l3"><a class="reference internal" href="linters/pylint.html">pylint</a></li>
<li class="toctree-l3"><a class="reference internal" href="linters/rejected-words.html">Rejected words</a></li>
<li class="toctree-l3"><a class="reference internal" href="linters/rstlinter.html">RST Linter</a></li>
<li class="toctree-l3"><a class="reference internal" href="linters/rustfmt.html">Rustfmt</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../coding-style/index.html">Coding style</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../l10n/index.html">Localization</a></li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Code quality</a> &raquo;</li>
        
          <li><a href="index.html">Linting</a> &raquo;</li>
        
      <li>Adding a New Linter to the Tree</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/code-quality/lint/create.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="adding-a-new-linter-to-the-tree">
<h1>Adding a New Linter to the Tree<a class="headerlink" href="#adding-a-new-linter-to-the-tree" title="Permalink to this headline">¶</a></h1>
<div class="section" id="linter-requirements">
<h2>Linter Requirements<a class="headerlink" href="#linter-requirements" title="Permalink to this headline">¶</a></h2>
<p>For a linter to be integrated into the mozilla-central tree, it needs to have:</p>
<ul class="simple">
<li><p>Any required dependencies should be installed as part of <code class="docutils literal notranslate"><span class="pre">./mach</span> <span class="pre">bootstrap</span></code></p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">./mach</span> <span class="pre">lint</span></code> interface</p></li>
<li><p>Running <code class="docutils literal notranslate"><span class="pre">./mach</span> <span class="pre">lint</span></code> command must pass (note, linters can be disabled for individual directories)</p></li>
<li><p>Taskcluster/Treeherder integration</p></li>
<li><p>In tree documentation (under <code class="docutils literal notranslate"><span class="pre">docs/code-quality/lint</span></code>) to give a basic summary, links and any other useful information</p></li>
<li><p>Unit tests (under <code class="docutils literal notranslate"><span class="pre">tools/lint/test</span></code>) to make sure that the linter works as expected and we don’t regress.</p></li>
</ul>
<p>The review group in Phabricator is <code class="docutils literal notranslate"><span class="pre">#linter-reviewers</span></code>.</p>
</div>
<div class="section" id="linter-basics">
<h2>Linter Basics<a class="headerlink" href="#linter-basics" title="Permalink to this headline">¶</a></h2>
<p>A linter is a yaml file with a <code class="docutils literal notranslate"><span class="pre">.yml</span></code> extension. Depending on how the type of linter, there may
be python code alongside the definition, pointed to by the ‘payload’ attribute.</p>
<p>Here’s a trivial example:</p>
<p>no-eval.yml</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">EvalLinter</span><span class="p">:</span>
    <span class="nt">description</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Ensures the string eval doesn&#39;t show up.</span>
    <span class="nt">extensions</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;js&#39;</span><span class="p p-Indicator">]</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">string</span>
    <span class="nt">payload</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">eval</span>
</pre></div>
</div>
<p>Now <code class="docutils literal notranslate"><span class="pre">no-eval.yml</span></code> gets passed into <code class="xref py py-func docutils literal notranslate"><span class="pre">LintRoller.read()</span></code>.</p>
</div>
<div class="section" id="linter-types">
<h2>Linter Types<a class="headerlink" href="#linter-types" title="Permalink to this headline">¶</a></h2>
<p>There are four types of linters, though more may be added in the future.</p>
<ol class="arabic simple">
<li><p>string - fails if substring is found</p></li>
<li><p>regex - fails if regex matches</p></li>
<li><p>external - fails if a python function returns a non-empty result list</p></li>
<li><p>structured_log - fails if a mozlog logger emits any lint_error or lint_warning log messages</p></li>
</ol>
<p>As seen from the example above, string and regex linters are very easy to create, but they
should be avoided if possible. It is much better to use a context aware linter for the language you
are trying to lint. For example, use eslint to lint JavaScript files, use flake8 to lint python
files, etc.</p>
<p>Which brings us to the third and most interesting type of linter,
external.  External linters call an arbitrary python function which is
responsible for not only running the linter, but ensuring the results
are structured properly. For example, an external type could shell out
to a 3rd party linter, collect the output and format it into a list of
<code class="xref py py-class docutils literal notranslate"><span class="pre">Issue</span></code> objects. The signature for this python
function is <code class="docutils literal notranslate"><span class="pre">lint(files,</span> <span class="pre">config,</span> <span class="pre">**kwargs)</span></code>, where <code class="docutils literal notranslate"><span class="pre">files</span></code> is a list of
files to lint and <code class="docutils literal notranslate"><span class="pre">config</span></code> is the linter definition defined in the <code class="docutils literal notranslate"><span class="pre">.yml</span></code>
file.</p>
<p>Structured log linters are much like external linters, but suitable
for cases where the linter code is using mozlog and emits
<code class="docutils literal notranslate"><span class="pre">lint_error</span></code> or <code class="docutils literal notranslate"><span class="pre">lint_warning</span></code> logging messages when the lint
fails. This is recommended for writing novel gecko-specific lints. In
this case the signature for lint functions is <code class="docutils literal notranslate"><span class="pre">lint(files,</span> <span class="pre">config,</span> <span class="pre">logger,</span>
<span class="pre">**kwargs)</span></code>.</p>
</div>
<div class="section" id="linter-definition">
<h2>Linter Definition<a class="headerlink" href="#linter-definition" title="Permalink to this headline">¶</a></h2>
<p>Each <code class="docutils literal notranslate"><span class="pre">.yml</span></code> file must have at least one linter defined in it. Here are the supported keys:</p>
<ul class="simple">
<li><p>description - A brief description of the linter’s purpose (required)</p></li>
<li><p>type - One of ‘string’, ‘regex’ or ‘external’ (required)</p></li>
<li><p>payload - The actual linting logic, depends on the type (required)</p></li>
<li><p>include - A list of file paths that will be considered (optional)</p></li>
<li><p>exclude - A list of file paths or glob patterns that must not be matched (optional)</p></li>
<li><p>extensions - A list of file extensions to be considered (optional)</p></li>
<li><p>setup - A function that sets up external dependencies (optional)</p></li>
<li><p>support-files - A list of glob patterns matching configuration files (optional)</p></li>
<li><p>find-dotfiles - If set to <code class="docutils literal notranslate"><span class="pre">true</span></code>, run on dot files (.*) (optional)</p></li>
<li><p>ignore-case - If set to <code class="docutils literal notranslate"><span class="pre">true</span></code> and <code class="docutils literal notranslate"><span class="pre">type</span></code> is regex, ignore the case (optional)</p></li>
</ul>
<p>In addition to the above, some <code class="docutils literal notranslate"><span class="pre">.yml</span></code> files correspond to a single lint rule. For these, the
following additional keys may be specified:</p>
<ul class="simple">
<li><p>message - A string to print on infraction (optional)</p></li>
<li><p>hint - A string with a clue on how to fix the infraction (optional)</p></li>
<li><p>rule - An id string for the lint rule (optional)</p></li>
<li><p>level - The severity of the infraction, either ‘error’ or ‘warning’ (optional)</p></li>
</ul>
<p>For structured_log lints the following additional keys apply:</p>
<ul class="simple">
<li><p>logger - A StructuredLog object to use for logging. If not supplied
one will be created (optional)</p></li>
</ul>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>Here is an example of an external linter that shells out to the python flake8 linter,
let’s call the file <code class="docutils literal notranslate"><span class="pre">flake8_lint.py</span></code> (<a class="reference external" href="https://searchfox.org/mozilla-central/source/tools/lint/python/flake8.py">in-tree version</a>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="kn">from</span> <span class="nn">mozlint</span> <span class="kn">import</span> <span class="n">result</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">which</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">shutil_which</span> <span class="kn">import</span> <span class="n">which</span>


<span class="n">FLAKE8_NOT_FOUND</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Could not find flake8! Install flake8 and try again.</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">lint</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">lintargs</span><span class="p">):</span>
    <span class="n">binary</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FLAKE8&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">binary</span><span class="p">:</span>
        <span class="n">binary</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s1">&#39;flake8&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">binary</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">FLAKE8_NOT_FOUND</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>

    <span class="c1"># Flake8 allows passing in a custom format string. We use</span>
    <span class="c1"># this to help mold the default flake8 format into what</span>
    <span class="c1"># mozlint&#39;s Issue object expects.</span>
    <span class="n">cmdargs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">binary</span><span class="p">,</span>
        <span class="s1">&#39;--format&#39;</span><span class="p">,</span>
        <span class="s1">&#39;{&quot;path&quot;:&quot;</span><span class="si">%(path)s</span><span class="s1">&quot;,&quot;lineno&quot;:</span><span class="si">%(row)s</span><span class="s1">,&quot;column&quot;:</span><span class="si">%(col)s</span><span class="s1">,&quot;rule&quot;:&quot;</span><span class="si">%(code)s</span><span class="s1">&quot;,&quot;message&quot;:&quot;</span><span class="si">%(text)s</span><span class="s1">&quot;}&#39;</span><span class="p">,</span>
    <span class="p">]</span> <span class="o">+</span> <span class="n">files</span>

    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmdargs</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># all passed</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="c1"># res is a dict of the form specified by --format above</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># parse level out of the id string</span>
        <span class="k">if</span> <span class="s1">&#39;code&#39;</span> <span class="ow">in</span> <span class="n">res</span> <span class="ow">and</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;W&#39;</span><span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;warning&#39;</span>

        <span class="c1"># result.from_linter is a convenience method that</span>
        <span class="c1"># creates a Issue using a LINTER definition</span>
        <span class="c1"># to populate some defaults.</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">res</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
<p>Now here is the linter definition that would call it:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">flake8</span><span class="p">:</span>
    <span class="nt">description</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Python linter</span>
    <span class="nt">include</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;.&#39;</span><span class="p p-Indicator">]</span>
    <span class="nt">extensions</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;py&#39;</span><span class="p p-Indicator">]</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">external</span>
    <span class="nt">payload</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">py.flake8:lint</span>
    <span class="nt">support-files</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="s">&#39;**/.flake8&#39;</span>
</pre></div>
</div>
<p>Notice the payload has two parts, delimited by ‘:’. The first is the module
path, which <code class="docutils literal notranslate"><span class="pre">mozlint</span></code> will attempt to import. The second is the object path
within that module (e.g, the name of a function to call). It is up to consumers
of <code class="docutils literal notranslate"><span class="pre">mozlint</span></code> to ensure the module is in <code class="docutils literal notranslate"><span class="pre">sys.path</span></code>. Structured log linters
use the same import mechanism.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">support-files</span></code> key is used to list configuration files or files related
to the running of the linter itself. If using <code class="docutils literal notranslate"><span class="pre">--outgoing</span></code> or <code class="docutils literal notranslate"><span class="pre">--workdir</span></code>
and one of these files was modified, the entire tree will be linted instead of
just the modified files.</p>
</div>
<div class="section" id="result-definition">
<h2>Result definition<a class="headerlink" href="#result-definition" title="Permalink to this headline">¶</a></h2>
<p>When generating the list of results, the following values are available.</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 29%" />
<col style="width: 57%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Optional</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>linter</p></td>
<td><p>Name of the linter that flagged this error</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>path</p></td>
<td><p>Path to the file containing the error</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>message</p></td>
<td><p>Text describing the error</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>lineno</p></td>
<td><p>Line number that contains the error</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>column</p></td>
<td><p>Column containing the error</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>level</p></td>
<td><p>Severity of the error, either ‘warning’ or ‘error’ (default ‘error’)</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p>hint</p></td>
<td><p>Suggestion for fixing the error</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p>source</p></td>
<td><p>Source code context of the error</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p>rule</p></td>
<td><p>Name of the rule that was violated</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p>lineoffset</p></td>
<td><p>Denotes an error spans multiple lines, of the form (&lt;lineno offset&gt;, &lt;num lines&gt;)</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p>diff</p></td>
<td><p>A diff describing the changes that need to be made to the code</p></td>
<td><p>Yes</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="automated-testing">
<h2>Automated testing<a class="headerlink" href="#automated-testing" title="Permalink to this headline">¶</a></h2>
<p>Every new checker must have tests associated.</p>
<p>They should be pretty easy to write as most of the work is managed by the Mozlint
framework. The key declaration is the <code class="docutils literal notranslate"><span class="pre">LINTER</span></code> variable which must match
the linker declaration.</p>
<p>As an example, the <a class="reference external" href="https://searchfox.org/mozilla-central/source/tools/lint/test/test_flake8.py">Flake8 test</a> looks like the following snippet:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mozunit</span>
<span class="n">LINTER</span> <span class="o">=</span> <span class="s1">&#39;flake8&#39;</span>

<span class="k">def</span> <span class="nf">test_lint_single_file</span><span class="p">(</span><span class="n">lint</span><span class="p">,</span> <span class="n">paths</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">lint</span><span class="p">(</span><span class="n">paths</span><span class="p">(</span><span class="s1">&#39;bad.py&#39;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rule</span> <span class="o">==</span> <span class="s1">&#39;F401&#39;</span>
    <span class="k">assert</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rule</span> <span class="o">==</span> <span class="s1">&#39;E501&#39;</span>
    <span class="k">assert</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lineno</span> <span class="o">==</span> <span class="mi">5</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">mozunit</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>As always with tests, please make sure that enough positive and negative cases are covered.</p>
<p>To run the tests:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ ./mach python-test --python <span class="m">3</span> --subsuite mozlint
</pre></div>
</div>
<p>More tests can be <a class="reference external" href="https://searchfox.org/mozilla-central/source/tools/lint/test">found in-tree</a>.</p>
</div>
<div class="section" id="bootstrapping-dependencies">
<h2>Bootstrapping Dependencies<a class="headerlink" href="#bootstrapping-dependencies" title="Permalink to this headline">¶</a></h2>
<p>Many linters, especially 3rd party ones, will require a set of dependencies. It
could be as simple as installing a binary from a package manager, or as
complicated as pulling a whole graph of tools, plugins and their dependencies.</p>
<p>Either way, to reduce the burden on users, linters should strive to provide
automated bootstrapping of all their dependencies. To help with this,
<code class="docutils literal notranslate"><span class="pre">mozlint</span></code> allows linters to define a <code class="docutils literal notranslate"><span class="pre">setup</span></code> config, which has the same
path object format as an external payload. For example (<a class="reference external" href="https://searchfox.org/mozilla-central/source/tools/lint/flake8.yml">in-tree version</a>):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">flake8</span><span class="p">:</span>
    <span class="nt">description</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Python linter</span>
    <span class="nt">include</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;.&#39;</span><span class="p p-Indicator">]</span>
    <span class="nt">extensions</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;py&#39;</span><span class="p p-Indicator">]</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">external</span>
    <span class="nt">payload</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">py.flake8:lint</span>
    <span class="nt">setup</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">py.flake8:setup</span>
</pre></div>
</div>
<p>The setup function takes a single argument, the root of the repository being
linted. In the case of <code class="docutils literal notranslate"><span class="pre">flake8</span></code>, it might look like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">distutils.spawn</span> <span class="kn">import</span> <span class="n">find_executable</span>

<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="o">**</span><span class="n">lintargs</span><span class="p">):</span>
    <span class="c1"># This is a simple example. Please look at the actual source for better examples.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">find_executable</span><span class="p">(</span><span class="s1">&#39;flake8&#39;</span><span class="p">):</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;pip&#39;</span><span class="p">,</span> <span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="s1">&#39;flake8&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>The setup function will be called implicitly before running the linter. This
means it should return fast and not produce any output if there is no setup to
be performed.</p>
<p>The setup functions can also be called explicitly by running <code class="docutils literal notranslate"><span class="pre">mach</span> <span class="pre">lint</span>
<span class="pre">--setup</span></code>. This will only perform setup and not perform any linting. It is
mainly useful for other tools like <code class="docutils literal notranslate"><span class="pre">mach</span> <span class="pre">bootstrap</span></code> to call into.</p>
</div>
<div class="section" id="adding-the-linter-to-the-ci">
<h2>Adding the linter to the CI<a class="headerlink" href="#adding-the-linter-to-the-ci" title="Permalink to this headline">¶</a></h2>
<p>First, the job will have to be declared in Taskcluster.</p>
<p>This should be done in the <a class="reference external" href="https://searchfox.org/mozilla-central/source/taskcluster/ci/source-test/mozlint.yml">mozlint Taskcluster configuration</a>.
You will need to define a symbol, how it is executed and on what kind of change.</p>
<p>For example, for flake8, the configuration is the following:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">py-flake8</span><span class="p">:</span>
    <span class="nt">description</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">flake8 run over the gecko codebase</span>
    <span class="nt">treeherder</span><span class="p">:</span>
        <span class="nt">symbol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">py(f8)</span>
    <span class="nt">run</span><span class="p">:</span>
        <span class="nt">mach</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">lint -l flake8 -f treeherder -f json:/builds/worker/mozlint.json</span>
    <span class="nt">when</span><span class="p">:</span>
        <span class="nt">files-changed</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="s">&#39;**/*.py&#39;</span>
            <span class="p p-Indicator">-</span> <span class="s">&#39;**/.flake8&#39;</span>
            <span class="c1"># moz.configure files are also Python files.</span>
            <span class="p p-Indicator">-</span> <span class="s">&#39;**/*.configure&#39;</span>
</pre></div>
</div>
<p>If the linter requires an external program, you will have to install it in the <a class="reference external" href="https://searchfox.org/mozilla-central/source/taskcluster/docker/lint/system-setup.sh">setup script</a>
and maybe install the necessary files in the <a class="reference external" href="https://searchfox.org/mozilla-central/source/taskcluster/docker/lint/Dockerfile">Docker configuration</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the defect found by the linter is minor, make sure that it is run as <a class="reference external" href="https://wiki.mozilla.org/Sheriffing/Job_Visibility_Policy#Overview_of_the_Job_Visibility_Tiers">tier 2</a>.
This prevents the tree from closing because of a tiny issue.
For example, the typo detection is run as tier-2.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="linters/black.html" class="btn btn-neutral float-right" title="Black" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="usage.html" class="btn btn-neutral float-left" title="Running Linters Locally" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>