

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Cross-channel VCS Graph &mdash; Firefox Source Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/firefox.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Commits and Metadata" href="commits.html" />
    <link rel="prev" title="Cross-channel" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Firefox Source Docs
          

          
            
            <img src="../../_static/firefox-wordmark.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup/index.html">Getting Set Up To Work On The Firefox Codebase</a></li>
</ul>
<p class="caption"><span class="caption-text">Working On Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Working on Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bug-mgmt/index.html">Bug Handling</a></li>
</ul>
<p class="caption"><span class="caption-text">Source Code Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../browser/index.html">Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/index.html">DOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../layout/index.html">Layout &amp; CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gfx/index.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devtools/index.html">Firefox DevTools Contributor Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../toolkit/index.html">Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../js/index.html">SpiderMonkey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile/android/geckoview/index.html">Welcome to GeckoView’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dom/bindings/webidl/index.html">WebIDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/libpref/index.html">libpref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../remote/index.html">Remote Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services/common/services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uriloader/index.html">File Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../widget/cocoa/index.html">Firefox on macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code-quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../writing-rust-code/index.html">Writing Rust Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/profiler/index.html">Gecko Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">The Firefox Build System</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mach/index.html">Mach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/try/index.html">Try Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build/buildsystem/index.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../taskcluster/index.html">TaskCluster Task-Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/moztreedocs/index.html">Managing Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Testing &amp; Test Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../testing/testing-policy/index.html">Testing Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/marionette/index.html">Marionette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/geckodriver/index.html">geckodriver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web-platform/index.html">web-platform-tests documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/fuzzing/index.html">Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/sanitizer/index.html">Sanitizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/perfdocs/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/code-coverage/index.html">Code coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing-rust-code/index.html">Testing &amp; Debugging Rust Code</a></li>
</ul>
<p class="caption"><span class="caption-text">Localization &amp; Internationalization</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../intl/index.html">Internationalization</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Localization</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../overview.html">Localization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fluent/index.html">Fluent</a></li>
<li class="toctree-l2"><a class="reference internal" href="../migrations/index.html">Migrating Strings From Legacy or Fluent Files</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Cross-channel</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Cross-channel VCS Graph</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sparse-graph">Sparse Graph</a></li>
<li class="toctree-l4"><a class="reference internal" href="#all-arcs">All Arcs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#removing-shortcuts">Removing Shortcuts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#single-head">Single Head</a></li>
<li class="toctree-l4"><a class="reference internal" href="#entry-points">Entry Points</a></li>
<li class="toctree-l4"><a class="reference internal" href="#maximum-parent-count">Maximum Parent Count</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="commits.html">Commits and Metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="content.html">Cross-channel Content</a></li>
<li class="toctree-l3"><a class="reference internal" href="repositories.html">gecko-strings and Quarantine</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../glossary.html">L10N Glossary</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Firefox and Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mozbase/index.html">mozbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Using third-party Python packages</a></li>
</ul>
<p class="caption"><span class="caption-text">Metrics Collected in Firefox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics/index.html#pings">Pings</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Firefox Source Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Localization</a> &raquo;</li>
        
          <li><a href="index.html">Cross-channel</a> &raquo;</li>
        
      <li>Cross-channel VCS Graph</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/l10n/crosschannel/graph.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="cross-channel-vcs-graph">
<h1>Cross-channel VCS Graph<a class="headerlink" href="#cross-channel-vcs-graph" title="Permalink to this headline">¶</a></h1>
<p>We opted to create a commit graph that reflects the original history.
We initially tried a number of different algorithms to create a linearized
history, but the results reflected the original attribution of content poorly.</p>
<p>To do so, we take the original graph, pick only the revisions that are of
interest to l10n files, and create content for each of those revisions. It’s
then committed with the original commit message and commit metadata, while
amending the message with metadata about which original commits went into
the generated content.</p>
<p>If you’re only interested in a high-level overview of cross-channel
localization, you may want to skip forward to <a class="reference internal" href="commits.html"><span class="doc">Commits and Metadata</span></a>.</p>
<p>The history of <code class="docutils literal notranslate"><span class="pre">mozilla-central</span></code> is
<a class="reference external" href="https://blog.mozilla.org/axel/2017/03/23/cant-you-graph-that-graph/">rather involved</a>.
There are a few aspects to be aware of:</p>
<ol class="arabic simple">
<li><p>The graph has multiple roots.</p></li>
<li><p>Files move in and out of the source paths configured by project configs.</p></li>
<li><p>Project configs change to expose existing files with history.</p></li>
<li><p>Merge days work differently in <code class="docutils literal notranslate"><span class="pre">mozilla-central</span></code> and <code class="docutils literal notranslate"><span class="pre">comm-central</span></code>.</p></li>
<li><p>Merge days don’t have correct file change metadata.</p></li>
</ol>
<p>The overall process to update the graph for a new revision <code class="docutils literal notranslate"><span class="pre">REV</span></code>
in the target goes as follows.</p>
<ol class="arabic simple">
<li><p>Find the revisions that are currently covered in the target repository.</p></li>
<li><p>Find all revisions that are ancestors of <code class="docutils literal notranslate"><span class="pre">REV</span></code>, but not ancestors of
already converted revisions from the previous step.</p></li>
<li><p>For all new revisions, find the ones that touch l10n. Keep track of new files.</p></li>
<li><p>For all new files, track their revisions, including moves and deletions.</p></li>
<li><p>Skip known-bad revisions.</p></li>
<li><p>Create a graph of the relevant revisions.</p></li>
<li><p>Fix the graph.</p></li>
<li><p>Ensure there’s a single head.</p></li>
<li><p>Find the right entry points for the fixed graph onto the target graph.</p></li>
</ol>
<p>The first few steps are straightforward, but the actual graph needs
work.</p>
<div class="section" id="sparse-graph">
<h2>Sparse Graph<a class="headerlink" href="#sparse-graph" title="Permalink to this headline">¶</a></h2>
<p>Let’s start with an example. Common graphs in <code class="docutils literal notranslate"><span class="pre">mozilla-central</span></code>
look like the following, with “green” nodes being the ones affecting
localization that we want to transform.</p>
<div class="graphviz"><img src="../../_images/graphviz-305352c7df6650aa8572e2648519e9b16d844bf5.png" alt="digraph full_tree {
graph [ rankdir=LR ];
&quot;red0&quot; -&gt; &quot;green1&quot; ;
&quot;red0&quot; -&gt; &quot;red1&quot; ;
&quot;red1&quot; -&gt; &quot;merge-red1&quot; ;
&quot;green1&quot; -&gt; &quot;merge-red1&quot; ;
&quot;merge-red1&quot; -&gt; &quot;green2&quot; ;
&quot;merge-red1&quot; -&gt; &quot;red2&quot; ;
&quot;red2&quot; -&gt; &quot;merge-red2&quot; ;
&quot;green2&quot; -&gt; &quot;merge-red2&quot; ;
&quot;merge-red2&quot; -&gt; &quot;green3&quot; ;
&quot;merge-red2&quot; -&gt; &quot;red3&quot; ;
&quot;green3&quot; -&gt; &quot;merge-red3&quot; ;
&quot;red3&quot; -&gt; &quot;merge-red3&quot; ;
&quot;merge-red3&quot; -&gt; &quot;green4&quot; ;
&quot;merge-red3&quot; -&gt; &quot;red4&quot; ;
&quot;red4&quot; -&gt; &quot;merge-red4&quot; ;
&quot;green4&quot; -&gt; &quot;merge-red4&quot; ;
&quot;merge-red4&quot; -&gt; &quot;green5&quot; ;
&quot;merge-red4&quot; -&gt; &quot;red5&quot; ;
&quot;red5&quot; -&gt; &quot;green4.5&quot; ;
&quot;green4.5&quot; -&gt; &quot;merge-red5&quot; ;
&quot;green5&quot; -&gt; &quot;merge-red5&quot; ;
&quot;green1&quot; [ color=green ] ;
&quot;green2&quot; [ color=green ] ;
&quot;green3&quot; [ color=green ] ;
&quot;green4&quot; [ color=green ] ;
&quot;green4.5&quot; [ color=green ] ;
&quot;green5&quot; [ color=green ] ;
}" class="graphviz" /></div>
<p>What we’d expect to get would be a graph that just goes through our nodes,
in this case effectively a linear graph.</p>
<div class="graphviz"><img src="../../_images/graphviz-95abb82e7d82b40bd299b71238555196f09694f5.png" alt="digraph target {
graph [ rankdir=LR ];
&quot;green1&quot; -&gt; &quot;green2&quot; ;
&quot;green2&quot; -&gt; &quot;green3&quot; ;
&quot;green3&quot; -&gt; &quot;green4&quot; ;
&quot;green4&quot; -&gt; &quot;green5&quot; ;
&quot;green4&quot; -&gt; &quot;green4.5&quot; ;
}" class="graphviz" /></div>
</div>
<div class="section" id="all-arcs">
<h2>All Arcs<a class="headerlink" href="#all-arcs" title="Permalink to this headline">¶</a></h2>
<p>Natively, Mercurial creates a graph that shows all paths from each node
to another that can be taken in the full graph, creating, in this case,
a graph that connects all nodes.</p>
<div class="graphviz"><img src="../../_images/graphviz-01415000a351346b0989fc2105779198a3258a93.png" alt="digraph mesh {
graph [ rankdir=LR ];
&quot;green1&quot; -&gt; &quot;green2&quot; ;
&quot;green1&quot; -&gt; &quot;green3&quot; ;
&quot;green2&quot; -&gt; &quot;green3&quot; ;
&quot;green3&quot; -&gt; &quot;green4&quot; ;
&quot;green1&quot; -&gt; &quot;green4&quot; ;
&quot;green2&quot; -&gt; &quot;green4&quot; ;
&quot;green3&quot; -&gt; &quot;green5&quot; ;
&quot;green1&quot; -&gt; &quot;green5&quot; ;
&quot;green4&quot; -&gt; &quot;green5&quot; ;
&quot;green2&quot; -&gt; &quot;green5&quot; ;
&quot;green3&quot; -&gt; &quot;green4.5&quot; ;
&quot;green1&quot; -&gt; &quot;green4.5&quot; ;
&quot;green4&quot; -&gt; &quot;green4.5&quot; ;
&quot;green2&quot; -&gt; &quot;green4.5&quot; ;
}" class="graphviz" /></div>
</div>
<div class="section" id="removing-shortcuts">
<h2>Removing Shortcuts<a class="headerlink" href="#removing-shortcuts" title="Permalink to this headline">¶</a></h2>
<p>The code generating our target repository needs to strip that
graph down. This is the step 7 in our list above. To do this, we find
and remove shortcuts in the graph. I.e., the arc from <code class="docutils literal notranslate"><span class="pre">green1</span></code> to
<code class="docutils literal notranslate"><span class="pre">green3</span></code> is a shortcut for the connection <code class="docutils literal notranslate"><span class="pre">green1</span></code> → <code class="docutils literal notranslate"><span class="pre">green2</span></code> → <code class="docutils literal notranslate"><span class="pre">green3</span></code>.
The algorithm removes the shortcut arc from <code class="docutils literal notranslate"><span class="pre">green1</span></code> to <code class="docutils literal notranslate"><span class="pre">green3</span></code>.
Applying this algorithm over the full graph yields a simplifed graph as follows.</p>
<div class="graphviz"><img src="../../_images/graphviz-f1af161baf90aaed7983c2a866457922df7b7075.png" alt="digraph mesh {
graph [ rankdir=LR ];
&quot;green1&quot; -&gt; &quot;green2&quot; ;
&quot;green2&quot; -&gt; &quot;green3&quot; ;
&quot;green3&quot; -&gt; &quot;green4&quot; ;
&quot;green1&quot; -&gt; &quot;green5&quot; ;
&quot;green4&quot; -&gt; &quot;green5&quot; ;
&quot;green1&quot; -&gt; &quot;green4.5&quot; ;
&quot;green4&quot; -&gt; &quot;green4.5&quot; ;
}" class="graphviz" /></div>
<p>This is almost the graph we’re looking for. There are still two more arcs
which shortcut, each from the root to each head of our graph here. They’re
pretty hard to find by extending the algorithm we used in the first
simplification. You need to check two, three, four, and five intermediate
nodes to discover them already in this example, and in practice, these
shortcuts can span much wider ranges. So to find these, we use a second
algorithm, starting with merge nodes, i.e., nodes with more than one parent.
For each merge node, we try to find a non-trivial path to the merge node from
any of its parents. If we find one, we drop the arc from that parent to
the merge node. This code is efficient at this point as we only have a much
smaller list of merge nodes, compared to the initial graph. And the code
can rely on the fact that the numeric IDs of Mercurial changesets of parents
are always smaller than the child. That allows to abort the search when the
algorithm walks “past” the given merge node.</p>
<p>This results in the expected sparse graph that we started out with.</p>
</div>
<div class="section" id="single-head">
<h2>Single Head<a class="headerlink" href="#single-head" title="Permalink to this headline">¶</a></h2>
<p>To have a single repository state that we can translate, we ensure that we
have a single head in the target repository. As you can see in our example,
that doesn’t necessarily need to be in our sparse set of nodes. If that’s the
case, we pick the oldest merge commit that is a descendant of all our heads.
Oldest in this case means the one with the lowest numeric ID. There’s not
necessarily a unique choice for this, and given that the numeric IDs depend on
how you added remote changesets to your local clone, this choice might be
only unique to your local clone.</p>
</div>
<div class="section" id="entry-points">
<h2>Entry Points<a class="headerlink" href="#entry-points" title="Permalink to this headline">¶</a></h2>
<p>Generally, the sparse graph here will be an incremental update to an
existing sparse graph. The increment can also have roots that are not
children of the known converted revisions in the target repository.</p>
<p>This used to be very frequent back when we had multiple integration repositories
like <code class="docutils literal notranslate"><span class="pre">mozilla-inbound</span></code> that merged into <code class="docutils literal notranslate"><span class="pre">mozilla-central</span></code>. The string
changes that landed there were based on a much older version of <code class="docutils literal notranslate"><span class="pre">mozilla-central</span></code>
than the last conversion.</p>
<p>To find the right parent in the target repository, there’s an algorithm that
finds a node in the target that corresponds to a parent in the source. That’s
run for each root of the incremental sparse graph.</p>
<p>Part of this algorithm is also to skip over <code class="docutils literal notranslate"><span class="pre">comm-*</span></code> changesets in the target
when searching for entry points for <code class="docutils literal notranslate"><span class="pre">mozilla-*</span></code> and vice versa. That way,
we linearize the history across <code class="docutils literal notranslate"><span class="pre">comm</span></code> and <code class="docutils literal notranslate"><span class="pre">mozilla</span></code>.</p>
</div>
<div class="section" id="maximum-parent-count">
<h2>Maximum Parent Count<a class="headerlink" href="#maximum-parent-count" title="Permalink to this headline">¶</a></h2>
<p>In Mercurial, a changeset can have one or two parents, but no more. There’s no
octopus merges like in git. The sparse graphs can contain merge nodes with more
than two parents, though, so when we encounter those merge nodes, we ingest
additional merge commits. The algorithm for finding good candidates for this
corresponds to the algorithm we used when ensuring a single head on the update.</p>
<p>With a known state of the changeset to convert, we’ll describe the context
with which the content is generated in the next section.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="commits.html" class="btn btn-neutral float-right" title="Commits and Metadata" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Cross-channel" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>